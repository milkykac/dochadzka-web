<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DochÃ¡dzka â€“ Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOSÃšLADENÃ‰ Å TÃLY S ADMIN PANELOM --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; display:flex; flex-direction:column; align-items:center;}
header { background:#007bff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; color:white; position:sticky; top:0; z-index:10; }
h1 { margin:0; font-size:22px; font-weight:700; }
header button { background:#fff; border:none; color:#007bff; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
header button:hover { background:#e2e6ea; }

nav { background:#fff; display:flex; justify-content:center; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:65px; z-index:5; flex-wrap:wrap; width:100%; max-width:1100px; border-radius:0 0 12px 12px; }
nav button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
nav button.active { background:#6f42c1; }
nav button:hover { background:#0056b3; }

section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; width:95%; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; font-weight:600; }

table {Â 
Â  Â  width:100%;Â 
Â  Â  border-collapse:collapse; 
Â  Â  margin-top:15px;Â 
Â  Â  border-radius:8px;Â 
Â  Â  overflow:hidden;Â 
Â  Â  border: none; 
}
th,td {Â 
Â  Â  border:1px solid #ddd;Â 
Â  Â  padding:10px;Â 
Â  Â  text-align:center;Â 
Â  Â  font-size:14px;Â 
Â  Â  color: #333;Â 
}
td {
Â  Â  border-top: none; 
Â  Â  border-bottom: 1px solid #ddd; 
}
tbody tr:first-child td {
Â  Â  border-top: 1px solid #ddd;
}
tbody tr:last-child td {
Â  Â  border-bottom: none;
}
th { background:#007bff; color:white; font-weight:600; }
tr:nth-child(even){ background:#f8f9fa; }

/* TlaÄidlo premenovanÃ© na ExportovaÅ¥ do XLSX */
.export-btn{ margin-top:15px; background:#28a745; border:none; color:white; border-radius:8px; padding:8px 14px; cursor:pointer; font-weight:600; transition: background 0.3s; }
.export-btn:hover{ background:#1e7e34; }
.export-btn:disabled{ background:#6c757d; cursor: not-allowed; }

/* Status box je teraz modrÃ½, aby sa hodil k tÃ©me */
.status-box { background:#e9f2ff; color:#007bff; font-weight:600; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; border:1px solid #007bff;}
.daily-summary-box { background:#d4edda; color:#155724; font-weight:600; padding:15px; border-radius:8px; text-align:center; margin-top:10px; border:1px solid #c3e6cb;}

.filter { margin-top: 10px; }
.filter input, .filter select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }

#debugUid { background:#d1ecf1;color:#0c5460;padding:5px;text-align:center;font-size:12px;margin-bottom:10px; border-radius: 4px;}

/* --- Å TÃLY PRE FAREBNÃ‰ PILULKY (ODZNAKY) --- */
.status-badge {
Â  Â  font-weight: 700 !important;
Â  Â  padding: 7px 14px !important;
Â  Â  border-radius: 50px !important; /* Tvar pilulky */
Â  Â  display: inline-block;
Â  Â  text-align: center;
Â  Â  min-width: 80px;
Â  Â  white-space: nowrap;
Â  Â  text-shadow: none !important;Â 
Â  Â  color: white !important;
Â  Â  font-size: 14px !important;
}
/* MenÅ¡Ã­ Å¡tÃ½l pilulky pre PrestÃ¡vky/PN v jedinom stÄºpci */
.status-badge.small {
Â  Â  padding: 4px 10px !important;
Â  Â  min-width: 60px;
Â  Â  font-size: 11px !important;
Â  Â  margin-left: 10px;
}
.status-prichod {Â 
Â  Â  background: #198754 !important; /* ZelenÃ¡ */
}Â 
.status-odchod {Â 
Â  Â  background: #dc3545 !important; /* ÄŒervenÃ¡ */
}Â 
.status-prestavka-start, .status-prestavka {Â 
Â  Â  background: #ffc107 !important; /* Å½ltÃ¡ */
Â  Â  color: #212529 !important; /* TmavÃ½ text na Å¾ltej */
}
.status-prestavka-end {Â 
Â  Â  background: #0dcaf0 !important; /* Svetlo modrÃ¡ (Cyan) */
}
.status-pn {Â 
Â  Â  background: #6f42c1 !important; /* FialovÃ¡ */
}Â 
/* ----------------------------------- */
</style>
</head>
<body>

<header>
Â  Â  <h1>ğŸ‘‹ Vitaj, <span id="userName">Zamestnanec</span></h1>
Â  Â  <button id="logoutBtn">OdhlÃ¡siÅ¥ sa</button>
</header>

<div id="debugUid">NaÄÃ­tavam UID...</div>

<nav>
Â  Â  <button data-target="dochadzka" class="active">DochÃ¡dzka</button>
Â  Â  <button data-target="prestavky">PrestÃ¡vky</button>
Â  Â  <button data-target="pn">PN</button>
</nav>

<section id="dochadzka" class="active">
Â  Â  <div id="statusBox" class="status-box">NaÄÃ­tavam stav...</div>
Â  Â  
    Â  Â  <div class="action-buttons" style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
Â  Â  Â  Â  <button id="btnPrichod" class="export-btn" style="background:#198754; display: none;">âœ… PRÃCHOD</button>
Â  Â  Â  Â  <button id="btnOdchod" class="export-btn" style="background:#dc3545; display: none;">âŒ ODCHOD</button>
Â  Â  Â  Â  <button id="btnPrestavkaStart" class="export-btn" style="background:#ffc107; color: #333; display: none;">â¸ ZAÄŒAÅ¤ PRESTÃVKU</button>
Â  Â  Â  Â  <button id="btnPrestavkaEnd" class="export-btn" style="background:#0dcaf0; color: #333; display: none;">â–¶ UKONÄŒIÅ¤ PRESTÃVKU</button>
Â  Â  </div>
    <div id="dailySummaryBox" class="daily-summary-box" style="display: none;"></div>

Â  Â  <h2>DochÃ¡dzka (PrÃ­chod/Odchod)</h2>
Â  Â  <button class="export-btn" data-export-table="dochadzka">ExportovaÅ¥ do XLSX (SumÃ¡r)</button>
Â  Â  <div class="filter">
Â  Â  Â  Â  <label for="dateDochadzka">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  <input type="date" id="dateDochadzka">
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas</th><th>Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="dochadzkaTable"><tr><td colspan="2">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="prestavky">
Â  Â  <h2>PrestÃ¡vky</h2>
Â  Â  <button class="export-btn" data-export-table="prestavky">ExportovaÅ¥ do XLSX (SumÃ¡r)</button>
Â  Â  <div class="filter">
Â  Â  Â  Â  <label for="datePrestavky">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  <input type="date" id="datePrestavky">
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="prestavkyTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="pn">
Â  Â  <h2>PN (PrÃ¡ceneschopnosÅ¥)</h2>
Â  Â  <button class="export-btn" data-export-table="pn">ExportovaÅ¥ do XLSX</button>
Â  Â  <div class="filter">
Â  Â  Â  Â  <label for="datePN">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  <input type="date" id="datePN">
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="pnTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
// NOVÃ IMPORT: push pre zÃ¡pis
import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
Â  Â  authDomain: "maturita-395fd.firebaseapp.com",
Â  Â  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
Â  Â  projectId: "maturita-395fd",
Â  Â  storageBucket: "maturita-395fd.firebasestorage.app",
Â  Â  messagingSenderId: "754745500563",
Â  Â  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
Â  Â  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// GlobÃ¡lne premennÃ©
const userId = localStorage.getItem("uid");
const userNameEl = document.getElementById("userName");
const statusBox = document.getElementById("statusBox");
const dailySummaryBox = document.getElementById("dailySummaryBox"); // NOVÃ‰
const debugUidEl = document.getElementById("debugUid");Â 
let allRecordsCache = []; // ZÃ¡sobnÃ­k vÅ¡etkÃ½ch zÃ¡znamov
let currentLogStatus = {}; // NOVÃ‰: Pre uchovanie aktuÃ¡lneho stavu

// --- Overenie a presmerovanie ---
if (!userId) {
Â  Â  alert("Nie si prihlÃ¡senÃ½!");
Â  Â  window.location.href = "index.html";
} else if (userId === "admin") {
Â  Â  window.location.href = "admin.html";
} else {
Â  Â  debugUidEl.textContent = `AktuÃ¡lne naÄÃ­tanÃ© UID: ${userId}`;
}

// --- POMOCNÃ‰ FUNKCIE ---

// Konverzia milisekÃºnd na formÃ¡t HH:MM
function msToHhMm(ms) {
Â  Â  if (ms < 0) return "00:00";
Â  Â  const totalMinutes = Math.floor(ms / (1000 * 60));
Â  Â  const hours = Math.floor(totalMinutes / 60);
Â  Â  const minutes = totalMinutes % 60;
Â  Â  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// ZÃ­skanie formÃ¡tovanÃ©ho Äasu pre zÃ¡pis
function getFormattedTime() {
    const now = new Date();
    // YYYY-MM-DD HH:MM format pre konzistentnÃ© triedenie/filtrovanie
    const datePart = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const timePart = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    return `${datePart} ${timePart}`;
}

// --- FUNKCIA PRE ZÃPIS NOVÃ‰HO ZÃZNAMU ---
async function writeLog(type) {
    if (!userId) return;

    try {
        let dbPath;
        if (type.includes('prichod') || type.includes('odchod')) {
            dbPath = `users/${userId}/dochadzka`;
        } else if (type.includes('prestavka')) {
            dbPath = `users/${userId}/prestavky`;
        } else if (type.includes('pn')) {
            dbPath = `users/${userId}/pn`;
        } else {
            throw new Error("NeznÃ¡my typ zÃ¡znamu.");
        }

        const casValue = getFormattedTime();
        
        // ZÃ¡pis do Firebase
        await push(ref(db, dbPath), {
            cas: casValue,
            typ: type
        });
        
        // Zobrazenie Ãºspechu
        statusBox.textContent = `âœ… ÃšspeÅ¡ne zaznamenanÃ©: ${type.toUpperCase()} o ${casValue.substring(11, 16)}`;
        statusBox.style.backgroundColor = '#d4edda'; // ZelenÃ¡ pre Ãºspech
        statusBox.style.color = '#155724';
        
        // OpÃ¤tovnÃ© naÄÃ­tanie dÃ¡t
        await loadUserData();
    } catch (e) {
        console.error("Chyba pri zÃ¡pise do DB:", e);
        statusBox.textContent = `âŒ Chyba pri zÃ¡pise ${type}: ${e.message}`;
        statusBox.style.backgroundColor = '#f8d7da'; // ÄŒervenÃ¡ pre chybu
        statusBox.style.color = '#721c24';
    }
}

// --- Logika aktualizÃ¡cie stavu a tlaÄidiel ---
function updateStatusAndButtons(records) {
    const btnPrichod = document.getElementById("btnPrichod");
    const btnOdchod = document.getElementById("btnOdchod");
    const btnPrestavkaStart = document.getElementById("btnPrestavkaStart");
    const btnPrestavkaEnd = document.getElementById("btnPrestavkaEnd");

    // SkryÅ¥ vÅ¡etky tlaÄidlÃ¡ na zaÄiatku
    [btnPrichod, btnOdchod, btnPrestavkaStart, btnPrestavkaEnd].forEach(b => b.style.display = 'none');

    // NÃ¡jdite najnovÅ¡Ã­ stav PN
    const lastPN = records.find(r => r.stav === 'pn');
    if (lastPN) {
        statusBox.innerHTML = `âš ï¸ AKTÃVNY STAV: **PN**`;
        statusBox.style.backgroundColor = '#6f42c1';
        statusBox.style.color = 'white';
        dailySummaryBox.style.display = 'none';
        return; // Ak je PN, Å¾iadna inÃ¡ akcia nie je moÅ¾nÃ¡
    }

    // NÃ¡jdite najnovÅ¡Ã­ hlavnÃ½ stav (prÃ­chod/odchod)
    const lastMainLog = records.find(r => r.stav === 'prichod' || r.stav === 'odchod');
    const isCurrentlyIn = lastMainLog && lastMainLog.stav === 'prichod';

    // NÃ¡jdite najnovÅ¡Ã­ stav prestÃ¡vky
    const lastBreakLog = records.find(r => r.stav.includes('prestavka'));
    const isCurrentlyOnBreak = lastBreakLog && lastBreakLog.stav === 'prestavka_start' || (lastBreakLog && lastBreakLog.stav === 'prestavka');

    if (!isCurrentlyIn) {
        // Zobrazenie: PRÃCHOD
        btnPrichod.style.display = 'block';
        statusBox.innerHTML = `ğŸ˜´ AKTÃVNY STAV: **ODHLÃSENÃ**`;
        statusBox.style.backgroundColor = '#e9f2ff';
        statusBox.style.color = '#007bff';
        dailySummaryBox.style.display = 'none';
    } else {
        // Zamestnanec je v prÃ¡ci
        btnOdchod.style.display = 'block';

        if (isCurrentlyOnBreak) {
            // Zobrazenie: UKONÄŒIÅ¤ PRESTÃVKU
            btnPrestavkaEnd.style.display = 'block';
            statusBox.innerHTML = `â˜• AKTÃVNY STAV: **NA PRESTÃVKE**`;
            statusBox.style.backgroundColor = '#ffc107';
            statusBox.style.color = '#333';
        } else {
            // Zobrazenie: ZAÄŒAÅ¤ PRESTÃVKU, ODCHOD
            btnPrestavkaStart.style.display = 'block';
            statusBox.innerHTML = `ğŸ’» AKTÃVNY STAV: **V PRÃCI**`;
            statusBox.style.backgroundColor = '#d4edda';
            statusBox.style.color = '#155724';
        }
        dailySummaryBox.style.display = 'block';
        updateDailySummary(records); // AktualizÃ¡cia dennÃ©ho sumÃ¡ru
    }
}

// --- FUNKCIA NA VÃPOÄŒET DENNÃ‰HO SUMÃRU ---
function updateDailySummary(records) {
    const today = new Date().toISOString().substring(0, 10); // YYYY-MM-DD
    
    // ZÃ¡znamy pre dneÅ¡nÃ½ deÅˆ
    const dailyRecords = records
        .filter(r => r.cas.substring(0, 10) === today)
        .sort((a, b) => new Date(a.cas) - new Date(b.cas));

    let workMs = 0;
    let breakMs = 0;
    let lastPrichod = null;
    let lastBreakStart = null;

    dailyRecords.forEach(record => {
        const currentTime = new Date(record.cas);

        // --- Logika PrestÃ¡vky ---
        if (record.stav.includes('prestavka')) {
            if (record.stav === 'prestavka_start' || record.stav === 'prestavka') {
                lastBreakStart = currentTime;
            } else if (record.stav === 'prestavka_end' && lastBreakStart) {
                breakMs += currentTime - lastBreakStart;
                lastBreakStart = null;
            }
        }
        
        // --- Logika PrÃ¡ca ---
        if (record.stav === 'prichod') {
            lastPrichod = currentTime;
        } else if (record.stav === 'odchod' && lastPrichod) {
            let duration = currentTime - lastPrichod;
            
            // OdpoÄÃ­taÅ¥ prestÃ¡vku, ak sa zaÄala a skonÄila v rÃ¡mci cyklu prÃ­chod-odchod
            const breakRecordsInPeriod = dailyRecords.filter(r => new Date(r.cas) > lastPrichod && new Date(r.cas) < currentTime && r.stav.includes('prestavka'));
            let breakDurationInPeriod = 0;
            let tempBreakStart = null;

            breakRecordsInPeriod.forEach(b => {
                const bTime = new Date(b.cas);
                if (b.stav.includes('start') || b.stav === 'prestavka') {
                    tempBreakStart = bTime;
                } else if (b.stav.includes('end') && tempBreakStart) {
                    breakDurationInPeriod += bTime - tempBreakStart;
                    tempBreakStart = null;
                }
            });

            duration -= breakDurationInPeriod;

            workMs += duration;
            lastPrichod = null;
        }
    });

    // Ak je zamestnanec aktuÃ¡lne v prÃ¡ci, prirÃ¡tajte Äas od poslednÃ©ho prÃ­chodu
    if (lastPrichod) {
        let ongoingWork = new Date() - lastPrichod;
        
        // Ak je aj na prestÃ¡vke, odpoÄÃ­tajte prebiehajÃºcu prestÃ¡vku
        if (lastBreakStart) {
            ongoingWork -= (new Date() - lastBreakStart);
        }
        
        if (ongoingWork > 0) workMs += ongoingWork;
    }

    dailySummaryBox.innerHTML = `
        Dnes odpracovanÃ©: <strong>${msToHhMm(workMs)}</strong> | 
        PrestÃ¡vky: <strong>${msToHhMm(breakMs)}</strong>
    `;
}

// --- NaÄÃ­tanie dÃ¡t pouÅ¾Ã­vateÄ¾a z Firebase ---
async function loadUserData() {
Â  Â  try {
Â  Â  Â  Â  const userSnap = await get(ref(db, `users/${userId}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!userSnap.exists()) {
Â  Â  Â  Â  Â  Â  console.error(`Chyba: DÃ¡ta pre UID "${userId}" neboli vo Firebase nÃ¡jdenÃ©!`);
Â  Â  Â  Â  Â  Â  userNameEl.textContent = "(NeznÃ¡my)";
Â  Â  Â  Â  Â  Â  // ... (chybovÃ© hlÃ¡senie)
Â  Â  Â  Â  Â  Â  renderTables([]);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const userData = userSnap.val();
Â  Â  Â  Â  userNameEl.textContent = userData.name || "(bez mena)";

Â  Â  Â  Â  const records = [];
Â  Â  Â  Â  const allPossibleLogs = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Zber zÃ¡znamov (z dochadzka, prestavky, pn)
Â  Â  Â  Â  ["dochadzka", "prestavky", "pn"].forEach(type => {
Â  Â  Â  Â  Â  Â  const logsObj = userData[type] || {};
Â  Â  Â  Â  Â  Â  Object.values(logsObj).forEach(log => allPossibleLogs.push(log));
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Spracovanie a normalizÃ¡cia Äasu
Â  Â  Â  Â  allPossibleLogs.forEach(log => {
Â  Â  Â  Â  Â  Â  if (!log || !log.cas || !log.typ) return;

Â  Â  Â  Â  Â  Â  let cleanTime = String(log.cas);
Â  Â  Â  Â  Â  Â  let validIsoTime = cleanTime;
Â  Â  Â  Â  Â  Â  let displayTime = cleanTime; 

Â  Â  Â  Â  Â  Â  // Logika normalizÃ¡cie Äasu zostÃ¡va
Â  Â  Â  Â  Â  Â  const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
Â  Â  Â  Â  Â  Â  const match = cleanTime.match(dateRegex);

Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  const [full, day, month, year, time] = match;
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year} ${time}`;
Â  Â  Â  Â  Â  Â  } else if (cleanTime.includes('-') && cleanTime.length >= 16) { // ISO like format YYYY-MM-DD HH:MM
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = cleanTime.replace('T', ' ').substring(0, 16); 
Â  Â  Â  Â  Â  Â  Â  Â  const [date, time] = validIsoTime.split(' ');
Â  Â  Â  Â  Â  Â  Â  Â  const [y, m, d] = date.split('-');
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const cleanType = String(log.typ)
Â  Â  Â  Â  Â  Â  Â  Â  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")Â 
Â  Â  Â  Â  Â  Â  Â  Â  .toLowerCase();

Â  Â  Â  Â  Â  Â  let recordType = null;
Â  Â  Â  Â  Â  Â  // NOVÃ VYLEPÅ ENÃ LOGIKA TYPOV
Â  Â  Â  Â  Â  Â  if (cleanType.includes('prichod')) recordType = 'prichod';
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('odchod')) recordType = 'odchod';
            // NOVÃ‰: PrestÃ¡vky sÃº teraz START/END
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('prestavka_start')) recordType = 'prestavka_start';
            else if (cleanType.includes('prestavka_end')) recordType = 'prestavka_end';
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('prestavka')) recordType = 'prestavka'; // Podpora starÃ©ho formÃ¡tu
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('pn')) recordType = 'pn';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (recordType) {
Â  Â  Â  Â  Â  Â  Â  Â  // Kontrola duplikÃ¡tov na zÃ¡klade Äasu a typu
Â  Â  Â  Â  Â  Â  Â  Â  const isDuplicate = records.some(r => r.cas === validIsoTime && r.stav === recordType);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!isDuplicate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â records.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cas: validIsoTime, // ISO formÃ¡t pre triedenie/filtrovanie
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â casDisplay: displayTime, // FormÃ¡t DD.MM.YYYY HH:MM pre zobrazenie/export
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â stav: recordType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â date: displayTime.substring(0, 10),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â time: displayTime.substring(11, 16)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Triedenie pre zobrazenie na strÃ¡nke (NajnovÅ¡ie prvÃ©)
Â  Â  Â  Â  records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
Â  Â  Â  Â  allRecordsCache = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // AKTUALIZÃCIA STAVU A TLAÄŒIDIEL
Â  Â  Â  Â  updateStatusAndButtons(records);

Â  Â  Â  Â  // Vykreslenie tabuliek
Â  Â  Â  Â  renderTables(allRecordsCache);

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t:", e);
Â  Â  Â  Â  statusBox.textContent = "KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t!";
Â  Â  Â  Â  renderTables([]);
Â  Â  }
}

// --- Vykreslenie tabuliek (S Pilulkami) ---
function renderTables(records) {
Â  Â  const dochadzkaTable = document.getElementById("dochadzkaTable");
Â  Â  const prestavkyTable = document.getElementById("prestavkyTable");
Â  Â  const pnTable = document.getElementById("pnTable");

Â  Â  // DÃ¡tum filtrovania musÃ­ byÅ¥ v ISO formÃ¡te YYYY-MM-DD pre porovnanie s r.cas
Â  Â  const filterDochadzka = document.getElementById("dateDochadzka").value;
Â  Â  const filterPrestavky = document.getElementById("datePrestavky").value;
Â  Â  const filterPN = document.getElementById("datePN").value;

Â  Â  const renderSection = (bodyEl, type, filterDate, expectedStav, colCount) => {
Â  Â  Â  Â  let filtered = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(filterDate) {
Â  Â  Â  Â  Â  Â  // Filtrovanie na zÃ¡klade dÃ¡tumu (ÄasÅ¥ YYYY-MM-DD)
Â  Â  Â  Â  Â  Â  filtered = filtered.filter(r => r.cas.substring(0, 10) === filterDate);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sectionRecords = filtered.filter(r => expectedStav.some(stav => r.stav.includes(stav)));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!sectionRecords.length) {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = `<tr><td colspan="${colCount}">Å½iadne zÃ¡znamy</td></tr>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = sectionRecords.map(z => {
Â  Â  Â  Â  Â  Â  Â  Â  const displayTime = z.casDisplay;

Â  Â  Â  Â  Â  Â  Â  Â  let statusClass = '';
Â  Â  Â  Â  Â  Â  Â  Â  let stavText = z.stav.toUpperCase();

Â  Â  Â  Â  Â  Â  Â  Â  if (z.stav === 'prichod') statusClass = 'status-prichod';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'odchod') statusClass = 'status-odchod';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'prestavka' || z.stav === 'prestavka_start') {
                    statusClass = 'status-prestavka-start';
                    stavText = 'PRESTÃVKA START';
                }
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'prestavka_end') {
                    statusClass = 'status-prestavka-end';
                    stavText = 'PRESTÃVKA END';
                }
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'pn') statusClass = 'status-pn';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'dochadzka') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // DochÃ¡dzka: 2 stÄºpce
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${displayTime}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status-badge ${statusClass}">${stavText}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // PrestÃ¡vky a PN: 1 stÄºpec
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${displayTime}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge small ${statusClass}">${stavText}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }).join("");
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // PrestÃ¡vky filtrujeme na akÃ½koÄ¾vek typ prestÃ¡vky
Â  Â  renderSection(dochadzkaTable, 'dochadzka', filterDochadzka, ["prichod", "odchod"], 2);
Â  Â  renderSection(prestavkyTable, 'prestavky', filterPrestavky, ["prestavka"], 1);
Â  Â  renderSection(pnTable, 'pn', filterPN, ["pn"], 1);
}

// --- HLAVNÃ FUNKCIA: Export do XLSX (S VylepÅ¡enou logikou prestÃ¡vok) ---
window.exportTable = function(sectionType) {
Â  Â  const userName = userNameEl.textContent;
Â  Â  let filterDate, expectedStav, sectionTitle;
Â  Â  let header; 
Â  Â  let fileNameBase;

Â  Â  // --- Krok 1: Definovanie filtrov a hlaviÄiek ---
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  filterDate = document.getElementById("dateDochadzka").value;
Â  Â  Â  Â  expectedStav = ["prichod", "odchod"];
Â  Â  Â  Â  sectionTitle = "DochÃ¡dzka (PrÃ­chod/Odchod) a SumarizÃ¡cia";
Â  Â  Â  Â  header = ["DÃ¡tum", "ÄŒas", "Typ", "OdpracovanÃ½ Äas/Status"];Â 
Â  Â  Â  Â  fileNameBase = "dochadzka_sumar";
Â  Â  } else if (sectionType === 'prestavky') {
Â  Â  Â  Â  filterDate = document.getElementById("datePrestavky").value;
Â  Â  Â  Â  expectedStav = ["prestavka"]; // Filtruje vÅ¡etky typy prestÃ¡vok
Â  Â  Â  Â  sectionTitle = "PrestÃ¡vky a ich Trvanie";
Â  Â  Â  Â  // NOVÃ HLAVIÄŒKA pre PrestÃ¡vky
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ ZÃ¡znamu", "Trvanie PrestÃ¡vky"];
Â  Â  Â  Â  fileNameBase = "prestavky_sumar";
Â  Â  } else if (sectionType === 'pn') {
Â  Â  Â  Â  filterDate = document.getElementById("datePN").value;
Â  Â  Â  Â  expectedStav = ["pn"];
Â  Â  Â  Â  sectionTitle = "PN";
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ"];
Â  Â  Â  Â  fileNameBase = "pn";
Â  Â  } else {
Â  Â  Â  Â  return alert("NeznÃ¡my typ sekcie pre export.");
Â  Â  }
Â  Â Â 
Â  Â  // --- Krok 2: FiltrÃ¡cia a triedenie dÃ¡t pre kalkulÃ¡ciu (od najstarÅ¡ieho) ---
Â  Â  let filteredRecords = allRecordsCache;
Â  Â  if(filterDate) {
Â  Â  Â  Â  filteredRecords = filteredRecords.filter(r => r.cas.substring(0, 10) === filterDate);
Â  Â  }
Â  Â Â 
Â  Â  const sortedRecords = filteredRecords
Â  Â  Â  Â  .filter(r => expectedStav.some(stav => r.stav.includes(stav)))
Â  Â  Â  Â  .sort((a, b) => new Date(a.cas) - new Date(b.cas));

Â  Â  // --- Krok 3: Generovanie dÃ¡tovÃ©ho poÄ¾a a KALKULÃCIA ---
Â  Â  const exportData = [
Â  Â  Â  Â  ["Typ zÃ¡znamu:", sectionTitle],
Â  Â  Â  Â  ["PouÅ¾Ã­vateÄ¾:", userName],
Â  Â  Â  Â  [],Â 
Â  Â  Â  Â  header 
Â  Â  ];
Â  Â Â 
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  // PonechÃ¡me komplexnÃº dochÃ¡dzkovÃº logiku pre export dochÃ¡dzky
Â  Â  Â  Â  let totalWorkMs = 0;
Â  Â  Â  Â  let lastPrichod = null;
Â  Â  Â  Â  let lastDate = null;
Â  Â  Â  Â  let dailyWorkMs = 0;
        
        // ZÃ­skame vÅ¡etky prestÃ¡vky, aby sme ich mohli odpoÄÃ­taÅ¥
        const breakRecords = allRecordsCache
            .filter(r => r.stav.includes('prestavka'))
            .sort((a, b) => new Date(a.cas) - new Date(b.cas));
        
        let totalBreakMs = 0;


Â  Â  Â  Â  sortedRecords.forEach((record) => {
Â  Â  Â  Â  Â  Â  const currentDateTime = new Date(record.cas);
Â  Â  Â  Â  Â  Â  const currentDateStr = record.date;
Â  Â  Â  Â  Â  Â  const currentTimeStr = record.time;

Â  Â  Â  Â  Â  Â  // --- Logika SumarizÃ¡cie DÅˆa ---
Â  Â  Â  Â  Â  Â  if (lastDate && lastDate !== currentDateStr) {
Â  Â  Â  Â  Â  Â  Â  Â  if (dailyWorkMs > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs = 0; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (record.stav === 'prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = currentDateTime;
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), ""]);
Â  Â  Â  Â  Â  Â  } else if (record.stav === 'odchod' && lastPrichod) {
Â  Â  Â  Â  Â  Â  Â  Â  let durationMs = currentDateTime - lastPrichod;
                
                // OdpoÄÃ­tanie Äasu prestÃ¡vok medzi tÃ½mto prÃ­chodom a odchodom
                let durationBreaks = 0;
                let lastBreakStart = null;
                
                breakRecords.forEach(breakR => {
                    const breakTime = new Date(breakR.cas);
                    if (breakTime > lastPrichod && breakTime < currentDateTime) {
                         if (breakR.stav.includes('start') || breakR.stav === 'prestavka') {
                            lastBreakStart = breakTime;
                        } else if (breakR.stav.includes('end') && lastBreakStart) {
                            durationBreaks += breakTime - lastBreakStart;
                            lastBreakStart = null;
                        }
                    }
                });
                
                totalBreakMs += durationBreaks;
Â  Â  Â  Â  Â  Â  Â  Â  durationMs -= durationBreaks; // ODPOÄŒÃTANIE PRESTÃVOK

Â  Â  Â  Â  Â  Â  Â  Â  const durationHhMm = msToHhMm(durationMs);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  totalWorkMs += durationMs;
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs += durationMs;

Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), durationHhMm]);
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = null; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), "Chyba PRICHOD/ODCHOD"]);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  lastDate = currentDateStr;
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- FinÃ¡lna SumarizÃ¡cia (PoslednÃ½ deÅˆ) ---
Â  Â  Â  Â  if (lastDate && dailyWorkMs > 0) {
Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CelkovÃ¡ SumarizÃ¡cia ---
Â  Â  Â  Â  exportData.push([]); 
        exportData.push(["CelkovÃ¡ odpracovanÃ¡ doba:", "", "", msToHhMm(totalWorkMs)]);
        exportData.push(["CelkovÃ¡ doba prestÃ¡vok (odpoÄÃ­tanÃ¡):", "", "", msToHhMm(totalBreakMs)]);


Â  Â  } else if (sectionType === 'prestavky') {
        // NOVÃ Logika pre export PrestÃ¡vok (SUMÃR)
        let totalBreakMs = 0;
        let lastBreakStart = null;
        
        // Pridanie riadkov, kde sa poÄÃ­ta trvanie prestÃ¡vky
        sortedRecords.forEach(record => {
            const currentDateTime = new Date(record.cas);
            let durationHhMm = "";
            let stavText = record.stav.toUpperCase();

            if (record.stav.includes('start') || record.stav === 'prestavka') {
                lastBreakStart = currentDateTime;
                stavText = 'PRESTÃVKA START';
            } else if (record.stav.includes('end') && lastBreakStart) {
                const durationMs = currentDateTime - lastBreakStart;
                durationHhMm = msToHhMm(durationMs);
                totalBreakMs += durationMs;
                lastBreakStart = null;
                stavText = 'PRESTÃVKA END';
            } else if (record.stav.includes('end')) {
                durationHhMm = "Chyba: ChÃ½ba START";
                stavText = 'PRESTÃVKA END';
            }

            exportData.push([
                record.casDisplay,
                stavText,
                durationHhMm
            ]);
        });

        // CelkovÃ½ sÃºÄet prestÃ¡vok
        exportData.push([]); 
        exportData.push(["CelkovÃ¡ doba prestÃ¡vok:", "", msToHhMm(totalBreakMs)]);

    } else { // Pre PN je jednoduchÃ½ export
Â  Â  Â  Â  if (sortedRecords.length === 0) {
Â  Â  Â  Â  Â  Â  exportData.push(["Å½iadne zÃ¡znamy", ""]);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sortedRecords.forEach(z => {
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  z.casDisplay, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  z.stav.toUpperCase()
Â  Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // --- Krok 4: Export XLSX s vizuÃ¡lnymi Ãºpravami ---
Â  Â Â 
Â  Â  const wb = XLSX.utils.book_new();
Â  Â  const ws = XLSX.utils.aoa_to_sheet(exportData);
Â  Â Â 
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 100 }, 
Â  Â  Â  Â  Â  Â  { wpx: 150 }, 
Â  Â  Â  Â  Â  Â  { wpx: 100 }, 
Â  Â  Â  Â  Â  Â  { wpx: 150 } 
Â  Â  Â  Â  ];

Â  Â  Â  Â  const finalRowIndex = exportData.length - 2; 

Â  Â  Â  Â  for (let i = 4; i < exportData.length; i++) {
Â  Â  Â  Â  Â  Â  const row = exportData[i];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (row[1] === "SumarizÃ¡cia dÅˆa:") {
Â  Â  Â  Â  Â  Â  Â  Â  const textCellRef = XLSX.utils.encode_cell({ r: i, c: 1 });
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }

Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFFCC00" } } }; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (row[3] === "Chyba PRICHOD/ODCHOD") {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FFCC0000" } } }; }Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (i === finalRowIndex && row[0] === "CelkovÃ¡ odpracovanÃ¡ doba:") {
Â  Â  Â  Â  Â  Â  Â  Â  const textCellRef = XLSX.utils.encode_cell({ r: i, c: 0 });
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FF00B050" } } }; }Â 
Â  Â  Â  Â  Â  Â  }
            // NOVÃ‰: CelkovÃ¡ doba prestÃ¡vok
            if (i === finalRowIndex + 1 && row[0] === "CelkovÃ¡ doba prestÃ¡vok (odpoÄÃ­tanÃ¡):") {
Â  Â  Â  Â  Â  Â  Â  Â  const textCellRef = XLSX.utils.encode_cell({ r: i, c: 0 });
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FF00BFFF" } } }; } // ModrÃ¡
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  } else if (sectionType === 'prestavky') {
Â  Â  Â  Â  Â  ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 150 }, 
Â  Â  Â  Â  Â  Â  { wpx: 150 },
            { wpx: 150 }Â 
Â  Â  Â  Â  ];
        // ZvÃ½raznenie celkovej doby prestÃ¡vok
        const finalRowIndex = exportData.length - 1;
        const textCellRef = XLSX.utils.encode_cell({ r: finalRowIndex, c: 0 });
        if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }
        const cellRef = XLSX.utils.encode_cell({ r: finalRowIndex, c: 2 });
        if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFFCC00" } } }; }
Â  Â  } else {
Â  Â  Â  Â  Â  ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 150 }, 
Â  Â  Â  Â  Â  Â  { wpx: 100 }Â 
Â  Â  Â  Â  ];
Â  Â  }
Â  Â Â 
Â  Â  XLSX.utils.book_append_sheet(wb, ws, "DochÃ¡dzka");

Â  Â  const safeUserName = userName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
Â  Â  const fileName = `${fileNameBase}_${safeUserName}_export.xlsx`;
Â  Â Â 
Â  Â  XLSX.writeFile(wb, fileName);
Â  Â Â 
Â  Â  const btn = document.querySelector(`[data-export-table="${sectionType}"]`);
Â  Â  if(btn) {
Â  Â  Â  Â  btn.textContent = "SÃºbor stiahnutÃ½!";
Â  Â  Â  Â  setTimeout(() => {
            if (sectionType === 'dochadzka') btn.textContent = "ExportovaÅ¥ do XLSX (SumÃ¡r)";
            else if (sectionType === 'prestavky') btn.textContent = "ExportovaÅ¥ do XLSX (SumÃ¡r)";
            else btn.textContent = "ExportovaÅ¥ do XLSX";
        }, 2000);
Â  Â  }
};

// --- Listenery ---

document.getElementById("logoutBtn").addEventListener("click", () => {
Â  Â  localStorage.removeItem("uid");
Â  Â  window.location.href = "index.html";
});

document.querySelectorAll("nav button").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
Â  Â  Â  Â  btn.classList.add("active");
Â  Â  Â  Â  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
Â  Â  Â  Â  document.getElementById(btn.dataset.target).classList.add("active");
Â  Â  Â  Â  renderTables(allRecordsCache); // Prekreslenie pri prepnutÃ­ sekcie
Â  Â  });
});

// Filtre spustia renderTables
document.getElementById("dateDochadzka").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePrestavky").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePN").addEventListener("change", () => renderTables(allRecordsCache));

document.querySelectorAll(".export-btn").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  exportTable(btn.dataset.exportTable);Â 
Â  Â  });
});

// NOVÃ‰: LISTENERY PRE AKÄŒNÃ‰ TLAÄŒIDLÃ
document.getElementById("btnPrichod").addEventListener("click", () => writeLog("prichod"));
document.getElementById("btnOdchod").addEventListener("click", () => writeLog("odchod"));
document.getElementById("btnPrestavkaStart").addEventListener("click", () => writeLog("prestavka_start"));
document.getElementById("btnPrestavkaEnd").addEventListener("click", () => writeLog("prestavka_end"));

// --- Spustenie aplikÃ¡cie ---
loadUserData();
</script>
</body>
</html>
