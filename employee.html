<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DochÃ¡dzka â€“ Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- PÃ”VODNÃ VIZUÃL A Å TÃLY --- */
:root {
Â  --bg: #f4f5f7;
Â  --text: #333;
Â  --card: #fff;
Â  --accent: #007bff;
Â  --accent-dark: #0056b3;
Â  --border: #ccc;
Â  --prichod: #28a745;
Â  --odchod: #dc3545;
Â  --prestavka: #ffc107;
Â  --pn: #6f42c1;
}
body {
Â  font-family: 'Poppins', sans-serif;
Â  margin: 0;
Â  padding: 0;
Â  background: var(--bg);
Â  color: var(--text);
Â  display: flex;
Â  flex-direction: column;
Â  align-items: center;
}
header {
Â  width: 100%;
Â  background: var(--accent);
Â  color: white;
Â  padding: 15px 25px;
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  position: sticky;
Â  top: 0;
Â  z-index: 100;
Â  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
header h1 { font-weight: 600; font-size: 22px; margin: 0; }
header button {
Â  background: #fff;
Â  color: var(--accent);
Â  border: none;
Â  border-radius: 8px;
Â  padding: 8px 14px;
Â  cursor: pointer;
Â  font-weight: 600;
Â  transition: 0.3s;
}
header button:hover { background: var(--accent-dark); color: white; }
nav { display: flex; gap: 10px; margin: 20px 0 0 0; }
nav button {
Â  background: var(--accent);
Â  color: white;
Â  border: none;
Â  border-radius: 8px;
Â  padding: 8px 16px;
Â  cursor: pointer;
Â  font-weight: 500;
Â  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
Â  transition: 0.3s;
}
nav button.active { background: var(--pn); }
nav button:hover { background: var(--accent-dark); }
.container {
Â  max-width: 850px;
Â  width: 95%;
Â  background: var(--card);
Â  margin: 25px auto 40px auto;
Â  padding: 25px 30px;
Â  border-radius: 16px;
Â  box-shadow: 0 6px 25px rgba(0,0,0,0.1);
}
h2 {
Â  color: var(--accent);
Â  border-bottom: 3px solid var(--accent);
Â  padding-bottom: 6px;
Â  margin-top: 0;
Â  font-weight: 600;
}
.table-section { display: none; margin-top: 20px; }
.table-section.active { display: block; }
table {
Â  width: 100%;
Â  border-collapse: collapse;
Â  margin-top: 10px;
Â  font-size: 15px;
Â  border-radius: 10px;
Â  overflow: hidden;
Â  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
th, td { border: 1px solid var(--border); padding: 10px; text-align: center; }
th { background: var(--accent); color: white; font-weight: 500; }
tr:nth-child(even) { background: rgba(0,0,0,0.03); }
tr:hover { background: rgba(0,0,0,0.08); }
.status-prichod, .status-odchod, .status-prestavka, .status-pn {
Â  font-weight: 600;
Â  padding: 3px 8px;
Â  border-radius: 12px;
Â  display: inline-block;
Â  color: white;
}
.status-prichod { background: var(--prichod); }
.status-odchod { background: var(--odchod); }
.status-prestavka { background: var(--prestavka); }
.status-pn { background: var(--pn); }
.status-box {
Â  margin: 10px 0 20px;
Â  font-weight: 600;
Â  padding: 12px;
Â  border-radius: 12px;
Â  text-align: center;
Â  background: #e9f2ff;
Â  font-size: 16px;
Â  color: var(--accent);
Â  border: 1px solid var(--accent);
Â  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}
button.export-btn {
Â  margin-top: 10px;
Â  background: #28a745;
Â  border: none;
Â  border-radius: 8px;
Â  color: white;
Â  padding: 8px 14px;
Â  font-weight: 500;
Â  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
Â  cursor: pointer;
Â  transition: 0.3s;
}
button.export-btn:hover { background: #218838; }
.filter { margin: 10px 0 0 0; }
.filter input { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); width: 160px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header>
Â  <h1>ğŸ‘‹ Vitaj, <span id="userName">Zamestnanec</span></h1>
Â  <button id="logoutBtn">OdhlÃ¡siÅ¥ sa</button>
</header>

<nav>
Â  <button data-target="attendance" class="active">DochÃ¡dzka</button>
Â  <button data-target="breaks">PrestÃ¡vky</button>
Â  <button data-target="pn">PN</button>
</nav>

<div class="container">
Â  <div id="statusBox" class="status-box">NaÄÃ­tavam stav...</div>

Â  <div class="table-section active" id="attendance">
Â  Â  <h2>DochÃ¡dzka</h2>
Â  Â  <button class="export-btn" data-export-table="attendance">Export do Excel</button>
Â  Â  <div class="filter">
Â  Â  Â  <label for="filterDate">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  <input type="date" id="filterDate">
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  <thead><tr><th>ÄŒas</th><th>Stav</th></tr></thead>
Â  Â  Â  <tbody id="myAttendanceBody"><tr><td colspan="2">NaÄÃ­tavam Ãºdaje...</td></tr></tbody>
Â  Â  </table>
Â  </div>

Â  <div class="table-section" id="breaks">
Â  Â  <h2>PrestÃ¡vky</h2>
Â  Â  <button class="export-btn" data-export-table="breaks">Export do Excel</button>
Â  Â  <table>
Â  Â  Â  <thead><tr><th>ÄŒas</th></tr></thead>
Â  Â  Â  <tbody id="myBreaksBody"><tr><td colspan="1">Å½iadne prestÃ¡vky</td></tr></tbody>
Â  Â  </table>
Â  </div>

Â  <div class="table-section" id="pn">
Â  Â  <h2>PN</h2>
Â  Â  <button class="export-btn" data-export-table="pn">Export do Excel</button>
Â  Â  <table>
Â  Â  Â  <thead><tr><th>ÄŒas</th></tr></thead>
Â  Â  Â  <tbody id="myPNBody"><tr><td colspan="1">Å½iadne PN</td></tr></tbody>
Â  Â  </table>
Â  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// --- KONFIGURÃCIA FIREBASE (ZADANÃ‰ VO VAÅ OM PÃ”VODNOM KÃ“DE) ---
const firebaseConfig = {
Â  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYp0g",
Â  authDomain: "maturita-395fd.firebaseapp.com",
Â  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
Â  projectId: "maturita-395fd",
Â  storageBucket: "maturita-395fd.firebasestorage.app",
Â  messagingSenderId: "754745500563",
Â  appId: "1:754745500563:web:74fd4d6ab5765ee788be66"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- ZÃSKANIE ELEMENTOV A VARIÃBLÃ ---
const userId = localStorage.getItem("uid");
const myAttendanceBody = document.getElementById("myAttendanceBody");
const myBreaksBody = document.getElementById("myBreaksBody");
const myPNBody = document.getElementById("myPNBody");
const userNameEl = document.getElementById("userName");
const filterDate = document.getElementById("filterDate");
const statusBox = document.getElementById("statusBox");

// Cache pre uloÅ¾enie vÅ¡etkÃ½ch zÃ¡znamov po naÄÃ­tanÃ­
let allRecordsCache = []; 

// --- OVERENIE PRIHLÃSENIA ---
if(!userId){
Â  alert("Nie si prihlÃ¡senÃ½!");
Â  window.location.href = "index.html";
} else if(userId === "admin"){
Â  window.location.href = "admin.html";
}

// --- FUNKCIA PRE NAÄŒÃTANIE DÃT Z FIREBASE ---
async function loadUserData() {
Â  try {
Â  Â  const userSnap = await get(ref(db, `users/${userId}`));
Â  Â  if (!userSnap.exists()) {
Â  Â  Â  userNameEl.textContent = "(NeznÃ¡my pouÅ¾Ã­vateÄ¾)";
Â  Â  Â  renderTables([]);
Â  Â  Â  return;
Â  Â  }

Â  Â  const userData = userSnap.val();
Â  Â  const chipUid = userData.chipUid;
Â  Â  userNameEl.textContent = userData.name || "(bez mena)";

Â  Â  if (!chipUid) {
Â  Â  Â  statusBox.textContent = "ÄŒip nie je priradenÃ½!";
Â  Â  Â  renderTables([]);
Â  Â  Â  return;
Â  Â  }

Â  Â  // NaÄÃ­tanie dochÃ¡dzky (predpokladÃ¡, Å¾e je rozdelenÃ¡ podÄ¾a ID Äipu pod kÄ¾ÃºÄom 'dochadzka')
Â  Â  const logsSnap = await get(ref(db, "dochadzka"));
Â  Â  // NaÄÃ­tanie mapovania Äipov na pouÅ¾Ã­vateÄ¾ov
Â  Â  const chipToUserSnap = await get(ref(db, "chipToUser"));

Â  Â  const chipUserMap = {};
Â  Â  if(chipToUserSnap.exists()) {
Â  Â  Â  chipToUserSnap.forEach(c => {
Â  Â  Â  Â  chipUserMap[c.key] = c.val();
Â  Â  Â  });
Â  Â  }

Â  Â  const records = [];
Â  Â  if(logsSnap.exists()){
Â  Â  Â  logsSnap.forEach(chipSnap => {
Â  Â  Â  Â  const chipUidKey = chipSnap.key; // ID ÄŒIPU
Â  Â  Â  Â  
Â  Â  Â  Â  // Filtrujeme len zÃ¡znamy, ktorÃ© patria aktuÃ¡lnemu pouÅ¾Ã­vateÄ¾ovi
Â  Â  Â  Â  if(chipUserMap[chipUidKey] === userId){
Â  Â  Â  Â  Â  const logs = chipSnap.val();
Â  Â  Â  Â  Â  if(logs){
Â  Â  Â  Â  Â  Â  Object.values(logs).forEach(log => {
Â  Â  Â  Â  Â  Â  Â  if(log && log.typ && log.cas){
Â  Â  Â  Â  Â  Â  Â  Â  records.push({ cas: log.cas, stav: log.typ.toLowerCase() });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  // Triedenie od najnovÅ¡ieho (konverzia na Date pre triedenie)
Â  Â  Â  records.sort((a, b) => new Date(b.cas.replace(' ', 'T')) - new Date(a.cas.replace(' ', 'T')));
Â  Â  Â  
Â  Â  Â  allRecordsCache = records; 
Â  Â  Â  
Â  Â  Â  statusBox.textContent = records.length ? "PoslednÃ½ stav: " + records[0].stav.toUpperCase() : "Å½iadny stav nezaznamenanÃ½.";
Â  Â  } else {
Â  Â  Â  statusBox.textContent = "Å½iadne zÃ¡znamy v databÃ¡ze.";
Â  Â  Â  allRecordsCache = [];
Â  Â  }

Â  Â  renderTables(allRecordsCache);

Â  } catch(e){
Â  Â  console.error("Chyba pri naÄÃ­tanÃ­ dÃ¡t:", e);
Â  Â  statusBox.textContent = "Chyba pri naÄÃ­tanÃ­ dÃ¡t!";
Â  Â  renderTables([]);
Â  }
}

// --- FUNKCIA PRE VYKRESLENIE TABULIEK S FILTROVANÃM ---
function renderTables(allRecords){
Â  let filtered = allRecords;
Â  const filterDateValue = filterDate.value;

Â  // AplikÃ¡cia filtra dÃ¡tumu
Â  if(filterDateValue){
Â  Â  filtered = allRecords.filter(r => r.cas.startsWith(filterDateValue));
Â  }
Â  
Â  // PomocnÃ¡ funkcia pre vykreslenie jednej sekcie tabuÄ¾ky
Â  const renderSection = (records, bodyElement, expectedStatus, cols, statusClass) => {
Â  Â  const sectionRecords = records.filter(r => expectedStatus.includes(r.stav));
Â  Â  
Â  Â  if(!sectionRecords.length) {
Â  Â  Â  bodyElement.innerHTML = `<tr><td colspan='${cols}'>Å½iadne zÃ¡znamy</td></tr>`;
Â  Â  } else {
Â  Â  Â  bodyElement.innerHTML = sectionRecords.map(z => {
Â  Â  Â  Â  if (cols === 2) {
Â  Â  Â  Â  Â  // DochÃ¡dzka: Dva stÄºpce
Â  Â  Â  Â  Â  const cls = z.stav === "prichod" ? "status-prichod" : "status-odchod";
Â  Â  Â  Â  Â  return `<tr><td>${z.cas}</td><td><span class="${cls}">${z.stav.toUpperCase()}</span></td></tr>`;
Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  // PrestÃ¡vky/PN: Jeden stÄºpec (Äas je vo vnÃºtri span pre farebnÃ½ vizuÃ¡l)
Â  Â  Â  Â  Â  return `<tr><td><span class="${statusClass}">${z.cas}</span></td></tr>`;
Â  Â  Â  Â  }
Â  Â  Â  }).join("");
Â  Â  }
Â  };

Â  renderSection(filtered, myAttendanceBody, ["prichod","odchod"], 2);
Â  renderSection(filtered, myBreaksBody, ["prestavka"], 1, "status-prestavka");
Â  renderSection(filtered, myPNBody, ["pn"], 1, "status-pn");
}

// --- FUNKCIA PRE EXPORT DO EXCELU ---
function exportData(tableId) {
Â  const userName = userNameEl.textContent;
Â  let data = [];
Â  
Â  const tableSection = document.getElementById(tableId);
Â  const table = tableSection ? tableSection.querySelector("table") : null;
Â  
Â  if (!table) return;

Â  const headerText = tableSection.querySelector("h2").textContent;
Â  // ZÃ­skanie hlaviÄiek tabuÄ¾ky
Â  const headerRow = Array.from(table.querySelector("thead tr th")).map(th => th.textContent);
Â  const tableRows = Array.from(table.querySelectorAll("tbody tr"));
Â  
Â  // Metadata pre export
Â  data.push([`Zamestnanec: ${userName}`]);
Â  data.push([`Typ: ${headerText}`]);
Â  data.push([]);
Â  data.push(headerRow); 

Â  tableRows.forEach(tr => {
Â  Â  const rowData = Array.from(tr.querySelectorAll("td")).map(td => td.textContent.trim());
Â  Â  data.push(rowData);
Â  });

Â  const ws = XLSX.utils.aoa_to_sheet(data);
Â  const wb = XLSX.utils.book_new();
Â  XLSX.utils.book_append_sheet(wb, ws, headerText.replace(' ', '_'));
Â  // DynamickÃ½ nÃ¡zov sÃºboru s dÃ¡tumom
Â  XLSX.writeFile(wb, `${headerText.replace(' ', '_')}_${userName}_${new Date().toLocaleDateString('sk-SK').replace(/\./g, '-')}.xlsx`);
}

// --- LISTENERY ---

// Filter handler - prefiltruje dÃ¡ta z cache
filterDate.addEventListener("change", ()=> renderTables(allRecordsCache));

// Handler pre odhlÃ¡senie
document.getElementById("logoutBtn").addEventListener("click", ()=>{
Â  localStorage.removeItem("uid");
Â  window.location.href="index.html";
});

// Handler pre export (viazanÃ½ na data-export-table atribÃºt)
document.querySelectorAll(".export-btn").forEach(btn => {
Â  btn.addEventListener("click", () => {
Â  Â  const targetId = btn.dataset.exportTable;
Â  Â  exportData(targetId);
Â  });
});

// Handler pre navigÃ¡ciu (prepÃ­nanie sekciÃ­)
document.querySelectorAll("nav button").forEach(btn=>{
Â  btn.onclick = ()=>{
Â  Â  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
Â  Â  btn.classList.add("active");
Â  Â  document.querySelectorAll(".table-section").forEach(sec=>sec.classList.remove("active"));
Â  Â  document.getElementById(btn.dataset.target).classList.add("active");
Â  }
});

// --- SPUSTENIE APLIKÃCIE ---
loadUserData();
</script>
</body>
</html>
