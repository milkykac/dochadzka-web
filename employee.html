<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DochÃ¡dzka â€“ Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOSÃšLADENÃ‰ Å TÃLY S ADMIN PANELOM A VIZUÃLNYM NÃVRHOM --- */
body {
Â  Â  font-family: 'Poppins', sans-serif;
Â  Â  margin: 0;
Â  Â  /* UPRAVENÃ: HlbÅ¡Ã­, sofistikovanejÅ¡Ã­ gradient */
Â  Â  background: linear-gradient(135deg, #0e3c63, #0a2745);
Â  Â  min-height: 100vh;
Â  Â  color: #333;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: center;
Â  Â  padding-bottom: 50px;
}

header {
Â  Â  /* UPRAVENÃ: TmavÅ¡ia modrÃ¡ */
Â  Â  background: #0062cc;
Â  Â  padding: 15px 25px;
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
Â  Â  width: 100%;
Â  Â  color: white;
Â  Â  position: sticky;
Â  Â  top: 0;
Â  Â  z-index: 10;
Â  Â  box-sizing: border-box;
}

h1 {
Â  Â  margin: 0;
Â  Â  font-size: 22px;
Â  Â  font-weight: 700;
}

header button {
Â  Â  background: #fff;
Â  Â  border: none;
Â  Â  color: #007bff;
Â  Â  padding: 8px 14px;
Â  Â  border-radius: 8px;
Â  Â  cursor: pointer;
Â  Â  font-size: 14px;
Â  Â  font-weight: 600;
Â  Â  transition: 0.3s;
Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

header button:hover {
Â  Â  background: #e2e6ea;
Â  Â  transform: translateY(-1px);
}

nav {
Â  Â  background: #fff;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  padding: 10px;
Â  Â  gap: 10px;
Â  Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
Â  Â  position: relative;
Â  Â  top: 0;
Â  Â  z-index: 5;
Â  Â  flex-wrap: wrap;
Â  Â  width: 95%;
Â  Â  max-width: 1100px;
Â  Â  border-radius: 0 0 12px 12px;
Â  Â  margin-top: 20px;
}

nav button {
Â  Â  background: #f0f0f0;
Â  Â  border: none;
Â  Â  color: #333;
Â  Â  padding: 10px 18px;
Â  Â  border-radius: 8px;
Â  Â  cursor: pointer;
Â  Â  font-size: 15px;
Â  Â  font-weight: 600;
Â  Â  transition: 0.3s;
Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

nav button.active {
Â  Â  background: #007bff;
Â  Â  color: white;
Â  Â  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

nav button:hover:not(.active) {
Â  Â  background: #e0e0e0;
Â  Â  transform: translateY(-1px);
}

section {
Â  Â  display: none;
Â  Â  padding: 30px;
Â  Â  background: #fff;
Â  Â  margin: 25px auto;
Â  Â  border-radius: 12px;
Â  Â  max-width: 1100px;
Â  Â  width: 95%;
Â  Â  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
Â  Â  transition: 0.3s;
}

section.active {
Â  Â  display: block;
}

h2 {
Â  Â  color: #007bff;
Â  Â  margin-top: 0;
Â  Â  border-bottom: 2px solid #e0e0e0;
Â  Â  padding-bottom: 10px;
Â  Â  font-weight: 600;
Â  Â  font-size: 20px;
Â  Â  margin-bottom: 25px;
}
/* NOVÃ‰: VylepÅ¡enÃ½ Å¡tÃ½l pre tabuÄ¾ky */
table {
Â  Â  width: 100%;
Â  Â  border-collapse: collapse;
Â  Â  margin-top: 20px;
Â  Â  border-radius: 10px;
Â  Â  overflow: hidden;
Â  Â  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
Â  Â  /* NOVÃ‰: MinimalistickÃ© oddelenie riadkov */
Â  Â  border: 1px solid #f0f0f0;
}

th,
td {
Â  Â  border: none; /* OdstrÃ¡nenÃ© border */
Â  Â  border-bottom: 1px solid #eee; /* Iba spodnÃ½ okraj */
Â  Â  padding: 12px 10px;
Â  Â  text-align: center;
Â  Â  font-size: 14px;
Â  Â  color: #333;
}

th {
Â  Â  background: #007bff;
Â  Â  color: white;
Â  Â  font-weight: 600;
Â  Â  padding: 15px 10px;
Â  Â  border-bottom: 2px solid #0056b3; /* TmavÅ¡Ã­ spodnÃ½ okraj */
}
/* OdstrÃ¡nenie alternatÃ­vnej farby riadkov pre ÄistejÅ¡Ã­ vzhÄ¾ad */
tr:nth-child(even) {
Â  Â  background: transparent;
}

tr:hover {
Â  Â  background: #f5f9ff;
}

/* TlaÄidlÃ¡ pre export */
.export-btn {
Â  Â  margin-top: 15px;
Â  Â  background: #198754; /* ZelenÃ¡ pre export */
Â  Â  border: none;
Â  Â  color: white;
Â  Â  border-radius: 8px;
Â  Â  padding: 10px 18px;
Â  Â  cursor: pointer;
Â  Â  font-weight: 600;
Â  Â  transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 8px;
}

.export-btn:hover {
Â  Â  background: #146c43;
Â  Â  transform: translateY(-2px);
Â  Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.export-btn:disabled {
Â  Â  background: #6c757d;
Â  Â  cursor: not-allowed;
Â  Â  transform: none;
Â  Â  box-shadow: none;
}

/* Status box je teraz modrÃ½, aby sa hodil k tÃ©me */
.status-box {
Â  Â  background: #e9f2ff;
Â  Â  color: #007bff;
Â  Â  font-weight: 600;
Â  Â  padding: 18px;
Â  Â  border-radius: 10px;
Â  Â  text-align: center;
Â  Â  margin-bottom: 25px;
Â  Â  border: 1px solid #a8d4ff;
Â  Â  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
Â  Â  font-size: 1.1em; /* VÃ¤ÄÅ¡Ã­ font pre status */
}
/* NOVÃ: Stav PN je tmavÅ¡Ã­ */
.status-box.pn-active {
Â  Â  background: #5e42a6; /* NOVÃ HlbÅ¡ia fialovÃ¡ */
Â  Â  color: white;
Â  Â  border-color: #4a3485;
Â  Â  box-shadow: 0 2px 8px rgba(94, 66, 166, 0.3);
}

/* NOVÃ: DennÃ½ sumÃ¡r box */
.daily-summary-box {
Â  Â  background: #d4edda;
Â  Â  color: #155724;
Â  Â  font-weight: 600;
Â  Â  padding: 18px;
Â  Â  border-radius: 10px;
Â  Â  text-align: center;
Â  Â  margin-top: 20px;
Â  Â  margin-bottom: 25px;
Â  Â  border: 1px solid #c3e6cb;
Â  Â  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  gap: 15px;
Â  Â  font-size: 1.1em;
}
.daily-summary-box strong {
Â  Â  color: #0062cc; /* TmavÅ¡Ã­ modrÃ½ Äas */
}


.filter {
Â  Â  margin-top: 20px;
Â  Â  margin-bottom: 20px;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  gap: 10px;
Â  Â  flex-wrap: wrap;
}

.filter label {
Â  Â  font-weight: 600;
Â  Â  color: #555;
Â  Â  white-space: nowrap;
}

.filter input[type="date"],
.filter select {
Â  Â  padding: 10px 12px;
Â  Â  border-radius: 8px;
Â  Â  border: 1px solid #ccc;
Â  Â  font-size: 14px;
Â  Â  color: #333;
Â  Â  transition: border-color 0.3s, box-shadow 0.3s;
Â  Â  flex-grow: 1;
Â  Â  max-width: 200px;
}

.filter input[type="date"]:focus,
.filter select:focus {
Â  Â  border-color: #007bff;
Â  Â  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
Â  Â  outline: none;
}

#debugUid {
Â  Â  background: #d1ecf1;
Â  Â  color: #0c5460;
Â  Â  padding: 8px;
Â  Â  text-align: center;
Â  Â  font-size: 13px;
Â  Â  margin-bottom: 15px;
Â  Â  border-radius: 6px;
Â  Â  width: 95%;
Â  Â  max-width: 1100px;
Â  Â  box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
Â  Â  margin-top: 20px;
}

/* --- Å TÃLY PRE FAREBNÃ‰ PILULKY (ODZNAKY) --- */
.status-badge {
Â  Â  font-weight: 700 !important;
Â  Â  padding: 8px 16px !important;
Â  Â  border-radius: 50px !important;
Â  Â  display: inline-flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  min-width: 90px;
Â  Â  white-space: nowrap;
Â  Â  text-shadow: none !important;
Â  Â  color: white !important;
Â  Â  font-size: 13px !important;
Â  Â  letter-spacing: 0.5px;
Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.status-badge.small {
Â  Â  padding: 5px 12px !important;
Â  Â  min-width: 70px;
Â  Â  font-size: 11px !important;
Â  Â  margin-left: 10px;
}
/* UPRAVENÃ‰ FARBY PILULIEK */
.status-prichod {
Â  Â  background: #1e944b !important; /* HlbÅ¡ia zelenÃ¡ */
}

.status-odchod {
Â  Â  background: #c0392b !important; /* ProfesionÃ¡lnejÅ¡ia ÄervenÃ¡ */
}

.status-prestavka-start,
.status-prestavka {
Â  Â  background: #f39c12 !important; /* TmavÅ¡ia oranÅ¾ovÃ¡ */
Â  Â  color: #212529 !important;
}

.status-prestavka-end {
Â  Â  background: #00a2c0 !important; /* TmavÅ¡Ã­ cyan */
Â  Â  color: white !important;
}

.status-pn {
Â  Â  background: #5e42a6 !important; /* HlbokÃ¡ fialovÃ¡ */
}

/* --- RESPONZÃVNE ÃšPRAVY --- */
@media (max-width: 768px) {
Â  Â  header {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  nav {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: stretch;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  }
Â  Â  nav button {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  }
Â  Â  .filter {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: stretch;
Â  Â  }
Â  Â  .filter input[type="date"] {
Â  Â  Â  Â  max-width: 100%;
Â  Â  }
Â  Â  section {
Â  Â  Â  Â  padding: 20px;
Â  Â  }
Â  Â  h2 {
Â  Â  Â  Â  font-size: 18px;
Â  Â  }
Â  Â  th, td {
Â  Â  Â  Â  padding: 8px 5px;
Â  Â  Â  Â  font-size: 12px;
Â  Â  }
Â  Â  .status-badge {
Â  Â  Â  Â  min-width: 70px;
Â  Â  Â  Â  padding: 6px 10px !important;
Â  Â  Â  Â  font-size: 11px !important;
Â  Â  }
Â  Â  .status-badge.small {
Â  Â  Â  Â  min-width: 50px;
Â  Â  Â  Â  font-size: 9px !important;
Â  Â  Â  Â  padding: 3px 8px !important;
Â  Â  }
Â  Â  .daily-summary-box {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  font-size: 1em;
Â  Â  }
}
</style>
</head>
<body>

<header>
Â  Â  <h1>ğŸ‘‹ Vitaj, <span id="userName">Zamestnanec</span></h1>
Â  Â  <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> OdhlÃ¡siÅ¥ sa</button>
</header>

<div id="debugUid">NaÄÃ­tavam UID...</div>

<nav>
Â  Â  <button data-target="dochadzka" class="active"><i class="fas fa-clock"></i> DochÃ¡dzka</button>
Â  Â  <button data-target="prestavky"><i class="fas fa-mug-hot"></i> PrestÃ¡vky</button>
Â  Â  <button data-target="pn"><i class="fas fa-hospital-alt"></i> PN</button>
</nav>

<section id="dochadzka" class="active">
Â  Â  <div id="statusBox" class="status-box">NaÄÃ­tavam stav...</div>
Â  Â Â 
Â  Â  <div id="dailySummaryBox" class="daily-summary-box" style="display: none;"></div>

Â  Â  <h2>DochÃ¡dzka (PrÃ­chod/Odchod)</h2>
Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  Â  <button class="export-btn" data-export-table="dochadzka"><i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX (SumÃ¡r)</button>
Â  Â  Â  Â  <div class="filter">
Â  Â  Â  Â  Â  Â  <label for="dateDochadzka">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="dateDochadzka">
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas</th><th>Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="dochadzkaTable"><tr><td colspan="2">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="prestavky">
Â  Â  <h2>PrestÃ¡vky</h2>
Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  Â  <button class="export-btn" data-export-table="prestavky"><i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX (SumÃ¡r)</button>
Â  Â  Â  Â  <div class="filter">
Â  Â  Â  Â  Â  Â  <label for="datePrestavky">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="datePrestavky">
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="prestavkyTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="pn">
Â  Â  <h2>PN (PrÃ¡ceneschopnosÅ¥)</h2>
Â  Â  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
Â  Â  Â  Â  <button class="export-btn" data-export-table="pn"><i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX</button>
Â  Â  Â  Â  <div class="filter">
Â  Â  Â  Â  Â  Â  <label for="datePN">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="datePN">
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="pnTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
Â  Â  authDomain: "maturita-395fd.firebaseapp.com",
Â  Â  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
Â  Â  projectId: "maturita-395fd",
Â  Â  storageBucket: "maturita-395fd.firebasestorage.app",
Â  Â  messagingSenderId: "754745500563",
Â  Â  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
Â  Â  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// GlobÃ¡lne premennÃ©
const userId = localStorage.getItem("uid");
const userNameEl = document.getElementById("userName");
const statusBox = document.getElementById("statusBox");
const dailySummaryBox = document.getElementById("dailySummaryBox");
const debugUidEl = document.getElementById("debugUid");
let allRecordsCache = [];
let currentLogStatus = {};

// --- Overenie a presmerovanie ---
if (!userId) {
Â  Â  alert("Nie si prihlÃ¡senÃ½!");
Â  Â  window.location.href = "index.html";
} else if (userId === "admin") {
Â  Â  window.location.href = "admin.html";
} else {
Â  Â  debugUidEl.textContent = `AktuÃ¡lne naÄÃ­tanÃ© UID: ${userId}`;
}

// --- POMOCNÃ‰ FUNKCIE ---

// Konverzia milisekÃºnd na formÃ¡t HH:MM
function msToHhMm(ms) {
Â  Â  if (ms < 0) return "00:00";
Â  Â  const totalMinutes = Math.floor(ms / (1000 * 60));
Â  Â  const hours = Math.floor(totalMinutes / 60);
Â  Â  const minutes = totalMinutes % 60;
Â  Â  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// ZÃ­skanie formÃ¡tovanÃ©ho Äasu pre zÃ¡pis (UÅ½ SA NEPOUÅ½ÃVA, iba pre writeLog, ak by bolo nutnÃ©)
function getFormattedTime() {
Â  Â  const now = new Date();
Â  Â  // YYYY-MM-DD HH:MM format pre konzistentnÃ© triedenie/filtrovanie
Â  Â  const datePart = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
Â  Â  const timePart = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
Â  Â  return `${datePart} ${timePart}`;
}

// writeLog funkcia je teraz len zÃ¡stupnÃ¡, keÄÅ¾e zÃ¡znamy sa logujÃº cez ESP32.
async function writeLog(type) {
Â  Â  if (!userId) return;

Â  Â  try {
Â  Â  Â  Â  let dbPath;
Â  Â  Â  Â  // Typy s medzerou fungujÃº s includes('prestavka')
Â  Â  Â  Â  if (type.includes('prichod') || type.includes('odchod') && !type.includes('prestavka')) {
Â  Â  Â  Â  Â  Â  dbPath = `users/${userId}/dochadzka`;
Â  Â  Â  Â  } else if (type.includes('prestavka')) {
Â  Â  Â  Â  Â  Â  dbPath = `users/${userId}/prestavky`;
Â  Â  Â  Â  } else if (type.includes('pn')) {
Â  Â  Â  Â  Â  Â  dbPath = `users/${userId}/pn`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  throw new Error("NeznÃ¡my typ zÃ¡znamu.");
Â  Â  Â  Â  }

Â  Â  Â  Â  const casValue = getFormattedTime();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ZÃ¡pis do Firebase
Â  Â  Â  Â  await push(ref(db, dbPath), {
Â  Â  Â  Â  Â  Â  cas: casValue,
Â  Â  Â  Â  Â  Â  typ: type,
Â  Â  Â  Â  Â  Â  // NOVÃ‰: OznaÄenie manuÃ¡lneho zÃ¡pisu z webu
Â  Â  Â  Â  Â  Â  manual_web: true
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Zobrazenie Ãºspechu
Â  Â  Â  Â  statusBox.innerHTML = `âœ… ÃšspeÅ¡ne zaznamenanÃ©: **${type.toUpperCase()}** o ${casValue.substring(11, 16)} (ManuÃ¡lny zÃ¡pis)`;
Â  Â  Â  Â  statusBox.style.backgroundColor = '#d4edda';
Â  Â  Â  Â  statusBox.style.color = '#155724';
Â  Â  Â  Â  statusBox.classList.remove('pn-active');
Â  Â  Â  Â Â 
Â  Â  Â  Â  await loadUserData();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Chyba pri zÃ¡pise do DB:", e);
Â  Â  Â  Â  statusBox.innerHTML = `âŒ Chyba pri zÃ¡pise ${type}: **${e.message}**`;
Â  Â  Â  Â  statusBox.style.backgroundColor = '#f8d7da';
Â  Â  Â  Â  statusBox.style.color = '#721c24';
Â  Â  Â  Â  statusBox.classList.remove('pn-active');
Â  Â  }
}

// --- Logika aktualizÃ¡cie stavu a tlaÄidiel (uÅ¾ bez tlaÄidiel) ---
function updateStatusAndButtons(records) {
Â  Â  // records sÃº zoradenÃ© od najnovÅ¡ieho
Â  Â  const latestRecord = records.length > 0 ? records[0] : null; 

Â  Â  // 1. OPRAVENÃ KONTROLA PN: PN je aktÃ­vny, len ak je poslednÃ½ zÃ¡znam PN
Â  Â  if (latestRecord && latestRecord.stav === 'pn') {
Â  Â  Â  Â  statusBox.innerHTML = `âš ï¸ AKTUÃLNY STAV: **PN** (Od: ${latestRecord.casDisplay.substring(0, 10)})`;
Â  Â  Â  Â  statusBox.classList.add('pn-active');
Â  Â  Â  Â  dailySummaryBox.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  statusBox.classList.remove('pn-active');
Â  Â  // Koniec PN kontroly

Â  Â  // NÃ¡jdite najnovÅ¡Ã­ hlavnÃ½ stav (prÃ­chod/odchod) pre aktuÃ¡lny deÅˆ
Â  Â  const today = new Date().toISOString().substring(0, 10);
Â  Â  const mainLogsToday = records.filter(r => r.cas.substring(0, 10) === today && (r.stav === 'prichod' || r.stav === 'odchod'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .sort((a, b) => new Date(b.cas) - new Date(a.cas));
Â  Â  const lastMainLogToday = mainLogsToday[0];
Â  Â  const isCurrentlyIn = lastMainLogToday && lastMainLogToday.stav === 'prichod';

Â  Â  // NÃ¡jdite najnovÅ¡Ã­ stav prestÃ¡vky pre aktuÃ¡lny deÅˆ
Â  Â  const breakLogsToday = records.filter(r => r.cas.substring(0, 10) === today && r.stav.startsWith('prestavka'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .sort((a, b) => new Date(b.cas) - new Date(a.cas));
Â  Â  const lastBreakLogToday = breakLogsToday[0];
Â  Â  // ZMENA: Kontrola novÃ©ho typu
Â  Â  const isCurrentlyOnBreak = lastBreakLogToday && lastBreakLogToday.stav === 'prestavka prichod';


Â  Â  if (!isCurrentlyIn) {
Â  Â  Â  Â  statusBox.innerHTML = `ğŸ˜´ AKTUÃLNY STAV: **ODHLÃSENÃ**`;
Â  Â  Â  Â  statusBox.style.backgroundColor = '#e9f2ff';
Â  Â  Â  Â  statusBox.style.color = '#007bff';
Â  Â  Â  Â  dailySummaryBox.style.display = 'none';
Â  Â  } else {
Â  Â  Â  Â  // Zamestnanec je v prÃ¡ci
Â  Â  Â  Â  if (isCurrentlyOnBreak) {
Â  Â  Â  Â  Â  Â  statusBox.innerHTML = `â˜• AKTUÃLNY STAV: **NA PRESTÃVKE**`;
Â  Â  Â  Â  Â  Â  statusBox.style.backgroundColor = '#ffc107';
Â  Â  Â  Â  Â  Â  statusBox.style.color = '#333';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  statusBox.innerHTML = `ğŸ’» AKTUÃLNY STAV: **V PRÃCI**`;
Â  Â  Â  Â  Â  Â  statusBox.style.backgroundColor = '#d4edda';
Â  Â  Â  Â  Â  Â  statusBox.style.color = '#155724';
Â  Â  Â  Â  }
Â  Â  Â  Â  dailySummaryBox.style.display = 'flex';
Â  Â  Â  Â  updateDailySummary(records);
Â  Â  }
}

// --- FUNKCIA NA VÃPOÄŒET DENNÃ‰HO SUMÃRU ---
function updateDailySummary(records) {
Â  Â  const today = new Date().toISOString().substring(0, 10);
Â  Â Â 
Â  Â  // ZÃ¡znamy pre dneÅ¡nÃ½ deÅˆ
Â  Â  const dailyRecords = records
Â  Â  Â  Â  .filter(r => r.cas.substring(0, 10) === today)
Â  Â  Â  Â  .sort((a, b) => new Date(a.cas) - new Date(b.cas)); // ZoradiÅ¥ od najstarÅ¡ieho pre vÃ½poÄet

Â  Â  let workMs = 0;
Â  Â  let breakMs = 0;
Â  Â  let lastPrichod = null;
Â  Â  let lastBreakStart = null;

Â  Â  dailyRecords.forEach(record => {
Â  Â  Â  Â  const currentTime = new Date(record.cas);

Â  Â  Â  Â  // --- Logika PrestÃ¡vky ---
Â  Â  Â  Â  if (record.stav.startsWith('prestavka')) {
Â  Â  Â  Â  Â  Â  // ZMENA: Kontrola novÃ©ho typu
Â  Â  Â  Â  Â  Â  if (record.stav === 'prestavka prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  lastBreakStart = currentTime;
Â  Â  Â  Â  Â  Â  } else if (record.stav === 'prestavka odchod' && lastBreakStart) {
Â  Â  Â  Â  Â  Â  Â  Â  breakMs += currentTime - lastBreakStart;
Â  Â  Â  Â  Â  Â  Â  Â  lastBreakStart = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Logika PrÃ¡ca ---
Â  Â  Â  Â  if (record.stav === 'prichod') {
Â  Â  Â  Â  Â  Â  lastPrichod = currentTime;
Â  Â  Â  Â  } else if (record.stav === 'odchod' && lastPrichod) {
Â  Â  Â  Â  Â  Â  let duration = currentTime - lastPrichod;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // OdpoÄÃ­taÅ¥ prestÃ¡vku, ak sa zaÄala a skonÄila v rÃ¡mci cyklu prÃ­chod-odchod
Â  Â  Â  Â  Â  Â  const breakRecordsInPeriod = dailyRecords.filter(r => new Date(r.cas) > lastPrichod && new Date(r.cas) < currentTime && r.stav.startsWith('prestavka'));
Â  Â  Â  Â  Â  Â  let tempBreakStart = null;

Â  Â  Â  Â  Â  Â  breakRecordsInPeriod.forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  const bTime = new Date(b.cas);
Â  Â  Â  Â  Â  Â  Â  Â  // ZMENA: Kontrola novÃ©ho typu
Â  Â  Â  Â  Â  Â  Â  Â  if (b.stav === 'prestavka prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempBreakStart = bTime;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (b.stav === 'prestavka odchod' && tempBreakStart) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration -= (bTime - tempBreakStart);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempBreakStart = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (duration > 0) workMs += duration;
Â  Â  Â  Â  Â  Â  lastPrichod = null;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // Ak je zamestnanec aktuÃ¡lne v prÃ¡ci, prirÃ¡tajte Äas od poslednÃ©ho prÃ­chodu
Â  Â  if (lastPrichod) {
Â  Â  Â  Â  let ongoingWork = new Date() - lastPrichod;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ak je aj na prestÃ¡vke, odpoÄÃ­tajte prebiehajÃºcu prestÃ¡vku
Â  Â  Â  Â  if (lastBreakStart) {
Â  Â  Â  Â  Â  Â  ongoingWork -= (new Date() - lastBreakStart);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (ongoingWork > 0) workMs += ongoingWork;
Â  Â  }

Â  Â  // Ak je prebiehajÃºca prestÃ¡vka (zaÄala, ale neskonÄila)
Â  Â  if (lastBreakStart) {
Â  Â  Â  Â  breakMs += (new Date() - lastBreakStart);
Â  Â  }


Â  Â  dailySummaryBox.innerHTML = `
Â  Â  Â  Â  Dnes odpracovanÃ©: <strong>${msToHhMm(workMs)}</strong> |
Â  Â  Â  Â  PrestÃ¡vky: <strong>${msToHhMm(breakMs)}</strong>
Â  Â  `;
}

// --- NaÄÃ­tanie dÃ¡t pouÅ¾Ã­vateÄ¾a z Firebase ---
async function loadUserData() {
Â  Â  try {
Â  Â  Â  Â  const userSnap = await get(ref(db, `users/${userId}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!userSnap.exists()) {
Â  Â  Â  Â  Â  Â  console.error(`Chyba: DÃ¡ta pre UID "${userId}" neboli vo Firebase nÃ¡jdenÃ©!`);
Â  Â  Â  Â  Â  Â  userNameEl.textContent = "(NeznÃ¡my)";
Â  Â  Â  Â  Â  Â  renderTables([]);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const userData = userSnap.val();
Â  Â  Â  Â  userNameEl.textContent = userData.name || "(bez mena)";

Â  Â  Â  Â  const records = [];
Â  Â  Â  Â  const allPossibleLogs = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Zber zÃ¡znamov (z dochadzka, prestavky, pn)
Â  Â  Â  Â  ["dochadzka", "prestavky", "pn"].forEach(type => {
Â  Â  Â  Â  Â  Â  const logsObj = userData[type] || {};
Â  Â  Â  Â  Â  Â  // PridÃ¡me Firebase kÄ¾ÃºÄ pre jednoduchÅ¡iu identifikÃ¡ciu zÃ¡znamu pri duplikÃ¡toch
Â  Â  Â  Â  Â  Â  Object.entries(logsObj).forEach(([key, log]) => {
Â  Â  Â  Â  Â  Â  Â  Â  log.key = key;
Â  Â  Â  Â  Â  Â  Â  Â  allPossibleLogs.push(log);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Spracovanie a normalizÃ¡cia Äasu
Â  Â  Â  Â  allPossibleLogs.forEach(log => {
Â  Â  Â  Â  Â  Â  if (!log || !log.cas || !log.typ) return;

Â  Â  Â  Â  Â  Â  let cleanTime = String(log.cas);
Â  Â  Â  Â  Â  Â  let validIsoTime = cleanTime;
Â  Â  Â  Â  Â  Â  let displayTime = cleanTime;

Â  Â  Â  Â  Â  Â  // Logika normalizÃ¡cie Äasu
Â  Â  Â  Â  Â  Â  // PrispÃ´sobenie pre formÃ¡t YYYY.MM.DD HH:MM z ESP32
Â  Â  Â  Â  Â  Â  const esp32FormatRegex = /(\d{4})\.(\d{1,2})\.(\d{1,2}) (\d{1,2}:\d{1,2})/;
Â  Â  Â  Â  Â  Â  const esp32Match = cleanTime.match(esp32FormatRegex);

Â  Â  Â  Â  Â  Â  if (esp32Match) {
Â  Â  Â  Â  Â  Â  Â  Â  const [full, year, month, day, time] = esp32Match;
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year} ${time}`;
Â  Â  Â  Â  Â  Â  } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
Â  Â  Â  Â  Â  Â  Â  Â  // ISO format (YYYY-MM-DD)
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = cleanTime.replace('T', ' ').substring(0, 16);
Â  Â  Â  Â  Â  Â  Â  Â  const [date, time] = validIsoTime.split(' ');
Â  Â  Â  Â  Â  Â  Â  Â  const [y, m, d] = date.split('-');
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const cleanType = String(log.typ)
Â  Â  Â  Â  Â  Â  Â  Â  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
Â  Â  Â  Â  Â  Â  Â  Â  .toLowerCase();

Â  Â  Â  Â  Â  Â  let recordType = null;

Â  Â  Â  Â  Â  Â  // NOVÃ LOGIKA TYPOV PRESTÃVKY (prestavka prichod/odchod)
Â  Â  Â  Â  Â  Â  if (cleanType.includes('prestavka prichod') || cleanType.includes('prestavka_start') || cleanType === 'prestavka') {
Â  Â  Â  Â  Â  Â  Â  Â  recordType = 'prestavka prichod';
Â  Â  Â  Â  Â  Â  } else if (cleanType.includes('prestavka odchod') || cleanType.includes('prestavka_end')) {
Â  Â  Â  Â  Â  Â  Â  Â  recordType = 'prestavka odchod';
Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  // DochÃ¡dzka (uistÃ­me sa, Å¾e neobsahuje 'prestavka')
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('prichod') && !cleanType.includes('prestavka')) {
Â  Â  Â  Â  Â  Â  Â  Â  recordType = 'prichod';
Â  Â  Â  Â  Â  Â  } else if (cleanType.includes('odchod') && !cleanType.includes('prestavka')) {
Â  Â  Â  Â  Â  Â  Â  Â  recordType = 'odchod';
Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  // PN
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('pn')) {
Â  Â  Â  Â  Â  Â  Â  Â  recordType = 'pn';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (recordType) {
Â  Â  Â  Â  Â  Â  Â  Â  records.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cas: validIsoTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  casDisplay: displayTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stav: recordType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  date: displayTime.substring(0, 10),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  time: displayTime.substring(11, 16),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  key: log.key // Pridanie Firebase kÄ¾ÃºÄa
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Triedenie od najnovÅ¡ieho
Â  Â  Â  Â  records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
Â  Â  Â  Â  allRecordsCache = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // AKTUALIZÃCIA STAVU
Â  Â  Â  Â  updateStatusAndButtons(records);

Â  Â  Â  Â  // Vykreslenie tabuliek
Â  Â  Â  Â  renderTables(allRecordsCache);

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t:", e);
Â  Â  Â  Â  statusBox.innerHTML = "âŒ KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t!";
Â  Â  Â  Â  renderTables([]);
Â  Â  }
}

// --- Vykreslenie tabuliek ---
function renderTables(records) {
Â  Â  const dochadzkaTable = document.getElementById("dochadzkaTable");
Â  Â  const prestavkyTable = document.getElementById("prestavkyTable");
Â  Â  const pnTable = document.getElementById("pnTable");

Â  Â  const filterDochadzka = document.getElementById("dateDochadzka").value;
Â  Â  const filterPrestavky = document.getElementById("datePrestavky").value;
Â  Â  const filterPN = document.getElementById("datePN").value;

Â  Â  const renderSection = (bodyEl, type, filterDate, expectedStav, colCount) => {
Â  Â  Â  Â  let filtered = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(filterDate) {
Â  Â  Â  Â  Â  Â  // Kontrola na formÃ¡t dÃ¡tumu z dÃ¡t (DD.MM.YYYY)
Â  Â  Â  Â  Â  Â  const filterDateDisplay = filterDate.split('-').reverse().join('.');
Â  Â  Â  Â  Â  Â  filtered = filtered.filter(r => r.date === filterDateDisplay);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sectionRecords = filtered.filter(r => expectedStav.some(stav => r.stav.includes(stav)));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!sectionRecords.length) {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = `<tr><td colspan="${colCount}">Å½iadne zÃ¡znamy</td></tr>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = sectionRecords.map(z => {
Â  Â  Â  Â  Â  Â  Â  Â  const displayTime = z.casDisplay;

Â  Â  Â  Â  Â  Â  Â  Â  let statusClass = '';
Â  Â  Â  Â  Â  Â  Â  Â  let stavText = z.stav.toUpperCase();

Â  Â  Â  Â  Â  Â  Â  Â  if (z.stav === 'prichod') statusClass = 'status-prichod';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'odchod') statusClass = 'status-odchod';
Â  Â  Â  Â  Â  Â  Â  Â  // ZMENA: NovÃ© typy prestÃ¡vky
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'prestavka prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusClass = 'status-prestavka-start';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stavText = 'PRESTÃVKA PRICHOD';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'prestavka odchod') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusClass = 'status-prestavka-end';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stavText = 'PRESTÃVKA ODCHOD';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'pn') statusClass = 'status-pn';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'dochadzka') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${displayTime}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status-badge ${statusClass}">${stavText}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${displayTime}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge small ${statusClass}">${stavText}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }).join("");
Â  Â  Â  Â  }
Â  Â  };

Â  Â  renderSection(dochadzkaTable, 'dochadzka', filterDochadzka, ["prichod", "odchod"], 2);
Â  Â  // PrestÃ¡vky zahÅ•ÅˆajÃº vÅ¡etky novÃ© typy prestÃ¡vok
Â  Â  renderSection(prestavkyTable, 'prestavky', filterPrestavky, ["prestavka prichod", "prestavka odchod"], 1);
Â  Â  renderSection(pnTable, 'pn', filterPN, ["pn"], 1);
}

// --- HLAVNÃ FUNKCIA: Export do XLSX ---
window.exportTable = function(sectionType) {
Â  Â  const userName = userNameEl.textContent;
Â  Â  let filterDate, expectedStav, sectionTitle;
Â  Â  let header;
Â  Â  let fileNameBase;

Â  Â  // --- Krok 1: Definovanie filtrov a hlaviÄiek ---
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  filterDate = document.getElementById("dateDochadzka").value;
Â  Â  Â  Â  expectedStav = ["prichod", "odchod"];
Â  Â  Â  Â  sectionTitle = "DochÃ¡dzka (PrÃ­chod/Odchod) a SumarizÃ¡cia";
Â  Â  Â  Â  header = ["DÃ¡tum", "ÄŒas", "Typ", "OdpracovanÃ½ Äas/Status"];
Â  Â  Â  Â  fileNameBase = "dochadzka_sumar";
Â  Â  } else if (sectionType === 'prestavky') {
Â  Â  Â  Â  filterDate = document.getElementById("datePrestavky").value;
Â  Â  Â  Â  // ZMENA: NovÃ© typy prestÃ¡vky
Â  Â  Â  Â  expectedStav = ["prestavka prichod", "prestavka odchod"];
Â  Â  Â  Â  sectionTitle = "PrestÃ¡vky a ich Trvanie";
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ ZÃ¡znamu", "Trvanie PrestÃ¡vky"];
Â  Â  Â  Â  fileNameBase = "prestavky_sumar";
Â  Â  } else if (sectionType === 'pn') {
Â  Â  Â  Â  filterDate = document.getElementById("datePN").value;
Â  Â  Â  Â  expectedStav = ["pn"];
Â  Â  Â  Â  sectionTitle = "PN";
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ"];
Â  Â  Â  Â  fileNameBase = "pn";
Â  Â  } else {
Â  Â  Â  Â  return alert("NeznÃ¡my typ sekcie pre export.");
Â  Â  }
Â  Â Â 
Â  Â  // --- Krok 2: FiltrÃ¡cia a triedenie dÃ¡t pre kalkulÃ¡ciu (od najstarÅ¡ieho) ---
Â  Â  let filteredRecords = allRecordsCache;
Â  Â  if(filterDate) {
Â  Â  Â  Â  // Filtrovanie podÄ¾a DÃ¡tumu (DD.MM.YYYY)
Â  Â  Â  Â  const filterDateDisplay = filterDate.split('-').reverse().join('.');
Â  Â  Â  Â  filteredRecords = filteredRecords.filter(r => r.date === filterDateDisplay);
Â  Â  }
Â  Â Â 
Â  Â  const sortedRecords = filteredRecords
Â  Â  Â  Â  .filter(r => expectedStav.some(stav => r.stav.includes(stav)))
Â  Â  Â  Â  .sort((a, b) => new Date(a.cas) - new Date(b.cas)); // Triedenie od najstarÅ¡ieho

Â  Â  // --- Krok 3: Generovanie dÃ¡tovÃ©ho poÄ¾a a KALKULÃCIA ---
Â  Â  const exportData = [
Â  Â  Â  Â  ["Typ zÃ¡znamu:", sectionTitle],
Â  Â  Â  Â  ["PouÅ¾Ã­vateÄ¾:", userName],
Â  Â  Â  Â  [],
Â  Â  Â  Â  header
Â  Â  ];
Â  Â Â 
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  let totalWorkMs = 0;
Â  Â  Â  Â  let lastPrichod = null;
Â  Â  Â  Â  let lastDate = null;
Â  Â  Â  Â  let dailyWorkMs = 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const breakRecords = allRecordsCache
Â  Â  Â  Â  Â  Â  .filter(r => r.stav.startsWith('prestavka')) // ZMENA
Â  Â  Â  Â  Â  Â  .sort((a, b) => new Date(a.cas) - new Date(b.cas));
Â  Â  Â  Â Â 
Â  Â  Â  Â  let totalBreakMs = 0;


Â  Â  Â  Â  sortedRecords.forEach((record) => {
Â  Â  Â  Â  Â  Â  const currentDateTime = new Date(record.cas);
Â  Â  Â  Â  Â  Â  const currentDateStr = record.date;
Â  Â  Â  Â  Â  Â  const currentTimeStr = record.time;

Â  Â  Â  Â  Â  Â  // --- Logika SumarizÃ¡cie DÅˆa ---
Â  Â  Â  Â  Â  Â  if (lastDate && lastDate !== currentDateStr) {
Â  Â  Â  Â  Â  Â  Â  Â  if (dailyWorkMs > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs = 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (record.stav === 'prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = currentDateTime;
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), ""]);
Â  Â  Â  Â  Â  Â  } else if (record.stav === 'odchod' && lastPrichod) {
Â  Â  Â  Â  Â  Â  Â  Â  let durationMs = currentDateTime - lastPrichod;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let durationBreaks = 0;
Â  Â  Â  Â  Â  Â  Â  Â  let lastBreakStart = null;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  breakRecords.forEach(breakR => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const breakTime = new Date(breakR.cas);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (breakTime > lastPrichod && breakTime < currentDateTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ZMENA: Kontrola novÃ©ho typu
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (breakR.stav === 'prestavka prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastBreakStart = breakTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (breakR.stav === 'prestavka odchod' && lastBreakStart) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  durationBreaks += breakTime - lastBreakStart;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastBreakStart = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  totalBreakMs += durationBreaks;
Â  Â  Â  Â  Â  Â  Â  Â  durationMs -= durationBreaks;

Â  Â  Â  Â  Â  Â  Â  Â  const durationHhMm = msToHhMm(durationMs);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  totalWorkMs += durationMs;
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs += durationMs;

Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), durationHhMm]);
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = null;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // PN zÃ¡znamy sa ignorujÃº, lebo sa majÃº exportovaÅ¥ v sekcii PN
Â  Â  Â  Â  Â  Â  Â  Â  if (record.stav !== 'pn') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), "Chyba PRICHOD/ODCHOD"]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  lastDate = currentDateStr;
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- FinÃ¡lna SumarizÃ¡cia (PoslednÃ½ deÅˆ) ---
Â  Â  Â  Â  if (lastDate && dailyWorkMs > 0) {
Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CelkovÃ¡ SumarizÃ¡cia ---
Â  Â  Â  Â  exportData.push([]);
Â  Â  Â  Â  exportData.push(["CelkovÃ¡ odpracovanÃ¡ doba:", "", "", msToHhMm(totalWorkMs)]);
Â  Â  Â  Â  // ZMENA: CelkovÃ¡ doba prestÃ¡vok by sa mala poÄÃ­taÅ¥ sprÃ¡vne v sekcii prestÃ¡vok
Â  Â  Â  Â  exportData.push(["CelkovÃ¡ doba prestÃ¡vok (odpoÄÃ­tanÃ¡):", "", "", msToHhMm(totalBreakMs)]);


Â  Â  } else if (sectionType === 'prestavky') {
Â  Â  Â  Â  let totalBreakMs = 0;
Â  Â  Â  Â  let lastBreakStart = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  sortedRecords.forEach(record => {
Â  Â  Â  Â  Â  Â  const currentDateTime = new Date(record.cas);
Â  Â  Â  Â  Â  Â  let durationHhMm = "";
Â  Â  Â  Â  Â  Â  let stavText = record.stav.toUpperCase();

Â  Â  Â  Â  Â  Â  // ZMENA: Kontrola novÃ©ho typu
Â  Â  Â  Â  Â  Â  if (record.stav === 'prestavka prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  lastBreakStart = currentDateTime;
Â  Â  Â  Â  Â  Â  Â  Â  stavText = 'PRESTÃVKA PRICHOD';
Â  Â  Â  Â  Â  Â  } else if (record.stav === 'prestavka odchod' && lastBreakStart) {
Â  Â  Â  Â  Â  Â  Â  Â  const durationMs = currentDateTime - lastBreakStart;
Â  Â  Â  Â  Â  Â  Â  Â  durationHhMm = msToHhMm(durationMs);
Â  Â  Â  Â  Â  Â  Â  Â  totalBreakMs += durationMs;
Â  Â  Â  Â  Â  Â  Â  Â  lastBreakStart = null;
Â  Â  Â  Â  Â  Â  Â  Â  stavText = 'PRESTÃVKA ODCHOD';
Â  Â  Â  Â  Â  Â  } else if (record.stav === 'prestavka odchod') {
Â  Â  Â  Â  Â  Â  Â  Â  durationHhMm = "(Chyba: Koniec bez zaÄiatku)";
Â  Â  Â  Â  Â  Â  Â  Â  stavText = 'PRESTÃVKA ODCHOD (Chyba)';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // ZÃ¡pis zÃ¡znamu prestÃ¡vky
Â  Â  Â  Â  Â  Â  exportData.push([record.casDisplay, stavText, durationHhMm]);
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Ak prebieha prestÃ¡vka (chyba), prirÃ¡ta sa
Â  Â  Â  Â  if (lastBreakStart) {
Â  Â  Â  Â  Â  Â  const ongoingMs = new Date() - lastBreakStart;
Â  Â  Â  Â  Â  Â  totalBreakMs += ongoingMs;
Â  Â  Â  Â  Â  Â  exportData.push([
Â  Â  Â  Â  Â  Â  Â  Â  lastBreakStart.toLocaleDateString('sk') + ' ' + lastBreakStart.toLocaleTimeString('sk').substring(0, 5), 
Â  Â  Â  Â  Â  Â  Â  Â  'PRESTÃVKA PRICHOD', 
Â  Â  Â  Â  Â  Â  Â  Â  'StÃ¡le prebieha - Trvanie: ' + msToHhMm(ongoingMs)
Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // CelkovÃ½ sÃºÄet prestÃ¡vok
Â  Â  Â  Â  exportData.push([]);
Â  Â  Â  Â  exportData.push(["CelkovÃ¡ doba prestÃ¡vok:", "", msToHhMm(totalBreakMs)]);


Â  Â  } else if (sectionType === 'pn') {
Â  Â  Â  Â  // PN nemÃ¡ Å¡peciÃ¡lnu kalkulÃ¡ciu, len exportuje dÃ¡ta
Â  Â  Â  Â  sortedRecords.forEach(record => {
Â  Â  Â  Â  Â  Â  exportData.push([record.casDisplay, "PN"]);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- Krok 4: Generovanie a stiahnutie sÃºboru XLSX ---
Â  Â  const ws = XLSX.utils.aoa_to_sheet(exportData);

Â  Â  // Ãšprava Å¡Ã­rky stÄºpcov pre lepÅ¡iu ÄitateÄ¾nosÅ¥
Â  Â  ws['!cols'] = [
Â  Â  Â  Â  { wch: 20 }, // DÃ¡tum a ÄŒas
Â  Â  Â  Â  { wch: 25 }, // Typ
Â  Â  Â  Â  { wch: 25 }, // Trvanie
Â  Â  Â  Â  { wch: 25 }Â  // Status
Â  Â  ];

Â  Â  const wb = XLSX.utils.book_new();
Â  Â  XLSX.utils.book_append_sheet(wb, ws, sectionTitle.substring(0, 31));

Â  Â  const filename = `${userName.toLowerCase().replace(/ /g, '_')}_${fileNameBase}_${filterDate || 'vsetky'}.xlsx`;
Â  Â  XLSX.writeFile(wb, filename);
}


// --- INICIALIZÃCIA ---

// Listener na prepÃ­nanie sekciÃ­
document.querySelectorAll("nav button").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
Â  Â  Â  Â  btn.classList.add("active");
Â  Â  Â  Â  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
Â  Â  Â  Â  document.getElementById(btn.dataset.target).classList.add("active");
Â  Â  Â  Â  // Prekreslenie pri prepnutÃ­ sekcie
Â  Â  Â  Â  renderTables(allRecordsCache); 
Â  Â  });
});

// Filtre spustia renderTables
document.getElementById("dateDochadzka").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePrestavky").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePN").addEventListener("change", () => renderTables(allRecordsCache));

// Listenery pre Export
document.querySelectorAll(".export-btn[data-export-table]").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  exportTable(btn.dataset.exportTable);Â 
Â  Â  });
});

// Listener pre odhlÃ¡senie
document.getElementById("logoutBtn").addEventListener("click", () => {
Â  Â  localStorage.removeItem("uid");
Â  Â  window.location.href = "index.html";
});

// SpustiÅ¥ naÄÃ­tanie dÃ¡t po naÄÃ­tanÃ­ strÃ¡nky
loadUserData();
setInterval(() => {
    // OpakovanÃ© volanie loadUserData kvÃ´li aktualizÃ¡cii statusu (V PRÃCI/ODHLÃSENÃ)
    if (document.querySelector('section.active').id === 'dochadzka') {
        updateStatusAndButtons(allRecordsCache);
    }
}, 30000); // Kontrola kaÅ¾dÃ½ch 30 sekÃºnd pre aktuÃ¡lny status.

</script>
</body>
</html>
