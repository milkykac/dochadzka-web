<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doch√°dzka ‚Äì Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f4f5f7;
  --text: #333;
  --card: #fff;
  --accent: #3e4e88;
  --border: #ccc;
  --prichod: #4caf50;
  --odchod: #dc3545;
  --prestavka: #ff9800;
  --pn: #9c27b0;
}
[data-theme="dark"] {
  --bg: #1f1f2e;
  --text: #eee;
  --card: #2a2b3d;
  --accent: #6699ff;
  --border: #444;
  --prichod: #39e639;
  --odchod: #ff6b6b;
  --prestavka: #ffa500;
  --pn: #ad8ee0;
}

body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: background 0.3s, color 0.3s;
}

header {
  width: 100%;
  background: var(--card);
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}

header h1 { 
  color: var(--accent);
  font-weight: 500;
  font-size: 22px;
  margin: 0;
}

header button {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  margin-left: 10px;
  cursor: pointer;
  transition: 0.3s;
}
header button:hover { background: #2b3a67; }

.container {
  max-width: 800px;
  width: 90%;
  background: var(--card);
  margin: 30px auto;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  transition: background 0.3s, color 0.3s;
}

h2 {
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
  padding-bottom: 6px;
  margin-top: 0;
}

.filter {
  margin: 15px 0;
  text-align: left;
}
.filter input {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  width: 150px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 15px;
}
th, td {
  border: 1px solid var(--border);
  padding: 10px;
  text-align: center;
}
th {
  background: var(--accent);
  color: white;
  font-weight: 500;
}
tr:nth-child(even) { background: rgba(0,0,0,0.03); }

.status-prichod { color: var(--prichod); font-weight: 600; }
.status-odchod { color: var(--odchod); font-weight: 600; }
.status-prestavka { color: var(--prestavka); font-weight: 600; }
.status-pn { color: var(--pn); font-weight: 600; }

.dark-toggle {
  background: none;
  color: var(--accent);
  border: 1px solid var(--accent);
  padding: 6px 10px;
  border-radius: 8px;
  margin-right: 5px;
}
  .dark-toggle:hover {
    background: var(--accent);
    color: white;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <h1>üëã Vitaj, <span id="userName">Zamestnanec</span></h1>
  <div>
    <button id="darkModeBtn" class="dark-toggle">üåô Dark mode</button>
    <button id="logoutBtn">Odhl√°si≈• sa</button>
  </div>
</header>

<div class="container">
  <h2>üìÖ Moja doch√°dzka</h2>
  <button onclick="exportMyData()">Export do Excel</button>
  <div class="filter">
    <label for="filterDate">Filtrova≈• podƒæa d√°tumu:</label>
    <input type="date" id="filterDate">
  </div>

  <h3>Doch√°dzka (Pr√≠chod / Odchod)</h3>
  <table>
    <thead>
      <tr><th>ƒåas</th><th>Stav</th></tr>
    </thead>
    <tbody id="myAttendanceBody">
      <tr><td colspan="2">Naƒç√≠tavam √∫daje...</td></tr>
    </tbody>
  </table>

  <h3>Prest√°vky</h3>
  <table>
    <thead>
      <tr><th>ƒåas</th></tr>
    </thead>
    <tbody id="myBreaksBody">
      <tr><td>≈Ωiadne prest√°vky</td></tr>
    </tbody>
  </table>

  <h3>PN</h3>
  <table>
    <thead>
      <tr><th>ƒåas</th></tr>
    </thead>
    <tbody id="myPNBody">
      <tr><td>≈Ωiadne PN</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain:"dochadzkaesp32.firebaseapp.com",
  databaseURL:"https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"dochadzkaesp32",
  storageBucket:"dochadzkaesp32.firebasestorage.app",
  messagingSenderId:"417668021105",
  appId:"1:417668021105:web:7fa3e144892d8b304854d0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const userId = localStorage.getItem("uid");
if(!userId){
  alert("Nie si prihl√°sen√Ω!");
  window.location.href = "index.html";
}

const myAttendanceBody = document.getElementById("myAttendanceBody");
const myBreaksBody = document.getElementById("myBreaksBody");
const myPNBody = document.getElementById("myPNBody");
const userNameEl = document.getElementById("userName");
const filterDate = document.getElementById("filterDate");

let allRecords = [];

get(ref(db, "users/" + userId)).then(snapshot => {
  if (!snapshot.exists()) {
    alert("Pou≈æ√≠vateƒæ nen√°jden√Ω!");
    window.location.href = "index.html";
    return;
  }
  const userData = snapshot.val();
  userNameEl.textContent = userData.name;
  const chipUid = userData.chipUid;

  onValue(ref(db, "dochadzka/" + chipUid), snap => {
    myAttendanceBody.innerHTML = "";
    myBreaksBody.innerHTML = "";
    myPNBody.innerHTML = "";
    allRecords = [];
    if (!snap.exists()) {
      myAttendanceBody.innerHTML = "<tr><td colspan='2'>≈Ωiadne z√°znamy</td></tr>";
      myBreaksBody.innerHTML = "<tr><td>≈Ωiadne prest√°vky</td></tr>";
      myPNBody.innerHTML = "<tr><td>≈Ωiadne PN</td></tr>";
      return;
    }
    snap.forEach(childSnap => {
      if (childSnap.key === "posledny_stav") return;
      const z = childSnap.val();
      allRecords.push(z);
    });
    renderTables();
  });
});

function renderTables() {
  myAttendanceBody.innerHTML = "";
  myBreaksBody.innerHTML = "";
  myPNBody.innerHTML = "";

  let filtered = allRecords;
  const selectedDate = filterDate.value;
  if (selectedDate) filtered = filtered.filter(r => r.cas.startsWith(selectedDate));

  const attendance = filtered.filter(r => r.stav === "PRICHOD" || r.stav === "ODCHOD");
  const breaks = filtered.filter(r => r.stav === "PRESTAVKA");
  const pn = filtered.filter(r => r.stav === "PN");

  if (!attendance.length) myAttendanceBody.innerHTML = "<tr><td colspan='2'>≈Ωiadne z√°znamy</td></tr>";
  else attendance.reverse().forEach(z => {
    const statusClass = z.stav.toLowerCase() === "prichod" ? "status-prichod" : "status-odchod";
    const row = document.createElement("tr");
    row.innerHTML = `<td>${z.cas}</td><td class="${statusClass}">${z.stav}</td>`;
    myAttendanceBody.appendChild(row);
  });

  if (!breaks.length) myBreaksBody.innerHTML = "<tr><td>≈Ωiadne prest√°vky</td></tr>";
  else breaks.reverse().forEach(z => {
    const row = document.createElement("tr");
    row.innerHTML = `<td class="status-prestavka">${z.cas}</td>`;
    myBreaksBody.appendChild(row);
  });

  if (!pn.length) myPNBody.innerHTML = "<tr><td>≈Ωiadne PN</td></tr>";
  else pn.reverse().forEach(z => {
    const row = document.createElement("tr");
    row.innerHTML = `<td class="status-pn">${z.cas}</td>`;
    myPNBody.appendChild(row);
  });
}

filterDate.addEventListener("change", renderTables);

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("uid");
  window.location.href = "index.html";
});

const darkBtn = document.getElementById("darkModeBtn");
darkBtn.addEventListener("click", () => {
  const isDark = document.body.getAttribute("data-theme") === "dark";
  document.body.setAttribute("data-theme", isDark ? "" : "dark");
  darkBtn.textContent = isDark ? "üåô Dark mode" : "‚òÄÔ∏è Light mode";
});

// üìä Export do Excel pre zamestnanca
function exportMyData() {
  const userName = document.getElementById("userName").textContent;
  const data = [
    ["Zamestnanec", userName],
    [],
    ["Doch√°dzka (Pr√≠chod / Odchod)"],
    ["ƒåas", "Stav"],
    ...Array.from(document.querySelectorAll("#myAttendanceBody tr")).map(tr => {
      const tds = tr.querySelectorAll("td");
      return tds.length ? [tds[0].textContent, tds[1].textContent] : [];
    }),
    [],
    ["Prest√°vky"],
    ["ƒåas"],
    ...Array.from(document.querySelectorAll("#myBreaksBody tr")).map(tr => {
      const tds = tr.querySelectorAll("td");
      return tds.length ? [tds[0].textContent] : [];
    }),
    [],
    ["PN"],
    ["ƒåas"],
    ...Array.from(document.querySelectorAll("#myPNBody tr")).map(tr => {
      const tds = tr.querySelectorAll("td");
      return tds.length ? [tds[0].textContent] : [];
    })
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Moja Doch√°dzka");
  XLSX.writeFile(wb, `Dochadzka_${userName}.xlsx`);
}
</script>
</body>
</html>


