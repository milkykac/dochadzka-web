<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DochÃ¡dzka â€“ Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOSÃšLADENÃ‰ Å TÃLY S ADMIN PANELOM A VIZUÃLNYM NÃVRHOM --- */
body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    /* NOVÃ‰: JemnÃ½ gradient s tmavÅ¡ou modrou */
    background: linear-gradient(135deg, #0f4c81, #0c2a4e);
    min-height: 100vh;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 50px; /* Pre mobilnÃ© zariadenia */
}

header {
    background: #007bff;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    width: 100%;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    box-sizing: border-box; /* ZahrnÃºÅ¥ padding do Å¡Ã­rky */
}

h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
}

header button {
    background: #fff;
    border: none;
    color: #007bff;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

header button:hover {
    background: #e2e6ea;
    transform: translateY(-1px);
}

nav {
    background: #fff;
    display: flex;
    justify-content: center;
    padding: 10px;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: relative; /* ZmenenÃ© na relative, ak nie je potrebnÃ© sticky */
    top: 0; /* UpravenÃ© */
    z-index: 5;
    flex-wrap: wrap;
    width: 95%; /* ZmenenÃ© na percentÃ¡ */
    max-width: 1100px;
    border-radius: 0 0 12px 12px;
    margin-top: 20px; /* PridanÃ© pre medzeru pod headerom */
}

nav button {
    background: #f0f0f0; /* JemnÃ© pozadie pre neaktÃ­vne */
    border: none;
    color: #333; /* TmavÅ¡Ã­ text */
    padding: 10px 18px; /* VÃ¤ÄÅ¡Ã­ padding */
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px; /* VÃ¤ÄÅ¡Ã­ font */
    font-weight: 600;
    transition: 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

nav button.active {
    background: #007bff; /* ModrÃ¡ pre aktÃ­vnu */
    color: white;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3); /* JemnÃ½ tieÅˆ */
}

nav button:hover:not(.active) {
    background: #e0e0e0;
    transform: translateY(-1px);
}

section {
    display: none;
    padding: 30px; /* VÃ¤ÄÅ¡Ã­ padding */
    background: #fff;
    margin: 25px auto;
    border-radius: 12px;
    max-width: 1100px;
    width: 95%;
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15); /* VÃ½raznejÅ¡Ã­ tieÅˆ */
    transition: 0.3s;
}

section.active {
    display: block;
}

h2 {
    color: #007bff;
    margin-top: 0;
    border-bottom: 2px solid #e0e0e0; /* JemnejÅ¡ia linka */
    padding-bottom: 10px; /* VÃ¤ÄÅ¡Ã­ padding */
    font-weight: 600;
    font-size: 20px;
    margin-bottom: 25px; /* VÃ¤ÄÅ¡ia medzera pod h2 */
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px; /* VÃ¤ÄÅ¡ia medzera */
    border-radius: 10px; /* ZaoblenÃ© rohy tabuÄ¾ky */
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); /* JemnÃ½ tieÅˆ tabuÄ¾ky */
}

th,
td {
    border: 1px solid #eee; /* JemnejÅ¡ie orÃ¡movanie */
    padding: 12px 10px; /* VÃ¤ÄÅ¡Ã­ padding */
    text-align: center;
    font-size: 14px;
    color: #333;
}

th {
    background: #007bff;
    color: white;
    font-weight: 600;
    padding: 15px 10px; /* VÃ¤ÄÅ¡Ã­ padding pre hlaviÄku */
}

tr:nth-child(even) {
    background: #f8f9fa;
}

tr:hover {
    background: #f0f0f0; /* Hover efekt na riadky */
}

/* TlaÄidlÃ¡ pre export */
.export-btn {
    margin-top: 15px;
    background: #28a745;
    border: none;
    color: white;
    border-radius: 8px;
    padding: 10px 18px; /* VÃ¤ÄÅ¡Ã­ padding */
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.export-btn:hover {
    background: #1e7e34;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.export-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Status box je teraz modrÃ½, aby sa hodil k tÃ©me */
.status-box {
    background: #e9f2ff;
    color: #007bff;
    font-weight: 600;
    padding: 18px; /* VÃ¤ÄÅ¡Ã­ padding */
    border-radius: 10px; /* ZaoblenejÅ¡ie rohy */
    text-align: center;
    margin-bottom: 25px; /* VÃ¤ÄÅ¡ia medzera */
    border: 1px solid #a8d4ff; /* JemnejÅ¡Ã­ rÃ¡mik */
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
}
/* NOVÃ: Stav PN je vÃ½raznejÅ¡Ã­ */
.status-box.pn-active {
    background: #6f42c1;
    color: white;
    border-color: #5a3699;
    box-shadow: 0 2px 8px rgba(111, 66, 193, 0.2);
}

/* NOVÃ: DennÃ½ sumÃ¡r box */
.daily-summary-box {
    background: #d4edda;
    color: #155724;
    font-weight: 600;
    padding: 18px;
    border-radius: 10px;
    text-align: center;
    margin-top: 20px; /* Medzera od akÄnÃ½ch tlaÄidiel */
    margin-bottom: 25px; /* Medzera pred H2 */
    border: 1px solid #c3e6cb;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
    display: flex; /* PouÅ¾itie flexboxu */
    justify-content: center; /* Centrovanie obsahu */
    align-items: center;
    gap: 15px; /* Medzera medzi prvkami */
    font-size: 1.1em;
}
.daily-summary-box strong {
    color: #007bff; /* ModrÃ¡ pre Äasy */
}


.filter {
    margin-top: 20px;
    margin-bottom: 20px; /* PridanÃ¡ medzera */
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap; /* Pre mobilnÃ© zariadenia */
}

.filter label {
    font-weight: 600;
    color: #555;
    white-space: nowrap; /* Aby sa "FiltrovaÅ¥ podÄ¾a dÃ¡tumu" nerozdelilo */
}

.filter input[type="date"],
.filter select {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    color: #333;
    transition: border-color 0.3s, box-shadow 0.3s;
    flex-grow: 1; /* Aby sa input natiahol */
    max-width: 200px;
}

.filter input[type="date"]:focus,
.filter select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    outline: none;
}

#debugUid {
    background: #d1ecf1;
    color: #0c5460;
    padding: 8px; /* VÃ¤ÄÅ¡Ã­ padding */
    text-align: center;
    font-size: 13px; /* VÃ¤ÄÅ¡Ã­ font */
    margin-bottom: 15px; /* VÃ¤ÄÅ¡ia medzera */
    border-radius: 6px;
    width: 95%; /* ZmenenÃ© na percentÃ¡ */
    max-width: 1100px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
    margin-top: 20px;
}

/* --- AKÄŒNÃ‰ TLAÄŒIDLÃ pre DochÃ¡dzku (NOVÃ‰) --- */
.action-buttons {
    margin-bottom: 25px;
    display: flex;
    gap: 12px; /* VÃ¤ÄÅ¡ia medzera */
    justify-content: center;
    flex-wrap: wrap;
}

.action-buttons .export-btn { /* VyuÅ¾Ã­vame Å¡tÃ½l .export-btn, ale s farebnÃ½mi Ãºpravami */
    padding: 12px 22px; /* VÃ¤ÄÅ¡Ã­ padding pre akÄnÃ© tlaÄidlÃ¡ */
    font-size: 16px;
    display: flex !important; /* VÅ¾dy flex pre ikony */
    align-items: center;
    gap: 8px; /* Medzera medzi ikonou a textom */
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.action-buttons .export-btn:hover {
    transform: translateY(-3px); /* VÃ½raznejÅ¡Ã­ hover */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

#btnPrichod { background: #28a745; border-color: #218838; } /* ZelenÃ¡ */
#btnPrichod:hover { background: #218838; }
#btnOdchod { background: #dc3545; border-color: #c82333; } /* ÄŒervenÃ¡ */
#btnOdchod:hover { background: #c82333; }
#btnPrestavkaStart { background: #ffc107; color: #333; border-color: #e0a800; } /* Å½ltÃ¡ */
#btnPrestavkaStart:hover { background: #e0a800; }
#btnPrestavkaEnd { background: #0dcaf0; color: #333; border-color: #0aa3c2; } /* Cyan */
#btnPrestavkaEnd:hover { background: #0aa3c2; }
/* ZakÃ¡zanÃ© tlaÄidlÃ¡ */
.action-buttons .export-btn[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}


/* --- Å TÃLY PRE FAREBNÃ‰ PILULKY (ODZNAKY) --- */
.status-badge {
    font-weight: 700 !important;
    padding: 8px 16px !important; /* VÃ¤ÄÅ¡Ã­ padding */
    border-radius: 50px !important; /* Tvar pilulky */
    display: inline-flex; /* Pre lepÅ¡ie zarovnanie */
    align-items: center;
    justify-content: center;
    min-width: 90px; /* VÃ¤ÄÅ¡ia minimÃ¡lna Å¡Ã­rka */
    white-space: nowrap;
    text-shadow: none !important;
    color: white !important;
    font-size: 13px !important; /* Trochu menÅ¡Ã­ font pre pilulky */
    letter-spacing: 0.5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.status-badge.small {
    padding: 5px 12px !important; /* MenÅ¡Ã­ padding pre small pilulky */
    min-width: 70px;
    font-size: 11px !important;
    margin-left: 10px;
}

.status-prichod {
    background: #198754 !important;
}

.status-odchod {
    background: #dc3545 !important;
}

.status-prestavka-start,
.status-prestavka {
    background: #ffc107 !important;
    color: #212529 !important;
}

.status-prestavka-end {
    background: #0dcaf0 !important;
    color: #212529 !important;
}

.status-pn {
    background: #6f42c1 !important;
}

/* --- RESPONZÃVNE ÃšPRAVY --- */
@media (max-width: 768px) {
    header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    nav {
        flex-direction: column;
        align-items: stretch;
        border-radius: 12px;
    }
    nav button {
        width: 100%;
        margin-bottom: 5px;
    }
    .action-buttons {
        flex-direction: column;
        align-items: stretch;
    }
    .action-buttons .export-btn {
        width: 100%;
    }
    .filter {
        flex-direction: column;
        align-items: stretch;
    }
    .filter input[type="date"] {
        max-width: 100%;
    }
    section {
        padding: 20px;
    }
    h2 {
        font-size: 18px;
    }
    th, td {
        padding: 8px 5px;
        font-size: 12px;
    }
    .status-badge {
        min-width: 70px;
        padding: 6px 10px !important;
        font-size: 11px !important;
    }
    .status-badge.small {
        min-width: 50px;
        font-size: 9px !important;
        padding: 3px 8px !important;
    }
    .daily-summary-box {
        flex-direction: column;
        gap: 8px;
        font-size: 1em;
    }
}
</style>
</head>
<body>

<header>
Â  Â  <h1>ğŸ‘‹ Vitaj, <span id="userName">Zamestnanec</span></h1>
Â  Â  <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> OdhlÃ¡siÅ¥ sa</button>
</header>

<div id="debugUid">NaÄÃ­tavam UID...</div>

<nav>
Â  Â  <button data-target="dochadzka" class="active"><i class="fas fa-clock"></i> DochÃ¡dzka</button>
Â  Â  <button data-target="prestavky"><i class="fas fa-mug-hot"></i> PrestÃ¡vky</button>
Â  Â  <button data-target="pn"><i class="fas fa-hospital-alt"></i> PN</button>
</nav>

<section id="dochadzka" class="active">
Â  Â  <div id="statusBox" class="status-box">NaÄÃ­tavam stav...</div>
Â  Â  
Â  Â  <div class="action-buttons">
Â  Â  Â  Â  <button id="btnPrichod" class="export-btn" style="display: none;"><i class="fas fa-sign-in-alt"></i> PRÃCHOD</button>
Â  Â  Â  Â  <button id="btnOdchod" class="export-btn" style="display: none;"><i class="fas fa-sign-out-alt"></i> ODCHOD</button>
Â  Â  Â  Â  <button id="btnPrestavkaStart" class="export-btn" style="display: none;"><i class="fas fa-coffee"></i> ZAÄŒAÅ¤ PRESTÃVKU</button>
Â  Â  Â  Â  <button id="btnPrestavkaEnd" class="export-btn" style="display: none;"><i class="fas fa-play"></i> UKONÄŒIÅ¤ PRESTÃVKU</button>
Â  Â  </div>

    <div id="dailySummaryBox" class="daily-summary-box" style="display: none;"></div>

Â  Â  <h2>DochÃ¡dzka (PrÃ­chod/Odchod)</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <button class="export-btn" data-export-table="dochadzka"><i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX (SumÃ¡r)</button>
        <div class="filter">
            <label for="dateDochadzka">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
            <input type="date" id="dateDochadzka">
        </div>
    </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas</th><th>Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="dochadzkaTable"><tr><td colspan="2">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="prestavky">
Â  Â  <h2>PrestÃ¡vky</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
Â  Â      <button class="export-btn" data-export-table="prestavky"><i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX (SumÃ¡r)</button>
        <div class="filter">
Â  Â          <label for="datePrestavky">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â          <input type="date" id="datePrestavky">
        </div>
    </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="prestavkyTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="pn">
Â  Â  <h2>PN (PrÃ¡ceneschopnosÅ¥)</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
Â  Â      <button class="export-btn" data-export-table="pn"><i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX</button>
        <div class="filter">
Â  Â          <label for="datePN">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â          <input type="date" id="datePN">
        </div>
    </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="pnTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
Â  Â  authDomain: "maturita-395fd.firebaseapp.com",
Â  Â  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
Â  Â  projectId: "maturita-395fd",
Â  Â  storageBucket: "maturita-395fd.firebasestorage.app",
Â  Â  messagingSenderId: "754745500563",
Â  Â  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
Â  Â  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// GlobÃ¡lne premennÃ©
const userId = localStorage.getItem("uid");
const userNameEl = document.getElementById("userName");
const statusBox = document.getElementById("statusBox");
const dailySummaryBox = document.getElementById("dailySummaryBox");
const debugUidEl = document.getElementById("debugUid");Â 
let allRecordsCache = []; // ZÃ¡sobnÃ­k vÅ¡etkÃ½ch zÃ¡znamov
let currentLogStatus = {}; // NOVÃ‰: Pre uchovanie aktuÃ¡lneho stavu

// --- Overenie a presmerovanie ---
if (!userId) {
Â  Â  alert("Nie si prihlÃ¡senÃ½!");
Â  Â  window.location.href = "index.html";
} else if (userId === "admin") {
Â  Â  window.location.href = "admin.html";
} else {
Â  Â  debugUidEl.textContent = `AktuÃ¡lne naÄÃ­tanÃ© UID: ${userId}`;
}

// --- POMOCNÃ‰ FUNKCIE ---

// Konverzia milisekÃºnd na formÃ¡t HH:MM
function msToHhMm(ms) {
Â  Â  if (ms < 0) return "00:00";
Â  Â  const totalMinutes = Math.floor(ms / (1000 * 60));
Â  Â  const hours = Math.floor(totalMinutes / 60);
Â  Â  const minutes = totalMinutes % 60;
Â  Â  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// ZÃ­skanie formÃ¡tovanÃ©ho Äasu pre zÃ¡pis
function getFormattedTime() {
    const now = new Date();
    // YYYY-MM-DD HH:MM format pre konzistentnÃ© triedenie/filtrovanie
    const datePart = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const timePart = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    return `${datePart} ${timePart}`;
}

// --- FUNKCIA PRE ZÃPIS NOVÃ‰HO ZÃZNAMU ---
async function writeLog(type) {
    if (!userId) return;

    try {
        let dbPath;
        if (type.includes('prichod') || type.includes('odchod')) {
            dbPath = `users/${userId}/dochadzka`;
        } else if (type.includes('prestavka')) {
            dbPath = `users/${userId}/prestavky`;
        } else if (type.includes('pn')) {
            dbPath = `users/${userId}/pn`;
        } else {
            throw new Error("NeznÃ¡my typ zÃ¡znamu.");
        }

        const casValue = getFormattedTime();
        
        // ZÃ¡pis do Firebase
        await push(ref(db, dbPath), {
            cas: casValue,
            typ: type
        });
        
        // Zobrazenie Ãºspechu
        statusBox.innerHTML = `âœ… ÃšspeÅ¡ne zaznamenanÃ©: **${type.replace('_', ' ').toUpperCase()}** o ${casValue.substring(11, 16)}`;
        statusBox.style.backgroundColor = '#d4edda'; // ZelenÃ¡ pre Ãºspech
        statusBox.style.color = '#155724';
        statusBox.classList.remove('pn-active'); // OdstrÃ¡niÅ¥ PN Å¡tÃ½l
        
        // OpÃ¤tovnÃ© naÄÃ­tanie dÃ¡t
        await loadUserData();
    } catch (e) {
        console.error("Chyba pri zÃ¡pise do DB:", e);
        statusBox.innerHTML = `âŒ Chyba pri zÃ¡pise ${type}: **${e.message}**`;
        statusBox.style.backgroundColor = '#f8d7da'; // ÄŒervenÃ¡ pre chybu
        statusBox.style.color = '#721c24';
        statusBox.classList.remove('pn-active'); // OdstrÃ¡niÅ¥ PN Å¡tÃ½l
    }
}

// --- Logika aktualizÃ¡cie stavu a tlaÄidiel ---
function updateStatusAndButtons(records) {
    const btnPrichod = document.getElementById("btnPrichod");
    const btnOdchod = document.getElementById("btnOdchod");
    const btnPrestavkaStart = document.getElementById("btnPrestavkaStart");
    const btnPrestavkaEnd = document.getElementById("btnPrestavkaEnd");

    // SkryÅ¥ vÅ¡etky tlaÄidlÃ¡ na zaÄiatku a povoliÅ¥ ich
    [btnPrichod, btnOdchod, btnPrestavkaStart, btnPrestavkaEnd].forEach(b => {
        b.style.display = 'none';
        b.disabled = false;
    });

    // NÃ¡jdite najnovÅ¡Ã­ stav PN
    // PN zÃ¡znamy sÃº oddelenÃ©, ale majÃº vplyv na akcie
    const lastPNRecord = records.filter(r => r.stav === 'pn').sort((a,b) => new Date(b.cas) - new Date(a.cas))[0];
    if (lastPNRecord) {
        // Kontrola, Äi je poslednÃ½ zÃ¡znam PN z dneÅ¡nÃ©ho alebo predchÃ¡dzajÃºceho dÅˆa a nemÃ¡ nasledujÃºci zÃ¡znam
        // ZjednoduÅ¡enÃ¡ logika: Ak existuje nejakÃ½ zÃ¡znam PN, predpokladÃ¡me, Å¾e je platnÃ½ pre aktuÃ¡lny deÅˆ
        statusBox.innerHTML = `âš ï¸ AKTUÃLNY STAV: **PN**`;
        statusBox.classList.add('pn-active');
        dailySummaryBox.style.display = 'none';
        return; 
    }
    statusBox.classList.remove('pn-active');


    // NÃ¡jdite najnovÅ¡Ã­ hlavnÃ½ stav (prÃ­chod/odchod) pre aktuÃ¡lny deÅˆ
    const today = new Date().toISOString().substring(0, 10);
    const mainLogsToday = records.filter(r => r.cas.substring(0, 10) === today && (r.stav === 'prichod' || r.stav === 'odchod'))
                                 .sort((a, b) => new Date(b.cas) - new Date(a.cas));
    const lastMainLogToday = mainLogsToday[0];
    const isCurrentlyIn = lastMainLogToday && lastMainLogToday.stav === 'prichod';

    // NÃ¡jdite najnovÅ¡Ã­ stav prestÃ¡vky pre aktuÃ¡lny deÅˆ
    const breakLogsToday = records.filter(r => r.cas.substring(0, 10) === today && r.stav.includes('prestavka'))
                                  .sort((a, b) => new Date(b.cas) - new Date(a.cas));
    const lastBreakLogToday = breakLogsToday[0];
    const isCurrentlyOnBreak = lastBreakLogToday && (lastBreakLogToday.stav === 'prestavka_start' || lastBreakLogToday.stav === 'prestavka');


    if (!isCurrentlyIn) {
        // Zobrazenie: PRÃCHOD
        btnPrichod.style.display = 'flex';
        statusBox.innerHTML = `ğŸ˜´ AKTUÃLNY STAV: **ODHLÃSENÃ**`;
        statusBox.style.backgroundColor = '#e9f2ff';
        statusBox.style.color = '#007bff';
        dailySummaryBox.style.display = 'none';
    } else {
        // Zamestnanec je v prÃ¡ci
        btnOdchod.style.display = 'flex';

        if (isCurrentlyOnBreak) {
            // Zobrazenie: UKONÄŒIÅ¤ PRESTÃVKU
            btnPrestavkaEnd.style.display = 'flex';
            statusBox.innerHTML = `â˜• AKTUÃLNY STAV: **NA PRESTÃVKE**`;
            statusBox.style.backgroundColor = '#ffc107';
            statusBox.style.color = '#333';
            btnOdchod.disabled = true; // NemÃ´Å¾e odÃ­sÅ¥, kÃ½m neukonÄÃ­ prestÃ¡vku
        } else {
            // Zobrazenie: ZAÄŒAÅ¤ PRESTÃVKU, ODCHOD
            btnPrestavkaStart.style.display = 'flex';
            statusBox.innerHTML = `ğŸ’» AKTUÃLNY STAV: **V PRÃCI**`;
            statusBox.style.backgroundColor = '#d4edda';
            statusBox.style.color = '#155724';
        }
        dailySummaryBox.style.display = 'flex'; // ZobraziÅ¥ dennÃ½ sumÃ¡r
        updateDailySummary(records); // AktualizÃ¡cia dennÃ©ho sumÃ¡ru
    }
}

// --- FUNKCIA NA VÃPOÄŒET DENNÃ‰HO SUMÃRU ---
function updateDailySummary(records) {
    const today = new Date().toISOString().substring(0, 10); // YYYY-MM-DD
    
    // ZÃ¡znamy pre dneÅ¡nÃ½ deÅˆ
    const dailyRecords = records
        .filter(r => r.cas.substring(0, 10) === today)
        .sort((a, b) => new Date(a.cas) - new Date(b.cas));

    let workMs = 0;
    let breakMs = 0;
    let lastPrichod = null;
    let lastBreakStart = null;

    dailyRecords.forEach(record => {
        const currentTime = new Date(record.cas);

        // --- Logika PrestÃ¡vky ---
        if (record.stav.includes('prestavka')) {
            if (record.stav === 'prestavka_start' || record.stav === 'prestavka') {
                lastBreakStart = currentTime;
            } else if (record.stav === 'prestavka_end' && lastBreakStart) {
                breakMs += currentTime - lastBreakStart;
                lastBreakStart = null;
            }
        }
        
        // --- Logika PrÃ¡ca ---
        if (record.stav === 'prichod') {
            lastPrichod = currentTime;
        } else if (record.stav === 'odchod' && lastPrichod) {
            let duration = currentTime - lastPrichod;
            
            // OdpoÄÃ­taÅ¥ prestÃ¡vku, ak sa zaÄala a skonÄila v rÃ¡mci cyklu prÃ­chod-odchod
            const breakRecordsInPeriod = dailyRecords.filter(r => new Date(r.cas) > lastPrichod && new Date(r.cas) < currentTime && r.stav.includes('prestavka'));
            let tempBreakStart = null;

            breakRecordsInPeriod.forEach(b => {
                const bTime = new Date(b.cas);
                if (b.stav.includes('start') || b.stav === 'prestavka') {
                    tempBreakStart = bTime;
                } else if (b.stav.includes('end') && tempBreakStart) {
                    duration -= (bTime - tempBreakStart); // OdpoÄÃ­taÅ¥ trvanie konkrÃ©tnej prestÃ¡vky
                    tempBreakStart = null;
                }
            });

            if (duration > 0) workMs += duration;
            lastPrichod = null;
        }
    });

    // Ak je zamestnanec aktuÃ¡lne v prÃ¡ci, prirÃ¡tajte Äas od poslednÃ©ho prÃ­chodu
    if (lastPrichod) {
        let ongoingWork = new Date() - lastPrichod;
        
        // Ak je aj na prestÃ¡vke, odpoÄÃ­tajte prebiehajÃºcu prestÃ¡vku
        if (lastBreakStart) {
            ongoingWork -= (new Date() - lastBreakStart);
        }
        
        if (ongoingWork > 0) workMs += ongoingWork;
    }

    // Ak je prebiehajÃºca prestÃ¡vka (zaÄala, ale neskonÄila)
    if (lastBreakStart) {
        breakMs += (new Date() - lastBreakStart);
    }


    dailySummaryBox.innerHTML = `
        Dnes odpracovanÃ©: <strong>${msToHhMm(workMs)}</strong> | 
        PrestÃ¡vky: <strong>${msToHhMm(breakMs)}</strong>
    `;
}

// --- NaÄÃ­tanie dÃ¡t pouÅ¾Ã­vateÄ¾a z Firebase ---
async function loadUserData() {
Â  Â  try {
Â  Â  Â  Â  const userSnap = await get(ref(db, `users/${userId}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!userSnap.exists()) {
Â  Â  Â  Â  Â  Â  console.error(`Chyba: DÃ¡ta pre UID "${userId}" neboli vo Firebase nÃ¡jdenÃ©!`);
Â  Â  Â  Â  Â  Â  userNameEl.textContent = "(NeznÃ¡my)";
Â  Â  Â  Â  Â  Â  // ... (chybovÃ© hlÃ¡senie)
Â  Â  Â  Â  Â  Â  renderTables([]);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const userData = userSnap.val();
Â  Â  Â  Â  userNameEl.textContent = userData.name || "(bez mena)";

Â  Â  Â  Â  const records = [];
Â  Â  Â  Â  const allPossibleLogs = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Zber zÃ¡znamov (z dochadzka, prestavky, pn)
Â  Â  Â  Â  ["dochadzka", "prestavky", "pn"].forEach(type => {
Â  Â  Â  Â  Â  Â  const logsObj = userData[type] || {};
Â  Â  Â  Â  Â  Â  Object.values(logsObj).forEach(log => allPossibleLogs.push(log));
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Spracovanie a normalizÃ¡cia Äasu
Â  Â  Â  Â  allPossibleLogs.forEach(log => {
Â  Â  Â  Â  Â  Â  if (!log || !log.cas || !log.typ) return;

Â  Â  Â  Â  Â  Â  let cleanTime = String(log.cas);
Â  Â  Â  Â  Â  Â  let validIsoTime = cleanTime;
Â  Â  Â  Â  Â  Â  let displayTime = cleanTime; 

Â  Â  Â  Â  Â  Â  // Logika normalizÃ¡cie Äasu zostÃ¡va
Â  Â  Â  Â  Â  Â  const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
Â  Â  Â  Â  Â  Â  const match = cleanTime.match(dateRegex);

Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  const [full, day, month, year, time] = match;
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year} ${time}`;
Â  Â  Â  Â  Â  Â  } else if (cleanTime.includes('-') && cleanTime.length >= 16) { // ISO like format YYYY-MM-DD HH:MM
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = cleanTime.replace('T', ' ').substring(0, 16); 
Â  Â  Â  Â  Â  Â  Â  Â  const [date, time] = validIsoTime.split(' ');
Â  Â  Â  Â  Â  Â  Â  Â  const [y, m, d] = date.split('-');
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const cleanType = String(log.typ)
Â  Â  Â  Â  Â  Â  Â  Â  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")Â 
Â  Â  Â  Â  Â  Â  Â  Â  .toLowerCase();

Â  Â  Â  Â  Â  Â  let recordType = null;
Â  Â  Â  Â  Â  Â  // NOVÃ VYLEPÅ ENÃ LOGIKA TYPOV
Â  Â  Â  Â  Â  Â  if (cleanType.includes('prichod')) recordType = 'prichod';
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('odchod')) recordType = 'odchod';
            // NOVÃ‰: PrestÃ¡vky sÃº teraz START/END
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('prestavka_start')) recordType = 'prestavka_start';
            else if (cleanType.includes('prestavka_end')) recordType = 'prestavka_end';
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('prestavka')) recordType = 'prestavka'; // Podpora starÃ©ho formÃ¡tu
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('pn')) recordType = 'pn';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (recordType) {
Â  Â  Â  Â  Â  Â  Â  Â  // Kontrola duplikÃ¡tov na zÃ¡klade Äasu a typu
Â  Â  Â  Â  Â  Â  Â  Â  const isDuplicate = records.some(r => r.cas === validIsoTime && r.stav === recordType);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!isDuplicate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â records.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cas: validIsoTime, // ISO formÃ¡t pre triedenie/filtrovanie
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â casDisplay: displayTime, // FormÃ¡t DD.MM.YYYY HH:MM pre zobrazenie/export
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â stav: recordType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â date: displayTime.substring(0, 10),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â time: displayTime.substring(11, 16)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Triedenie pre zobrazenie na strÃ¡nke (NajnovÅ¡ie prvÃ©)
Â  Â  Â  Â  records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
Â  Â  Â  Â  allRecordsCache = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // AKTUALIZÃCIA STAVU A TLAÄŒIDIEL
Â  Â  Â  Â  updateStatusAndButtons(records);

Â  Â  Â  Â  // Vykreslenie tabuliek
Â  Â  Â  Â  renderTables(allRecordsCache);

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t:", e);
Â  Â  Â  Â  statusBox.innerHTML = "âŒ KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t!";
Â  Â  Â  Â  renderTables([]);
Â  Â  }
}

// --- Vykreslenie tabuliek (S Pilulkami) ---
function renderTables(records) {
Â  Â  const dochadzkaTable = document.getElementById("dochadzkaTable");
Â  Â  const prestavkyTable = document.getElementById("prestavkyTable");
Â  Â  const pnTable = document.getElementById("pnTable");

Â  Â  // DÃ¡tum filtrovania musÃ­ byÅ¥ v ISO formÃ¡te YYYY-MM-DD pre porovnanie s r.cas
Â  Â  const filterDochadzka = document.getElementById("dateDochadzka").value;
Â  Â  const filterPrestavky = document.getElementById("datePrestavky").value;
Â  Â  const filterPN = document.getElementById("datePN").value;

Â  Â  const renderSection = (bodyEl, type, filterDate, expectedStav, colCount) => {
Â  Â  Â  Â  let filtered = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(filterDate) {
Â  Â  Â  Â  Â  Â  // Filtrovanie na zÃ¡klade dÃ¡tumu (ÄasÅ¥ YYYY-MM-DD)
Â  Â  Â  Â  Â  Â  filtered = filtered.filter(r => r.cas.substring(0, 10) === filterDate);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sectionRecords = filtered.filter(r => expectedStav.some(stav => r.stav.includes(stav)));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!sectionRecords.length) {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = `<tr><td colspan="${colCount}">Å½iadne zÃ¡znamy</td></tr>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = sectionRecords.map(z => {
Â  Â  Â  Â  Â  Â  Â  Â  const displayTime = z.casDisplay;

Â  Â  Â  Â  Â  Â  Â  Â  let statusClass = '';
Â  Â  Â  Â  Â  Â  Â  Â  let stavText = z.stav.toUpperCase();

Â  Â  Â  Â  Â  Â  Â  Â  if (z.stav === 'prichod') statusClass = 'status-prichod';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'odchod') statusClass = 'status-odchod';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'prestavka' || z.stav === 'prestavka_start') {
                    statusClass = 'status-prestavka-start';
                    stavText = 'PRESTÃVKA START';
                }
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'prestavka_end') {
                    statusClass = 'status-prestavka-end';
                    stavText = 'PRESTÃVKA END';
                }
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'pn') statusClass = 'status-pn';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'dochadzka') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // DochÃ¡dzka: 2 stÄºpce
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${displayTime}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status-badge ${statusClass}">${stavText}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // PrestÃ¡vky a PN: 1 stÄºpec
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${displayTime}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge small ${statusClass}">${stavText}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }).join("");
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // PrestÃ¡vky filtrujeme na akÃ½koÄ¾vek typ prestÃ¡vky
Â  Â  renderSection(dochadzkaTable, 'dochadzka', filterDochadzka, ["prichod", "odchod"], 2);
Â  Â  renderSection(prestavkyTable, 'prestavky', filterPrestavky, ["prestavka"], 1);
Â  Â  renderSection(pnTable, 'pn', filterPN, ["pn"], 1);
}

// --- HLAVNÃ FUNKCIA: Export do XLSX (S VylepÅ¡enou logikou prestÃ¡vok) ---
window.exportTable = function(sectionType) {
Â  Â  const userName = userNameEl.textContent;
Â  Â  let filterDate, expectedStav, sectionTitle;
Â  Â  let header; 
Â  Â  let fileNameBase;

Â  Â  // --- Krok 1: Definovanie filtrov a hlaviÄiek ---
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  filterDate = document.getElementById("dateDochadzka").value;
Â  Â  Â  Â  expectedStav = ["prichod", "odchod"];
Â  Â  Â  Â  sectionTitle = "DochÃ¡dzka (PrÃ­chod/Odchod) a SumarizÃ¡cia";
Â  Â  Â  Â  header = ["DÃ¡tum", "ÄŒas", "Typ", "OdpracovanÃ½ Äas/Status"];Â 
Â  Â  Â  Â  fileNameBase = "dochadzka_sumar";
Â  Â  } else if (sectionType === 'prestavky') {
Â  Â  Â  Â  filterDate = document.getElementById("datePrestavky").value;
Â  Â  Â  Â  expectedStav = ["prestavka"]; // Filtruje vÅ¡etky typy prestÃ¡vok
Â  Â  Â  Â  sectionTitle = "PrestÃ¡vky a ich Trvanie";
Â  Â  Â  Â  // NOVÃ HLAVIÄŒKA pre PrestÃ¡vky
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ ZÃ¡znamu", "Trvanie PrestÃ¡vky"];
Â  Â  Â  Â  fileNameBase = "prestavky_sumar";
Â  Â  } else if (sectionType === 'pn') {
Â  Â  Â  Â  filterDate = document.getElementById("datePN").value;
Â  Â  Â  Â  expectedStav = ["pn"];
Â  Â  Â  Â  sectionTitle = "PN";
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ"];
Â  Â  Â  Â  fileNameBase = "pn";
Â  Â  } else {
Â  Â  Â  Â  return alert("NeznÃ¡my typ sekcie pre export.");
Â  Â  }
Â  Â Â 
Â  Â  // --- Krok 2: FiltrÃ¡cia a triedenie dÃ¡t pre kalkulÃ¡ciu (od najstarÅ¡ieho) ---
Â  Â  let filteredRecords = allRecordsCache;
Â  Â  if(filterDate) {
Â  Â  Â  Â  filteredRecords = filteredRecords.filter(r => r.cas.substring(0, 10) === filterDate);
Â  Â  }
Â  Â Â 
Â  Â  const sortedRecords = filteredRecords
Â  Â  Â  Â  .filter(r => expectedStav.some(stav => r.stav.includes(stav)))
Â  Â  Â  Â  .sort((a, b) => new Date(a.cas) - new Date(b.cas));

Â  Â  // --- Krok 3: Generovanie dÃ¡tovÃ©ho poÄ¾a a KALKULÃCIA ---
Â  Â  const exportData = [
Â  Â  Â  Â  ["Typ zÃ¡znamu:", sectionTitle],
Â  Â  Â  Â  ["PouÅ¾Ã­vateÄ¾:", userName],
Â  Â  Â  Â  [],Â 
Â  Â  Â  Â  header 
Â  Â  ];
Â  Â Â 
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  // PonechÃ¡me komplexnÃº dochÃ¡dzkovÃº logiku pre export dochÃ¡dzky
Â  Â  Â  Â  let totalWorkMs = 0;
Â  Â  Â  Â  let lastPrichod = null;
Â  Â  Â  Â  let lastDate = null;
Â  Â  Â  Â  let dailyWorkMs = 0;
        
        // ZÃ­skame vÅ¡etky prestÃ¡vky, aby sme ich mohli odpoÄÃ­taÅ¥
        const breakRecords = allRecordsCache
            .filter(r => r.stav.includes('prestavka'))
            .sort((a, b) => new Date(a.cas) - new Date(b.cas));
        
        let totalBreakMs = 0;


Â  Â  Â  Â  sortedRecords.forEach((record) => {
Â  Â  Â  Â  Â  Â  const currentDateTime = new Date(record.cas);
Â  Â  Â  Â  Â  Â  const currentDateStr = record.date;
Â  Â  Â  Â  Â  Â  const currentTimeStr = record.time;

Â  Â  Â  Â  Â  Â  // --- Logika SumarizÃ¡cie DÅˆa ---
Â  Â  Â  Â  Â  Â  if (lastDate && lastDate !== currentDateStr) {
Â  Â  Â  Â  Â  Â  Â  Â  if (dailyWorkMs > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs = 0; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (record.stav === 'prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = currentDateTime;
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), ""]);
Â  Â  Â  Â  Â  Â  } else if (record.stav === 'odchod' && lastPrichod) {
Â  Â  Â  Â  Â  Â  Â  Â  let durationMs = currentDateTime - lastPrichod;
                
                // OdpoÄÃ­tanie Äasu prestÃ¡vok medzi tÃ½mto prÃ­chodom a odchodom
                let durationBreaks = 0;
                let lastBreakStart = null;
                
                breakRecords.forEach(breakR => {
                    const breakTime = new Date(breakR.cas);
                    if (breakTime > lastPrichod && breakTime < currentDateTime) {
                         if (breakR.stav.includes('start') || breakR.stav === 'prestavka') {
                            lastBreakStart = breakTime;
                        } else if (breakR.stav.includes('end') && lastBreakStart) {
                            durationBreaks += breakTime - lastBreakStart;
                            lastBreakStart = null;
                        }
                    }
                });
                
                totalBreakMs += durationBreaks;
Â  Â  Â  Â  Â  Â  Â  Â  durationMs -= durationBreaks; // ODPOÄŒÃTANIE PRESTÃVOK

Â  Â  Â  Â  Â  Â  Â  Â  const durationHhMm = msToHhMm(durationMs);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  totalWorkMs += durationMs;
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs += durationMs;

Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), durationHhMm]);
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = null; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), "Chyba PRICHOD/ODCHOD"]);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  lastDate = currentDateStr;
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- FinÃ¡lna SumarizÃ¡cia (PoslednÃ½ deÅˆ) ---
Â  Â  Â  Â  if (lastDate && dailyWorkMs > 0) {
Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CelkovÃ¡ SumarizÃ¡cia ---
Â  Â  Â  Â  exportData.push([]); 
        exportData.push(["CelkovÃ¡ odpracovanÃ¡ doba:", "", "", msToHhMm(totalWorkMs)]);
        exportData.push(["CelkovÃ¡ doba prestÃ¡vok (odpoÄÃ­tanÃ¡):", "", "", msToHhMm(totalBreakMs)]);


Â  Â  } else if (sectionType === 'prestavky') {
        // NOVÃ Logika pre export PrestÃ¡vok (SUMÃR)
        let totalBreakMs = 0;
        let lastBreakStart = null;
        
        // Pridanie riadkov, kde sa poÄÃ­ta trvanie prestÃ¡vky
        sortedRecords.forEach(record => {
            const currentDateTime = new Date(record.cas);
            let durationHhMm = "";
            let stavText = record.stav.toUpperCase();

            if (record.stav.includes('start') || record.stav === 'prestavka') {
                lastBreakStart = currentDateTime;
                stavText = 'PRESTÃVKA START';
            } else if (record.stav.includes('end') && lastBreakStart) {
                const durationMs = currentDateTime - lastBreakStart;
                durationHhMm = msToHhMm(durationMs);
                totalBreakMs += durationMs;
                lastBreakStart = null;
                stavText = 'PRESTÃVKA END';
            } else if (record.stav.includes('end')) {
                durationHhMm = "Chyba: ChÃ½ba START";
                stavText = 'PRESTÃVKA END';
            }

            exportData.push([
                record.casDisplay,
                stavText,
                durationHhMm
            ]);
        });

        // CelkovÃ½ sÃºÄet prestÃ¡vok
        exportData.push([]); 
        exportData.push(["CelkovÃ¡ doba prestÃ¡vok:", "", msToHhMm(totalBreakMs)]);

    } else { // Pre PN je jednoduchÃ½ export
Â  Â  Â  Â  if (sortedRecords.length === 0) {
Â  Â  Â  Â  Â  Â  exportData.push(["Å½iadne zÃ¡znamy", ""]);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sortedRecords.forEach(z => {
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  z.casDisplay, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  z.stav.toUpperCase()
Â  Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // --- Krok 4: Export XLSX s vizuÃ¡lnymi Ãºpravami ---
Â  Â Â 
Â  Â  const wb = XLSX.utils.book_new();
Â  Â  const ws = XLSX.utils.aoa_to_sheet(exportData);
Â  Â Â 
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 100 }, 
Â  Â  Â  Â  Â  Â  { wpx: 150 }, 
Â  Â  Â  Â  Â  Â  { wpx: 100 }, 
Â  Â  Â  Â  Â  Â  { wpx: 150 } 
Â  Â  Â  Â  ];

Â  Â  Â  Â  const finalRowIndex = exportData.length - 2; 

Â  Â  Â  Â  for (let i = 4; i < exportData.length; i++) {
Â  Â  Â  Â  Â  Â  const row = exportData[i];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (row[1] === "SumarizÃ¡cia dÅˆa:") {
Â  Â  Â  Â  Â  Â  Â  Â  const textCellRef = XLSX.utils.encode_cell({ r: i, c: 1 });
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }

Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFFCC00" } } }; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (row[3] === "Chyba PRICHOD/ODCHOD") {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FFCC0000" } } }; }Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (i === finalRowIndex && row[0] === "CelkovÃ¡ odpracovanÃ¡ doba:") {
Â  Â  Â  Â  Â  Â  Â  Â  const textCellRef = XLSX.utils.encode_cell({ r: i, c: 0 });
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FF00B050" } } }; }Â 
Â  Â  Â  Â  Â  Â  }
            // NOVÃ‰: CelkovÃ¡ doba prestÃ¡vok
            if (i === finalRowIndex + 1 && row[0] === "CelkovÃ¡ doba prestÃ¡vok (odpoÄÃ­tanÃ¡):") {
Â  Â  Â  Â  Â  Â  Â  Â  const textCellRef = XLSX.utils.encode_cell({ r: i, c: 0 });
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FF00BFFF" } } }; } // ModrÃ¡
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  } else if (sectionType === 'prestavky') {
Â  Â  Â  Â  Â  ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 150 }, 
Â  Â  Â  Â  Â  Â  { wpx: 150 },
            { wpx: 150 }Â 
Â  Â  Â  Â  ];
        // ZvÃ½raznenie celkovej doby prestÃ¡vok
        const finalRowIndex = exportData.length - 1;
        const textCellRef = XLSX.utils.encode_cell({ r: finalRowIndex, c: 0 });
        if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }
        const cellRef = XLSX.utils.encode_cell({ r: finalRowIndex, c: 2 });
        if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFFCC00" } } }; }
Â  Â  } else {
Â  Â  Â  Â  Â  ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 150 }, 
Â  Â  Â  Â  Â  Â  { wpx: 100 }Â 
Â  Â  Â  Â  ];
Â  Â  }
Â  Â Â 
Â  Â  XLSX.utils.book_append_sheet(wb, ws, "DochÃ¡dzka");

Â  Â  const safeUserName = userName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
Â  Â  const fileName = `${fileNameBase}_${safeUserName}_export.xlsx`;
Â  Â Â 
Â  Â  XLSX.writeFile(wb, fileName);
Â  Â Â 
Â  Â  const btn = document.querySelector(`[data-export-table="${sectionType}"]`);
Â  Â  if(btn) {
Â  Â  Â  Â  btn.innerHTML = `<i class="fas fa-check"></i> SÃºbor stiahnutÃ½!`; // Ikona pre stiahnutÃ©
Â  Â  Â  Â  setTimeout(() => {
            if (sectionType === 'dochadzka') btn.innerHTML = `<i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX (SumÃ¡r)`;
            else if (sectionType === 'prestavky') btn.innerHTML = `<i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX (SumÃ¡r)`;
            else btn.innerHTML = `<i class="fas fa-file-excel"></i> ExportovaÅ¥ do XLSX`;
        }, 2000);
Â  Â  }
};

// --- Listenery ---

document.getElementById("logoutBtn").addEventListener("click", () => {
Â  Â  localStorage.removeItem("uid");
Â  Â  window.location.href = "index.html";
});

document.querySelectorAll("nav button").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
Â  Â  Â  Â  btn.classList.add("active");
Â  Â  Â  Â  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
Â  Â  Â  Â  document.getElementById(btn.dataset.target).classList.add("active");
Â  Â  Â  Â  renderTables(allRecordsCache); // Prekreslenie pri prepnutÃ­ sekcie
Â  Â  });
});

// Filtre spustia renderTables
document.getElementById("dateDochadzka").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePrestavky").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePN").addEventListener("change", () => renderTables(allRecordsCache));

document.querySelectorAll(".export-btn[data-export-table]").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  exportTable(btn.dataset.exportTable);Â 
Â  Â  });
});

// NOVÃ‰: LISTENERY PRE AKÄŒNÃ‰ TLAÄŒIDLÃ
document.getElementById("btnPrichod").addEventListener("click", () => writeLog("prichod"));
document.getElementById("btnOdchod").addEventListener("click", () => writeLog("odchod"));
document.getElementById("btnPrestavkaStart").addEventListener("click", () => writeLog("prestavka_start"));
document.getElementById("btnPrestavkaEnd").addEventListener("click", () => writeLog("prestavka_end"));

// --- Spustenie aplikÃ¡cie ---
loadUserData();
</script>
</body>
</html>
