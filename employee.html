<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DochÃ¡dzka â€“ Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- Å tÃ½ly (z predchÃ¡dzajÃºcich verziÃ­) --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#f4f5f7,#e0e0e0); min-height:100vh; color:#333; display:flex; flex-direction:column; align-items:center;}
header { background:#007bff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; color:white; position:sticky; top:0; z-index:10; }
h1 { margin:0; font-size:22px; font-weight:600; }
header button { background:#fff; border:none; color:#007bff; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
header button:hover { background:#e2e6ea; }

nav { background:#fff; display:flex; justify-content:center; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:65px; z-index:5; flex-wrap:wrap; width:100%; max-width:1100px; border-radius:0 0 12px 12px; }
nav button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; }
nav button.active { background:#6f42c1; }
nav button:hover { background:#0056b3; }

section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; width:95%; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }

table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
th,td { border:1px solid #ddd; padding:10px; text-align:center; font-size:14px; }
th { background:#007bff; color:white; font-weight:500; }
tr:nth-child(even){ background:#f8f9fa; }

.export-btn{ margin-top:15px; background:#28a745; border:none; color:white; border-radius:8px; padding:8px 14px; cursor:pointer; font-weight:500; }
.export-btn:hover{ background:#1e7e34; }

.status-box { background:#e9f2ff; color:#007bff; font-weight:600; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; border:1px solid #007bff;}

/* --- VIZUÃLNE ODZNAKY --- */
.status-badge {
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 12px;
    display: inline-block;
    color: white;
    text-align: center;
    min-width: 60px;
    white-space: nowrap;
}
.status-prichod { background: #28a745; } /* ZelenÃ¡ */
.status-odchod { background: #dc3545; } /* ÄŒervenÃ¡ */
.status-prestavka { background: #ffc107; color: #333; } /* Å½ltÃ¡ */
.status-pn { background: #6f42c1; } /* FialovÃ¡ */

.filter { margin-top: 10px; }
.filter input { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }

/* DEBUG BOX - NA OVERENIE NAÄŒÃTANÃ‰HO UID */
#debugUid { background:#f8d7da;color:#721c24;padding:5px;text-align:center;font-size:12px;margin-bottom:10px; }
</style>
</head>
<body>

<header>
Â  <h1>ğŸ‘‹ Vitaj, <span id="userName">Zamestnanec</span></h1>
Â  <button id="logoutBtn">OdhlÃ¡siÅ¥ sa</button>
</header>

<div id="debugUid" style="background:#f8d7da;color:#721c24;padding:5px;text-align:center;font-size:12px;margin-bottom:10px;">NaÄÃ­tavam UID...</div>

<nav>
Â  <button data-target="dochadzka" class="active">DochÃ¡dzka</button>
Â  <button data-target="prestavky">PrestÃ¡vky</button>
Â  <button data-target="pn">PN</button>
</nav>

<section id="dochadzka" class="active">
Â  <div id="statusBox" class="status-box">NaÄÃ­tavam stav...</div>
Â  <h2>DochÃ¡dzka (PrÃ­chod/Odchod)</h2>
Â  <button class="export-btn" data-export-table="dochadzka">ExportovaÅ¥ do CSV</button>
Â  <div class="filter">
Â  Â  <label for="dateDochadzka">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  <input type="date" id="dateDochadzka">
Â  </div>
Â  <table>
Â  Â  <thead><tr><th>ÄŒas</th><th>Typ</th></tr></thead>
Â  Â  <tbody id="dochadzkaTable"><tr><td colspan="2">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  </table>
</section>

<section id="prestavky">
Â  <h2>PrestÃ¡vky</h2>
Â  <button class="export-btn" data-export-table="prestavky">ExportovaÅ¥ do CSV</button>
Â  <div class="filter">
Â  Â  <label for="datePrestavky">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  <input type="date" id="datePrestavky">
Â  </div>
Â  <table>
Â  Â  <thead><tr><th>ÄŒas</th></tr></thead>
Â  Â  <tbody id="prestavkyTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  </table>
</section>

<section id="pn">
Â  <h2>PN</h2>
Â  <button class="export-btn" data-export-table="pn">ExportovaÅ¥ do CSV</button>
Â  <div class="filter">
Â  Â  <label for="datePN">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  <input type="date" id="datePN">
Â  </div>
Â  <table>
Â  Â  <thead><tr><th>ÄŒas</th></tr></thead>
Â  Â  <tbody id="pnTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
Â  authDomain: "maturita-395fd.firebaseapp.com",
Â  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
Â  projectId: "maturita-395fd",
Â  storageBucket: "maturita-395fd.firebasestorage.app",
Â  messagingSenderId: "754745500563",
Â  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
Â  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// GlobÃ¡lne premennÃ©
const userId = localStorage.getItem("uid");
const userNameEl = document.getElementById("userName");
const statusBox = document.getElementById("statusBox");
const debugUidEl = document.getElementById("debugUid"); 
let allRecordsCache = [];

// --- Overenie a presmerovanie ---
if (!userId) {
Â  alert("Nie si prihlÃ¡senÃ½!");
Â  window.location.href = "index.html";
} else if (userId === "admin") {
Â  window.location.href = "admin.html";
} else {
    // OkamÅ¾itÃ© zobrazenie UID
    debugUidEl.textContent = `AktuÃ¡lne naÄÃ­tanÃ© UID: ${userId}`;
    console.log("AKTÃVNE UID:", userId);
}

// --- NaÄÃ­tanie dÃ¡t pouÅ¾Ã­vateÄ¾a z Firebase (ROBUSTNÃ VERZIA) ---
async function loadUserData() {
    try {
        const userSnap = await get(ref(db, `users/${userId}`));
        
        if (!userSnap.exists()) {
            console.error(`Chyba: DÃ¡ta pre UID "${userId}" neboli vo Firebase nÃ¡jdenÃ©!`);
            userNameEl.textContent = "(NeznÃ¡my)";
            debugUidEl.style.backgroundColor = '#dc3545';
            debugUidEl.style.color = 'white';
            debugUidEl.textContent = `CHYBA: DÃ¡ta pre UID ${userId} neexistujÃº!`;
            renderTables([]);
            return;
        }

        const userData = userSnap.val();
        userNameEl.textContent = userData.name || "(bez mena)";

        const records = [];

        // RekurzÃ­vna funkcia na nÃ¡jdenie zÃ¡znamov v chaotickej (plochej) Å¡truktÃºre
        function collectRecords(data) {
            if (typeof data !== 'object' || data === null) return;

            // KÄ¾ÃºÄovÃ¡ podmienka: ak objekt obsahuje polia 'cas' a 'typ', je to dochÃ¡dzkovÃ½ zÃ¡znam.
            if (data.cas && data.typ) {
                let cleanTime = String(data.cas).replace(' ', 'T');
                
                // Kontrola pre formÃ¡t dÃ¡tumu (ignorujeme nekompatibilnÃ© formÃ¡ty)
                if (!cleanTime.includes('-')) return;

                const recordType = String(data.typ).toLowerCase();
                
                // Zbierame len relevantnÃ© typy
                if (["prichod", "odchod", "prestavka", "pn"].includes(recordType)) {
                    records.push({
                        cas: cleanTime,
                        stav: recordType,
                    });
                }
                return; // Ak je to zÃ¡znam, nepokraÄujeme hlbÅ¡ie v tomto uzle
            }

            // RekurzÃ­vne volanie pre vÅ¡etky pod-objekty (prehÄ¾adÃ¡ dochadzka, prestavky, pn, atÄ.)
            Object.values(data).forEach(collectRecords);
        }

        // SpustÃ­me zber dÃ¡t z hlavnÃ©ho uzla pouÅ¾Ã­vateÄ¾a
        collectRecords(userData);
        
        // 3. Triedenie (od najnovÅ¡ieho)
        records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
        allRecordsCache = records;
        
        // 4. AktualizÃ¡cia stavu
        const lastStatus = records.length ? records[0].stav.toUpperCase() : "Å½iadny stav nezaznamenanÃ½.";
        const lastStatusClass = records.length ? `status-${records[0].stav}` : '';
        statusBox.innerHTML = `PoslednÃ½ stav: <span class="status-badge ${lastStatusClass}">${lastStatus}</span>`;

        // 5. Vykreslenie vÅ¡etkÃ½ch sekciÃ­
        renderTables(allRecordsCache);

    } catch (e) {
        console.error("KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t:", e);
        statusBox.textContent = "KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t!";
        renderTables([]);
    }
}

// --- Vykreslenie tabuliek (PouÅ¾Ã­va explicitnÃ½ poÄet stÄºpcov) ---
function renderTables(records) {
Â  const dochadzkaTable = document.getElementById("dochadzkaTable");
Â  const prestavkyTable = document.getElementById("prestavkyTable");
Â  const pnTable = document.getElementById("pnTable");

Â  const filterDochadzka = document.getElementById("dateDochadzka").value;
Â  const filterPrestavky = document.getElementById("datePrestavky").value;
Â  const filterPN = document.getElementById("datePN").value;

Â  // VykresÄ¾uje sekciu s explicitne urÄenÃ½m poÄtom stÄºpcov
Â  const renderSection = (bodyEl, type, filterDate, expectedStav, colCount) => {
Â  Â  let filtered = records;
Â  Â Â 
Â  Â  if(filterDate) {
Â  Â  Â  // Filtrujeme presne podÄ¾a dÃ¡tumu (YYYY-MM-DD)
Â  Â  Â  filtered = filtered.filter(r => r.cas.substring(0, 10) === filterDate);
Â  Â  }
Â  Â Â 
Â  Â  const sectionRecords = filtered.filter(r => expectedStav.includes(r.stav));
    
Â  Â  if (!sectionRecords.length) {
Â  Â  Â  // Colspan na zÃ¡klade colCount
Â  Â  Â  bodyEl.innerHTML = `<tr><td colspan="${colCount}">Å½iadne zÃ¡znamy</td></tr>`;
Â  Â  } else {
Â  Â  Â  bodyEl.innerHTML = sectionRecords.map(z => {
Â  Â  Â  Â  // Ãšprava Äasu pre zobrazenie (odstrÃ¡nenie T, milisekÃºnd a Z)
        let visibleTime = z.cas.replace('T', ' ').split('.')[0]; 
        visibleTime = visibleTime.endsWith('Z') ? visibleTime.slice(0, -1) : visibleTime;

Â  Â  Â  Â  const cls = `status-${z.stav}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (type === 'dochadzka') {
Â  Â  Â  Â  Â  // DochÃ¡dzka: 2 stÄºpce
Â  Â  Â  Â  Â  return `<tr><td>${visibleTime}</td><td><span class="status-badge ${cls}">${z.stav.toUpperCase()}</span></td></tr>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // PrestÃ¡vky a PN: 1 stÄºpec
Â  Â  Â  Â  Â  return `<tr><td><span class="status-badge ${cls}">${visibleTime}</span></td></tr>`;
Â  Â  Â  Â  }
Â  Â  Â  }).join("");
Â  Â  }
Â  };

Â  // Zavolanie funkcie s explicitnÃ½m poÄtom stÄºpcov
Â  renderSection(dochadzkaTable, 'dochadzka', filterDochadzka, ["prichod", "odchod"], 2);
Â  renderSection(prestavkyTable, 'prestavky', filterPrestavky, ["prestavka"], 1);
Â  renderSection(pnTable, 'pn', filterPN, ["pn"], 1);
}


// --- Export do CSV (RobustnÃ¡ verzia) ---
window.exportTable = function(sectionNameId) {
    const sectionEl = document.getElementById(sectionNameId); 
    const table = sectionEl ? sectionEl.querySelector('table') : null;
    
    if(!table) return alert("Å½iadne dÃ¡ta na export alebo tabuÄ¾ka nebola nÃ¡jdenÃ¡.");
    
    const userName = userNameEl.textContent;
    const sectionTitle = sectionEl.querySelector('h2').textContent.trim(); 
    
    let csv = [];
    
    csv.push(`"Typ zÃ¡znamu","${sectionTitle.split('(')[0].trim()}"`);
    csv.push(`"PouÅ¾Ã­vateÄ¾","${userName}"`);
    csv.push("");
    
    const header = Array.from(table.querySelectorAll("thead th")).map(th => `"${th.innerText.trim()}"`);
    csv.push(header.join(","));
    
    table.querySelectorAll("tbody tr").forEach(row => {
        const cols = Array.from(row.querySelectorAll("td")).map(td => `"${td.textContent.trim()}"`);
        
        if (cols.length > 0 && cols[0].includes("Å½iadne zÃ¡znamy") === false) {
            csv.push(cols.join(","));
        }
    });
    
    const blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${sectionTitle.replace(/[^a-zA-Z0-9]/g, '_')}_${userName}.csv`;
    a.click();
};

// --- Listenery (Bezo zmeny) ---

document.getElementById("logoutBtn").addEventListener("click", () => {
Â  localStorage.removeItem("uid");
Â  window.location.href = "index.html";
});

document.querySelectorAll("nav button").forEach(btn => {
Â  btn.addEventListener("click", () => {
Â  Â  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
Â  Â  btn.classList.add("active");
Â  Â  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
Â  Â  document.getElementById(btn.dataset.target).classList.add("active");
Â  });
});

document.getElementById("dateDochadzka").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePrestavky").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePN").addEventListener("change", () => renderTables(allRecordsCache));

document.querySelectorAll(".export-btn").forEach(btn => {
Â  btn.addEventListener("click", () => {
Â  Â  exportTable(btn.dataset.exportTable);
Â  });
});

// --- Spustenie aplikÃ¡cie ---
loadUserData();
</script>
</body>
</html>
