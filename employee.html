<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doch√°dzka ‚Äì Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f4f5f7;
  --text: #333;
  --card: #fff;
  --accent: #007bff;
  --accent-dark: #0056b3;
  --border: #ccc;
  --prichod: #28a745;
  --odchod: #dc3545;
  --prestavka: #ffc107;
  --pn: #6f42c1;
}

body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
}

header {
  width: 100%;
  background: var(--accent);
  color: white;
  padding: 15px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

header h1 {
  font-weight: 600;
  font-size: 22px;
  margin: 0;
}

header button {
  background: #fff;
  color: var(--accent);
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
header button:hover {
  background: var(--accent-dark);
  color: white;
}

.container {
  max-width: 850px;
  width: 95%;
  background: var(--card);
  margin: 25px auto 40px auto;
  padding: 25px 30px;
  border-radius: 16px;
  box-shadow: 0 6px 25px rgba(0,0,0,0.1);
}

h2 {
  color: var(--accent);
  border-bottom: 3px solid var(--accent);
  padding-bottom: 6px;
  margin-top: 0;
  font-weight: 600;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 15px;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
th, td {
  border: 1px solid var(--border);
  padding: 10px;
  text-align: center;
}
th {
  background: var(--accent);
  color: white;
  font-weight: 500;
}
tr:nth-child(even) { background: rgba(0,0,0,0.03); }
tr:hover { background: rgba(0,0,0,0.08); }

.status-prichod, .status-odchod, .status-prestavka, .status-pn {
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 12px;
  display: inline-block;
  color: white;
}
.status-prichod { background: var(--prichod); }
.status-odchod { background: var(--odchod); }
.status-prestavka { background: var(--prestavka); }
.status-pn { background: var(--pn); }

.status-box {
  margin: 10px 0 20px;
  font-weight: 600;
  padding: 12px;
  border-radius: 12px;
  text-align: center;
  background: #e9f2ff;
  font-size: 16px;
  color: var(--accent);
  border: 1px solid var(--accent);
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

button.export-btn {
  margin-top: 10px;
  background: #28a745;
  border: none;
  border-radius: 8px;
  color: white;
  padding: 8px 14px;
  font-weight: 500;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  cursor: pointer;
  transition: 0.3s;
}
button.export-btn:hover { background: #218838; }

.filter {
  margin: 10px 0 0 0;
}
.filter input {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
  width: 160px;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <h1>üëã Vitaj, <span id="userName">Zamestnanec</span></h1>
  <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<div class="container">
  <div id="statusBox" class="status-box">Naƒç√≠tavam stav...</div>

  <h2>Moja Doch√°dzka</h2>
  <button class="export-btn" onclick="exportMyData()">Export do Excel</button>
  <div class="filter">
    <label for="filterDate">Filtrova≈• podƒæa d√°tumu:</label>
    <input type="date" id="filterDate">
  </div>
  <table>
    <thead>
      <tr><th>ƒåas</th><th>Stav</th></tr>
    </thead>
    <tbody id="attendanceBody"><tr><td colspan="2">Naƒç√≠tavam √∫daje...</td></tr></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYp0g",
  authDomain: "maturita-395fd.firebaseapp.com",
  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
  projectId: "maturita-395fd",
  storageBucket: "maturita-395fd.firebasestorage.app",
  messagingSenderId: "754745500563",
  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
  measurementId: "G-F6KQQS48GD"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const userId = localStorage.getItem("uid");
if (!userId) { alert("Nie si prihl√°sen√Ω!"); window.location.href = "index.html"; }

const attendanceBody = document.getElementById("attendanceBody");
const userNameEl = document.getElementById("userName");
const filterDate = document.getElementById("filterDate");
const statusBox = document.getElementById("statusBox");

let allRecords = [];

// Naƒç√≠tanie pou≈æ√≠vateƒæa
get(ref(db, "users/" + userId)).then(snapshot => {
  if (!snapshot.exists()) { alert("Pou≈æ√≠vateƒæ nen√°jden√Ω!"); window.location.href = "index.html"; return; }
  const userData = snapshot.val();
  userNameEl.textContent = userData.name;
  const chipUid = userData.chipUid;

  onValue(ref(db, "dochadzka/" + chipUid), snap => {
    allRecords = [];
    attendanceBody.innerHTML = "";
    if (!snap.exists()) { attendanceBody.innerHTML = "<tr><td colspan='2'>≈Ωiadne z√°znamy</td></tr>"; return; }
    snap.forEach(childSnap => {
      if (childSnap.key !== "posledny_stav") allRecords.push(childSnap.val());
    });
    renderTable();
  });

  onValue(ref(db, "dochadzka/" + chipUid + "/posledny_stav"), snap => {
    statusBox.textContent = snap.exists() ? "Posledn√Ω stav: " + snap.val() : "≈Ωiadny stav nezaznamenan√Ω.";
  });
});

function renderTable() {
  attendanceBody.innerHTML = "";
  let filtered = allRecords;
  const selectedDate = filterDate.value;
  if (selectedDate) filtered = filtered.filter(r => r.cas.startsWith(selectedDate));

  if (!filtered.length) attendanceBody.innerHTML = "<tr><td colspan='2'>≈Ωiadne z√°znamy</td></tr>";
  else filtered.reverse().forEach(z => {
    let cls = "";
    switch(z.typ.toLowerCase()) {
      case "prichod": cls="status-prichod"; break;
      case "odchod": cls="status-odchod"; break;
      case "prestavka": cls="status-prestavka"; break;
      case "pn": cls="status-pn"; break;
    }
    attendanceBody.innerHTML += `<tr><td>${z.cas}</td><td class="${cls}">${z.typ}</td></tr>`;
  });
}

filterDate.addEventListener("change", renderTable);

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("uid");
  window.location.href = "index.html";
});

// Export do Excelu
window.exportMyData = function() {
  const userName = userNameEl.textContent;
  const data = [
    ["Zamestnanec", userName],
    ["Posledn√Ω stav", statusBox.textContent],
    [],
    ["Doch√°dzka"], ["ƒåas","Stav"],
    ...allRecords.map(r => [r.cas, r.typ])
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Moja Doch√°dzka");
  XLSX.writeFile(wb, `Dochadzka_${userName}.xlsx`);
}
</script>
</body>
</html>



