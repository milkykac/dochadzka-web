<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doch√°dzka ‚Äì Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f4f5f7;
  --text: #333;
  --card: #fff;
  --accent: #007bff;
  --accent-dark: #0056b3;
  --border: #ccc;
  --prichod: #28a745;
  --odchod: #dc3545;
  --prestavka: #ffc107;
  --pn: #6f42c1;
}
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
}
header {
  width: 100%;
  background: var(--accent);
  color: white;
  padding: 15px 25px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
header h1 { font-weight: 600; font-size: 22px; margin: 0; }
header button {
  background: #fff;
  color: var(--accent);
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}
header button:hover { background: var(--accent-dark); color: white; }
nav { display: flex; gap: 10px; margin: 20px 0 0 0; }
nav button {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  font-weight: 500;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: 0.3s;
}
nav button.active { background: var(--pn); }
nav button:hover { background: var(--accent-dark); }
.container {
  max-width: 850px;
  width: 95%;
  background: var(--card);
  margin: 25px auto 40px auto;
  padding: 25px 30px;
  border-radius: 16px;
  box-shadow: 0 6px 25px rgba(0,0,0,0.1);
}
h2 {
  color: var(--accent);
  border-bottom: 3px solid var(--accent);
  padding-bottom: 6px;
  margin-top: 0;
  font-weight: 600;
}
.table-section { display: none; margin-top: 20px; }
.table-section.active { display: block; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 15px;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
th, td { border: 1px solid var(--border); padding: 10px; text-align: center; }
th { background: var(--accent); color: white; font-weight: 500; }
tr:nth-child(even) { background: rgba(0,0,0,0.03); }
tr:hover { background: rgba(0,0,0,0.08); }
.status-prichod, .status-odchod, .status-prestavka, .status-pn {
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 12px;
  display: inline-block;
  color: white;
}
.status-prichod { background: var(--prichod); }
.status-odchod { background: var(--odchod); }
.status-prestavka { background: var(--prestavka); }
.status-pn { background: var(--pn); }
.status-box {
  margin: 10px 0 20px;
  font-weight: 600;
  padding: 12px;
  border-radius: 12px;
  text-align: center;
  background: #e9f2ff;
  font-size: 16px;
  color: var(--accent);
  border: 1px solid var(--accent);
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}
button.export-btn {
  margin-top: 10px;
  background: #28a745;
  border: none;
  border-radius: 8px;
  color: white;
  padding: 8px 14px;
  font-weight: 500;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  cursor: pointer;
  transition: 0.3s;
}
button.export-btn:hover { background: #218838; }
.filter { margin: 10px 0 0 0; }
.filter input { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); width: 160px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <h1>üëã Vitaj, <span id="userName">Zamestnanec</span></h1>
  <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<nav>
  <button data-target="attendance" class="active">Doch√°dzka</button>
  <button data-target="breaks">Prest√°vky</button>
  <button data-target="pn">PN</button>
</nav>

<div class="container">
  <div id="statusBox" class="status-box">Naƒç√≠tavam stav...</div>

  <div class="table-section active" id="attendance">
    <h2>Doch√°dzka</h2>
    <button class="export-btn" onclick="exportMyData()">Export do Excel</button>
    <div class="filter">
      <label for="filterDate">Filtrova≈• podƒæa d√°tumu:</label>
      <input type="date" id="filterDate">
    </div>
    <table>
      <thead><tr><th>ƒåas</th><th>Stav</th></tr></thead>
      <tbody id="myAttendanceBody"><tr><td colspan="2">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </div>

  <div class="table-section" id="breaks">
    <h2>Prest√°vky</h2>
    <button class="export-btn" onclick="exportMyData()">Export do Excel</button>
    <table>
      <thead><tr><th>ƒåas</th></tr></thead>
      <tbody id="myBreaksBody"><tr><td>≈Ωiadne prest√°vky</td></tr></tbody>
    </table>
  </div>

  <div class="table-section" id="pn">
    <h2>PN</h2>
    <button class="export-btn" onclick="exportMyData()">Export do Excel</button>
    <table>
      <thead><tr><th>ƒåas</th></tr></thead>
      <tbody id="myPNBody"><tr><td>≈Ωiadne PN</td></tr></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYp0g",
  authDomain: "maturita-395fd.firebaseapp.com",
  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
  projectId: "maturita-395fd",
  storageBucket: "maturita-395fd.firebasestorage.app",
  messagingSenderId: "754745500563",
  appId: "1:754745500563:web:74fd4d6ab5765ee788be66"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const userId = localStorage.getItem("uid");
const myAttendanceBody = document.getElementById("myAttendanceBody");
const myBreaksBody = document.getElementById("myBreaksBody");
const myPNBody = document.getElementById("myPNBody");
const userNameEl = document.getElementById("userName");
const filterDate = document.getElementById("filterDate");
const statusBox = document.getElementById("statusBox");

if(!userId){
  alert("Nie si prihl√°sen√Ω!");
  window.location.href = "index.html";
} else if(userId === "admin"){
  window.location.href = "admin.html";
}

async function loadUserData() {
  try {
    const snap = await get(ref(db, "users/" + userId));
    if(!snap.exists()){
      alert("Pou≈æ√≠vateƒæ nen√°jden√Ω!");
      window.location.href = "index.html";
      return;
    }
    const userData = snap.val();
    userNameEl.textContent = userData.name || "(bez mena)";
    const chipUid = userData.chipUid;
    if(!chipUid){
      statusBox.textContent = "ƒåip nie je priraden√Ω!";
      renderTables([]);
      return;
    }

    const logsSnap = await get(ref(db, "dochadzka/" + chipUid));
    let records = [];
    if(logsSnap.exists()){
      logsSnap.forEach(childSnap => {
        if(childSnap.key !== "posledny_stav"){
          const rec = childSnap.val();
          records.push({cas: rec.cas, stav: rec.typ.toUpperCase()});
        }
      });
      records.sort((a,b) => new Date(b.cas) - new Date(a.cas));
      if(records.length>0){
        statusBox.textContent = "Posledn√Ω stav: " + records[0].stav;
      } else {
        statusBox.textContent = "≈Ωiadny stav nezaznamenan√Ω.";
      }
    } else {
      statusBox.textContent = "≈Ωiadne z√°znamy v datab√°ze.";
    }
    renderTables(records);

  } catch(e){
    console.error(e);
    statusBox.textContent = "Chyba pri naƒç√≠tan√≠ d√°t!";
    renderTables([]);
  }
}

function renderTables(allRecords){
  let filtered = allRecords;
  if(filterDate.value){
    filtered = filtered.filter(r => r.cas.startsWith(filterDate.value));
  }

  const attendance = filtered.filter(r => ["PRICHOD","ODCHOD"].includes(r.stav));
  if(!attendance.length) myAttendanceBody.innerHTML = "<tr><td colspan='2'>≈Ωiadne z√°znamy</td></tr>";
  else myAttendanceBody.innerHTML = attendance.map(z=>{
    const cls = z.stav==="PRICHOD"?"status-prichod":"status-odchod";
    return `<tr><td>${z.cas}</td><td class="${cls}">${z.stav}</td></tr>`;
  }).join("");

  const breaks = filtered.filter(r => r.stav==="PRESTAVKA");
  if(!breaks.length) myBreaksBody.innerHTML = "<tr><td>≈Ωiadne prest√°vky</td></tr>";
  else myBreaksBody.innerHTML = breaks.map(z=>`<tr><td class="status-prestavka">${z.cas}</td></tr>`).join("");

  const pn = filtered.filter(r => r.stav==="PN");
  if(!pn.length) myPNBody.innerHTML = "<tr><td>≈Ωiadne PN</td></tr>";
  else myPNBody.innerHTML = pn.map(z=>`<tr><td class="status-pn">${z.cas}</td></tr>`).join("");
}

filterDate.addEventListener("change", ()=> loadUserData());

document.getElementById("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem("uid");
  window.location.href="index.html";
});

window.exportMyData = function() {
  const userName = userNameEl.textContent;
  const data = [
    ["Zamestnanec", userName],
    ["Posledn√Ω stav", statusBox.textContent],
    [],
    ["Doch√°dzka (Pr√≠chod / Odchod)"], ["ƒåas","Stav"],
    ...Array.from(document.querySelectorAll("#myAttendanceBody tr")).map(tr=>Array.from(tr.querySelectorAll("td")).map(td=>td.textContent)),
    [], ["Prest√°vky"], ["ƒåas"],
    ...Array.from(document.querySelectorAll("#myBreaksBody tr")).map(tr=>Array.from(tr.querySelectorAll("td")).map(td=>td.textContent)),
    [], ["PN"], ["ƒåas"],
    ...Array.from(document.querySelectorAll("#myPNBody tr")).map(tr=>Array.from(tr.querySelectorAll("td")).map(td=>td.textContent))
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Moja Doch√°dzka");
  XLSX.writeFile(wb, `Dochadzka_${userName}.xlsx`);
}

loadUserData();

document.querySelectorAll("nav button").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".table-section").forEach(sec=>sec.classList.remove("active"));
    document.getElementById(btn.dataset.target).classList.add("active");
  }
});
</script>
</body>
</html>
