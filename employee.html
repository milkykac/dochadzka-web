<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dochádzkový systém</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOSÚLADENÉ ŠTÝLY S ADMIN PANELOM --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; display:flex; flex-direction:column; align-items:center;}
header { background:#007bff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; color:white; position:sticky; top:0; z-index:10; }
h1 { margin:0; font-size:22px; font-weight:700; }
header button { background:#fff; border:none; color:#007bff; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
header button:hover { background:#e2e6ea; }

nav { background:#fff; display:flex; justify-content:center; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:65px; z-index:5; flex-wrap:wrap; width:100%; max-width:1100px; border-radius:0 0 12px 12px; }
nav button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
nav button.active { background:#6f42c1; }
nav button:hover { background:#0056b3; }

section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; width:95%; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; font-weight:600; }

/* OPRAVENÉ ŠTÝLY PRE TABUĽKU */
table { 
    width:100%; 
    border-collapse:collapse; 
    margin-top:15px; 
    border-radius:8px; 
    overflow:hidden; 
    border: 1px solid #ddd; /* Hlavný vonkajší rám, ak je border-collapse */
}

th,td { 
    border:1px solid #ddd; 
    padding:10px; 
    text-align:center; 
    font-size:14px; 
    color: #333; 
}
th { background:#007bff; color:white; font-weight:600; }
tr:nth-child(even){ background:#f8f9fa; }

/* Tlačidlo premenované na Exportovať do XLSX */
.export-btn{ margin-top:15px; background:#28a745; border:none; color:white; border-radius:8px; padding:8px 14px; cursor:pointer; font-weight:600; }
.export-btn:hover{ background:#1e7e34; }

/* Status box je teraz modrý, aby sa hodil k téme */
.status-box { background:#e9f2ff; color:#007bff; font-weight:600; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; border:1px solid #007bff;}

.filter { margin-top: 10px; }
.filter input { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }

#debugUid { background:#d1ecf1;color:#0c5460;padding:5px;text-align:center;font-size:12px;margin-bottom:10px; border-radius: 4px;}

/* --- ŠTÝLY PRE FAREBNÉ PILULKY (ODZNAKY) --- */
.status-badge {
    font-weight: 700 !important;
    padding: 7px 14px !important;
    border-radius: 50px !important; /* Tvar pilulky */
    display: inline-block;
    text-align: center;
    min-width: 80px;
    white-space: nowrap;
    text-shadow: none !important; 
    color: white !important;
    font-size: 14px !important;
}
/* Menší štýl pilulky pre Prestávky/PN v jedinom stĺpci */
.status-badge.small {
    padding: 4px 10px !important;
    min-width: 60px;
    font-size: 11px !important;
    margin-left: 10px;
}
.status-prichod { 
    background: #198754 !important; /* Zelená */
} 
.status-odchod { 
    background: #dc3545 !important; /* Červená */
} 
.status-prestavka { 
    background: #ffc107 !important; /* Žltá */
    color: #212529 !important; /* Tmavý text na žltej */
}
.status-pn { 
    background: #6f42c1 !important; /* Fialová */
} 
/* ----------------------------------- */

/* Logický kontajner pre dochádzku */
#dochadzkaContainer {
    display: flex;
    justify-content: space-between;
    gap: 20px;
}
#dochadzkaLog, #dochadzkaSummary {
    flex: 1;
}
#dochadzkaLog h3, #dochadzkaSummary h3 {
    color: #007bff;
}
@media (max-width: 768px) {
    #dochadzkaContainer {
        flex-direction: column;
    }
}
</style>
</head>
<body>

<header>
  <h1>Dochádzkový systém</h1>
  <button id="logoutButton" onclick="logout()">Odhlásiť sa</button>
</header>

<nav>
  <button data-target="dochadzka" class="active">Dochádzka</button>
  <button data-target="prestavky">Prestávky</button>
  <button data-target="pn">PN</button>
  <button data-target="nastavenia">Nastavenia</button>
</nav>

<section id="dochadzka" class="active">
  <h2>Denná dochádzka</h2>
  
  <div id="dochadzkaContainer">
    <div id="dochadzkaLog">
      <h3>Všetky záznamy</h3>
      <div class="filter">
        <input type="date" id="dateDochadzka" onchange="loadDochadzka()">
      </div>
      <div id="dochadzkaTable" class="loader">Načítavam dochádzku...</div>
    </div>
    
    <div id="dochadzkaSummary">
      <h3>Sumár za mesiac</h3>
      <div class="status-box" id="summaryBox">
        <strong>Pracovný čas:</strong> <span id="workTime">00:00</span><br>
        <strong>Prestávky:</strong> <span id="breakTime">00:00</span><br>
        <strong>PN dni:</strong> <span id="pnDays">0</span>
      </div>
      <button class="export-btn" onclick="exportData('dochadzka')">Exportovať do XLSX</button>
    </div>
  </div>
</section>

<section id="prestavky">
  <h2>Záznamy prestávok</h2>
  <div class="filter">
    <input type="date" id="datePrestavky" onchange="loadSection('prestavky')">
  </div>
  <div id="prestavkyTable" class="loader">Načítavam prestávky...</div>
  <button class="export-btn" onclick="exportData('prestavky')">Exportovať do XLSX</button>
</section>

<section id="pn">
  <h2>Záznamy PN</h2>
  <div class="filter">
    <input type="date" id="datePN" onchange="loadSection('pn')">
  </div>
  <div id="pnTable" class="loader">Načítavam PN záznamy...</div>
  <button class="export-btn" onclick="exportData('pn')">Exportovať do XLSX</button>
</section>

<section id="nastavenia">
  <h2>Nastavenia konta</h2>
  <div class="status-box" id="userInfoBox">
    Meno: <strong id="userName"></strong><br>
    UID: <strong id="debugUid"></strong>
  </div>
  
  <h3>Zmena hesla</h3>
  <input type="password" id="oldPassword" placeholder="Staré heslo" style="width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;">
  <input type="password" id="newPassword1" placeholder="Nové heslo" style="width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;">
  <input type="password" id="newPassword2" placeholder="Zopakujte nové heslo" style="width:100%; padding:10px; margin-bottom:15px; border-radius:6px; border:1px solid #ccc;">
  <button onclick="changePassword()" style="background:#6f42c1; padding:10px 20px; border-radius:8px; font-weight:600;">Zmeniť heslo</button>
</section>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// !!! NAHRADTE TOTO VLASTNYMI UDAJMI Z FIREBASE !!!
const firebaseConfig = {
  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
  authDomain: "maturita-395fd.firebaseapp.com",
  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
  projectId: "maturita-395fd",
  storageBucket: "maturita-395fd.firebasestorage.app",
  messagingSenderId: "754745500563",
  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const userId = localStorage.getItem("uid");
let userRef;
let userRecordsCache = { dochadzka: [], prestavky: [], pn: [] };
let cachedUserName = "";

// Inicializácia a overenie prihlásenia
document.addEventListener('DOMContentLoaded', () => {
    if (!userId || userId === "admin") {
        alert("Najprv sa prihláste.");
        window.location.href = "login.html";
        return;
    }

    userRef = ref(db, `users/${userId}`);
    
    // Prepínanie sekcií
    document.querySelectorAll("nav button").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
            document.getElementById(btn.dataset.target).classList.add("active");
            
            if (btn.dataset.target === "dochadzka") loadDochadzka();
            else if (btn.dataset.target === "nastavenia") loadSettings();
            else window.loadSection(btn.dataset.target);
        });
    });

    // Spustenie
    fetchAllRecords();
});

// Funkcia na konverziu ms na HH:MM
function msToHhMm(ms) {
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// 1. NAČÍTANIE A PARSOVANIE VŠETKÝCH ZÁZNAMOV DO CACHE
async function fetchAllRecords() {
    try {
        const snap = await get(userRef);
        if (!snap.exists()) {
            alert("Účet neexistuje.");
            return logout();
        }
        const userData = snap.val();
        cachedUserName = userData.name || "Používateľ";

        // Reset cache
        userRecordsCache = { dochadzka: [], prestavky: [], pn: [] };

        ["dochadzka", "prestavky", "pn"].forEach(type => {
            const logsObj = userData[type] || {};
            Object.values(logsObj).forEach(log => {
                if (!log || !log.cas || !log.typ) return;

                let cleanTime = String(log.cas);
                let validIsoTime = cleanTime;

                // Normalizácia dátumu/času
                const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
                const match = cleanTime.match(dateRegex);

                if (match) {
                    const [full, day, month, year, time] = match;
                    validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
                } else if (cleanTime.includes('T') && cleanTime.includes('-')) {
                    validIsoTime = cleanTime.replace('T', ' ');
                } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
                    validIsoTime = cleanTime;
                } else {
                    return;
                }

                // Normalizácia typu na malú abecedu bez diakritiky
                const cleanType = String(log.typ).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); 
                let recordType = null;
                if (cleanType.includes('prichod')) recordType = 'prichod';
                else if (cleanType.includes('odchod')) recordType = 'odchod';
                else if (cleanType.includes('prestavka')) recordType = 'prestavka';
                else if (cleanType.includes('pn')) recordType = 'pn';

                if (recordType) {
                    // Pridanie do správnej cache
                    const cacheKey = { prichod: "dochadzka", odchod: "dochadzka", prestavka: "prestavky", pn: "pn" }[recordType];

                    userRecordsCache[cacheKey].push({
                        cas: validIsoTime, // Pre triedenie/filtrovanie
                        casDisplay: cleanTime, // Pôvodný formát pre zobrazenie
                        date: validIsoTime.substring(0, 10), // YYYY-MM-DD
                        time: validIsoTime.substring(11, 16), // HH:MM
                        stav: recordType, // Normalizovaný stav pre CSS
                        rawType: log.typ.toUpperCase() // Pôvodný typ s diakritikou pre zobrazenie
                    });
                }
            });
        });

        // Triedenie všetkých cache
        for (const key in userRecordsCache) {
            userRecordsCache[key].sort((a, b) => new Date(b.cas) - new Date(a.cas));
        }
        
        // Po načítaní dát spustíme predvolenú sekciu
        loadDochadzka();

    } catch (e) {
        console.error("Chyba pri načítaní dát:", e);
        alert("Chyba pri načítaní dát z databázy.");
    }
}


// 2. LOGIKA PRE SEKCIU DOCHÁDZKA (VRÁTANE SUMÁRU)
async function loadDochadzka() {
    const dateFilter = document.getElementById("dateDochadzka").value || "";
    const logEl = document.getElementById("dochadzkaTable");
    logEl.innerHTML = "Načítavam dáta...";

    const records = userRecordsCache.dochadzka;
    const breakRecords = userRecordsCache.prestavky;
    const pnRecords = userRecordsCache.pn;

    // --------------------
    // A. Sumarizácia (vždy za celý mesiac)
    // --------------------
    const today = new Date();
    const currentMonth = today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, '0');
    
    let totalWorkMs = 0;
    let lastPrichod = null;
    
    // Vypočítame odpracovaný čas
    records.forEach(record => {
        if (!record.cas.startsWith(currentMonth)) return;
        
        const currentTime = new Date(record.cas);
        
        if (record.stav === 'prichod') {
            lastPrichod = currentTime;
        } else if (record.stav === 'odchod' && lastPrichod) {
            totalWorkMs += currentTime - lastPrichod;
            lastPrichod = null;
        }
    });

    // Vypočítame celkový čas prestávok (za mesiac)
    let totalBreakMs = 0;
    breakRecords.forEach(record => {
        if (!record.cas.startsWith(currentMonth)) return;
        // Predpokladáme, že každý záznam "Prestávka" trvá 30 minút
        totalBreakMs += 30 * 60 * 1000;
    });
    
    // Vypočítame PN dni (za mesiac)
    const pnDates = new Set();
    pnRecords.forEach(record => {
        if (record.cas.startsWith(currentMonth)) {
            pnDates.add(record.date);
        }
    });
    const pnDaysCount = pnDates.size;
    
    document.getElementById("workTime").textContent = msToHhMm(totalWorkMs);
    document.getElementById("breakTime").textContent = msToHhMm(totalBreakMs);
    document.getElementById("pnDays").textContent = pnDaysCount;


    // --------------------
    // B. Log záznamov (filtrovaný dátumom)
    // --------------------
    const filteredRecords = records.filter(r => !dateFilter || r.date === dateFilter);
    
    let html="<table><tr><th>Dátum</th><th>Čas</th><th>Typ</th></tr>";
    let entriesFound = false;

    filteredRecords.forEach(log => {
        entriesFound = true;
        const logTypNormalized = log.stav;
        const rawType = log.rawType;
        
        const statusClass = 'status-' + logTypNormalized;
        
        html += `<tr>
            <td>${log.date || '-'}</td>
            <td>${log.time || '-'}</td>
            <td><span class="status-badge ${statusClass}">${rawType}</span></td>
          </tr>`;
    });
    
    if (!entriesFound) {
        html += '<tr><td colspan="3">Žiadne záznamy podľa filtra.</td></tr>';
    }
    
    html += "</table>";
    logEl.innerHTML = html;
}

// 3. LOGIKA PRE SEKCIE PRESTÁVKY A PN
window.loadSection = function(type){
    const dateId = `date${type.charAt(0).toUpperCase() + type.slice(1)}`;
    const tableId = `${type}Table`;
    const dateFilter = document.getElementById(dateId)?.value || "";
    const el = document.getElementById(tableId);

    el.innerHTML = "Načítavam dáta...";

    const records = userRecordsCache[type].filter(r => !dateFilter || r.date === dateFilter);
    
    let html=`<table><tr><th>Dátum</th><th>Čas</th><th>Typ</th></tr>`;
    let entriesFound = false;

    records.forEach(log => {
        entriesFound = true;
        const logTypNormalized = log.stav;
        const rawType = log.rawType;
        
        const statusClass = 'status-' + logTypNormalized;
        
        html += `<tr>
            <td>${log.date || '-'}</td>
            <td>${log.time || '-'}</td>
            <td><span class="status-badge ${statusClass}">${rawType}</span></td>
          </tr>`;
    });
    
    if (!entriesFound) {
        html += '<tr><td colspan="3">Žiadne záznamy podľa filtra.</td></tr>';
    }
    
    html += "</table>";
    el.innerHTML = html;
};

// 4. NASTAVENIA A ZMENA HESLA
async function loadSettings() {
    document.getElementById("userName").textContent = cachedUserName;
    document.getElementById("debugUid").textContent = userId;
}

window.changePassword = async function() {
    const oldPass = document.getElementById("oldPassword").value;
    const newPass1 = document.getElementById("newPassword1").value;
    const newPass2 = document.getElementById("newPassword2").value;
    
    if (newPass1 !== newPass2) {
        alert("Nové heslá sa nezhodujú.");
        return;
    }
    if (newPass1.length < 4) {
        alert("Nové heslo musí mať aspoň 4 znaky.");
        return;
    }
    
    try {
        // Overenie starého hesla
        const snap = await get(child(userRef, 'password'));
        const currentPass = snap.val();
        
        if (currentPass !== oldPass) {
            alert("Zadané staré heslo je nesprávne.");
            return;
        }
        
        // Zmena hesla
        await set(child(userRef, 'password'), newPass1);
        
        alert("Heslo bolo úspešne zmenené!");
        document.getElementById("oldPassword").value = "";
        document.getElementById("newPassword1").value = "";
        document.getElementById("newPassword2").value = "";
    } catch (e) {
        console.error("Chyba pri zmene hesla:", e);
        alert("Chyba pri komunikácii s databázou.");
    }
};

// 5. EXPORT
window.exportData = async function(type) {
    const btn = document.querySelector(`#${type} .export-btn`);
    if(btn) btn.textContent = "Generujem XLSX...";
    
    const records = userRecordsCache[type].map(r => [r.date, r.time, r.rawType]);
    const header = ["Dátum", "Čas", "Typ"];
    
    let exportArray = [
        [`Export ${type.toUpperCase()}`],
        [`Používateľ: ${cachedUserName}`],
        [],
        header,
        ...records
    ];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(exportArray);
    ws['!cols'] = [{ wpx: 120 }, { wpx: 100 }, { wpx: 100 }];
    XLSX.utils.book_append_sheet(wb, ws, type.charAt(0).toUpperCase() + type.slice(1));
    
    XLSX.writeFile(wb, `${type}_${cachedUserName}_export.xlsx`);
    
    if(btn) {
        btn.textContent = "Súbor stiahnutý!";
        setTimeout(() => btn.textContent = "Exportovať do XLSX", 2000);
    }
};

// 6. ODHLÁSENIE
window.logout = () => { localStorage.removeItem("uid"); window.location.href="login.html"; };
</script>
</body>
</html>
