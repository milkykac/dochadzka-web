<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doch√°dzka ‚Äì Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOS√öLADEN√â ≈†T√ùLY S ADMIN PANELOM --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; display:flex; flex-direction:column; align-items:center;}
header { background:#007bff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; color:white; position:sticky; top:0; z-index:10; }
h1 { margin:0; font-size:22px; font-weight:700; }
header button { background:#fff; border:none; color:#007bff; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
header button:hover { background:#e2e6ea; }

nav { background:#fff; display:flex; justify-content:center; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:65px; z-index:5; flex-wrap:wrap; width:100%; max-width:1100px; border-radius:0 0 12px 12px; }
nav button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
nav button.active { background:#6f42c1; }
nav button:hover { background:#0056b3; }

section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; width:95%; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; font-weight:600; }

/* OPRAVA: Zabezpeƒçenie, aby tabuƒæka nemala okraje medzi riadkami */
table { 
    width:100%; 
    border-collapse:collapse; /* Toto zabezpeƒçuje, ≈æe okraje buniek sa spoja */
    margin-top:15px; 
    border-radius:8px; 
    overflow:hidden; 
    border: none; /* √öpln√© zru≈°enie hlavn√©ho okraja tabuƒæky */
}

/* OPRAVA: Pou≈æ√≠vame len 1px okraj len pre vizu√°lne rozdelenie stƒ∫pcov a riadkov */
th,td { 
    border:1px solid #ddd; 
    padding:10px; 
    text-align:center; 
    font-size:14px; 
    color: #333; 
}
/* ≈†peci√°lne nastavenie pre bunky (td), aby riadky neboli oddelen√© dvojit√Ωm okrajom */
td {
    border-top: none; /* Odstr√°nime horn√Ω okraj na bunk√°ch */
    border-bottom: 1px solid #ddd; /* Ponech√°me spodn√Ω okraj pre delenie riadkov */
}
/* Prv√Ω riadok v tele tabuƒæky mus√≠ ma≈• horn√Ω okraj */
tbody tr:first-child td {
    border-top: 1px solid #ddd;
}
/* Posledn√Ω riadok v tele tabuƒæky */
tbody tr:last-child td {
    border-bottom: none;
}
th { background:#007bff; color:white; font-weight:600; }
tr:nth-child(even){ background:#f8f9fa; }

/* Tlaƒçidlo premenovan√© na Exportova≈• do XLSX */
.export-btn{ background:#28a745; border:none; color:white; border-radius:8px; padding:10px 18px; cursor:pointer; font-weight:600; transition: background 0.2s;}
.export-btn:hover{ background:#1e7e34; }
.export-btn:disabled { background: #adb5bd; cursor: not-allowed; }

/* NOV√â ≈†T√ùLY PRE AKƒåN√â TLAƒåIDL√Å */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    justify-content: center;
}
.action-buttons .export-btn {
    font-size: 16px;
    padding: 12px 25px;
    min-width: 150px;
}
#actionPrichod { background: #198754; } /* Zelen√° */
#actionPrichod:hover:not(:disabled) { background: #157347; }
#actionOdchod { background: #dc3545; } /* ƒåerven√° */
#actionOdchod:hover:not(:disabled) { background: #bb2d3b; }
#actionPrestavka { background: #ffc107; color: #333; } /* ≈Ωlt√° */
#actionPrestavka:hover:not(:disabled) { background: #ffae19; }
/* KONIEC NOV√ùCH ≈†T√ùLOV */


/* Status box je teraz modr√Ω, aby sa hodil k t√©me */
.status-box { background:#e9f2ff; color:#007bff; font-weight:600; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; border:1px solid #007bff; font-size: 18px;}

.filter { margin-top: 10px; margin-bottom: 10px; text-align: left; }
.filter label { font-weight: 600; color: #6f42c1; margin-right: 10px; }
.filter input { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }

#debugUid { background:#d1ecf1;color:#0c5460;padding:5px;text-align:center;font-size:12px;margin-bottom:10px; border-radius: 4px;}

/* --- ≈†T√ùLY PRE FAREBN√â PILULKY (ODZNAKY) --- */
.status-badge {
    font-weight: 700 !important;
    padding: 7px 14px !important;
    border-radius: 50px !important; /* Tvar pilulky */
    display: inline-block;
    text-align: center;
    min-width: 80px;
    white-space: nowrap;
    text-shadow: none !important; 
    color: white !important;
    font-size: 14px !important;
}
/* Men≈°√≠ ≈°t√Ωl pilulky pre Prest√°vky/PN v jedinom stƒ∫pci */
.status-badge.small {
    padding: 4px 10px !important;
    min-width: 60px;
    font-size: 11px !important;
    margin-left: 10px;
}
.status-prichod { 
    background: #198754 !important; /* Zelen√° */
} 
.status-odchod { 
    background: #dc3545 !important; /* ƒåerven√° */
} 
.status-prestavka { 
    background: #ffc107 !important; /* ≈Ωlt√° */
    color: #212529 !important; /* Tmav√Ω text na ≈æltej */
}
.status-pn { 
    background: #6f42c1 !important; /* Fialov√° */
} 
/* SPINNER STYLE */
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 10px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
</head>
<body>

<header>
    <h1>üëã Vitaj, <span id="userName">Zamestnanec</span></h1>
    <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<div id="debugUid">Naƒç√≠tavam UID...</div>

<nav>
    <button data-target="dochadzka" class="active">Doch√°dzka</button>
    <button data-target="prestavky">Prest√°vky</button>
    <button data-target="pn">PN</button>
</nav>

<section id="dochadzka" class="active">
    <div id="statusBox" class="status-box">Naƒç√≠tavam stav...</div>
    
    <div class="action-buttons">
        <button id="actionPrichod" class="export-btn">PR√çCHOD</button>
        <button id="actionOdchod" class="export-btn">ODCHOD</button>
        <button id="actionPrestavka" class="export-btn">PREST√ÅVKA</button>
    </div>
    <h2>Doch√°dzka (Pr√≠chod/Odchod)</h2>
    <button class="export-btn" data-export-table="dochadzka" style="margin-bottom: 15px;">Exportova≈• do XLSX (s kalkul√°ciou)</button>
    <div class="filter">
        <label for="dateDochadzka">Filtrova≈• podƒæa d√°tumu:</label>
        <input type="date" id="dateDochadzka">
    </div>
    <table>
        <thead><tr><th>ƒåas</th><th>Typ</th></tr></thead>
        <tbody id="dochadzkaTable"><tr><td colspan="2"><span class="spinner"></span> Naƒç√≠tavam d√°ta...</td></tr></tbody>
    </table>
</section>

<section id="prestavky">
    <h2>Prest√°vky</h2>
    <button class="export-btn" data-export-table="prestavky" style="margin-bottom: 15px;">Exportova≈• do XLSX</button>
    <div class="filter">
        <label for="datePrestavky">Filtrova≈• podƒæa d√°tumu:</label>
        <input type="date" id="datePrestavky">
    </div>
    <table>
        <thead><tr><th>D√°tum</th><th>ƒåas</th><th>Typ</th></tr></thead>
        <tbody id="prestavkyTable"><tr><td colspan="3"><span class="spinner"></span> Naƒç√≠tavam d√°ta...</td></tr></tbody>
    </table>
</section>

<section id="pn">
    <h2>PN</h2>
    <button class="export-btn" data-export-table="pn" style="margin-bottom: 15px;">Exportova≈• do XLSX</button>
    <div class="filter">
        <label for="datePN">Filtrova≈• podƒæa d√°tumu:</label>
        <input type="date" id="datePN">
    </div>
    <table>
        <thead><tr><th>D√°tum</th><th>ƒåas</th><th>Typ</th></tr></thead>
        <tbody id="pnTable"><tr><td colspan="3"><span class="spinner"></span> Naƒç√≠tavam d√°ta...</td></tr></tbody>
    </table>
</section>

<script type="module">
// Pridan√© importy pre z√°pis do Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
    authDomain: "maturita-395fd.firebaseapp.com",
    databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
    projectId: "maturita-395fd",
    storageBucket: "maturita-395fd.firebasestorage.app",
    messagingSenderId: "754745500563",
    appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
    measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Glob√°lne premenn√©
const userId = localStorage.getItem("uid");
const userNameEl = document.getElementById("userName");
const statusBox = document.getElementById("statusBox");
const debugUidEl = document.getElementById("debugUid"); 
let allRecordsCache = []; // Z√°sobn√≠k v≈°etk√Ωch z√°znamov
let lastMainStatus = null; // Pr√≠chod/Odchod/null
let lastOverallStatus = null; // Pr√≠chod/Odchod/Prest√°vka/PN/null

// --- Overenie a presmerovanie ---
if (!userId) {
    alert("Nie si prihl√°sen√Ω!");
    window.location.href = "index.html";
} else if (userId === "admin") {
    window.location.href = "admin.html";
} else {
    debugUidEl.textContent = `Aktu√°lne naƒç√≠tan√© UID: ${userId}`;
}


// --- POMOCN√Å FUNKCIA: Normaliz√°cia ƒçasu ---
/**
 * Konvertuje re≈•azec ƒçasu (DD.MM.YYYY HH:MM alebo ISO) na objekt s potrebn√Ωmi form√°tmi.
 */
function normalizeTime(cleanTime) {
    if (!cleanTime) return null;
    cleanTime = String(cleanTime);
    let validIsoTime = cleanTime;
    let displayTime = cleanTime; 

    const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
    const match = cleanTime.match(dateRegex);

    if (match) {
        const [full, day, month, year, time] = match;
        validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
        displayTime = `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year} ${time}`;
    } else if (cleanTime.includes('T') && cleanTime.includes('-')) {
        validIsoTime = cleanTime.replace('T', ' ').substring(0, 16); 
        const [date, time] = validIsoTime.split(' ');
        const [y, m, d] = date.split('-');
        displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
    } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
        validIsoTime = cleanTime.substring(0, 16);
        const [date, time] = validIsoTime.split(' ');
        const [y, m, d] = date.split('-');
        displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
    } else {
        return null;
    }
    
    return {
        iso: validIsoTime,
        display: displayTime,
        date: displayTime.substring(0, 10),
        time: displayTime.substring(11, 16)
    };
}


// --- Z√ÅPIS D√ÅT: Spracovanie kliknutia na akƒçn√© tlaƒçidlo ---
async function handleActionClick(actionType) {
    const now = new Date();
    // Vytvor√≠me ƒçasov√∫ zn√°mku v ISO form√°te pre jednoduch√© triedenie vo Firebase
    const cas = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' + 
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0');

    const logData = {
        cas: cas,
        typ: actionType, // prichod, odchod, prestavka
        // timestamp: Date.now() // voliteƒæn√©
    };

    // Urƒçenie cesty pre z√°pis (napr. pre doch√°dzku, prest√°vky, PN)
    let firebasePath = `users/${userId}/dochadzka`; 
    if (actionType === 'prestavka') firebasePath = `users/${userId}/prestavky`;
    // Ak by sme potrebovali zaznamen√°va≈• PN priamo z tohto panela, bola by tu aj PN logika.
    
    try {
        // --- Simul√°cia z√°pisu ---
        alert(`Simulujem z√°pis: ${actionType.toUpperCase()} o ${logData.cas}. Pre pln√∫ funkƒçnos≈• je potrebn√© re√°lne volanie push().`);
        // await push(ref(db, firebasePath), logData); 
        // --- Koniec simul√°cie ---
        
        await loadUserData(); // Prekresl√≠ UI s nov√Ωmi d√°tami (aj keƒè len simulovan√Ωmi)
    } catch (e) {
        alert("Chyba pri z√°pise do datab√°zy: " + e.message);
        console.error("Chyba pri z√°pise do datab√°zy:", e);
    }
}


// --- AKTUALIZ√ÅCIA STAVU A TLAƒåIDIEL ---
function updateStatusAndButtons() {
    const actionPrichodBtn = document.getElementById("actionPrichod");
    const actionOdchodBtn = document.getElementById("actionOdchod");
    const actionPrestavkaBtn = document.getElementById("actionPrestavka");
    
    // Vynulovanie pre dynamick√© nastavenie
    actionPrichodBtn.disabled = true;
    actionOdchodBtn.disabled = true;
    actionPrestavkaBtn.disabled = true;
    actionPrestavkaBtn.textContent = "PREST√ÅVKA"; 

    // 1. Priorita: PN (ak je posledn√Ω stav PN, nem√¥≈æe sa logova≈• niƒç in√©)
    if (lastOverallStatus === 'pn') {
        statusBox.innerHTML = `Posledn√Ω stav: **PN** ü§í (Nem√¥≈æete sa zaznamena≈•)`;
    } 
    // 2. Priorita: Prest√°vka (ak je vo vn√∫tri a posledn√Ω z√°znam je prest√°vka)
    else if (lastOverallStatus === 'prestavka' && lastMainStatus === 'prichod') {
        statusBox.innerHTML = `Posledn√Ω stav: **NA PREST√ÅVKE** ‚òï`;
        actionPrestavkaBtn.textContent = "KONIEC PREST√ÅVKY";
        actionPrestavkaBtn.disabled = false;
        actionOdchodBtn.disabled = false; // Povoli≈• ODCHOD aj z prest√°vky
    }
    // 3. Priorita: V Pr√°ci (Prichod)
    else if (lastMainStatus === 'prichod') {
        statusBox.innerHTML = `Posledn√Ω stav: **V PR√ÅCI** ‚úÖ`;
        actionOdchodBtn.disabled = false;
        actionPrestavkaBtn.textContent = "PREST√ÅVKA";
        actionPrestavkaBtn.disabled = false;
    } 
    // 4. Priorita: Mimo Pr√°ce (Odchod alebo ≈Ωiadny z√°znam)
    else { 
        statusBox.innerHTML = `Posledn√Ω stav: **ODHL√ÅSEN√ù** üè†`;
        actionPrichodBtn.disabled = false;
    }
}


// --- Naƒç√≠tanie d√°t pou≈æ√≠vateƒæa z Firebase ---
async function loadUserData() {
    // Vizu√°lna sp√§tn√° v√§zba (spinner)
    document.getElementById("dochadzkaTable").innerHTML = `<tr><td colspan="2"><span class="spinner"></span> Naƒç√≠tavam d√°ta...</td></tr>`;

    try {
        const userSnap = await get(ref(db, `users/${userId}`));
        
        if (!userSnap.exists()) {
            userNameEl.textContent = "(Nezn√°my)";
            debugUidEl.style.backgroundColor = '#dc3545';
            debugUidEl.style.color = 'white';
            debugUidEl.textContent = `CHYBA: D√°ta pre UID ${userId} neexistuj√∫!`;
            renderTables([]);
            return;
        }

        const userData = userSnap.val();
        userNameEl.textContent = userData.name || "(bez mena)";

        const records = [];
        const allPossibleLogs = [];
        
        // Zber z√°znamov (Dochadzka, prestavky, pn)
        ["dochadzka", "prestavky", "pn"].forEach(type => {
            const logsObj = userData[type] || {};
            Object.values(logsObj).forEach(log => allPossibleLogs.push(log));
        });
        
        // Spracovanie a normaliz√°cia ƒçasu
        allPossibleLogs.forEach(log => {
            if (!log || !log.cas || !log.typ) return;

            const normalized = normalizeTime(log.cas);
            if (!normalized) return; 
            
            const cleanType = String(log.typ)
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
                .toLowerCase();

            let recordType = null;
            if (cleanType.includes('prichod')) recordType = 'prichod';
            else if (cleanType.includes('odchod')) recordType = 'odchod';
            else if (cleanType.includes('prestavka')) recordType = 'prestavka';
            else if (cleanType.includes('pn')) recordType = 'pn';
            
            if (recordType) {
                const isDuplicate = records.some(r => r.cas === normalized.iso && r.stav === recordType);
                if (!isDuplicate) {
                    records.push({
                        cas: normalized.iso, 
                        casDisplay: normalized.display,
                        stav: recordType,
                        date: normalized.date,
                        time: normalized.time
                    });
                }
            }
        });

        // Triedenie pre zobrazenie na str√°nke (Najnov≈°ie prv√©)
        records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
        allRecordsCache = records;
        
        // AKTUALIZ√ÅCIA STAVU PRE TLAƒåIDL√Å
        const sortedMainRecords = records.filter(r => r.stav === 'prichod' || r.stav === 'odchod');
        lastMainStatus = sortedMainRecords.length ? sortedMainRecords[0].stav : null;
        lastOverallStatus = records.length ? records[0].stav : null; 
        
        updateStatusAndButtons();

        // Vykreslenie
        renderTables(allRecordsCache);

    } catch (e) {
        console.error("Kritick√° chyba pri naƒç√≠tan√≠ d√°t:", e);
        statusBox.textContent = "Kritick√° chyba pri naƒç√≠tan√≠ d√°t!";
        renderTables([]);
    }
}

// --- Vykreslenie tabuliek (S Pilulkami) ---
function renderTables(records) {
    const dochadzkaTable = document.getElementById("dochadzkaTable");
    const prestavkyTable = document.getElementById("prestavkyTable");
    const pnTable = document.getElementById("pnTable");

    const filterDochadzka = document.getElementById("dateDochadzka").value;
    const filterPrestavky = document.getElementById("datePrestavky").value;
    const filterPN = document.getElementById("datePN").value;

    const renderSection = (bodyEl, type, filterDate, expectedStav) => {
        let filtered = records;
        
        if(filterDate) {
            filtered = filtered.filter(r => r.cas.substring(0, 10) === filterDate);
        }
        
        const sectionRecords = filtered.filter(r => expectedStav.includes(r.stav));
        const colCount = (type === 'dochadzka') ? 2 : 3;

        if (!sectionRecords.length) {
            bodyEl.innerHTML = `<tr><td colspan="${colCount}">≈Ωiadne z√°znamy</td></tr>`;
        } else {
            bodyEl.innerHTML = sectionRecords.map(z => {
                const displayTime = z.casDisplay;

                let statusClass = '';
                if (z.stav === 'prichod') statusClass = 'status-prichod';
                else if (z.stav === 'odchod') statusClass = 'status-odchod';
                else if (z.stav === 'prestavka') statusClass = 'status-prestavka';
                else if (z.stav === 'pn') statusClass = 'status-pn';

                
                if (type === 'dochadzka') {
                    // Doch√°dzka: 2 stƒ∫pce (ƒåas a Typ)
                    return `<tr>
                        <td>${displayTime}</td>
                        <td><span class="status-badge ${statusClass}">${z.stav.toUpperCase()}</span></td>
                    </tr>`;
                } else {
                    // Prest√°vky a PN: 3 stƒ∫pce (D√°tum, ƒåas, Typ)
                    return `<tr>
                            <td>${z.date}</td>
                            <td>${z.time}</td>
                            <td><span class="status-badge small ${statusClass}">${z.stav.toUpperCase()}</span></td>
                        </tr>`;
                }
            }).join("");
        }
    };

    // Zavolanie funkcie
    renderSection(dochadzkaTable, 'dochadzka', filterDochadzka, ["prichod", "odchod"]);
    renderSection(prestavkyTable, 'prestavky', filterPrestavky, ["prestavka"]);
    renderSection(pnTable, 'pn', filterPN, ["pn"]);
}

// --- POMOCN√Å FUNKCIA: Konverzia milisek√∫nd na form√°t HH:MM ---
function msToHhMm(ms) {
    if (ms < 0) ms = 0; // O≈°etrenie z√°porn√©ho ƒçasu
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// --- HLAVN√Å FUNKCIA: Export do XLSX s vylep≈°enou KALKUL√ÅCIOU ---
window.exportTable = function(sectionType) {
    const userName = userNameEl.textContent;
    let filterDate, expectedStav, sectionTitle;
    let header; 
    let fileNameBase;

    // --- Krok 1: Definovanie filtrov a hlaviƒçiek ---
    if (sectionType === 'dochadzka') {
        filterDate = document.getElementById("dateDochadzka").value;
        expectedStav = ["prichod", "odchod"];
        sectionTitle = "Doch√°dzka a Sumariz√°cia (Prest√°vky odr√°tan√©)";
        header = ["D√°tum", "ƒåas", "Typ", "Odpracovan√Ω ƒças/Status"]; 
        fileNameBase = "dochadzka_sumar";
    } else if (sectionType === 'prestavky') {
        filterDate = document.getElementById("datePrestavky").value;
        expectedStav = ["prestavka"];
        sectionTitle = "Prest√°vky";
        header = ["D√°tum", "ƒåas", "Typ"]; // Zmenen√° hlaviƒçka
        fileNameBase = "prestavky_detail";
    } else if (sectionType === 'pn') {
        filterDate = document.getElementById("datePN").value;
        expectedStav = ["pn"];
        sectionTitle = "PN";
        header = ["D√°tum", "ƒåas", "Typ"]; // Zmenen√° hlaviƒçka
        fileNameBase = "pn_detail";
    } else {
        return alert("Nezn√°my typ sekcie pre export.");
    }
    
    // --- Krok 2: Filtr√°cia a triedenie d√°t pre kalkul√°ciu ---
    let filteredRecords = allRecordsCache;
    if(filterDate) {
        filteredRecords = filteredRecords.filter(r => r.cas.substring(0, 10) === filterDate);
    }
    
    // Pre export s kalkul√°ciou v Doch√°dzke mus√≠me triedi≈• od NAJSTAR≈†IEHO k NAJNOV≈†IEMU
    const sortedRecords = filteredRecords
        .filter(r => expectedStav.includes(r.stav))
        .sort((a, b) => new Date(a.cas) - new Date(b.cas));

    // --- Krok 3: Generovanie d√°tov√©ho poƒæa a KALKUL√ÅCIA ---
    const exportData = [
        ["Typ z√°znamu:", sectionTitle],
        ["Pou≈æ√≠vateƒæ:", userName],
        [], 
        header 
    ];
    
    let totalWorkMs = 0;
    let dailyWorkMs = 0;
    let workPairs = []; // Pou≈æijeme pre zhroma≈æƒèovanie Pr√≠chod-Odchod p√°rov
    let prestavkaLogs = filteredRecords.filter(r => r.stav === 'prestavka');

    if (sectionType === 'dochadzka') {
        
        let currentPair = { prichod: null, odchod: null };

        sortedRecords.forEach((record) => {
            const currentDateTime = new Date(record.cas);
            
            if (record.stav === 'prichod') {
                // Zaƒç√≠name nov√Ω p√°r
                if (currentPair.prichod) {
                    // Ak u≈æ je pr√≠chod a pri≈°iel ƒèal≈°√≠ pr√≠chod, znamen√° to ch√Ωbaj√∫ci odchod.
                    // Zaznamen√°me chybu pre predch√°dzaj√∫ci de≈à a zaƒçneme nov√Ω p√°r.
                    workPairs.push({ 
                        prichod: currentPair.prichod, 
                        odchod: currentPair.prichod, // Pou≈æijeme pr√≠chod ako "odchod" pre z√°pis d√°tumu, ale vypoƒç√≠tame nulu
                        status: "Chyba: Ch√Ωba odchod" 
                    });
                }
                currentPair.prichod = currentDateTime;
                exportData.push([record.date, record.time, record.stav.toUpperCase(), ""]);
            } else if (record.stav === 'odchod' && currentPair.prichod) {
                // Dokonƒç√≠me aktu√°lny p√°r
                currentPair.odchod = currentDateTime;
                workPairs.push({ 
                    prichod: currentPair.prichod, 
                    odchod: currentPair.odchod,
                    prichodData: record.date,
                    odchodData: record.time,
                    status: "OK" 
                });
                currentPair = { prichod: null, odchod: null }; // Reset pre ƒèal≈°√≠ p√°r
                exportData.push([record.date, record.time, record.stav.toUpperCase(), "ƒåak√° na kalkul√°ciu..."]);
            } else if (record.stav === 'odchod' && !currentPair.prichod) {
                // Odchod bez predch√°dzaj√∫ceho pr√≠chodu
                exportData.push([record.date, record.time, record.stav.toUpperCase(), "Chyba: Ch√Ωba pr√≠chod"]);
            }
        });
        
        // Ak posledn√Ω p√°r zostal otvoren√Ω
        if (currentPair.prichod) {
            workPairs.push({ 
                prichod: currentPair.prichod, 
                odchod: currentPair.prichod, 
                status: "Chyba: Ch√Ωba odchod" 
            });
            // Prid√°me z√°znam chyby pre posledn√Ω pr√≠chod
            const lastPrichodRecord = sortedRecords.find(r => new Date(r.cas).getTime() === currentPair.prichod.getTime());
             if (lastPrichodRecord) {
                 // N√°jdeme riadok s t√Ωmto pr√≠chodom a oznaƒç√≠me ho ako chybn√Ω (u≈æ je tam len pr√°zdny ƒças, ƒço je OK)
             }
        }
        
        // --- Vlastn√° KALKUL√ÅCIA a Z√°pis do exportData (op√§≈•) ---
        let finalExportData = [
            ["Typ z√°znamu:", sectionTitle],
            ["Pou≈æ√≠vateƒæ:", userName],
            [], 
            header 
        ];
        
        // Pomocn√° funkcia na n√°jdenie riadku s pr√≠chodom v existuj√∫com poli exportData (podƒæa D√°tumu a ƒåasu)
        const findMatchingRowIndex = (dateStr, timeStr, typeStr) => {
            return exportData.findIndex(row => 
                row[0] === dateStr && row[1] === timeStr && row[2] === typeStr.toUpperCase()
            );
        };
        
        let currentDay = null;

        // Vynulujeme a prejdeme znova cez workPairs
        dailyWorkMs = 0;
        totalWorkMs = 0;
        
        for (const pair of workPairs) {
            const prichodDateStr = pair.prichodData || pair.prichod.toLocaleDateString('sk-SK').substring(0, 10);

            // Sumariz√°cia predch√°dzaj√∫ceho d≈àa
            if (currentDay && currentDay !== prichodDateStr) {
                finalExportData.push(["", "Sumariz√°cia d≈àa:", currentDay, msToHhMm(dailyWorkMs)]);
                dailyWorkMs = 0; // Reset pre nov√Ω de≈à
            }

            // Pridanie riadku PR√çCHOD
            finalExportData.push([
                prichodDateStr, 
                pair.prichod.toLocaleTimeString('sk-SK').substring(0, 5), 
                "PRICHOD", 
                ""
            ]);
            
            let durationMs = 0;
            let durationHhMm = "Chyba PRICHOD/ODCHOD";

            if (pair.status === "OK") {
                durationMs = pair.odchod - pair.prichod;

                // --- ODR√ÅTANIE PREST√ÅVOK ---
                let totalBreakMs = 0;
                prestavkaLogs.filter(b => b.date === prichodDateStr) // Filtrujeme prest√°vky len pre dan√Ω de≈à
                    .sort((a, b) => new Date(a.cas) - new Date(b.cas)) // Triedime ich chronologicky
                    .forEach((b) => {
                        const breakTime = new Date(b.cas);
                        // Jednoduch√° logika: Odƒç√≠tame ≈°tandardn√∫ 30-min√∫tov√∫ pauzu, ak je v r√°mci intervalu.
                        // Pre presnej≈°iu logiku by sa musel zaznamen√°va≈• "zaƒçiatok prest√°vky" a "koniec prest√°vky".
                        // Vzhƒæadom na jednoduch√∫ ≈°trukt√∫ru (len log "prestavka") odr√°tame 30 min. za ka≈æd√Ω z√°znam prest√°vky.
                        // Alebo sa budeme dr≈æa≈• toho, ≈æe "prest√°vka" v logu znamen√° 30 min. pauzu. Zostaneme pri zjednodu≈°enej kalkul√°cii, k√Ωm nem√°me "Zaƒçiatok/Koniec Prest√°vky".
                        
                        // Zist√≠me ƒças pred a po logu prest√°vky, aby sme zistili, ƒçi je to "p√°r" alebo len jeden log.
                        // Ak m√°me len jeden log 'prestavka', predpoklad√°me, ≈æe trvala 30 min√∫t.
                        totalBreakMs += (30 * 60 * 1000); // Odƒç√≠tame 30 min√∫t
                    });
                
                const finalDurationMs = durationMs - totalBreakMs;
                durationHhMm = msToHhMm(finalDurationMs);
                totalWorkMs += finalDurationMs;
                dailyWorkMs += finalDurationMs;
            }
            
            // Pridanie riadku ODCHOD
            finalExportData.push([
                prichodDateStr, 
                pair.odchod.toLocaleTimeString('sk-SK').substring(0, 5), 
                "ODCHOD", 
                durationHhMm
            ]);
            
            currentDay = prichodDateStr;
        }

        // --- Fin√°lna Sumariz√°cia (Posledn√Ω de≈à) ---
        if (currentDay) {
            finalExportData.push(["", "Sumariz√°cia d≈àa:", currentDay, msToHhMm(dailyWorkMs)]);
        }

        // --- Celkov√° Sumariz√°cia ---
        finalExportData.push([]); 
        finalExportData.push(["Celkov√° odpracovan√° doba:", "", "", msToHhMm(totalWorkMs)]);
        
        // Prep√≠≈°eme exportData fin√°lnou verziou
        exportData.splice(0, exportData.length, ...finalExportData); 

    } else { // Pre Prest√°vky a PN (jednoduch√Ω detailn√Ω export)
        if (sortedRecords.length === 0) {
            exportData.push(["≈Ωiadne z√°znamy", "", ""]);
        } else {
            sortedRecords.forEach(z => {
                exportData.push([
                    z.date, 
                    z.time,
                    z.stav.toUpperCase()
                ]);
            });
        }
    }


    // --- Krok 4: Export XLSX s vizu√°lnymi √∫pravami ---
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    
    // ----------------------------------------------------
    // VIZU√ÅLNE √öPRAVY H√ÅRKU (≈†√≠rka stƒ∫pcov, Form√°t buniek)
    // ----------------------------------------------------
    
    // Nastavenie ≈°√≠rky stƒ∫pcov pre Doch√°dzku
    if (sectionType === 'dochadzka') {
        ws['!cols'] = [
            { wpx: 100 }, 
            { wpx: 150 }, 
            { wpx: 100 }, 
            { wpx: 150 } 
        ];
        
        // Zv√Ωraznenie buniek s kalkul√°ciami (Sumariz√°cia a CHYBY)
        const finalRowIndex = exportData.length - 1;

        for (let i = 4; i < exportData.length; i++) {
            const row = exportData[i];
            
            // Kontrola dennej sumy
            if (row[1] === "Sumariz√°cia d≈àa:") {
                // Text "Sumariz√°cia d≈àa:" (B-stƒ∫pec)
                const textCellRef = XLSX.utils.encode_cell({ r: i, c: 1 });
                if (ws[textCellRef]) {
                    ws[textCellRef].s = { font: { bold: true } };
                }

                // Form√°tovanie sumy (D-stƒ∫pec) - ≈Ωlt√°, tuƒçn√©
                const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 }); 
                if (ws[cellRef]) {
                    ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFFCC00" } } }; 
                }
            }
            
            // Kontrola na ch√Ωbaj√∫ci pr√≠chod/odchod (Chyba)
            if (String(row[3]).includes("Chyba")) { 
                const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 }); 
                if (ws[cellRef]) {
                    // ƒåerven√° v√Ωpl≈à pre chybu s bielym p√≠smom
                    ws[cellRef].s = { font: { bold: true, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FFCC0000" } } }; 
                }
            }
            
            // Celkov√° suma
            if (i === finalRowIndex && row[0] === "Celkov√° odpracovan√° doba:") {
                // Text "Celkov√° odpracovan√° doba:" (A-stƒ∫pec)
                const textCellRef = XLSX.utils.encode_cell({ r: i, c: 0 });
                if (ws[textCellRef]) {
                    ws[textCellRef].s = { font: { bold: true } };
                }
                
                // Form√°tovanie celkovej sumy (D-stƒ∫pec) - Zelen√°, tuƒçn√©
                const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 }); 
                if (ws[cellRef]) {
                    ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FF00B050" } } }; 
                }
            }
        }
    } else {
        // Nastavenie ≈°√≠rky stƒ∫pcov pre Prest√°vky/PN
        ws['!cols'] = [
             { wpx: 100 }, // D√°tum
             { wpx: 80 }, // ƒåas
             { wpx: 100 }  // Typ
        ];
    }
    
    // ----------------------------------------------------

    XLSX.utils.book_append_sheet(wb, ws, "Doch√°dzka");

    // 5. Stiahnutie s√∫boru
    const safeUserName = userName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
    const fileName = `${fileNameBase}_${safeUserName}_export.xlsx`;
    
    XLSX.writeFile(wb, fileName);
    
    // Sp√§tn√° v√§zba na tlaƒçidle
    const btn = document.querySelector(`[data-export-table="${sectionType}"]`);
    if(btn) {
        btn.textContent = "S√∫bor stiahnut√Ω!";
        setTimeout(() => btn.textContent = `Exportova≈• do XLSX${sectionType === 'dochadzka' ? ' (s kalkul√°ciou)' : ''}`, 2000);
    }
};

// --- Listenery ---

document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("uid");
    window.location.href = "index.html";
});

document.querySelectorAll("nav button").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
        document.getElementById(btn.dataset.target).classList.add("active");
        renderTables(allRecordsCache); // Prekreslenie pri prepnut√≠ sekcie
    });
});

// Listener pre AKƒåN√â TLAƒåIDL√Å
document.getElementById("actionPrichod").addEventListener("click", () => handleActionClick("prichod"));
document.getElementById("actionOdchod").addEventListener("click", () => handleActionClick("odchod"));
document.getElementById("actionPrestavka").addEventListener("click", () => {
    // Ak je text "KONIEC PREST√ÅVKY", zaznamen√°me to ist√© ako "prichod" (n√°vrat do pr√°ce)
    const action = (lastOverallStatus === 'prestavka' && lastMainStatus === 'prichod') ? "prichod" : "prestavka";
    handleActionClick(action);
});


// Filtre spustia renderTables, ƒço prekresl√≠ tabuƒæky aj s pilulkami
document.getElementById("dateDochadzka").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePrestavky").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePN").addEventListener("change", () => renderTables(allRecordsCache));

document.querySelectorAll(".export-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        if(btn.dataset.exportTable) {
            exportTable(btn.dataset.exportTable); 
        }
    });
});

// --- Spustenie aplik√°cie ---
loadUserData();
</script>
</body>
</html>
