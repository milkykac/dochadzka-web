<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DochÃ¡dzka â€“ Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOSÃšLADENÃ‰ Å TÃLY S ADMIN PANELOM --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; display:flex; flex-direction:column; align-items:center;}
header { background:#007bff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; color:white; position:sticky; top:0; z-index:10; }
h1 { margin:0; font-size:22px; font-weight:700; }
header button { background:#fff; border:none; color:#007bff; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
header button:hover { background:#e2e6ea; }

nav { background:#fff; display:flex; justify-content:center; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:65px; z-index:5; flex-wrap:wrap; width:100%; max-width:1100px; border-radius:0 0 12px 12px; }
nav button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
nav button.active { background:#6f42c1; }
nav button:hover { background:#0056b3; }

section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; width:95%; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; font-weight:600; }

/* OPRAVA: ZabezpeÄenie, aby tabuÄ¾ka nemala okraje medzi riadkami */
table {
Â  Â  width:100%;
Â  Â  border-collapse:collapse; /* Toto zabezpeÄuje, Å¾e okraje buniek sa spoja */
Â  Â  margin-top:15px;
Â  Â  border-radius:8px;
Â  Â  overflow:hidden;
Â  Â  border: none; /* ÃšplnÃ© zruÅ¡enie hlavnÃ©ho okraja tabuÄ¾ky */
}

/* OPRAVA: PouÅ¾Ã­vame len 1px okraj len pre vizuÃ¡lne rozdelenie stÄºpcov a riadkov */
th,td {
Â  Â  border:1px solid #ddd;
Â  Â  padding:10px;
Â  Â  text-align:center;
Â  Â  font-size:14px;
Â  Â  color: #333;
}
/* Å peciÃ¡lne nastavenie pre bunky (td), aby riadky neboli oddelenÃ© dvojitÃ½m okrajom */
td {
Â  Â  border-top: none; /* OdstrÃ¡nime hornÃ½ okraj na bunkÃ¡ch */
Â  Â  border-bottom: 1px solid #ddd; /* PonechÃ¡me spodnÃ½ okraj pre delenie riadkov */
}
/* PrvÃ½ riadok v tele tabuÄ¾ky musÃ­ maÅ¥ hornÃ½ okraj */
tbody tr:first-child td {
Â  Â  border-top: 1px solid #ddd;
}
/* PoslednÃ½ riadok v tele tabuÄ¾ky */
tbody tr:last-child td {
Â  Â  border-bottom: none;
}
th { background:#007bff; color:white; font-weight:600; }
tr:nth-child(even){ background:#f8f9fa; }

/* TlaÄidlo premenovanÃ© na ExportovaÅ¥ do XLSX */
.export-btn{ margin-top:15px; background:#28a745; border:none; color:white; border-radius:8px; padding:8px 14px; cursor:pointer; font-weight:600; }
.export-btn:hover{ background:#1e7e34; }

/* Status box je teraz modrÃ½, aby sa hodil k tÃ©me */
.status-box { background:#e9f2ff; color:#007bff; font-weight:600; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; border:1px solid #007bff;}

.filter { margin-top: 10px; }
.filter label { font-weight: 500; margin-right: 10px; color: #333; }
.filter input { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }

#debugUid { background:#d1ecf1;color:#0c5460;padding:5px;text-align:center;font-size:12px;margin-bottom:10px; border-radius: 4px;}

/* --- Å TÃLY PRE FAREBNÃ‰ PILULKY (ODZNAKY) --- */
.status-badge {
Â  Â  font-weight: 700 !important;
Â  Â  padding: 7px 14px !important;
Â  Â  border-radius: 50px !important; /* Tvar pilulky */
Â  Â  display: inline-block;
Â  Â  text-align: center;
Â  Â  min-width: 80px;
Â  Â  white-space: nowrap;
Â  Â  text-shadow: none !important;
Â  Â  color: white !important;
Â  Â  font-size: 14px !important;
}
/* MenÅ¡Ã­ Å¡tÃ½l pilulky pre PrestÃ¡vky/PN v jedinom stÄºpci */
.status-badge.small {
Â  Â  padding: 4px 10px !important;
Â  Â  min-width: 60px;
Â  Â  font-size: 11px !important;
Â  Â  margin-left: 10px;
}
.status-prichod {
Â  Â  background: #198754 !important; /* ZelenÃ¡ */
}
.status-odchod {
Â  Â  background: #dc3545 !important; /* ÄŒervenÃ¡ */
}
.status-prestavka {
Â  Â  background: #ffc107 !important; /* Å½ltÃ¡ */
Â  Â  color: #212529 !important; /* TmavÃ½ text na Å¾ltej */
}
.status-pn {
Â  Â  background: #6f42c1 !important; /* FialovÃ¡ */
}
/* ----------------------------------- */
</style>
</head>
<body>

<header>
Â  Â  <h1>ğŸ‘‹ Vitaj, <span id="userName">Zamestnanec</span></h1>
Â  Â  <button id="logoutBtn">OdhlÃ¡siÅ¥ sa</button>
</header>

<div id="debugUid">NaÄÃ­tavam UID...</div>

<nav>
Â  Â  <button data-target="dochadzka" class="active">DochÃ¡dzka</button>
Â  Â  <button data-target="prestavky">PrestÃ¡vky</button>
Â  Â  <button data-target="pn">PN</button>
</nav>

<section id="dochadzka" class="active">
Â  Â  <div id="statusBox" class="status-box">NaÄÃ­tavam stav...</div>
Â  Â  <h2>DochÃ¡dzka (PrÃ­chod/Odchod)</h2>
Â  Â  <button class="export-btn" data-export-table="dochadzka">ExportovaÅ¥ do XLSX</button>
Â  Â  <div class="filter">
Â  Â  Â  Â  <label for="dateDochadzka">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  <input type="date" id="dateDochadzka">
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas</th><th>Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="dochadzkaTable"><tr><td colspan="2">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="prestavky">
Â  Â  <h2>PrestÃ¡vky</h2>
Â  Â  <button class="export-btn" data-export-table="prestavky">ExportovaÅ¥ do XLSX</button>
Â  Â  <div class="filter">
Â  Â  Â  Â  <label for="datePrestavky">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  <input type="date" id="datePrestavky">
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="prestavkyTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<section id="pn">
Â  Â  <h2>PN</h2>
Â  Â  <button class="export-btn" data-export-table="pn">ExportovaÅ¥ do XLSX</button>
Â  Â  <div class="filter">
Â  Â  Â  Â  <label for="datePN">FiltrovaÅ¥ podÄ¾a dÃ¡tumu:</label>
Â  Â  Â  Â  <input type="date" id="datePN">
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  Â  <thead><tr><th>ÄŒas a Typ</th></tr></thead>
Â  Â  Â  Â  <tbody id="pnTable"><tr><td colspan="1">NaÄÃ­tavam dÃ¡ta...</td></tr></tbody>
Â  Â  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
Â  Â  authDomain: "maturita-395fd.firebaseapp.com",
Â  Â  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
Â  Â  projectId: "maturita-395fd",
Â  Â  storageBucket: "maturita-395fd.firebasestorage.app",
Â  Â  messagingSenderId: "754745500563",
Â  Â  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
Â  Â  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// GlobÃ¡lne premennÃ©
const userId = localStorage.getItem("uid");
const userNameEl = document.getElementById("userName");
const statusBox = document.getElementById("statusBox");
const debugUidEl = document.getElementById("debugUid");
let allRecordsCache = []; // ZÃ¡sobnÃ­k vÅ¡etkÃ½ch zÃ¡znamov

// --- Overenie a presmerovanie ---
if (!userId) {
Â  Â  alert("Nie si prihlÃ¡senÃ½!");
Â  Â  window.location.href = "index.html";
} else if (userId === "admin") {
Â  Â  window.location.href = "admin.html";
} else {
Â  Â  debugUidEl.textContent = `AktuÃ¡lne naÄÃ­tanÃ© UID: ${userId}`;
}

// --- NaÄÃ­tanie dÃ¡t pouÅ¾Ã­vateÄ¾a z Firebase ---
async function loadUserData() {
Â  Â  try {
Â  Â  Â  Â  const userSnap = await get(ref(db, `users/${userId}`));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!userSnap.exists()) {
Â  Â  Â  Â  Â  Â  console.error(`Chyba: DÃ¡ta pre UID "${userId}" neboli vo Firebase nÃ¡jdenÃ©!`);
Â  Â  Â  Â  Â  Â  userNameEl.textContent = "(NeznÃ¡my)";
Â  Â  Â  Â  Â  Â  debugUidEl.style.backgroundColor = '#dc3545';
Â  Â  Â  Â  Â  Â  debugUidEl.style.color = 'white';
Â  Â  Â  Â  Â  Â  debugUidEl.textContent = `CHYBA: DÃ¡ta pre UID ${userId} neexistujÃº!`;
Â  Â  Â  Â  Â  Â  renderTables([]);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const userData = userSnap.val();
Â  Â  Â  Â  userNameEl.textContent = userData.name || "(bez mena)";

Â  Â  Â  Â  const records = [];
Â  Â  Â  Â  const allPossibleLogs = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Zber zÃ¡znamov (ZÃ¡sobnÃ­k dÃ¡t z dochadzka, prestavky, pn)
Â  Â  Â  Â  ["dochadzka", "prestavky", "pn"].forEach(type => {
Â  Â  Â  Â  Â  Â  const logsObj = userData[type] || {};
Â  Â  Â  Â  Â  Â  Object.values(logsObj).forEach(log => allPossibleLogs.push(log));
Â  Â  Â  Â  });
Â  Â  Â  Â  // Zber priamych vlastnostÃ­, ak sÃº logy (pre prÃ­pad starÅ¡ieho formÃ¡tu)
Â  Â  Â  Â  Object.values(userData).forEach(prop => {
Â  Â  Â  Â  Â  Â  if (prop && prop.cas && prop.typ) {
Â  Â  Â  Â  Â  Â  Â  Â  allPossibleLogs.push(prop);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Spracovanie a normalizÃ¡cia Äasu
Â  Â  Â  Â  allPossibleLogs.forEach(log => {
Â  Â  Â  Â  Â  Â  if (!log || !log.cas || !log.typ) return;

Â  Â  Â  Â  Â  Â  let cleanTime = String(log.cas);
Â  Â  Â  Â  Â  Â  let validIsoTime = cleanTime;
Â  Â  Â  Â  Â  Â  let displayTime = cleanTime; // Pre zobrazenie

Â  Â  Â  Â  Â  Â  // Regex pre formÃ¡t DD.MM.YYYY HH:MM
Â  Â  Â  Â  Â  Â  const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
Â  Â  Â  Â  Â  Â  const match = cleanTime.match(dateRegex);

Â  Â  Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  Â  Â  Â  const [full, day, month, year, time] = match;
Â  Â  Â  Â  Â  Â  Â  Â  // ISO pre triedenie
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
Â  Â  Â  Â  Â  Â  Â  Â  // FormÃ¡t pre zobrazenie
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year} ${time}`;
Â  Â  Â  Â  Â  Â  } else if (cleanTime.includes('T') && cleanTime.includes('-')) {
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = cleanTime.replace('T', ' ').substring(0, 16); // ISO format (YYYY-MM-DD HH:MM)
Â  Â  Â  Â  Â  Â  Â  Â  // FormÃ¡t pre zobrazenie
Â  Â  Â  Â  Â  Â  Â  Â  const [date, time] = validIsoTime.split(' ');
Â  Â  Â  Â  Â  Â  Â  Â  const [y, m, d] = date.split('-');
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
Â  Â  Â  Â  Â  Â  } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
Â  Â  Â  Â  Â  Â  Â  Â  validIsoTime = cleanTime.substring(0, 16); // PredpokladÃ¡me YYYY-MM-DD HH:MM
Â  Â  Â  Â  Â  Â  Â  Â  // FormÃ¡t pre zobrazenie
Â  Â  Â  Â  Â  Â  Â  Â  const [date, time] = validIsoTime.split(' ');
Â  Â  Â  Â  Â  Â  Â  Â  const [y, m, d] = date.split('-');
Â  Â  Â  Â  Â  Â  Â  Â  displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const cleanType = String(log.typ)
Â  Â  Â  Â  Â  Â  Â  Â  .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
Â  Â  Â  Â  Â  Â  Â  Â  .toLowerCase();

Â  Â  Â  Â  Â  Â  let recordType = null;
Â  Â  Â  Â  Â  Â  if (cleanType.includes('prichod')) recordType = 'prichod';
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('odchod')) recordType = 'odchod';
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('prestavka')) recordType = 'prestavka';
Â  Â  Â  Â  Â  Â  else if (cleanType.includes('pn')) recordType = 'pn';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (recordType) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const isDuplicate = records.some(r => r.cas === validIsoTime && r.stav === recordType);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!isDuplicate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â records.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â cas: validIsoTime, // ISO formÃ¡t pre triedenie/filtrovanie
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â casDisplay: displayTime, // FormÃ¡t DD.MM.YYYY HH:MM pre zobrazenie/export
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â stav: recordType,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Pridanie dÃ¡tumu a Äasu do samostatnÃ½ch polÃ­ pre export
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â date: displayTime.substring(0, 10), // DD.MM.RRRR
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â time: displayTime.substring(11, 16) // HH:MM
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Triedenie pre zobrazenie na strÃ¡nke (NajnovÅ¡ie prvÃ©)
Â  Â  Â  Â  records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
Â  Â  Â  Â  allRecordsCache = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // AKTUALIZÃCIA STAVU
Â  Â  Â  Â  // PoslednÃ½ zÃ¡znam, ktorÃ½ nie je prestÃ¡vka
Â  Â  Â  Â  const mainStatusRecord = records.find(r => r.stav !== 'prestavka');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const lastStatus = mainStatusRecord ? mainStatusRecord.stav.toUpperCase() : "Å½iadny stav nezaznamenanÃ½";
Â  Â  Â  Â Â 
Â  Â  Â  Â  statusBox.innerHTML = `PoslednÃ½ stav: **${lastStatus}**`;

Â  Â  Â  Â  // Vykreslenie
Â  Â  Â  Â  renderTables(allRecordsCache);

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t:", e);
Â  Â  Â  Â  statusBox.textContent = "KritickÃ¡ chyba pri naÄÃ­tanÃ­ dÃ¡t!";
Â  Â  Â  Â  renderTables([]);
Â  Â  }
}

// --- Vykreslenie tabuliek (S Pilulkami) ---
function renderTables(records) {
Â  Â  const dochadzkaTable = document.getElementById("dochadzkaTable");
Â  Â  const prestavkyTable = document.getElementById("prestavkyTable");
Â  Â  const pnTable = document.getElementById("pnTable");

Â  Â  // Filtrovanie na zobrazenie
Â  Â  const filterDochadzka = document.getElementById("dateDochadzka").value;
Â  Â  const filterPrestavky = document.getElementById("datePrestavky").value;
Â  Â  const filterPN = document.getElementById("datePN").value;

Â  Â  const renderSection = (bodyEl, type, filterDate, expectedStav, colCount) => {
Â  Â  Â  Â  let filtered = records;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(filterDate) {
Â  Â  Â  Â  Â  Â  // Filtrujeme podÄ¾a ISO dÃ¡tumu (YYYY-MM-DD)
Â  Â  Â  Â  Â  Â  filtered = filtered.filter(r => r.cas.substring(0, 10) === filterDate);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sectionRecords = filtered.filter(r => expectedStav.includes(r.stav));
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!sectionRecords.length) {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = `<tr><td colspan="${colCount}">Å½iadne zÃ¡znamy podÄ¾a filtra.</td></tr>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  bodyEl.innerHTML = sectionRecords.map(z => {
Â  Â  Â  Â  Â  Â  Â  Â  // VÅ¾dy pouÅ¾Ã­vame casDisplay
Â  Â  Â  Â  Â  Â  Â  Â  const displayTime = z.casDisplay;

Â  Â  Â  Â  Â  Â  Â  Â  let statusClass = '';
Â  Â  Â  Â  Â  Â  Â  Â  let statusText = z.stav.toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (z.stav === 'prichod') statusClass = 'status-prichod';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'odchod') statusClass = 'status-odchod';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'prestavka') statusClass = 'status-prestavka';
Â  Â  Â  Â  Â  Â  Â  Â  else if (z.stav === 'pn') statusClass = 'status-pn';

Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'dochadzka') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // DochÃ¡dzka: 2 stÄºpce
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${displayTime}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="status-badge ${statusClass}">${statusText}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // PrestÃ¡vky a PN: 1 stÄºpec
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${displayTime}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="status-badge small ${statusClass}">${statusText}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }).join("");
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // Zavolanie funkcie s explicitnÃ½m poÄtom stÄºpcov
Â  Â  renderSection(dochadzkaTable, 'dochadzka', filterDochadzka, ["prichod", "odchod"], 2);
Â  Â  renderSection(prestavkyTable, 'prestavky', filterPrestavky, ["prestavka"], 1);
Â  Â  renderSection(pnTable, 'pn', filterPN, ["pn"], 1);
}

// --- POMOCNÃ FUNKCIA: Konverzia milisekÃºnd na formÃ¡t HH:MM ---
function msToHhMm(ms) {
Â  Â  const totalMinutes = Math.floor(ms / (1000 * 60));
Â  Â  const hours = Math.floor(totalMinutes / 60);
Â  Â  const minutes = totalMinutes % 60;
Â  Â  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// --- HLAVNÃ FUNKCIA: Export do XLSX s vÃ½poÄtom odpracovanÃ©ho Äasu ---
window.exportTable = function(sectionType) {
Â  Â  const userName = userNameEl.textContent;
Â  Â  let filterDate, expectedStav, sectionTitle;
Â  Â  let header; // HlaviÄka sa bude lÃ­Å¡iÅ¥ pre DochÃ¡dzku
Â  Â  let fileNameBase;

Â  Â  // --- Krok 1: Definovanie filtrov a hlaviÄiek ---
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  filterDate = document.getElementById("dateDochadzka").value;
Â  Â  Â  Â  expectedStav = ["prichod", "odchod"];
Â  Â  Â  Â  sectionTitle = "DochÃ¡dzka (PrÃ­chod/Odchod) a SumarizÃ¡cia";
Â  Â  Â  Â  // NovÃ¡ hlaviÄka pre dochÃ¡dzku s kalkulÃ¡ciou
Â  Â  Â  Â  header = ["DÃ¡tum", "ÄŒas", "Typ", "OdpracovanÃ½ Äas/Status"];
Â  Â  Â  Â  fileNameBase = "dochadzka_sumar";
Â  Â  } else if (sectionType === 'prestavky') {
Â  Â  Â  Â  filterDate = document.getElementById("datePrestavky").value;
Â  Â  Â  Â  expectedStav = ["prestavka"];
Â  Â  Â  Â  sectionTitle = "PrestÃ¡vky";
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ"];
Â  Â  Â  Â  fileNameBase = "prestavky";
Â  Â  } else if (sectionType === 'pn') {
Â  Â  Â  Â  filterDate = document.getElementById("datePN").value;
Â  Â  Â  Â  expectedStav = ["pn"];
Â  Â  Â  Â  sectionTitle = "PN";
Â  Â  Â  Â  header = ["DÃ¡tum a ÄŒas", "Typ"];
Â  Â  Â  Â  fileNameBase = "pn";
Â  Â  } else {
Â  Â  Â  Â  return alert("NeznÃ¡my typ sekcie pre export.");
Â  Â  }
Â  Â Â 
Â  Â  // --- Krok 2: FiltrÃ¡cia a triedenie dÃ¡t pre kalkulÃ¡ciu ---
Â  Â  let filteredRecords = allRecordsCache;
Â  Â  if(filterDate) {
Â  Â  Â  Â  filteredRecords = filteredRecords.filter(r => r.cas.substring(0, 10) === filterDate);
Â  Â  }
Â  Â Â 
Â  Â  // Pre export s kalkulÃ¡ciou v DochÃ¡dzke musÃ­me triediÅ¥ od NAJSTARÅ IEHO k NAJNOVÅ IEMU
Â  Â  const sortedRecords = filteredRecords
Â  Â  Â  Â  .filter(r => expectedStav.includes(r.stav))
Â  Â  Â  Â  .sort((a, b) => new Date(a.cas) - new Date(b.cas));

Â  Â  // --- Krok 3: Generovanie dÃ¡tovÃ©ho poÄ¾a a KALKULÃCIA ---
Â  Â  const exportData = [
Â  Â  Â  Â  ["Typ zÃ¡znamu:", sectionTitle],
Â  Â  Â  Â  ["PouÅ¾Ã­vateÄ¾:", userName],
Â  Â  Â  Â  [],
Â  Â  Â  Â  header // 4. riadok: HlaviÄka
Â  Â  ];
Â  Â Â 
Â  Â  let totalWorkMs = 0;
Â  Â  let lastPrichod = null;
Â  Â  let lastDate = null;
Â  Â  let dailyWorkMs = 0;

Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â Â 
Â  Â  Â  Â  sortedRecords.forEach((record) => {
Â  Â  Â  Â  Â  Â  const currentDateTime = new Date(record.cas);
Â  Â  Â  Â  Â  Â  const currentDateStr = record.date; // DD.MM.RRRR
Â  Â  Â  Â  Â  Â  const currentTimeStr = record.time; // HH:MM

Â  Â  Â  Â  Â  Â  // --- Logika SumarizÃ¡cie DÅˆa ---
Â  Â  Â  Â  Â  Â  if (lastDate && lastDate !== currentDateStr) {
Â  Â  Â  Â  Â  Â  Â  Â  // SumarizÃ¡cia predchÃ¡dzajÃºceho dÅˆa
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs = 0; // Reset pre novÃ½ deÅˆ
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (record.stav === 'prichod') {
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = currentDateTime;
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), ""]);
Â  Â  Â  Â  Â  Â  } else if (record.stav === 'odchod' && lastPrichod) {
Â  Â  Â  Â  Â  Â  Â  Â  const durationMs = currentDateTime - lastPrichod;
Â  Â  Â  Â  Â  Â  Â  Â  const durationHhMm = msToHhMm(durationMs);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  totalWorkMs += durationMs;
Â  Â  Â  Â  Â  Â  Â  Â  dailyWorkMs += durationMs;

Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), durationHhMm]);
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = null; // Vynulovanie po odchode
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // PrÃ­pad odchodu bez predchÃ¡dzajÃºceho prÃ­chodu, alebo prebytoÄnÃ½ prÃ­chod (ten nepridÃ¡me)
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), "ChÃ½ba PRÃCHOD"]);
Â  Â  Â  Â  Â  Â  Â  Â  lastPrichod = null; // Reset pre opÃ¤tovnÃº kontrolu
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  lastDate = currentDateStr;
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- FinÃ¡lna SumarizÃ¡cia (PoslednÃ½ deÅˆ) ---
Â  Â  Â  Â  if (lastDate) {
Â  Â  Â  Â  Â  Â  // PridÃ¡me celkovÃº sumu pre poslednÃ½ spracovanÃ½ deÅˆ
Â  Â  Â  Â  Â  Â  exportData.push(["", "SumarizÃ¡cia dÅˆa:", lastDate, msToHhMm(dailyWorkMs)]);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CelkovÃ¡ SumarizÃ¡cia ---
Â  Â  Â  Â  exportData.push([]); // PrÃ¡zdny riadok
Â  Â  Â  Â  exportData.push(["CelkovÃ¡ odpracovanÃ¡ doba:", "", "", msToHhMm(totalWorkMs)]);

Â  Â  } else { // Pre PrestÃ¡vky a PN je jednoduchÃ½ export
Â  Â  Â  Â  if (sortedRecords.length === 0) {
Â  Â  Â  Â  Â  Â  exportData.push(["Å½iadne zÃ¡znamy", ""]);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sortedRecords.forEach(z => {
Â  Â  Â  Â  Â  Â  Â  Â  exportData.push([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  z.casDisplay, // DÃ¡tum a ÄŒas v jednom stÄºpci
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  z.stav.toUpperCase()
Â  Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // --- Krok 4: Export XLSX s vizuÃ¡lnymi Ãºpravami ---
Â  Â Â 
Â  Â  const wb = XLSX.utils.book_new();
Â  Â  const ws = XLSX.utils.aoa_to_sheet(exportData);
Â  Â Â 
Â  Â  // ----------------------------------------------------
Â  Â  // VIZUÃLNE ÃšPRAVY HÃRKU (Å Ã­rka stÄºpcov, FormÃ¡t buniek)
Â  Â  // ----------------------------------------------------
Â  Â Â 
Â  Â  if (sectionType === 'dochadzka') {
Â  Â  Â  Â  // Nastavenie Å¡Ã­rky stÄºpcov pre DochÃ¡dzku
Â  Â  Â  Â  ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 100 }, // StÄºpec A: DÃ¡tum
Â  Â  Â  Â  Â  Â  { wpx: 70 },Â  // StÄºpec B: ÄŒas
Â  Â  Â  Â  Â  Â  { wpx: 100 }, // StÄºpec C: Typ
Â  Â  Â  Â  Â  Â  { wpx: 150 }Â  // StÄºpec D: OdpracovanÃ½ Äas/Status
Â  Â  Â  Â  ];

Â  Â  Â  Â  // ZvÃ½raznenie buniek s kalkulÃ¡ciami (SumarizÃ¡cia)
Â  Â  Â  Â  // PouÅ¾Ã­vame styler na bunky, ktorÃ© obsahujÃº "SumarizÃ¡cia" alebo "CelkovÃ¡"
Â  Â  Â  Â  const finalRowIndex = exportData.length - 1;

Â  Â  Â  Â  for (let i = 4; i < exportData.length; i++) {
Â  Â  Â  Â  Â  Â  const row = exportData[i];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Kontrola dennej sumy
Â  Â  Â  Â  Â  Â  if (row[1] === "SumarizÃ¡cia dÅˆa:") {
Â  Â  Â  Â  Â  Â  Â  Â  // FormÃ¡tovanie sumy (D-stÄºpec)
Â  Â  Â  Â  Â  Â  Â  Â  const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (ws[cellRef]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFFFF00" } } }; // Å½ltÃ¡ farba
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CelkovÃ¡ suma
Â  Â  Â  Â  Â  Â  if (i === finalRowIndex && row[0] === "CelkovÃ¡ odpracovanÃ¡ doba:") {
Â  Â  Â  Â  Â  Â  Â  Â  Â // FormÃ¡tovanie textu "CelkovÃ¡ odpracovanÃ¡ doba:" (A-stÄºpec)
Â  Â  Â  Â  Â  Â  Â  Â  Â const textCellRef = XLSX.utils.encode_cell({ r: i, c: 0 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â if (ws[textCellRef]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ws[textCellRef].s = { font: { bold: true } };
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â // FormÃ¡tovanie celkovej sumy (D-stÄºpec)
Â  Â  Â  Â  Â  Â  Â  Â  Â const cellRef = XLSX.utils.encode_cell({ r: i, c: 3 });Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â if (ws[cellRef]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFCCFFCC" } } }; // Svetlo zelenÃ¡
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  } else {
Â  Â  Â  Â  // Nastavenie Å¡Ã­rky stÄºpcov pre PrestÃ¡vky/PN
Â  Â  Â  Â  Â ws['!cols'] = [
Â  Â  Â  Â  Â  Â  { wpx: 150 }, // StÄºpec A: DÃ¡tum a ÄŒas
Â  Â  Â  Â  Â  Â  { wpx: 100 }Â  // StÄºpec B: Typ
Â  Â  Â  Â  ];
Â  Â  }
Â  Â Â 
Â  Â  // ----------------------------------------------------

Â  Â  XLSX.utils.book_append_sheet(wb, ws, "DochÃ¡dzka");

Â  Â  // 5. Stiahnutie sÃºboru
Â  Â  const safeUserName = userName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
Â  Â  const fileName = `${fileNameBase}_${safeUserName}_export.xlsx`;
Â  Â Â 
Â  Â  XLSX.writeFile(wb, fileName);
Â  Â Â 
Â  Â  // SpÃ¤tnÃ¡ vÃ¤zba na tlaÄidle
Â  Â  const btn = document.querySelector(`[data-export-table="${sectionType}"]`);
Â  Â  if(btn) {
Â  Â  Â  Â  btn.textContent = "SÃºbor stiahnutÃ½!";
Â  Â  Â  Â  setTimeout(() => btn.textContent = "ExportovaÅ¥ do XLSX", 2000);
Â  Â  }
};

// --- Listenery ---

document.getElementById("logoutBtn").addEventListener("click", () => {
Â  Â  localStorage.removeItem("uid");
Â  Â  window.location.href = "index.html";
});

document.querySelectorAll("nav button").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
Â  Â  Â  Â  btn.classList.add("active");
Â  Â  Â  Â  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
Â  Â  Â  Â  document.getElementById(btn.dataset.target).classList.add("active");
Â  Â  Â  Â  renderTables(allRecordsCache);
Â  Â  });
});

document.getElementById("dateDochadzka").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePrestavky").addEventListener("change", () => renderTables(allRecordsCache));
document.getElementById("datePN").addEventListener("change", () => renderTables(allRecordsCache));

document.querySelectorAll(".export-btn").forEach(btn => {
Â  Â  btn.addEventListener("click", () => {
Â  Â  Â  Â  // OdovzdÃ¡vame len dÃ¡tovÃ½ atribÃºt 'dochadzka', 'prestavky' alebo 'pn'
Â  Â  Â  Â  exportTable(btn.dataset.exportTable);
Â  Â  });
});

// --- Spustenie aplikÃ¡cie ---
loadUserData();
</script>
</body>
</html>
