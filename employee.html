<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doch√°dzka ‚Äì Zamestnanec</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOS√öLADEN√â ≈†T√ùLY S ADMIN PANELOM A VIZU√ÅLNYM N√ÅVRHOM --- */
body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    /* UPRAVEN√ù: Hlb≈°√≠, sofistikovanej≈°√≠ gradient */
    background: linear-gradient(135deg, #0e3c63, #0a2745);
    min-height: 100vh;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 50px;
}

header {
    /* UPRAVEN√ù: Tmav≈°ia modr√° */
    background: #0062cc;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    width: 100%;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    box-sizing: border-box;
}

h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
}

header button {
    background: #fff;
    border: none;
    color: #007bff;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

header button:hover {
    background: #e2e6ea;
    transform: translateY(-1px);
}

nav {
    background: #fff;
    display: flex;
    justify-content: center;
    padding: 10px;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    top: 0;
    z-index: 5;
    flex-wrap: wrap;
    width: 95%;
    max-width: 1100px;
    border-radius: 0 0 12px 12px;
    margin-top: 20px;
}

nav button {
    background: #f0f0f0;
    border: none;
    color: #333;
    padding: 10px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

nav button.active {
    background: #007bff;
    color: white;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

nav button:hover:not(.active) {
    background: #e0e0e0;
    transform: translateY(-1px);
}

section {
    display: none;
    padding: 30px;
    background: #fff;
    margin: 25px auto;
    border-radius: 12px;
    max-width: 1100px;
    width: 95%;
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
    transition: 0.3s;
}

section.active {
    display: block;
}

h2 {
    color: #007bff;
    margin-top: 0;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 10px;
    font-weight: 600;
    font-size: 20px;
    margin-bottom: 25px;
}
/* NOV√â: Vylep≈°en√Ω ≈°t√Ωl pre tabuƒæky */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    /* NOV√â: Minimalistick√© oddelenie riadkov */
    border: 1px solid #f0f0f0;
}

th,
td {
    border: none; /* Odstr√°nen√© border */
    border-bottom: 1px solid #eee; /* Iba spodn√Ω okraj */
    padding: 12px 10px;
    text-align: center;
    font-size: 14px;
    color: #333;
}

th {
    background: #007bff;
    color: white;
    font-weight: 600;
    padding: 15px 10px;
    border-bottom: 2px solid #0056b3; /* Tmav≈°√≠ spodn√Ω okraj */
}
/* Odstr√°nenie alternat√≠vnej farby riadkov pre ƒçistej≈°√≠ vzhƒæad */
tr:nth-child(even) {
    background: transparent;
}

tr:hover {
    background: #f5f9ff;
}

/* Tlaƒçidl√° pre export */
.export-btn {
    margin-top: 15px;
    background: #198754; /* Zelen√° pre export */
    border: none;
    color: white;
    border-radius: 8px;
    padding: 10px 18px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s, transform 0.2s, box-shadow 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 8px;
}

.export-btn:hover {
    background: #146c43;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.export-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Status box je teraz modr√Ω, aby sa hodil k t√©me */
.status-box {
    background: #e9f2ff;
    color: #007bff;
    font-weight: 600;
    padding: 18px;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 25px;
    border: 1px solid #a8d4ff;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    font-size: 1.1em; /* V√§ƒç≈°√≠ font pre status */
}
/* NOV√ù: Stav PN je tmav≈°√≠ */
.status-box.pn-active {
    background: #5e42a6; /* NOV√Å Hlb≈°ia fialov√° */
    color: white;
    border-color: #4a3485;
    box-shadow: 0 2px 8px rgba(94, 66, 166, 0.3);
}

/* NOV√ù: Denn√Ω sum√°r box */
.daily-summary-box {
    background: #d4edda;
    color: #155724;
    font-weight: 600;
    padding: 18px;
    border-radius: 10px;
    text-align: center;
    margin-top: 20px;
    margin-bottom: 25px;
    border: 1px solid #c3e6cb;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    font-size: 1.1em;
}
.daily-summary-box strong {
    color: #0062cc; /* Tmav≈°√≠ modr√Ω ƒças */
}


.filter {
    margin-top: 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.filter label {
    font-weight: 600;
    color: #555;
    white-space: nowrap;
}

.filter input[type="date"],
.filter select {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    color: #333;
    transition: border-color 0.3s, box-shadow 0.3s;
    flex-grow: 1;
    max-width: 200px;
}

.filter input[type="date"]:focus,
.filter select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    outline: none;
}

#debugUid {
    background: #d1ecf1;
    color: #0c5460;
    padding: 8px;
    text-align: center;
    font-size: 13px;
    margin-bottom: 15px;
    border-radius: 6px;
    width: 95%;
    max-width: 1100px;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
    margin-top: 20px;
}

/* --- ≈†T√ùLY PRE FAREBN√â PILULKY (ODZNAKY) --- */
.status-badge {
    font-weight: 700 !important;
    padding: 8px 16px !important;
    border-radius: 50px !important;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 90px;
    white-space: nowrap;
    text-shadow: none !important;
    color: white !important;
    font-size: 13px !important;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.status-badge.small {
    padding: 5px 12px !important;
    min-width: 70px;
    font-size: 11px !important;
    margin-left: 10px;
}
/* UPRAVEN√â FARBY PILULIEK */
.status-prichod {
    background: #1e944b !important; /* Hlb≈°ia zelen√° */
}

.status-odchod {
    background: #c0392b !important; /* Profesion√°lnej≈°ia ƒçerven√° */
}

.status-prestavka-start,
.status-prestavka {
    background: #f39c12 !important; /* Tmav≈°ia oran≈æov√° */
    color: #212529 !important;
}

.status-prestavka-end {
    background: #00a2c0 !important; /* Tmav≈°√≠ cyan */
    color: white !important;
}

.status-pn {
    background: #5e42a6 !important; /* Hlbok√° fialov√° */
}

/* --- RESPONZ√çVNE √öPRAVY --- */
@media (max-width: 768px) {
    header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    nav {
        flex-direction: column;
        align-items: stretch;
        border-radius: 12px;
    }
    nav button {
        width: 100%;
        margin-bottom: 5px;
    }
    .filter {
        flex-direction: column;
        align-items: stretch;
    }
    .filter input[type="date"] {
        max-width: 100%;
    }
    section {
        padding: 20px;
    }
    h2 {
        font-size: 18px;
    }
    th, td {
        padding: 8px 5px;
        font-size: 12px;
    }
    .status-badge {
        min-width: 70px;
        padding: 6px 10px !important;
        font-size: 11px !important;
    }
    .status-badge.small {
        min-width: 50px;
        font-size: 9px !important;
        padding: 3px 8px !important;
    }
    .daily-summary-box {
        flex-direction: column;
        gap: 8px;
        font-size: 1em;
    }
}
</style>
</head>
<body>

<header>
    <h1>üëã Vitaj, <span id="userName">Zamestnanec</span></h1>
    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Odhl√°si≈• sa</button>
</header>

<div id="debugUid">Naƒç√≠tavam UID...</div>

<nav>
    <button data-target="dochadzka" class="active"><i class="fas fa-clock"></i> Doch√°dzka</button>
    <button data-target="prestavky"><i class="fas fa-mug-hot"></i> Prest√°vky</button>
    <button data-target="pn"><i class="fas fa-hospital-alt"></i> PN</button>
</nav>

<section id="dochadzka" class="active">
    <div id="statusBox" class="status-box">Naƒç√≠tavam stav...</div>
    
    <div id="dailySummaryBox" class="daily-summary-box" style="display: none;"></div>

    <h2>Doch√°dzka (Pr√≠chod/Odchod)</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <button class="export-btn" data-export-table="dochadzka"><i class="fas fa-file-excel"></i> Exportova≈• do XLSX (Sum√°r)</button>
        <div class="filter">
            <label for="dateDochadzka">Filtrova≈• podƒæa d√°tumu:</label>
            <input type="date" id="dateDochadzka">
        </div>
    </div>
    <table>
        <thead><tr><th>ƒåas</th><th>Typ</th></tr></thead>
        <tbody id="dochadzkaTable"><tr><td colspan="2">Naƒç√≠tavam d√°ta...</td></tr></tbody>
    </table>
</section>

<section id="prestavky">
    <h2>Prest√°vky</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <button class="export-btn" data-export-table="prestavky"><i class="fas fa-file-excel"></i> Exportova≈• do XLSX (Sum√°r)</button>
        <div class="filter">
            <label for="datePrestavky">Filtrova≈• podƒæa d√°tumu:</label>
            <input type="date" id="datePrestavky">
        </div>
    </div>
    <table>
        <thead><tr><th>ƒåas a Typ</th></tr></thead>
        <tbody id="prestavkyTable"><tr><td colspan="1">Naƒç√≠tavam d√°ta...</td></tr></tbody>
    </table>
</section>

<section id="pn">
    <h2>PN (Pr√°ceneschopnos≈•)</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <button class="export-btn" data-export-table="pn"><i class="fas fa-file-excel"></i> Exportova≈• do XLSX</button>
        <div class="filter">
            <label for="datePN">Filtrova≈• podƒæa d√°tumu:</label>
            <input type="date" id="datePN">
        </div>
    </div>
    <table>
        <thead><tr><th>ƒåas a Typ</th></tr></thead>
        <tbody id="pnTable"><tr><td colspan="1">Naƒç√≠tavam d√°ta...</td></tr></tbody>
    </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
    authDomain: "maturita-395fd.firebaseapp.com",
    databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
    projectId: "maturita-395fd",
    storageBucket: "maturita-395fd.firebasestorage.app",
    messagingSenderId: "754745500563",
    appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
    measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Glob√°lne premenn√©
const userId = localStorage.getItem("uid");
const userNameEl = document.getElementById("userName");
const statusBox = document.getElementById("statusBox");
const dailySummaryBox = document.getElementById("dailySummaryBox");
const debugUidEl = document.getElementById("debugUid");
let allRecordsCache = [];
let currentLogStatus = {};

// --- Overenie a presmerovanie ---
if (!userId) {
    alert("Nie si prihl√°sen√Ω!");
    window.location.href = "index.html";
} else if (userId === "admin") {
    window.location.href = "admin.html";
} else {
    debugUidEl.textContent = `Aktu√°lne naƒç√≠tan√© UID: ${userId}`;
}

// --- POMOCN√â FUNKCIE ---

// Konverzia milisek√∫nd na form√°t HH:MM
function msToHhMm(ms) {
    if (ms < 0) return "00:00";
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// Z√≠skanie form√°tovan√©ho ƒçasu pre z√°pis (U≈Ω SA NEPOU≈Ω√çVA, iba pre writeLog, ak by bolo nutn√©)
function getFormattedTime() {
    const now = new Date();
    // YYYY-MM-DD HH:MM format pre konzistentn√© triedenie/filtrovanie
    const datePart = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const timePart = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    return `${datePart} ${timePart}`;
}

// writeLog funkcia je teraz len z√°stupn√°, keƒè≈æe z√°znamy sa loguj√∫ cez ESP32.
async function writeLog(type) {
    if (!userId) return;

    try {
        let dbPath;
        if (type.includes('prichod') || type.includes('odchod')) {
            dbPath = `users/${userId}/dochadzka`;
        } else if (type.includes('prestavka')) {
            dbPath = `users/${userId}/prestavky`;
        } else if (type.includes('pn')) {
            dbPath = `users/${userId}/pn`;
        } else {
            throw new Error("Nezn√°my typ z√°znamu.");
        }

        const casValue = getFormattedTime();
        
        // Z√°pis do Firebase
        await push(ref(db, dbPath), {
            cas: casValue,
            typ: type,
            // NOV√â: Oznaƒçenie manu√°lneho z√°pisu z webu
            manual_web: true
        });
        
        // Zobrazenie √∫spechu
        statusBox.innerHTML = `‚úÖ √öspe≈°ne zaznamenan√©: **${type.replace('_', ' ').toUpperCase()}** o ${casValue.substring(11, 16)} (Manu√°lny z√°pis)`;
        statusBox.style.backgroundColor = '#d4edda';
        statusBox.style.color = '#155724';
        statusBox.classList.remove('pn-active');
        
        await loadUserData();
    } catch (e) {
        console.error("Chyba pri z√°pise do DB:", e);
        statusBox.innerHTML = `‚ùå Chyba pri z√°pise ${type}: **${e.message}**`;
        statusBox.style.backgroundColor = '#f8d7da';
        statusBox.style.color = '#721c24';
        statusBox.classList.remove('pn-active');
    }
}

// --- Logika aktualiz√°cie stavu a tlaƒçidiel (u≈æ bez tlaƒçidiel) ---
function updateStatusAndButtons(records) {
    // N√°jdite najnov≈°√≠ stav PN
    const lastPNRecord = records.filter(r => r.stav === 'pn').sort((a,b) => new Date(b.cas) - new Date(a.cas))[0];
    if (lastPNRecord) {
        statusBox.innerHTML = `‚ö†Ô∏è AKTU√ÅLNY STAV: **PN**`;
        statusBox.classList.add('pn-active');
        dailySummaryBox.style.display = 'none';
        return;
    }
    statusBox.classList.remove('pn-active');

    // N√°jdite najnov≈°√≠ hlavn√Ω stav (pr√≠chod/odchod) pre aktu√°lny de≈à
    const today = new Date().toISOString().substring(0, 10);
    const mainLogsToday = records.filter(r => r.cas.substring(0, 10) === today && (r.stav === 'prichod' || r.stav === 'odchod'))
                                 .sort((a, b) => new Date(b.cas) - new Date(a.cas));
    const lastMainLogToday = mainLogsToday[0];
    const isCurrentlyIn = lastMainLogToday && lastMainLogToday.stav === 'prichod';

    // N√°jdite najnov≈°√≠ stav prest√°vky pre aktu√°lny de≈à
    const breakLogsToday = records.filter(r => r.cas.substring(0, 10) === today && r.stav.includes('prestavka'))
                                 .sort((a, b) => new Date(b.cas) - new Date(a.cas));
    const lastBreakLogToday = breakLogsToday[0];
    const isCurrentlyOnBreak = lastBreakLogToday && (lastBreakLogToday.stav === 'prestavka_start' || lastBreakLogToday.stav === 'prestavka');


    if (!isCurrentlyIn) {
        statusBox.innerHTML = `üò¥ AKTU√ÅLNY STAV: **ODHL√ÅSEN√ù**`;
        statusBox.style.backgroundColor = '#e9f2ff';
        statusBox.style.color = '#007bff';
        dailySummaryBox.style.display = 'none';
    } else {
        // Zamestnanec je v pr√°ci
        if (isCurrentlyOnBreak) {
            statusBox.innerHTML = `‚òï AKTU√ÅLNY STAV: **NA PREST√ÅVKE**`;
            statusBox.style.backgroundColor = '#ffc107';
            statusBox.style.color = '#333';
        } else {
            statusBox.innerHTML = `üíª AKTU√ÅLNY STAV: **V PR√ÅCI**`;
            statusBox.style.backgroundColor = '#d4edda';
            statusBox.style.color = '#155724';
        }
        dailySummaryBox.style.display = 'flex';
        updateDailySummary(records);
    }
}

// --- FUNKCIA NA V√ùPOƒåET DENN√âHO SUM√ÅRU ---
function updateDailySummary(records) {
    const today = new Date().toISOString().substring(0, 10);
    
    // Z√°znamy pre dne≈°n√Ω de≈à
    const dailyRecords = records
        .filter(r => r.cas.substring(0, 10) === today)
        .sort((a, b) => new Date(a.cas) - new Date(b.cas));

    let workMs = 0;
    let breakMs = 0;
    let lastPrichod = null;
    let lastBreakStart = null;

    dailyRecords.forEach(record => {
        const currentTime = new Date(record.cas);

        // --- Logika Prest√°vky ---
        if (record.stav.includes('prestavka')) {
            if (record.stav === 'prestavka_start' || record.stav === 'prestavka') {
                lastBreakStart = currentTime;
            } else if (record.stav === 'prestavka_end' && lastBreakStart) {
                breakMs += currentTime - lastBreakStart;
                lastBreakStart = null;
            }
        }
        
        // --- Logika Pr√°ca ---
        if (record.stav === 'prichod') {
            lastPrichod = currentTime;
        } else if (record.stav === 'odchod' && lastPrichod) {
            let duration = currentTime - lastPrichod;
            
            // Odpoƒç√≠ta≈• prest√°vku, ak sa zaƒçala a skonƒçila v r√°mci cyklu pr√≠chod-odchod
            const breakRecordsInPeriod = dailyRecords.filter(r => new Date(r.cas) > lastPrichod && new Date(r.cas) < currentTime && r.stav.includes('prestavka'));
            let tempBreakStart = null;

            breakRecordsInPeriod.forEach(b => {
                const bTime = new Date(b.cas);
                if (b.stav.includes('start') || b.stav === 'prestavka') {
                    tempBreakStart = bTime;
                } else if (b.stav.includes('end') && tempBreakStart) {
                    duration -= (bTime - tempBreakStart);
                    tempBreakStart = null;
                }
            });

            if (duration > 0) workMs += duration;
            lastPrichod = null;
        }
    });

    // Ak je zamestnanec aktu√°lne v pr√°ci, prir√°tajte ƒças od posledn√©ho pr√≠chodu
    if (lastPrichod) {
        let ongoingWork = new Date() - lastPrichod;
        
        // Ak je aj na prest√°vke, odpoƒç√≠tajte prebiehaj√∫cu prest√°vku
        if (lastBreakStart) {
            ongoingWork -= (new Date() - lastBreakStart);
        }
        
        if (ongoingWork > 0) workMs += ongoingWork;
    }

    // Ak je prebiehaj√∫ca prest√°vka (zaƒçala, ale neskonƒçila)
    if (lastBreakStart) {
        breakMs += (new Date() - lastBreakStart);
    }


    dailySummaryBox.innerHTML = `
        Dnes odpracovan√©: <strong>${msToHhMm(workMs)}</strong> |
        Prest√°vky: <strong>${msToHhMm(breakMs)}</strong>
    `;
}

// --- Naƒç√≠tanie d√°t pou≈æ√≠vateƒæa z Firebase ---
async function loadUserData() {
    try {
        const userSnap = await get(ref(db, `users/${userId}`));
        
        if (!userSnap.exists()) {
            console.error(`Chyba: D√°ta pre UID "${userId}" neboli vo Firebase n√°jden√©!`);
            userNameEl.textContent = "(Nezn√°my)";
            renderTables([]);
            return;
        }

        const userData = userSnap.val();
        userNameEl.textContent = userData.name || "(bez mena)";

        const records = [];
        const allPossibleLogs = [];
        
        // Zber z√°znamov (z dochadzka, prestavky, pn)
        ["dochadzka", "prestavky", "pn"].forEach(type => {
            const logsObj = userData[type] || {};
            Object.values(logsObj).forEach(log => allPossibleLogs.push(log));
        });
        
        // Spracovanie a normaliz√°cia ƒçasu
        allPossibleLogs.forEach(log => {
            if (!log || !log.cas || !log.typ) return;

            let cleanTime = String(log.cas);
            let validIsoTime = cleanTime;
            let displayTime = cleanTime;

            // Logika normaliz√°cie ƒçasu
            const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
            const match = cleanTime.match(dateRegex);

            if (match) {
                const [full, day, month, year, time] = match;
                validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
                displayTime = `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year} ${time}`;
            } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
                validIsoTime = cleanTime.replace('T', ' ').substring(0, 16);
                const [date, time] = validIsoTime.split(' ');
                const [y, m, d] = date.split('-');
                displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
            } else {
                return;
            }
            
            const cleanType = String(log.typ)
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .toLowerCase();

            let recordType = null;
            if (cleanType.includes('prichod')) recordType = 'prichod';
            else if (cleanType.includes('odchod')) recordType = 'odchod';
            else if (cleanType.includes('prestavka_start')) recordType = 'prestavka_start';
            else if (cleanType.includes('prestavka_end')) recordType = 'prestavka_end';
            else if (cleanType.includes('prestavka')) recordType = 'prestavka';
            else if (cleanType.includes('pn')) recordType = 'pn';
            
            if (recordType) {
                const isDuplicate = records.some(r => r.cas === validIsoTime && r.stav === recordType);
                if (!isDuplicate) {
                    records.push({
                        cas: validIsoTime,
                        casDisplay: displayTime,
                        stav: recordType,
                        date: displayTime.substring(0, 10),
                        time: displayTime.substring(11, 16)
                    });
                }
            }
        });

        records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
        allRecordsCache = records;
        
        // AKTUALIZ√ÅCIA STAVU
        updateStatusAndButtons(records);

        // Vykreslenie tabuliek
        renderTables(allRecordsCache);

    } catch (e) {
        console.error("Kritick√° chyba pri naƒç√≠tan√≠ d√°t:", e);
        statusBox.innerHTML = "‚ùå Kritick√° chyba pri naƒç√≠tan√≠ d√°t!";
        renderTables([]);
    }
}

// --- Vykreslenie tabuliek ---
function renderTables(records) {
    const dochadzkaTable = document.getElementById("dochadzkaTable");
    const prestavkyTable = document.getElementById("prestavkyTable");
    const pnTable = document.getElementById("pnTable");

    const filterDochadzka = document.getElementById("dateDochadzka").value;
    const filterPrestavky = document.getElementById("datePrestavky").value;
    const filterPN = document.getElementById("datePN").value;

    const renderSection = (bodyEl, type, filterDate, expectedStav, colCount) => {
        let filtered = records;
        
        if(filterDate) {
            filtered = filtered.filter(r => r.cas.substring(0, 10) === filterDate);
        }
        
        const sectionRecords = filtered.filter(r => expectedStav.some(stav => r.stav.includes(stav)));
        
        if (!sectionRecords.length) {
            bodyEl.innerHTML = `<tr><td colspan="${colCount}">≈Ωiadne z√°znamy</td></tr>`;
        } else {
            bodyEl.innerHTML = sectionRecords.map(z => {
                const displayTime = z.casDisplay;

                let statusClass = '';
                let stavText = z.stav.toUpperCase();

                if (z.stav === 'prichod') statusClass = 'status-prichod';
                else if (z.stav === 'odchod') statusClass = 'status-odchod';
                else if (z.stav === 'prestavka' || z.stav === 'prestavka_start') {
                    statusClass = 'status-prestavka-start';
                    stavText = 'PREST√ÅVKA START';
                }
                else if (z.stav === 'prestavka_end') {
                    statusClass = 'status-prestavka-end';
                    stavText = 'PREST√ÅVKA END';
                }
                else if (z.stav === 'pn') statusClass = 'status-pn';
                
                if (type === 'dochadzka') {
                    return `<tr>
                        <td>${displayTime}</td>
                        <td><span class="status-badge ${statusClass}">${stavText}</span></td>
                    </tr>`;
                } else {
                    return `<tr>
                            <td>
                                ${displayTime}
                                <span class="status-badge small ${statusClass}">${stavText}</span>
                            </td>
                        </tr>`;
                }
            }).join("");
        }
    };

    renderSection(dochadzkaTable, 'dochadzka', filterDochadzka, ["prichod", "odchod"], 2);
    // Prest√°vky zah≈ï≈àaj√∫ v≈°etky typy prest√°vok
    renderSection(prestavkyTable, 'prestavky', filterPrestavky, ["prestavka"], 1);
    renderSection(pnTable, 'pn', filterPN, ["pn"], 1);
}

// --- HLAVN√Å FUNKCIA: Export do XLSX ---
window.exportTable = function(sectionType) {
    const userName = userNameEl.textContent;
    let filterDate, expectedStav, sectionTitle;
    let header;
    let fileNameBase;

    // --- Krok 1: Definovanie filtrov a hlaviƒçiek ---
    if (sectionType === 'dochadzka') {
        filterDate = document.getElementById("dateDochadzka").value;
        expectedStav = ["prichod", "odchod"];
        sectionTitle = "Doch√°dzka (Pr√≠chod/Odchod) a Sumariz√°cia";
        header = ["D√°tum", "ƒåas", "Typ", "Odpracovan√Ω ƒças/Status"];
        fileNameBase = "dochadzka_sumar";
    } else if (sectionType === 'prestavky') {
        filterDate = document.getElementById("datePrestavky").value;
        expectedStav = ["prestavka"];
        sectionTitle = "Prest√°vky a ich Trvanie";
        header = ["D√°tum a ƒåas", "Typ Z√°znamu", "Trvanie Prest√°vky"];
        fileNameBase = "prestavky_sumar";
    } else if (sectionType === 'pn') {
        filterDate = document.getElementById("datePN").value;
        expectedStav = ["pn"];
        sectionTitle = "PN";
        header = ["D√°tum a ƒåas", "Typ"];
        fileNameBase = "pn";
    } else {
        return alert("Nezn√°my typ sekcie pre export.");
    }
    
    // --- Krok 2: Filtr√°cia a triedenie d√°t pre kalkul√°ciu (od najstar≈°ieho) ---
    let filteredRecords = allRecordsCache;
    if(filterDate) {
        filteredRecords = filteredRecords.filter(r => r.cas.substring(0, 10) === filterDate);
    }
    
    const sortedRecords = filteredRecords
        .filter(r => expectedStav.some(stav => r.stav.includes(stav)))
        .sort((a, b) => new Date(a.cas) - new Date(b.cas));

    // --- Krok 3: Generovanie d√°tov√©ho poƒæa a KALKUL√ÅCIA ---
    const exportData = [
        ["Typ z√°znamu:", sectionTitle],
        ["Pou≈æ√≠vateƒæ:", userName],
        [],
        header
    ];
    
    if (sectionType === 'dochadzka') {
        let totalWorkMs = 0;
        let lastPrichod = null;
        let lastDate = null;
        let dailyWorkMs = 0;
        
        const breakRecords = allRecordsCache
            .filter(r => r.stav.includes('prestavka'))
            .sort((a, b) => new Date(a.cas) - new Date(b.cas));
        
        let totalBreakMs = 0;


        sortedRecords.forEach((record) => {
            const currentDateTime = new Date(record.cas);
            const currentDateStr = record.date;
            const currentTimeStr = record.time;

            // --- Logika Sumariz√°cie D≈àa ---
            if (lastDate && lastDate !== currentDateStr) {
                if (dailyWorkMs > 0) {
                    exportData.push(["", "Sumariz√°cia d≈àa:", lastDate, msToHhMm(dailyWorkMs)]);
                }
                dailyWorkMs = 0;
            }

            if (record.stav === 'prichod') {
                lastPrichod = currentDateTime;
                exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), ""]);
            } else if (record.stav === 'odchod' && lastPrichod) {
                let durationMs = currentDateTime - lastPrichod;
                
                let durationBreaks = 0;
                let lastBreakStart = null;
                
                breakRecords.forEach(breakR => {
                    const breakTime = new Date(breakR.cas);
                    if (breakTime > lastPrichod && breakTime < currentDateTime) {
                         if (breakR.stav.includes('start') || breakR.stav === 'prestavka') {
                            lastBreakStart = breakTime;
                        } else if (breakR.stav.includes('end') && lastBreakStart) {
                            durationBreaks += breakTime - lastBreakStart;
                            lastBreakStart = null;
                        }
                    }
                });
                
                totalBreakMs += durationBreaks;
                durationMs -= durationBreaks;

                const durationHhMm = msToHhMm(durationMs);
                
                totalWorkMs += durationMs;
                dailyWorkMs += durationMs;

                exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), durationHhMm]);
                lastPrichod = null;
            } else {
                exportData.push([currentDateStr, currentTimeStr, record.stav.toUpperCase(), "Chyba PRICHOD/ODCHOD"]);
            }

            lastDate = currentDateStr;
        });

        // --- Fin√°lna Sumariz√°cia (Posledn√Ω de≈à) ---
        if (lastDate && dailyWorkMs > 0) {
            exportData.push(["", "Sumariz√°cia d≈àa:", lastDate, msToHhMm(dailyWorkMs)]);
        }

        // --- Celkov√° Sumariz√°cia ---
        exportData.push([]);
        exportData.push(["Celkov√° odpracovan√° doba:", "", "", msToHhMm(totalWorkMs)]);
        exportData.push(["Celkov√° doba prest√°vok (odpoƒç√≠tan√°):", "", "", msToHhMm(totalBreakMs)]);


    } else if (sectionType === 'prestavky') {
        let totalBreakMs = 0;
        let lastBreakStart = null;
        
        sortedRecords.forEach(record => {
            const currentDateTime = new Date(record.cas);
            let durationHhMm = "";
            let stavText = record.stav.toUpperCase();

            if (record.stav.includes('start') || record.stav === 'prestavka') {
                lastBreakStart = currentDateTime;
                stavText = 'PREST√ÅVKA START';
            } else if (record.stav.includes('end') && lastBreakStart) {
                const durationMs = currentDateTime - lastBreakStart;
                durationHhMm = msToHhMm(durationMs);
                totalBreakMs += durationMs;
                lastBreakStart = null;
                stavText = 'PREST√ÅVKA END';
            } else if (record.stav.includes('end')) {
                durationHhMm = "(Chyba: Koniec bez zaƒçiatku)";
                stavText = 'PREST√ÅVKA END (Chyba)';
            }
            // Z√°pis z√°znamu prest√°vky
            exportData.push([record.casDisplay, stavText, durationHhMm]);
        });
        
        // Celkov√° sumariz√°cia prest√°vok
        exportData.push([]);
        exportData.push(["Celkov√° doba prest√°vok:", "", msToHhMm(totalBreakMs)]);


    } else if (sectionType === 'pn') {
        sortedRecords.forEach(record => {
            exportData.push([record.casDisplay, record.stav.toUpperCase()]);
        });
    }

    // --- Krok 4: Tvorba a stiahnutie s√∫boru ---
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "D√°ta");

    const userNameClean = userName.replace(/[^a-zA-Z0-9_]/g, "_").toLowerCase();
    const dateSuffix = filterDate ? `_${filterDate.replace(/-/g, '')}` : `_${new Date().toISOString().substring(0, 10).replace(/-/g, '')}`;
    const finalFileName = `${userNameClean}_${fileNameBase}${dateSuffix}.xlsx`;

    XLSX.writeFile(wb, finalFileName);
    alert(`‚úÖ D√°ta pre ${sectionTitle} boli exportovan√© do ${finalFileName}`);
}

// --- INICIALIZ√ÅCIA A LISTENERY ---
document.addEventListener("DOMContentLoaded", () => {
    // 1. Naƒç√≠tanie d√°t po naƒç√≠tan√≠ DOM
    loadUserData();
    
    // 2. Listenery pre navig√°ciu
    document.querySelectorAll("nav button").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
            document.getElementById(btn.dataset.target).classList.add("active");
            renderTables(allRecordsCache); // Prekreslenie pri prepnut√≠ sekcie
        });
    });

    // 3. Filtre spustia renderTables
    document.getElementById("dateDochadzka").addEventListener("change", () => renderTables(allRecordsCache));
    document.getElementById("datePrestavky").addEventListener("change", () => renderTables(allRecordsCache));
    document.getElementById("datePN").addEventListener("change", () => renderTables(allRecordsCache));
    
    // 4. Listenery pre export tlaƒçidl√°
    document.querySelectorAll(".export-btn[data-export-table]").forEach(btn => {
        btn.addEventListener("click", () => {
            exportTable(btn.dataset.exportTable);
        });
    });
    
    // 5. Listener pre odhl√°senie
    document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("uid");
        window.location.href = "index.html";
    });

    // 6. Opakovan√© naƒç√≠tanie d√°t na aktualiz√°ciu stavu a denn√©ho sum√°ru (ka≈æd√Ωch 30 sek√∫nd)
    setInterval(loadUserData, 30000);
});
</script>

</body>
</html>
