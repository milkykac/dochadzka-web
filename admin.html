<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - DochÃ¡dzka</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Roboto', sans-serif; margin: 0; background: #f4f5f7; color: #333; display: flex; }
    .sidebar { width: 240px; background: #2b3a67; color: white; height: 100vh; display: flex; flex-direction: column; padding-top: 20px; }
    .sidebar h2 { text-align: center; font-weight: 600; margin-bottom: 20px; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar li { padding: 14px 20px; cursor: pointer; transition: background 0.2s; }
    .sidebar li:hover, .sidebar li.active { background: #5060a8; font-weight: 600; }
    main { flex: 1; padding: 20px; }
    section { display: none; animation: fadeIn 0.3s ease; }
    section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #dfe3ee; }
    tbody tr:nth-child(even) { background: #f9f9f9; }
    button { background: #3e4e88; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #2b3a67; }
    input { padding: 8px; margin-top: 5px; width: 200px; }
    #loading { display: none; text-align: center; margin-top: 20px; font-style: italic; color: #666; }
  </style>
</head>

<body>
  <aside class="sidebar">
    <h2>ğŸ‘‘ Admin Panel</h2>
    <ul>
      <li data-target="view-attendance" class="active">ğŸ“… DochÃ¡dzka</li>
      <li data-target="view-breaks">â˜• PrestÃ¡vky</li>
      <li data-target="view-pn">ğŸ¥ PN</li>
      <li data-target="manage-users">ğŸ‘¤ SprÃ¡va zamestnancov</li>
      <li id="logoutBtn">ğŸšª OdhlÃ¡siÅ¥</li>
    </ul>
  </aside>

  <main>
    <section id="view-attendance" class="active">
      <h2>ğŸ“… DochÃ¡dzka</h2>
      <button onclick="exportToExcel('dochadzkaTable', 'Dochadzka')">Export do Excel</button>
      <table id="dochadzkaTable"><thead><tr><th>Zamestnanec</th><th>UID</th><th>DÃ¡tum</th><th>ÄŒas</th><th>Typ</th></tr></thead><tbody></tbody></table>
      <div id="loading">NaÄÃ­tavam Ãºdaje...</div>
    </section>

    <section id="view-breaks">
      <h2>â˜• PrestÃ¡vky</h2>
      <button onclick="exportToExcel('prestÃ¡vkyTable', 'PrestÃ¡vky')">Export do Excel</button>
      <table id="prestÃ¡vkyTable"><thead><tr><th>Zamestnanec</th><th>DÃ¡tum</th><th>ZaÄiatok</th><th>Koniec</th></tr></thead><tbody></tbody></table>
    </section>

    <section id="view-pn">
      <h2>ğŸ¥ PN</h2>
      <button onclick="exportToExcel('pnTable', 'PN')">Export do Excel</button>
      <table id="pnTable"><thead><tr><th>Zamestnanec</th><th>Od</th><th>Do</th><th>PoznÃ¡mka</th></tr></thead><tbody></tbody></table>
    </section>

    <section id="manage-users">
      <h2>ğŸ‘¤ SprÃ¡va zamestnancov</h2>
      <button onclick="showAddUserForm()">PridaÅ¥ zamestnanca</button>
      <button onclick="exportToExcel('usersTable', 'Zamestnanci')">Export do Excel</button>
      <table id="usersTable"><thead><tr><th>Meno</th><th>UID Äipu</th><th>Akcie</th></tr></thead><tbody id="usersList"></tbody></table>

      <div id="addUserForm" style="display:none;margin-top:20px;">
        <h3>PridaÅ¥ novÃ©ho zamestnanca</h3>
        <input type="text" id="newUserName" placeholder="Meno"><br>
        <input type="text" id="newUserUid" placeholder="UID Äipu (voliteÄ¾nÃ©)"><br>
        <button id="confirmAddUserBtn">PridaÅ¥</button>
        <button onclick="hideAddUserForm()">ZruÅ¡iÅ¥</button>
        <p id="addUserMsg"></p>
      </div>
    </section>
  </main>

  <!-- Firebase modulovÃ½ kÃ³d -->
  <script type="module" defer>
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

    const firebaseConfig = {
      apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
      authDomain: "dochadzkaesp32.firebaseapp.com",
      databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dochadzkaesp32",
      storageBucket: "dochadzkaesp32.appspot.com",
      messagingSenderId: "417668021105",
      appId: "1:417668021105:web:99a456dd622bb4ac4854d0",
      measurementId: "G-268ZE9WLV1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ğŸ” Kontrola prihlÃ¡senia
    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "index.html";
    });

    // ğŸšª OdhlÃ¡senie
    document.getElementById("logoutBtn").addEventListener("click", () => {
      signOut(auth).then(() => {
        alert("Boli ste ÃºspeÅ¡ne odhlÃ¡senÃ½.");
        window.location.href = "index.html";
      }).catch(err => alert("Chyba pri odhlasovanÃ­: " + err.message));
    });

    // ğŸ“„ NaÄÃ­tanie dÃ¡t
    function loadAttendance() {
      const refPath = ref(db, "dochadzka");
      const loader = document.getElementById("loading");
      loader.style.display = "block";
      onValue(refPath, (snapshot) => {
        const tbody = document.querySelector("#dochadzkaTable tbody");
        tbody.innerHTML = "";
        snapshot.forEach(userSnap => {
          userSnap.forEach(rec => {
            const d = rec.val();
            tbody.innerHTML += `<tr>
              <td>${d.zamestnanec}</td>
              <td>${d.uid || ""}</td>
              <td>${d.datum}</td>
              <td>${d.cas}</td>
              <td>${d.typ}</td>
            </tr>`;
          });
        });
        loader.style.display = "none";
      });
    }

    function loadBreaks() {
      const refPath = ref(db, "prestÃ¡vky");
      onValue(refPath, (snapshot) => {
        const tbody = document.querySelector("#prestÃ¡vkyTable tbody");
        tbody.innerHTML = "";
        snapshot.forEach(userSnap => {
          userSnap.forEach(rec => {
            const d = rec.val();
            tbody.innerHTML += `<tr><td>${d.zamestnanec}</td><td>${d.datum}</td><td>${d.zaciatok}</td><td>${d.koniec}</td></tr>`;
          });
        });
      });
    }

    function loadPN() {
      const refPath = ref(db, "pn");
      onValue(refPath, (snapshot) => {
        const tbody = document.querySelector("#pnTable tbody");
        tbody.innerHTML = "";
        snapshot.forEach(userSnap => {
          userSnap.forEach(rec => {
            const d = rec.val();
            tbody.innerHTML += `<tr><td>${d.zamestnanec}</td><td>${d.od}</td><td>${d.do}</td><td>${d.poznamka || ""}</td></tr>`;
          });
        });
      });
    }

    function loadUsers() {
      const refPath = ref(db, "users");
      onValue(refPath, (snapshot) => {
        const tbody = document.getElementById("usersList");
        tbody.innerHTML = "";
        snapshot.forEach(childSnap => {
          const user = childSnap.val();
          tbody.innerHTML += `<tr>
            <td>${user.name}</td>
            <td>${user.chipUid || ""}</td>
            <td><button onclick="deleteUser('${childSnap.key}')">VymazaÅ¥</button></td>
          </tr>`;
        });
      });
    }

    // â• Pridanie zamestnanca s kontrolou duplicitnÃ©ho UID
    document.getElementById("confirmAddUserBtn").addEventListener("click", async () => {
      const name = document.getElementById("newUserName").value.trim();
      const uid = document.getElementById("newUserUid").value.trim();
      const msg = document.getElementById("addUserMsg");

      if (!name) {
        msg.textContent = "Zadajte meno zamestnanca!";
        return;
      }

      if (uid) {
        const q = query(ref(db, "users"), orderByChild("chipUid"), equalTo(uid));
        const snap = await get(q);
        if (snap.exists()) {
          msg.textContent = "Tento UID Äipu uÅ¾ existuje!";
          return;
        }
      }

      push(ref(db, "users"), { name, chipUid: uid || "", createdAt: new Date().toISOString() })
        .then(() => {
          msg.textContent = "âœ… Zamestnanec pridanÃ½!";
          hideAddUserForm();
        })
        .catch(err => msg.textContent = "Chyba: " + err.message);
    });

    // ğŸ—‘ï¸ Mazanie
    window.deleteUser = (key) => {
      if (confirm("Naozaj chcete vymazaÅ¥ tohto zamestnanca?")) {
        remove(ref(db, "users/" + key))
          .then(() => alert("Zamestnanec odstrÃ¡nenÃ½."))
          .catch(err => alert("Chyba: " + err.message));
      }
    };

    // ğŸ“¤ Export
    window.exportToExcel = (tableId, fileName) => {
      const table = document.getElementById(tableId);
      const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
      XLSX.writeFile(wb, fileName + ".xlsx");
    };

    // ğŸ‘¤ Form funkcie
    window.showAddUserForm = () => document.getElementById("addUserForm").style.display = "block";
    window.hideAddUserForm = () => {
      document.getElementById("addUserForm").style.display = "none";
      document.getElementById("newUserName").value = "";
      document.getElementById("newUserUid").value = "";
      document.getElementById("addUserMsg").textContent = "";
    };

    // ğŸ”„ PrepÃ­nanie sekciÃ­
    const tabs = document.querySelectorAll(".sidebar li[data-target]");
    const sections = document.querySelectorAll("main section");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.target).classList.add("active");
      });
    });

    // ğŸš€ NaÄÃ­tanie po spustenÃ­
    loadAttendance();
    loadBreaks();
    loadPN();
    loadUsers();
  </script>
</body>
</html>

