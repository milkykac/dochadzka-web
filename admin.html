<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dochádzka - Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght+400;600;700&display=swap" rel="stylesheet">
    <style>
        /* PÔVODNÉ ŠTÝLY (bez opraveného CSS glitchu) */
        body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#6f42c1,#007bff); min-height:100vh; color:#333; }
        header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
        h1 { color:#6f42c1; margin:0; font-size:24px; font-weight:700; }
        button { background:#6f42c1; border:none; color:white; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; transition:0.3s; }
        button:hover { background:#5a32a3; }
        
        /* Prihlasovanie */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 90vh; padding: 20px; }
        .login-box { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; width: 100%; text-align: center; }
        .login-box h2 { color: #6f42c1; margin-bottom: 25px; font-weight: 600; }
        .login-box input[type="text"], .login-box input[type="password"] {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px;
        }
        .login-box button { width: 100%; padding: 12px; font-size: 16px; background: #007bff; }
        .login-box button:hover { background: #0056b3; }

        /* Hlavný Admin Panel */
        .admin-container {
            display: none; /* Skryté, kým sa admin neprihlási */
            padding: 30px;
            background: #fff;
            margin: 25px auto;
            border-radius: 12px;
            max-width: 1200px;
            width: 95%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        /* Sekcia pre logy */
        .logs-section { padding-top: 20px; }
        table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        th,td { border:1px solid #ddd; padding:12px; text-align:left; font-size:15px; }
        th { background:#6f42c1; color:white; font-weight:600; }
        tr:nth-child(even){ background:#f8f9fa; }

        /* PÔVODNÉ ODZNAKY (S GLITCHOM) */
        .status-badge {
            font-weight: 700;
            padding: 7px 14px;
            border-radius: 50px;
            display: inline-block;
            text-align: center;
            min-width: 80px; 
        }

        .status-prichod { background: #198754; color: white; }
        .status-odchod { background: #dc3545; color: white; }
        .status-prestavka { background: #ffc107; color: #000000; }
        .status-pn { background: #6f42c1; color: white; }

        @media(max-width:768px){ 
            header{flex-direction:column; text-align:center; gap:10px;} 
            table{display:block; overflow-x:auto; white-space:nowrap;}
        }
    </style>
</head>
<body>

<div id="loginView" class="login-container">
    <div class="login-box">
        <h2>Admin Prihlásenie</h2>
        <input type="text" id="adminName" placeholder="Admin Meno (admin)">
        <input type="password" id="adminPassword" placeholder="Heslo (Pôvodné)">
        <button onclick="adminLogin()">Prihlásiť sa</button>
        <div style="margin-top: 15px;">
            <a href="index.html" style="color: #007bff; text-decoration: none;">Späť na Používateľské Prihlásenie</a>
        </div>
    </div>
</div>


<div id="mainView" class="admin-container">
    <header style="background:none; box-shadow:none; padding: 0 0 20px 0; position:static;">
        <h1 id="welcomeText">Admin Panel</h1>
        <button onclick="adminLogout()">Odhlásiť sa</button>
    </header>

    <div class="logs-section">
        <h2>Prehľad Dochádzkových Logov (Všetci)</h2>
        <select id="logUserFilter" style="padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:10px;" onchange="loadAllLogs()">
            <option value="">Všetci Používatelia</option>
        </select>
        <input type="date" id="logDateFilter" style="padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:10px; margin-left: 10px;" onchange="loadAllLogs()">
        <button style="background: #28a745; margin-left: 10px;" onclick="exportAllLogs()">Exportovať Všetko</button>
        <div id="allLogsTable" class="loader">Načítavam dáta...</div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, child, push, set, remove, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
    authDomain: "maturita-395fd.firebaseapp.com",
    databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
    projectId: "maturita-395fd",
    storageBucket: "maturita-395fd.firebasestorage.app",
    messagingSenderId: "754745500563",
    appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
    measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allUsers = {}; 

document.addEventListener('DOMContentLoaded', () => {
    // KONTROLA PRE ADMIN PANEL (pôvodne pravdepodobne viedla k chybe, pretože ste sa neprihlásili)
    if (localStorage.getItem("adminUid") === "admin") {
        showMainView();
        loadAllUsers();
        loadAllLogs();
    } else {
        document.getElementById("loginView").style.display = "flex";
    }
});

function showMainView() {
    document.getElementById("loginView").style.display = "none";
    document.getElementById("mainView").style.display = "block";
}

window.adminLogout = function() {
    localStorage.removeItem("adminUid");
    window.location.reload();
}

window.adminLogin = function() {
    const nameInput = document.getElementById("adminName").value.trim();
    const passInput = document.getElementById("adminPassword").value.trim();

    // PÔVODNÁ LOGIKA PRIHLÁSENIA (heslo bolo pravdepodobne zlé)
    if (nameInput === "admin" && passInput === "admin_heslo") { // NASTAVTE SI SEM POZNÁTKU S PÔVODNÝM HESLOM!
        localStorage.setItem("adminUid", "admin");
        showMainView();
        loadAllUsers();
        loadAllLogs();
    } else {
        alert("Nesprávne admin meno alebo heslo.");
    }
}

// PÔVODNE TU BOLI LEN ZÁKLADNÉ FUNKCIE, OSTATNÉ KARTY FUNKCIÍ CHÝBALI
async function loadAllUsers() {
    const logUserFilter = document.getElementById("logUserFilter");
    logUserFilter.innerHTML = '<option value="">Všetci Používatelia</option>';
    allUsers = {};

    try {
        const snapshot = await get(ref(db, 'users'));
        if (snapshot.exists()) {
            snapshot.forEach((userSnap) => {
                const user = userSnap.val();
                const uid = userSnap.key;
                allUsers[uid] = user;
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = `${user.name}`;
                logUserFilter.appendChild(option);
            });
        }
    } catch(e) {
        console.error("Chyba pri načítaní používateľov:", e);
    }
}


window.loadAllLogs = async function(){
    const el = document.getElementById("allLogsTable");
    el.innerHTML='<div class="loader">Načítavam dáta...</div>'; 

    const userFilter = document.getElementById("logUserFilter")?.value;
    const dateFilter = document.getElementById("logDateFilter")?.value;
    
    try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        let allLogs = [];
        
        if (snapshot.exists()) {
            snapshot.forEach(userSnap => {
                const uid = userSnap.key;
                if (userFilter && uid !== userFilter) return;

                const user = userSnap.val();
                const userName = user.name;
                
                ['dochadzka', 'prestavky', 'pn'].forEach(logType => {
                    const logs = user[logType];
                    if (logs) {
                        for (const key in logs) {
                            const log = logs[key];
                            const logTime = log.cas || "-";
                            const logDate = logTime.slice(0,10);
                            
                            if (!dateFilter || logDate === dateFilter) {
                                allLogs.push({
                                    userName: userName,
                                    logTime: logTime,
                                    typ: log.typ || logType,
                                    kategoria: logType
                                });
                            }
                        }
                    }
                });
            });
        }

        allLogs.sort((a, b) => new Date(b.logTime) - new Date(a.logTime));
        
        let tableBodyHtml = "";
        allLogs.forEach(log => {
            const rawType = log.typ.toLowerCase();
            const normalizedType = rawType.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            let statusClass = '';
            
            if (normalizedType === 'prichod') statusClass = 'status-prichod';
            else if (normalizedType === 'odchod') statusClass = 'status-odchod';
            else if (normalizedType === 'prestavka') statusClass = 'status-prestavka';
            else if (normalizedType === 'pn') statusClass = 'status-pn';
            
            tableBodyHtml += `<tr>
                <td>${log.logTime}</td>
                <td>${log.userName}</td>
                <td><span class="status-badge ${statusClass}">${rawType.toUpperCase()}</span></td>
                <td>${log.kategoria.toUpperCase()}</td>
            </tr>`;
        });
        
        let finalHtml = `<table>
            <tr>
                <th>Čas</th>
                <th>Používateľ</th>
                <th>Typ</th>
                <th>Kategória</th>
            </tr>`;
        
        if (allLogs.length > 0) {
            finalHtml += tableBodyHtml;
        } else {
            finalHtml += `<tr><td colspan='4'>Žiadne záznamy podľa zvolených filtrov.</td></tr>`;
        }
        finalHtml += "</table>";
        
        el.innerHTML = finalHtml;
        
    } catch (e) {
        el.innerHTML = "Chyba pri načítaní dát.";
        console.error(e);
    }
}


window.exportAllLogs = function(){
    const container = document.getElementById("allLogsTable");
    if (!container) return alert("Kontajner tabuľky nebol nájdený.");
    const table = container.querySelector("table");
    
    if(!table) return alert("Žiadne dáta na export.");
    let csv=[];
    table.querySelectorAll("tr").forEach(row=>{
        const cols=[...row.querySelectorAll("th,td")].map(td=>`"${td.innerText.trim().replace(/(\r\n|\n|\r)/gm, "")}"`); 
        csv.push(cols.join(","));
    });
    const blob=new Blob([csv.join("\n")],{type:"text/csv;charset=utf-8;"}); 
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`admin_all_logs_${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
};
</script>

</body>
</html>
