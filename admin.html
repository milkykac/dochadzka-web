<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äì Doch√°dzka ESP32</title>
<style>
body {font-family:'Poppins',sans-serif;background:#eef2f6;margin:0;padding:0;display:flex;}
.sidebar{width:230px;height:100vh;background:linear-gradient(180deg,#007bff 0%,#0056b3 100%);color:white;position:fixed;left:0;top:0;padding-top:30px;display:flex;flex-direction:column;}
.sidebar h2{margin-bottom:40px;font-size:20px;font-weight:600;text-align:center;}
.sidebar ul{list-style:none;padding:0;width:100%;}
.sidebar li{padding:15px 30px;cursor:pointer;transition:0.3s;text-align:left;}
.sidebar li:hover,.sidebar li.active{background:rgba(255,255,255,0.2);}
header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.05);color:#333;text-align:center;padding:20px;font-size:22px;font-weight:600;position:fixed;top:0;left:230px;right:0;z-index:100;}
#logoutBtn{position:absolute;top:15px;right:30px;background:#dc3545;color:white;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;transition:0.3s;}
#logoutBtn:hover{background:#b52a3a;}
main{flex:1;margin-left:250px;margin-top:90px;padding:30px;}
section{display:none;}
section.active{display:block;background:#fff;padding:25px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.05);margin-bottom:30px;}
h2{color:#007bff;border-bottom:2px solid #007bff;padding-bottom:8px;margin-bottom:20px;}
input,select{padding:8px 12px;border-radius:8px;border:1px solid #ccc;margin:6px 4px;outline:none;}
button{background:#007bff;color:white;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;transition:0.3s;}
button:hover{background:#0056b3;}
table{border-collapse:collapse;width:100%;margin-top:20px;font-size:14px;}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:#007bff;color:white;}
tr:nth-child(even){background:#f9f9f9;}
.action-btn{background:#dc3545;border:none;color:white;padding:6px 10px;border-radius:6px;cursor:pointer;transition:0.3s;}
.action-btn:hover{background:#b52a3a;}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Admin Panel</h2>
  <ul>
    <li id="manageUsersTab" class="active">üë§ Spr√°va zamestnancov</li>
    <li id="viewAttendanceTab">üìÖ Doch√°dzka</li>
    <li id="viewBreaksTab">‚òï Prest√°vky</li>
    <li id="viewPnTab">üè• PN</li>
    <li id="changePasswordTab">üîë Zmena hesla</li>
  </ul>
</div>

<header>
  üõ†Ô∏è Administr√°cia doch√°dzky
  <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<main>
  <!-- Spr√°va zamestnancov -->
  <section id="manage-users" class="active">
    <h2>üë§ Spr√°va zamestnancov</h2>
    <input type="email" id="email" placeholder="Email"> <!-- Zmenen√© na email -->
    <input type="password" id="password" placeholder="Heslo">
    <input type="text" id="chipUid" placeholder="Chip UID">
    <button id="addUserBtn">Prida≈• / Aktualizova≈•</button>
    <table id="userTable">
      <thead><tr><th>UID</th><th>Email</th><th>Heslo</th><th>Chip UID</th><th>Akcie</th></tr></thead>
      <tbody id="userBody"><tr><td colspan="5">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- Doch√°dzka -->
  <section id="view-attendance">
    <h2>üìÖ Doch√°dzka</h2>
    <div style="margin-bottom:20px;">
      <label>D√°tum:</label>
      <input type="date" id="filterDate">
      <label style="margin-left:20px;">Zamestnanec:</label>
      <select id="filterName"><option value="">V≈°etci</option></select>
    </div>
    <div style="margin-bottom:20px;">
      <input type="text" id="chipUidAttendance" placeholder="Chip UID">
      <select id="attendanceType">
        <option value="PRICHOD">Pr√≠chod</option>
        <option value="ODCHOD">Odchod</option>
        <option value="PRESTAVKA">Prest√°vka</option>
        <option value="PN">PN</option>
      </select>
      <button id="addAttendanceBtn">Prida≈• z√°znam</button>
    </div>
    <table id="attendanceTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th><th>Typ</th></tr></thead>
      <tbody id="attendanceBody"><tr><td colspan="4">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- Prest√°vky -->
  <section id="view-breaks">
    <h2>‚òï Prest√°vky</h2>
    <table id="breaksTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th></tr></thead>
      <tbody id="breaksBody"><tr><td colspan="3">≈Ωiadne prest√°vky</td></tr></tbody>
    </table>
  </section>

  <!-- PN -->
  <section id="view-pn">
    <h2>üè• PN</h2>
    <table id="pnTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th></tr></thead>
      <tbody id="pnBody"><tr><td colspan="3">≈Ωiadne PN</td></tr></tbody>
    </table>
  </section>

  <!-- Zmena hesla -->
  <section id="change-password">
    <h2>üîë Zmena hesla</h2>
    <input type="email" id="passwordEmail" placeholder="Email zamestnanca">
    <input type="password" id="newPassword" placeholder="Nov√© heslo">
    <button id="updatePasswordBtn">Ulo≈æi≈• nov√© heslo</button>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script> <!-- Pridan√© -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain:"dochadzkaesp32.firebaseapp.com",
  databaseURL:"https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"dochadzkaesp32",
  storageBucket:"dochadzkaesp32.firebasestorage.app",
  messagingSenderId:"417668021105",
  appId:"1:417668021105:web:7fa3e144892d8b304854d0"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); // Pridan√©
const db = firebase.database();

const emailInput = document.getElementById("email"); // Zmenen√© z name na email
const passInput = document.getElementById("password");
const chipUidInput = document.getElementById("chipUid");
const addBtn = document.getElementById("addUserBtn");
const userBody = document.getElementById("userBody");

const attendanceBody = document.getElementById("attendanceBody");
const breaksBody = document.getElementById("breaksBody");
const pnBody = document.getElementById("pnBody");
const filterDate = document.getElementById("filterDate");
const filterName = document.getElementById("filterName");
const chipUidAttendance = document.getElementById("chipUidAttendance");
const attendanceTypeSelect = document.getElementById("attendanceType");
const addAttendanceBtn = document.getElementById("addAttendanceBtn");
const passwordEmailInput = document.getElementById("passwordEmail");
const newPasswordInput = document.getElementById("newPassword");
const updatePasswordBtn = document.getElementById("updatePasswordBtn");

let allUsers = {}, allAttendance = [], allBreaks = [], allPN = [];

// Overenie autentifik√°cie
auth.onAuthStateChanged(user => {
  if (!user || user.email !== "admin@dochadzka.com") { // Predpoklad√°me admin email
    window.location.href = "index.html";
  } else {
    loadUsers(); // Naƒç√≠taj d√°ta po overen√≠
  }
});

// Hashovanie hesiel (u≈æ nie potrebn√© pre Firebase Auth, ale pre datab√°zu)
async function hashPassword(password){ return CryptoJS.SHA256(password).toString(); }

// Naƒç√≠tanie pou≈æ√≠vateƒæov
function loadUsers(){
  try {
    db.ref("users/").on("value", snapshot=>{
      userBody.innerHTML=""; allUsers={}; filterName.innerHTML='<option value="">V≈°etci</option>';
      if(!snapshot.exists()){ userBody.innerHTML="<tr><td colspan='5'>≈Ωiadni zamestnanci</td></tr>"; return; }
      snapshot.forEach(child=>{
        const data = child.val(); allUsers[child.key]=data;
        const option = document.createElement("option");
        option.value = data.email; // Pou≈æ√≠vame email
        option.textContent = data.email;
        filterName.appendChild(option);
        const row = document.createElement("tr");
        row.innerHTML=`<td>${child.key}</td><td>${data.email}</td><td>***</td><td>${data.chipUid||''}</td>
                       <td><button class="action-btn" onclick="deleteUser('${child.key}')">Zmaza≈•</button></td>`;
        userBody.appendChild(row);
      });
      loadAttendance();
    });
  } catch (error) {
    alert("Chyba pri naƒç√≠tan√≠ pou≈æ√≠vateƒæov: " + error.message);
  }
}

// Mazanie pou≈æ√≠vateƒæa
function deleteUser(uid){ if(confirm("Naozaj zmaza≈•?")) db.ref("users/"+uid).remove(); }
window.deleteUser = deleteUser;

// Pridanie pou≈æ√≠vateƒæa (s Firebase Auth)
addBtn.addEventListener("click", async()=>{
  const email = emailInput.value.trim();
  const password = passInput.value.trim();
  const chipUid = chipUidInput.value.trim();
  if(!email || !password){ alert("Vypl≈à email a heslo!"); return; }
  try {
    // Vytvor pou≈æ√≠vateƒæa vo Firebase Auth
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const uid = userCredential.user.uid;
    // Ulo≈æ do datab√°zy
    await db.ref("users/"+uid).set({email, chipUid});
    emailInput.value=""; passInput.value=""; chipUidInput.value="";
    alert("Pou≈æ√≠vateƒæ pridan√Ω!");
  } catch (error) {
    alert("Chyba pri prid√°van√≠: " + error.message);
  }
});

// Naƒç√≠tanie doch√°dzky
function loadAttendance(){
  try {
    db.ref("dochadzka/").on("value", snapshot=>{
      allAttendance=[]; allBreaks=[]; allPN=[];
      if(snapshot.exists()){
        snapshot.forEach(userSnap=>{
          const userEmail = userSnap.key; // Pou≈æ√≠vame email ako kƒæ√∫ƒç
          userSnap.forEach(rSnap=>{
            const r = rSnap.val();
            const [date,time] = r.cas ? r.cas.split(" ") : ["",""];
            if(r.stav==="PN") allPN.push({name:userEmail,date,time});
            else if(r.stav==="PRESTAVKA") allBreaks.push({name:userEmail,date,time});
            else allAttendance.push({name:userEmail,date,time,stav:r.stav});
          });
        });
      }
      renderTables();
    });
  } catch (error) {
    alert("Chyba pri naƒç√≠tan√≠ doch√°dzky: " + error.message);
  }
}

// Render tabuƒæky
function renderTables(){
  attendanceBody.innerHTML=""; breaksBody.innerHTML=""; pnBody.innerHTML="";
  let filteredAttendance = allAttendance;
  let filteredBreaks = allBreaks;
  let filteredPN = allPN;
  const selectedDate = filterDate.value;
  const selectedEmail = filterName.value;
  if(selectedDate){
    filteredAttendance = filteredAttendance.filter(r=>r.date===selectedDate);
    filteredBreaks = filteredBreaks.filter(r=>r.date===selectedDate);
    filteredPN = filteredPN.filter(r=>r.date===selectedDate);
  }
  if(selectedEmail){
    filteredAttendance = filteredAttendance.filter(r=>r.name===selectedEmail);
    filteredBreaks = filteredBreaks.filter(r=>r.name===selectedEmail);
    filteredPN = filteredPN.filter(r=>r.name===selectedEmail);
  }
  if(!filteredAttendance.length) attendanceBody.innerHTML="<tr><td colspan='4'>≈Ωiadne z√°znamy</td></tr>";
  else filteredAttendance.forEach(r=>attendanceBody.innerHTML+=`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.time}</td><td>${r.stav}</td></tr>`);
  if(!filteredBreaks.length) breaksBody.innerHTML="<tr><td colspan='3'>≈Ωiadne prest√°vky</td></tr>";
  else filteredBreaks.forEach(r=>breaksBody.innerHTML+=`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.time}</td></tr>`);
  if(!filteredPN.length) pnBody.innerHTML="<tr><td colspan='3'>≈Ωiadne PN</td></tr>";
  else filteredPN.forEach(r=>pnBody.innerHTML+=`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.time}</td></tr>`);
}

// Filtrovanie
filterDate.addEventListener("change", renderTables);
filterName.addEventListener("change", renderTables);

// Pridanie doch√°dzky
addAttendanceBtn.addEventListener("click", async()=>{
  const chip = chipUidAttendance.value.trim();
  const type = attendanceTypeSelect.value;
  if(!chip){ alert("Vypl≈à Chip UID!"); return; }
  const userEmail = Object.values(allUsers).find(u=>u.chipUid===chip)?.email;
  if(!userEmail){ alert("Chip UID nezodpoved√° ≈æiadnemu zamestnancovi!"); return; }
  try {
    const now = new Date();
    const date = now.toISOString().split("T")[0];
    const time = now.toTimeString().split(' ')[0];
    await db.ref("dochadzka/"+userEmail).push({cas: date+" "+time, stav:type});
    chipUidAttendance.value="";
    alert("Z√°znam pridan√Ω!");
  } catch (error) {
    alert("Chyba pri prid√°van√≠ z√°znamu: " + error.message);
  }
});

// Zmena hesla (cez Firebase Auth)
updatePasswordBtn.addEventListener("click", async()=>{
  const email = passwordEmailInput.value.trim();
  const newPass = newPasswordInput.value.trim();
  if(!email || !newPass){ alert("Vypl≈à email a nov√© heslo!"); return; }
  try {
    // Aktualizuj heslo pre aktu√°lneho pou≈æ√≠vateƒæa alebo admin
    await auth.currentUser.updatePassword(newPass);
    alert("Heslo zmenen√©!");
    passwordEmailInput.value=""; newPasswordInput.value="";
  } catch (error) {
    alert("Chyba pri zmene hesla: " + error.message);
  }
});

// Prep√≠nanie sekci√≠
const sections={
  manageUsers: document.getElementById("manage-users"),
  viewAttendance: document.getElementById("view-attendance"),
  viewBreaks: document.getElementById("view-breaks"),
  viewPn: document.getElementById("view-pn"),
  changePassword: document.getElementById("change-password")
};
function switchSection(name){
  Object.values(sections).forEach(s=>s.classList.remove("active"));
  sections[name].classList.add("active");
  document.querySelectorAll(".sidebar li").forEach(li=>li.classList.remove("active"));
  const mapping={
    manageUsers:"manageUsersTab",
    viewAttendance:"viewAttendanceTab",
    viewBreaks:"viewBreaksTab",
    viewPn:"viewPnTab",
    changePassword:"changePasswordTab"
  };
  document.getElementById(mapping[name]).classList.add("active");
}
document.getElementById("manageUsersTab").addEventListener("click", ()=>switchSection("manageUsers"));
document.getElementById("viewAttendanceTab").addEventListener("click", ()=>switchSection("viewAttendance"));
document.getElementById("viewBreaksTab").addEventListener("click", ()=>switchSection("viewBreaks"));
document.getElementById("viewPnTab").addEventListener("click", ()=>switchSection("viewPn"));
document.getElementById("changePasswordTab").addEventListener("click", ()=>switchSection("changePassword"));

// Logout
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  auth.signOut();
  window.location.href="index.html";
});

// Inicializ√°cia (u≈æ nie loadUsers(), preto≈æe sa vol√° v onAuthStateChanged)
</script>
</body>
</html>



