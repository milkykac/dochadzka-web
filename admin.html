 <!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin panel ‚Äì Doch√°dzka</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); color:#333; min-height:100vh; }
header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
h1 { color:#007bff; margin:0; font-size:22px; font-weight:600; }
button { border:none; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; }
button:hover { opacity:0.9; }
nav { background:#fff; display:flex; justify-content:center; gap:10px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:70px; z-index:5; }
nav button { background:#007bff; color:white; padding:8px 14px; border-radius:8px; font-weight:500; }
nav button.active { background:#6f42c1; }
section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1000px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }
table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; }
th, td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
th { background:#007bff; color:white; font-weight:500; cursor:pointer; }
tr:nth-child(even){ background:#f8f9fa; }
.loader { text-align:center; padding:20px; color:#007bff; font-weight:bold; }
td button { background:#dc3545; font-size:13px; }
td button:hover { background:#a71d2a; }
.export-btn { margin-top:15px; background:#28a745; }
.export-btn:hover { background:#1e7e34; }

/* Modal */
#assignModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100; }
.modal-content { background:#fff; padding:20px; border-radius:12px; position:relative; width:300px; animation:fadeIn 0.3s; }
#closeModal { position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px; }
@keyframes fadeIn { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
</style>
</head>
<body>

<header>
<h1>Admin panel ‚Äì Doch√°dzkov√Ω syst√©m</h1>
<button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<nav>
<button data-target="dochadzka" class="active">Doch√°dzka</button>
<button data-target="prest√°vky">Prest√°vky</button>
<button data-target="pn">PN</button>
<button data-target="pouzivatelia">Pou≈æ√≠vatelia</button>
<button data-target="newChips">Nov√≠ zamestnanci</button>
</nav>

<section id="dochadzka" class="active">
<h2>Doch√°dzka</h2>
<button class="export-btn" onclick="exportTable('dochadzkaTable')">Exportova≈• do CSV</button>
<div id="dochadzkaTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="prest√°vky">
<h2>Prest√°vky</h2>
<button class="export-btn" onclick="exportTable('prest√°vkyTable')">Exportova≈• do CSV</button>
<div id="prest√°vkyTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pn">
<h2>PN</h2>
<button class="export-btn" onclick="exportTable('pnTable')">Exportova≈• do CSV</button>
<div id="pnTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pouzivatelia">
<h2>Pou≈æ√≠vatelia</h2>
<div id="usersTable" class="loader">Naƒç√≠tavam pou≈æ√≠vateƒæov...</div>
</section>

<section id="newChips">
<h2>Nov√≠ zamestnanci</h2>
<div id="newChipsTable" class="loader">Naƒç√≠tavam nov√© ƒçipy...</div>
</section>

<!-- Modal -->
<div id="assignModal">
<div class="modal-content">
<span id="closeModal">&times;</span>
<h3>Priradi≈• meno nov√©mu ƒçipu</h3>
<input type="text" id="newUserName" placeholder="Meno zamestnanca" style="width:100%; padding:8px; margin-top:10px; border-radius:6px; border:1px solid #ccc;">
<button id="assignBtn" style="margin-top:15px; width:100%; padding:8px; border:none; background:#007bff; color:white; border-radius:6px;">Priradi≈•</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, set, remove, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ‚úÖ ADMIN LOGIN
if (localStorage.getItem("isAdmin") !== "true") {
  alert("Pr√≠stup len pre admina!");
  window.location.href = "index.html";
}
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("isAdmin");
  window.location.href = "index.html";
};

// üî• Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain: "dochadzkaesp32.firebaseapp.com",
  databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dochadzkaesp32",
  storageBucket: "dochadzkaesp32.firebasestorage.app",
  messagingSenderId: "417668021105",
  appId: "1:417668021105:web:7fa3e144892d8b304854d0"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// üîÑ Prep√≠nanie sekci√≠
document.querySelectorAll("nav button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
    document.getElementById(btn.dataset.target).classList.add("active");
  });
});

// üìä Naƒç√≠tanie d√°t funkcia
function loadTable(refName, tableId) {
  const container = document.getElementById(tableId);
  onValue(ref(db, refName), snapshot=>{
    if(!snapshot.exists()){ container.innerHTML="<p>≈Ωiadne d√°ta.</p>"; return; }
    let data=[];
    snapshot.forEach(userSnap=>{
      if(typeof userSnap.val()==="object"){
        userSnap.forEach(recordSnap=>{
          const record = recordSnap.val();
          data.push({ user:userSnap.key, ...record });
        });
      } else { data.push({ key:userSnap.key, ...userSnap.val() }); }
    });
    if(data.length===0){ container.innerHTML="<p>≈Ωiadne d√°ta.</p>"; return; }

    let html="<table><thead><tr>";
    const keys = Object.keys(data[0]);
    keys.forEach(k=>html+=`<th>${k}</th>`);
    html+="</tr></thead><tbody>";
    data.forEach(item=>{
      html+="<tr>";
      keys.forEach(k=>html+=`<td>${item[k]}</td>`);
      html+="</tr>";
    });
    html+="</tbody></table>";
    container.innerHTML=html;
  }, err=>{ console.error(err); container.innerHTML="<p>Chyba naƒç√≠tania d√°t!</p>"; });
}

// Naƒç√≠tanie sekci√≠
loadTable("dochadzka","dochadzkaTable");
loadTable("prest√°vky","prest√°vkyTable");
loadTable("pn","pnTable");

// üë• Pou≈æ√≠vatelia
function loadUsers() {
  const container = document.getElementById("usersTable");
  onValue(ref(db,"users"),snapshot=>{
    if(!snapshot.exists()){ container.innerHTML="<p>≈Ωiadni pou≈æ√≠vatelia.</p>"; return; }
    let html=`<table><tr><th>Meno</th><th>UID</th><th>Akcie</th></tr>`;
    snapshot.forEach(child=>{
      const u=child.val();
      html+=`<tr><td>${u.name}</td><td>${u.chipUid||"-"}</td><td><button onclick="deleteUser('${child.key}')">Vymaza≈•</button></td></tr>`;
    });
    html+="</table>"; container.innerHTML=html;
  });
}
loadUsers();

// ‚ùå Mazanie pou≈æ√≠vateƒæov
window.deleteUser=async key=>{
  if(!confirm("Naozaj chcete vymaza≈• pou≈æ√≠vateƒæa a jeho d√°ta?")) return;
  try{
    await Promise.all([
      remove(ref(db,"users/"+key)),
      remove(ref(db,"dochadzka/"+key)),
      remove(ref(db,"prest√°vky/"+key)),
      remove(ref(db,"pn/"+key))
    ]);
    alert("Pou≈æ√≠vateƒæ a jeho d√°ta boli odstr√°nen√©.");
  } catch(err){ console.error(err); alert("Chyba pri mazan√≠ pou≈æ√≠vateƒæa."); }
};

// üîî Nov√≠ ƒçipy
const modal = document.getElementById("assignModal");
document.getElementById("closeModal").onclick = () => modal.style.display="none";
modal.onclick = e => { if(e.target===modal) modal.style.display="none"; }

function openAssignModal(chipUid){
  modal.style.display="flex";
  document.getElementById("assignBtn").onclick = () => assignUser(chipUid);
}

// Naƒç√≠tanie nov√Ωch ƒçipov
function loadNewChips(){
  const container = document.getElementById("newChipsTable");
  onValue(ref(db,"newChips"),snapshot=>{
    if(!snapshot.exists()){ container.innerHTML="<p>≈Ωiadne nov√© ƒçipy.</p>"; return; }
    let html=`<table><tr><th>UID</th><th>Timestamp</th><th>Akcie</th></tr>`;
    snapshot.forEach(child=>{
      const c = child.val();
      html+=`<tr><td>${child.key}</td><td>${c.timestamp||"-"}</td><td><button onclick="openAssignModal('${child.key}')">Priradi≈•</button></td></tr>`;
    });
    html+="</table>"; container.innerHTML=html;
  });
}
loadNewChips();

// Priradenie nov√©ho pou≈æ√≠vateƒæa
async function assignUser(chipUid){
  const name = document.getElementById("newUserName").value.trim();
  if(!name || !/^[\w\s]+$/.test(name)){ alert("Zadajte platn√© meno (len p√≠smen√° a ƒç√≠sla)."); return; }
  try{
    const userRef = ref(db,"users/"+chipUid);
    const snapshot = await get(userRef);
    if(snapshot.exists()){ alert("Tento ƒçip je u≈æ priraden√Ω."); return; }
    await set(userRef,{ name:name, chipUid:chipUid });
    await remove(ref(db,"newChips/"+chipUid));
    modal.style.display="none";
    alert("Pou≈æ√≠vateƒæ priraden√Ω!");
  }catch(err){ console.error(err); alert("Chyba pri priraƒèovan√≠ pou≈æ√≠vateƒæa."); }
}

// üì§ Export CSV s form√°tovan√Ωm ƒçasom
window.exportTable=tableId=>{
  const table=document.querySelector(`#${tableId} table`);
  if(!table) return;
  let csv=[];
  const headers=[]; for(let cell of table.rows[0].cells) headers.push(cell.textContent);
  csv.push(headers.join(','));
  for(let i=1;i<table.rows.length;i++){
    let rowData=[];
    for(let j=0;j<table.rows[i].cells.length;j++){
      let val=table.rows[i].cells[j].textContent;
      if(!isNaN(val) && val>1000000000){ val=new Date(parseInt(val)).toLocaleString('sk-SK'); }
      rowData.push(`"${val.replace(/"/g,'""')}"`);
    }
    csv.push(rowData.join(','));
  }
  const blob=new Blob([csv.join('\n')],{ type:'text/csv;charset=utf-8;' });
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${tableId}.csv`; a.click(); URL.revokeObjectURL(url);
};
</script>
</body>
</html>
