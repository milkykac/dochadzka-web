<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin panel – Dochádzka</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; }
header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
h1 { color:#007bff; margin:0; font-size:22px; font-weight:600; }
button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; }
button:hover { background:#0056b3; }
section { padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1000px; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }
table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
th,td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
th { background:#007bff; color:white; font-weight:500; }
tr:nth-child(even){ background:#f8f9fa; }
.loader{ text-align:center; padding:20px; color:#007bff; font-weight:bold; }
.export-btn{ margin-top:15px; background:#28a745; border-radius:8px; padding:8px 14px; }
.export-btn:hover{ background:#1e7e34; }
.modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.5); }
.modal-content{ background:#fff; margin:10% auto; padding:20px; border-radius:8px; width:90%; max-width:400px; position:relative; animation:fadeIn 0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
#closeModal,#closeNewUserModal{ position:absolute; right:10px; top:5px; font-size:22px; cursor:pointer; color:#333; }
@keyframes fadeIn{ from{opacity:0;} to{opacity:1;} }
input[type=text], input[type=password], input[type=date]{ width:100%; padding:8px; margin-top:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
.modal button{ width:100%; margin-top:10px; border-radius:6px; padding:8px 0; font-weight:500; cursor:pointer; background:#007bff; color:white; transition:0.3s;}
.modal button:hover{ background:#0056b3;}
</style>
</head>
<body>

<header>
  <h1>Admin panel – Dochádzka</h1>
  <button id="logoutBtn">Odhlásiť sa</button>
</header>

<section>
  <h2>Používatelia</h2>
  <button class="export-btn" onclick="exportTable('userTable')">Exportovať do CSV</button>
  <table id="userTable">
    <thead>
      <tr><th>Meno</th><th>Čip UID</th><th>Akcie</th><th></th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Nový zamestnanec</h3>
  <input type="text" id="newUserName" placeholder="Meno zamestnanca">
  <input type="password" id="newUserPassword" placeholder="Heslo (voliteľné)">
  <button id="createUserBtn">Pridať zamestnanca</button>

  <h3>Nové čipy</h3>
  <ul id="newChipsList"></ul>
</section>

<script type="module">
// --- Firebase ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, push, remove, update, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain: "dochadzkaesp32.firebaseapp.com",
  databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dochadzkaesp32",
  storageBucket: "dochadzkaesp32.appspot.com",
  messagingSenderId: "417668021105",
  appId: "1:417668021105:web:99a456dd622bb4ac4854d0"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- Kontrola admin prihlásenia ---
if (localStorage.getItem("isAdmin") !== "true") {
  alert("Prístup len pre admina!");
  window.location.href = "index.html";
}
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("isAdmin");
  window.location.href = "index.html";
};

// --- Načítanie používateľov ---
async function loadUsers() {
  const tbody = document.querySelector("#userTable tbody");
  tbody.innerHTML = "<tr><td colspan='4'>Načítavam...</td></tr>";

  try {
    const snapshot = await get(ref(db, "users"));
    tbody.innerHTML = "";
    if (snapshot.exists()) {
      const users = snapshot.val();
      Object.entries(users).forEach(([key, user]) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${user.name || "-"}</td>
          <td>${user.chipUid || "-"}</td>
          <td>
            <button onclick="assignChip('${key}')">Priradiť čip</button>
            <button onclick="manualDeparture('${key}')">Manuálny odchod</button>
          </td>
          <td><button onclick="deleteUser('${key}')">Vymazať</button></td>`;
        tbody.appendChild(row);
      });
    } else {
      tbody.innerHTML = "<tr><td colspan='4'>Žiadni používatelia</td></tr>";
    }
  } catch (e) {
    console.error(e);
    tbody.innerHTML = "<tr><td colspan='4'>Chyba pri načítaní!</td></tr>";
  }
}

// --- Nové čipy ---
async function loadNewChips() {
  const chipList = document.getElementById("newChipsList");
  const snapshot = await get(ref(db, "newChips"));
  chipList.innerHTML = "";
  if (snapshot.exists()) {
    const chips = snapshot.val();
    Object.entries(chips).forEach(([key, chip]) => {
      const li = document.createElement("li");
      li.textContent = `${key}`;
      chipList.appendChild(li);
    });
  } else {
    chipList.innerHTML = "<li>Žiadne nové čipy</li>";
  }
}

// --- Priradenie čipu ---
window.assignChip = async function (userKey) {
  const uid = prompt("Zadaj UID čipu:");
  if (!uid) return;
  try {
    await update(ref(db, "users/" + userKey), { chipUid: uid });
    alert("Čip priradený!");
    loadUsers();
  } catch (e) {
    alert("Chyba pri priraďovaní čipu!");
  }
};

// --- Manuálny odchod ---
window.manualDeparture = async function (userKey) {
  const time = prompt("Zadaj čas odchodu (napr. 2025-11-05 15:30:00):");
  if (!time) return;
  const userSnap = await get(ref(db, "users/" + userKey));
  if (!userSnap.exists()) return alert("Používateľ neexistuje!");
  const user = userSnap.val();
  const record = { meno: user.name, cas: time, typ: "odchod (manuálny)" };
  await push(ref(db, "dochadzka/" + user.name), record);
  alert("Čas odchodu zapísaný!");
};

// --- Pridanie nového používateľa ---
document.getElementById("createUserBtn").onclick = async () => {
  const name = document.getElementById("newUserName").value.trim();
  const password = document.getElementById("newUserPassword").value.trim();
  if (!name) return alert("Zadajte meno!");
  const newUserRef = push(ref(db, "users"));
  await set(newUserRef, { name, password });
  alert("Zamestnanec pridaný!");
  document.getElementById("newUserName").value = "";
  document.getElementById("newUserPassword").value = "";
  loadUsers();
};

// --- Vymazanie používateľa ---
window.deleteUser = async function (key) {
  if (confirm("Naozaj odstrániť tohto používateľa?")) {
    await remove(ref(db, "users/" + key));
    alert("Používateľ odstránený!");
    loadUsers();
  }
};

// --- Export do CSV ---
window.exportTable = function (tableId) {
  const rows = document.querySelectorAll(`#${tableId} tr`);
  let csv = [];
  rows.forEach(row => {
    const cols = row.querySelectorAll("td, th");
    const line = Array.from(cols).map(c => `"${c.innerText}"`).join(",");
    csv.push(line);
  });
  const blob = new Blob([csv.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${tableId}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

// --- Automatické načítanie ---
loadUsers();
loadNewChips();
setInterval(loadNewChips, 10000);
</script>
</body>
</html>
