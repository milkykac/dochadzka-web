<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin panel ‚Äì Doch√°dzka</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* p√¥vodn√Ω vizu√°l (modro-fialn√Ω gradient, biele karty) */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; }
header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
h1 { color:#007bff; margin:0; font-size:22px; font-weight:600; }
button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; }
button:hover { background:#0056b3; }
nav { background:#fff; display:flex; justify-content:center; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:70px; z-index:5; }
nav button { background:#007bff; color:white; padding:8px 14px; border-radius:8px; font-weight:500; }
nav button.active { background:#6f42c1; }
section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }
table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); background:#fff; }
th,td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
th { background:#007bff; color:white; font-weight:500; user-select:none; }
tr:nth-child(even){ background:#f8f9fa; }
.loader{ text-align:center; padding:20px; color:#007bff; font-weight:bold; }
td button { background:#dc3545; font-size:13px; margin-right:5px; border-radius:6px; padding:5px 8px; }
td button:hover { background:#a71d2a; }
.export-btn{ margin-top:15px; background:#28a745; border-radius:8px; padding:8px 14px; }
.export-btn:hover{ background:#1e7e34; }
.new-chip { background:#17a2b8; padding:8px 10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-radius:6px; color:white; font-size:14px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.new-chip button { background:#ffc107; color:#333; border:none; padding:5px 8px; border-radius:4px; cursor:pointer; font-size:13px; }
.new-chip button:hover { background:#e0a800; }

/* modal */
.modal { display:none; position:fixed; z-index:200; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
.modal .content { background:#fff; padding:18px; border-radius:8px; width:90%; max-width:420px; box-shadow:0 6px 20px rgba(0,0,0,0.2); }
.modal .content h3{ margin-top:0; color:#007bff; }
.input-row { margin-top:8px; }
select,input,button.modal-action { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
button.modal-action { background:#007bff; color:#fff; border:none; cursor:pointer; }
button.modal-cancel { background:#ccc; color:#333; margin-top:8px; }

/* responsive */
@media (max-width:768px){
  nav { flex-wrap:wrap; }
  section { margin:12px; padding:15px; }
}
</style>
</head>
<body>

<header>
  <h1>Admin panel ‚Äì Doch√°dzka</h1>
  <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<nav>
  <button data-target="dochadzka" class="active">Doch√°dzka</button>
  <button data-target="prestavky">Prest√°vky</button>
  <button data-target="pn">PN</button>
  <button data-target="pouzivatelia">Pou≈æ√≠vatelia</button>
</nav>

<section id="dochadzka" class="active">
  <h2>Doch√°dzka</h2>
  <button class="export-btn" onclick="exportTable('dochadzkaTable')">Exportova≈• do CSV</button>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input type="date" id="dateDochadzka" style="flex:1;">
    <input type="text" id="searchDochadzka" placeholder="Hƒæada≈•..." style="flex:2;">
  </div>
  <div id="dochadzkaTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="prestavky">
  <h2>Prest√°vky</h2>
  <button class="export-btn" onclick="exportTable('prestavkyTable')">Exportova≈• do CSV</button>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input type="date" id="datePrestavky" style="flex:1;">
    <input type="text" id="searchPrestavky" placeholder="Hƒæada≈•..." style="flex:2;">
  </div>
  <div id="prestavkyTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pn">
  <h2>PN</h2>
  <button class="export-btn" onclick="exportTable('pnTable')">Exportova≈• do CSV</button>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input type="date" id="datePN" style="flex:1;">
    <input type="text" id="searchPN" placeholder="Hƒæada≈•..." style="flex:2;">
  </div>
  <div id="pnTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pouzivatelia">
  <h2>Pou≈æ√≠vatelia</h2>
  <button class="export-btn" onclick="exportTable('usersTable')">Exportova≈• do CSV</button>
  <button id="newUserBtn" style="background:#17a2b8;">Nov√Ω zamestnanec</button>
  <div id="usersTable" class="loader">Naƒç√≠tavam pou≈æ√≠vateƒæov...</div>

  <h3 style="margin-top:18px;">Nep≈ôiraden√© ƒçipy</h3>
  <div id="newChipsContainer" class="loader">Naƒç√≠tavam ƒçipy...</div>
</section>

<!-- Mod√°ly -->
<div id="assignChipModal" class="modal">
  <div class="content">
    <h3>Priradi≈• ƒçip</h3>
    <div class="input-row">
      <label>Vybra≈• pou≈æ√≠vateƒæa</label>
      <select id="assignUserSelect"></select>
    </div>
    <div class="input-row">
      <label>ƒåip UID</label>
      <input id="assignChipUid" readonly />
    </div>
    <button class="modal-action" id="assignChipSave">Priradi≈•</button>
    <button class="modal-cancel" id="assignChipCancel">Zru≈°i≈•</button>
  </div>
</div>

<div id="changePasswordModal" class="modal">
  <div class="content">
    <h3>Zmeni≈• heslo pou≈æ√≠vateƒæa</h3>
    <input type="hidden" id="pwdUserId">
    <div class="input-row">
      <input type="password" id="pwdInput" placeholder="Nov√© heslo" />
    </div>
    <button class="modal-action" id="pwdSave">Ulo≈æi≈•</button>
    <button class="modal-cancel" id="pwdCancel">Zru≈°i≈•</button>
  </div>
</div>

<!-- Firebase (namespaced) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>

<script>
/* ====== vlo≈æ sem svoju firebase konfigur√°ciu ====== */
const firebaseConfig = {
  apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain: "dochadzkaesp32.firebaseapp.com",
  databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dochadzkaesp32",
  storageBucket: "dochadzkaesp32.firebasestorage.app",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abcdef123456"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- UI navigation ---------- */
document.querySelectorAll('nav button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(btn.dataset.target).classList.add('active');
  });
});

/* ---------- helpers ---------- */
function escapeHtml(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatCsvCell(s){ return '"' + String(s==null?'':s).replace(/"/g,'""') + '"'; }

/* ---------- CSV export ---------- */
function exportTable(containerId){
  const container = document.getElementById(containerId);
  const table = container.querySelector('table');
  if(!table){ alert('≈Ωiadne d√°ta na export.'); return; }
  const rows = [...table.rows];
  const csv = rows.map(r=>[...r.querySelectorAll('th,td')].map(td=>formatCsvCell(td.innerText)).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${containerId}.csv`;
  a.click();
}

/* ---------- d√°tov√© cache a realtime listeners ---------- */
let usersData = {};    // userId -> object
let chipToUid = {};    // chipUid -> userId

// onValue listeners to auto-update when DB changes
db.ref('users').on('value', async snap => {
  usersData = {};
  chipToUid = {};
  if(snap.exists()){
    snap.forEach(u=>{
      usersData[u.key] = u.val() || {};
      const c = (u.val() && u.val().chipUid) ? u.val().chipUid : null;
      if(c && c !== '-' && c !== '') chipToUid[c] = u.key;
    });
  }
  renderUsersTable();
  renderAssignUserSelect();
  // attendance tables rely on usersData/chipToUid -> re-render them
  renderAttendance('dochadzka','dochadzkaTable','dateDochadzka','searchDochadzka');
  renderAttendance('prestavky','prestavkyTable','datePrestavky','searchPrestavky');
  renderAttendance('pn','pnTable','datePN','searchPN');
});

db.ref('newChips').on('value', snap => {
  renderNewChips(snap);
});

// attendance nodes: use on('value') to auto update
db.ref('dochadzka').on('value', snap => renderAttendanceFromSnap(snap, 'dochadzka', 'dochadzkaTable','dateDochadzka','searchDochadzka'));
db.ref('prestavky').on('value', snap => renderAttendanceFromSnap(snap, 'prestavky', 'prestavkyTable','datePrestavky','searchPrestavky'));
db.ref('pn').on('value', snap => renderAttendanceFromSnap(snap, 'pn', 'pnTable','datePN','searchPN'));

/* ---------- render functions ---------- */

function renderUsersTable(){
  const el = document.getElementById('usersTable');
  if(!Object.keys(usersData).length){ el.innerHTML = 'Naƒç√≠tavam pou≈æ√≠vateƒæov...'; return; }
  let html = '<table><tr><th>Meno</th><th>ƒåip</th><th>Akcie</th></tr>';
  for(const [id, v] of Object.entries(usersData)){
    html += `<tr>
      <td>${escapeHtml(v.name || '(bez mena)')}</td>
      <td>${escapeHtml(v.chipUid || '-')}</td>
      <td>
        <button onclick="removeUser('${id}')">üóëÔ∏è</button>
        <button onclick="openPwdModal('${id}')">üîë</button>
      </td>
    </tr>`;
  }
  html += '</table>';
  el.innerHTML = html;
}

function renderNewChips(snap){
  const container = document.getElementById('newChipsContainer');
  if(!snap.exists()){ container.innerHTML = '≈Ωiadne nov√© ƒçipy'; return; }
  container.innerHTML = '';
  snap.forEach(c=>{
    const chip = c.key;
    const div = document.createElement('div');
    div.className = 'new-chip';
    div.innerHTML = `${escapeHtml(chip)}<div><button onclick="openAssignModal('${chip}')">Priradi≈•</button><button style="margin-left:6px" onclick="removeChip('${chip}')">Odstr√°ni≈•</button></div>`;
    container.appendChild(div);
  });
}

/* attendance renderer helper: we use snapshots delivered by on('value') listeners above */
function renderAttendanceFromSnap(snap, type, containerId, dateInputId, searchInputId){
  // store snapshot for rendering with filters
  const container = document.getElementById(containerId);
  const dateFilter = document.getElementById(dateInputId)?.value || '';
  const searchFilter = (document.getElementById(searchInputId)?.value || '').toLowerCase();
  let html = '<table><tr><th>Meno</th><th>ƒåas</th><th>Typ</th></tr>';
  if(!snap.exists()){ container.innerHTML = '<table><tr><th>Meno</th><th>ƒåas</th><th>Typ</th></tr></table>'; return; }

  snap.forEach(node=>{
    const nodeKey = node.key; // userId (dochadzka/pn) or chipUid (prestavky) depending on DB
    node.forEach(logSnap=>{
      const val = logSnap.val() || {};
      const cas = val.cas || '-';
      const typ = val.typ || '-';
      // compute name:
      let name = '(nezn√°my pou≈æ√≠vateƒæ)';
      if(type === 'prestavky'){
        const chipUid = nodeKey;
        const uid = chipToUid[chipUid];
        if(uid && usersData[uid] && usersData[uid].name) name = usersData[uid].name;
      } else {
        const uid = nodeKey;
        if(usersData[uid] && usersData[uid].name) name = usersData[uid].name;
      }

      // apply date filter and search filter
      const logDate = cas.indexOf('T')!==-1 ? cas.split('T')[0] : (cas.length>=10 ? cas.slice(0,10) : '');
      if((!dateFilter || logDate === dateFilter) && (!searchFilter || name.toLowerCase().includes(searchFilter))){
        html += `<tr><td>${escapeHtml(name)}</td><td>${escapeHtml(cas)}</td><td>${escapeHtml(typ)}</td></tr>`;
      }
    });
  });

  html += '</table>';
  container.innerHTML = html;
}

// convenience wrapper to re-render using current data (calls will be ignored if realtime listeners already updated)
function renderAttendance(type, containerId, dateInputId, searchInputId){
  // read current snapshot once and call the rendering logic above by reading DB once (but listeners already call renderAttendanceFromSnap)
  db.ref(type).get().then(snap => renderAttendanceFromSnap(snap, type, containerId, dateInputId, searchInputId)).catch(e=>{
    document.getElementById(containerId).innerHTML = 'Chyba pri naƒç√≠tan√≠ d√°t.';
    console.error(e);
  });
}

/* ---------- actions ---------- */

async function removeUser(id){
  if(!confirm('Naozaj odstr√°ni≈• pou≈æ√≠vateƒæa?')) return;
  try{
    await db.ref('users/' + id).set(null);
    alert('Pou≈æ√≠vateƒæ odstr√°nen√Ω.');
  }catch(e){
    console.error(e); alert('Chyba pri odstra≈àovan√≠ pou≈æ√≠vateƒæa.');
  }
}

/* assign chip modal logic (dropdown) */
function renderAssignUserSelect(){
  const sel = document.getElementById('assignUserSelect');
  if(!sel) return;
  sel.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.innerText='-- vyber pou≈æ√≠vateƒæa --';
  sel.appendChild(opt0);
  for(const [id, u] of Object.entries(usersData)){
    const o = document.createElement('option');
    o.value = id;
    o.innerText = `${u.name || '(bez mena)'}${u.chipUid && u.chipUid !== '-' ? ' ‚Äî ' + u.chipUid : ''}`;
    sel.appendChild(o);
  }
}
let currentAssignChipUid = null;
function openAssignModal(chipUid){
  currentAssignChipUid = chipUid;
  renderAssignUserSelect();
  document.getElementById('assignChipUid').value = chipUid;
  document.getElementById('assignChipModal').style.display = 'flex';
}
document.getElementById('assignChipCancel').addEventListener('click', ()=> {
  document.getElementById('assignChipModal').style.display = 'none';
  currentAssignChipUid = null;
});
document.getElementById('assignChipSave').addEventListener('click', async ()=> {
  const sel = document.getElementById('assignUserSelect');
  const uid = sel.value;
  if(!uid){ alert('Vyber pou≈æ√≠vateƒæa.'); return; }
  const chip = currentAssignChipUid;
  try{
    // set user's chipUid
    await db.ref('users/' + uid).update({ chipUid: chip });
    // remove from newChips
    await db.ref('newChips/' + chip).set(null);
    // add one prichod record to dochadzka
    await db.ref('dochadzka/' + uid).push({ cas: new Date().toISOString(), typ: 'prichod', manual: false });
    alert('ƒåip priraden√Ω.');
    document.getElementById('assignChipModal').style.display = 'none';
    currentAssignChipUid = null;
  }catch(e){
    console.error(e);
    alert('Nepodarilo sa priradi≈• ƒçip.');
  }
});

/* remove chip (from newChips) */
async function removeChip(chipUid){
  if(!confirm('Naozaj chce≈° odstr√°ni≈• tento ƒçip?')) return;
  try{
    await db.ref('newChips/' + chipUid).set(null);
    alert('ƒåip odstr√°nen√Ω.');
  }catch(e){ console.error(e); alert('Chyba pri odstra≈àovan√≠ ƒçipu.'); }
}

/* password modal */
function openPwdModal(userId){
  document.getElementById('pwdUserId').value = userId;
  document.getElementById('pwdInput').value = '';
  document.getElementById('changePasswordModal').style.display = 'flex';
}
document.getElementById('pwdCancel').addEventListener('click', ()=> document.getElementById('changePasswordModal').style.display = 'none');
document.getElementById('pwdSave').addEventListener('click', async ()=>{
  const id = document.getElementById('pwdUserId').value;
  const pass = document.getElementById('pwdInput').value;
  if(!pass || !pass.trim()) return alert('Zadaj nov√© heslo.');
  try{
    await db.ref('users/' + id + '/password').set(pass);
    alert('Heslo zmenen√©.');
    document.getElementById('changePasswordModal').style.display = 'none';
  }catch(e){ console.error(e); alert('Chyba pri ukladan√≠ hesla.'); }
});

/* filter inputs: re-render (we have realtime listeners but filtering is local) */
['dateDochadzka','searchDochadzka','datePrestavky','searchPrestavky','datePN','searchPN'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', ()=> {
    // triggers re-render using current cache + current DB snapshot
    const type = id.includes('Dochadzka') ? 'dochadzka' : (id.includes('Prestavky') ? 'prestavky' : 'pn');
    const container = id.includes('Dochadzka') ? 'dochadzkaTable' : (id.includes('Prestavky') ? 'prestavkyTable' : 'pnTable');
    renderAttendance(type, container, id, id.replace('date','search'));
  });
});

/* renderAttendance wrapper that reads DB once (used by filters) */
function renderAttendance(type, containerId, dateInputId, searchInputId){
  db.ref(type).get().then(snap => renderAttendanceFromSnapshotForFilter(snap,type,containerId,dateInputId,searchInputId))
    .catch(e=>{ document.getElementById(containerId).innerHTML='Chyba pri naƒç√≠tan√≠.'; console.error(e); });
}
function renderAttendanceFromSnapshotForFilter(snap,type,containerId,dateInputId,searchInputId){
  const container = document.getElementById(containerId);
  const dateFilter = document.getElementById(dateInputId)?.value || '';
  const searchFilter = (document.getElementById(searchInputId)?.value || '').toLowerCase();
  let html = '<table><tr><th>Meno</th><th>ƒåas</th><th>Typ</th></tr>';
  if(snap.exists()){
    snap.forEach(node=>{
      const nodeKey = node.key;
      node.forEach(logSnap=>{
        const val = logSnap.val() || {};
        const cas = val.cas || '-';
        const typ = val.typ || '-';
        let name = '(nezn√°my pou≈æ√≠vateƒæ)';
        if(type === 'prestavky'){
          const chipUid = nodeKey;
          const uid = chipToUid[chipUid];
          if(uid && usersData[uid] && usersData[uid].name) name = usersData[uid].name;
        } else {
          const uid = nodeKey;
          if(usersData[uid] && usersData[uid].name) name = usersData[uid].name;
        }
        const logDate = cas.indexOf('T')!==-1 ? cas.split('T')[0] : (cas.length>=10 ? cas.slice(0,10) : '');
        if((!dateFilter || logDate===dateFilter) && (!searchFilter || name.toLowerCase().includes(searchFilter))){
          html += `<tr><td>${escapeHtml(name)}</td><td>${escapeHtml(cas)}</td><td>${escapeHtml(typ)}</td></tr>`;
        }
      });
    });
  }
  html += '</table>';
  container.innerHTML = html;
}

/* renderAttendanceFromSnap used by realtime on('value') listeners earlier */
function renderAttendanceFromSnap(snap, type, containerId, dateInputId, searchInputId){
  renderAttendanceFromSnapshotForFilter(snap,type,containerId,dateInputId,searchInputId);
}

/* ---------- initial load for users list (in case 'users' hasn't fired yet) ---------- */
db.ref('users').get().then(snap => {
  if(snap.exists()){
    usersData = {};
    chipToUid = {};
    snap.forEach(u=>{
      usersData[u.key] = u.val() || {};
      const c = u.val().chipUid;
      if(c && c !== '-' && c !== '') chipToUid[c] = u.key;
    });
    renderUsersTable();
    renderAssignUserSelect();
  }
}).catch(e=>console.error(e));

/* ---------- logout stub ---------- */
document.getElementById('logoutBtn').addEventListener('click', ()=> {
  // default: navigate to index.html (uprav podƒæa potreby)
  window.location.href = 'index.html';
});

/* expose some functions globally for inline onclicks in generated HTML */
window.removeUser = removeUser;
window.openAssignModal = openAssignModal;
window.removeChip = removeChip;
window.openPwdModal = openPwdModal;
</script>
</body>
</html>

