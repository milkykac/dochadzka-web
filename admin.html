<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doch√°dzka ‚Äì Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- ZOS√öLADEN√â ≈†T√ùLY S EMPLOYEE PANELOM --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#6f42c1,#007bff); min-height:100vh; color:#333; display:flex; flex-direction:column; align-items:center;}
header { background:#6f42c1; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; color:white; position:sticky; top:0; z-index:10; }
h1 { margin:0; font-size:22px; font-weight:700; }
header button { background:#fff; border:none; color:#6f42c1; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
header button:hover { background:#e2e6ea; }

/* Admin Navig√°cia a sekcia */
nav { background:#fff; display:flex; justify-content:center; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:65px; z-index:5; flex-wrap:wrap; width:100%; max-width:1400px; border-radius:0 0 12px 12px; }
nav button { background:#6f42c1; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:0.3s; }
nav button.active { background:#007bff; }
nav button:hover { background:#5a329e; }

section { display:block; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1400px; width:95%; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
h2 { color:#6f42c1; margin-top:0; border-bottom:2px solid #6f42c1; padding-bottom:5px; font-weight:600; }

/* Filtre a Kontroly */
.controls { display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; padding:10px; border:1px solid #ddd; border-radius:8px; background:#f8f9fa; align-items:center;}
.controls label { font-weight:600; color:#333; }
.controls input[type="date"], .controls select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }

/* Tabuƒæka */
table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; border: none; }
th,td { border:1px solid #ddd; padding:10px; text-align:center; font-size:14px; color: #333; }
td { border-top: none; border-bottom: 1px solid #ddd; }
tbody tr:first-child td { border-top: 1px solid #ddd; }
tbody tr:last-child td { border-bottom: none; }
th { background:#6f42c1; color:white; font-weight:600; }
tr:nth-child(even){ background:#f8f9fa; }

/* Tlaƒçidlo Export */
.export-btn{ margin-top:15px; background:#28a745; border:none; color:white; border-radius:8px; padding:8px 14px; cursor:pointer; font-weight:600; }
.export-btn:hover{ background:#1e7e34; }

/* --- ≈†T√ùLY PRE FAREBN√â PILULKY (ODZNAKY) --- */
/* Tieto triedy s√∫ kƒæ√∫ƒçov√© pre vizu√°lne odl√≠≈°enie stavov v tabuƒæke */
.status-badge {
    font-weight: 700 !important;
    padding: 7px 14px !important;
    border-radius: 50px !important; 
    display: inline-block;
    text-align: center;
    min-width: 80px;
    white-space: nowrap;
    color: white !important;
    font-size: 14px !important;
}
.status-prichod { 
    background: #198754 !important; /* Zelen√° */
} 
.status-odchod { 
    background: #dc3545 !important; /* ƒåerven√° */
} 
.status-prestavka { 
    background: #ffc107 !important; /* ≈Ωlt√° */
    color: #212529 !important; /* Tmav√Ω text na ≈æltej */
}
.status-pn { 
    background: #6f42c1 !important; /* Fialov√° */
} 
/* ----------------------------------- */
</style>
</head>
<body>

<header>
    <h1>üëë Admin Panel ‚Äì Doch√°dzka</h1>
    <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<section id="dochadzka">
    <h2>Prehƒæad Doch√°dzky a Statusov</h2>
    
    <div class="controls">
        <label for="dateFilter">Filtrova≈• podƒæa d√°tumu:</label>
        <input type="date" id="dateFilter">
        
        <label for="employeeFilter">Filtrova≈• podƒæa zamestnanca:</label>
        <select id="employeeFilter">
            <option value="all">V≈°etci zamestnanci</option>
            </select>
        
        <button id="applyFilterBtn" style="background:#007bff; color:white; padding:8px 14px; border-radius:8px;">Aplikova≈• filter</button>
    </div>
    
    <button id="exportBtn" class="export-btn">Exportova≈• zobrazen√© d√°ta do XLSX</button>
    
    <table>
        <thead>
            <tr>
                <th>Zamestnanec</th>
                <th>D√°tum a ƒåas</th>
                <th>Typ</th>
                <th>Cel√Ω status</th>
            </tr>
        </thead>
        <tbody id="dochadzkaTable">
            <tr><td colspan="4">Naƒç√≠tavam d√°ta...</td></tr>
        </tbody>
    </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
    authDomain: "maturita-395fd.firebaseapp.com",
    databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
    projectId: "maturita-395fd",
    storageBucket: "maturita-395fd.firebasestorage.app",
    messagingSenderId: "754745500563",
    appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
    measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Glob√°lne premenn√©
const userId = localStorage.getItem("uid");
const dochadzkaTable = document.getElementById("dochadzkaTable");
const employeeFilter = document.getElementById("employeeFilter");
const dateFilter = document.getElementById("dateFilter");

let allRecordsCache = []; // Z√°sobn√≠k v≈°etk√Ωch z√°znamov v≈°etk√Ωch zamestnancov
let allUsers = {}; // Mapa pou≈æ√≠vateƒæov: { uid: { name: 'Meno', ... } }

// --- Overenie a presmerovanie ---
if (userId !== "admin") {
    alert("Pr√≠stup odmietnut√Ω. Len pre administr√°tora!");
    window.location.href = "index.html";
}


// --- Naƒç√≠tanie d√°t v≈°etk√Ωch pou≈æ√≠vateƒæov z Firebase ---
async function loadAllData() {
    dochadzkaTable.innerHTML = '<tr><td colspan="4">Naƒç√≠tavam d√°ta v≈°etk√Ωch zamestnancov...</td></tr>';
    
    try {
        const usersSnap = await get(ref(db, `users`));
        if (!usersSnap.exists()) {
            dochadzkaTable.innerHTML = '<tr><td colspan="4">≈Ωiadni zamestnanci n√°jden√≠ vo Firebase.</td></tr>';
            return;
        }

        const usersData = usersSnap.val();
        const records = [];
        allUsers = {};

        // 1. Spracovanie a Normaliz√°cia d√°t
        for (const uid in usersData) {
            if (uid === "admin" || !usersData[uid] || !usersData[uid].name) continue; // Preskoƒç admina

            const userData = usersData[uid];
            allUsers[uid] = { name: userData.name, uid: uid };

            const allPossibleLogs = [];
            
            // Zber z√°znamov (Z√°sobn√≠k d√°t z dochadzka, prestavky, pn)
            ["dochadzka", "prestavky", "pn"].forEach(type => {
                const logsObj = userData[type] || {};
                // Prid√°me UID k logom pre jednoduch≈°iu identifik√°ciu
                Object.values(logsObj).forEach(log => allPossibleLogs.push({...log, uid, userName: userData.name, logType: type}));
            });
            // Zber priamych vlastnost√≠ pre star≈°ie form√°ty
             Object.values(userData).forEach(prop => {
                if (prop && prop.cas && prop.typ && !prop.logType) {
                     allPossibleLogs.push({...prop, uid, userName: userData.name, logType: 'dochadzka'}); 
                }
            });

            allPossibleLogs.forEach(log => {
                if (!log || !log.cas || !log.typ) return;

                let cleanTime = String(log.cas);
                let validIsoTime = cleanTime;
                let displayTime = cleanTime; 
                
                // --- Logika spracovania ƒçasu (z employee.html) ---
                const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
                const match = cleanTime.match(dateRegex);

                if (match) {
                    const [full, day, month, year, time] = match;
                    validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
                    displayTime = `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year} ${time}`;
                } else if (cleanTime.includes('T') && cleanTime.includes('-')) {
                    validIsoTime = cleanTime.replace('T', ' '); 
                    const [date, time] = validIsoTime.split(' ');
                    const [y, m, d] = date.split('-');
                    displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
                } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
                    validIsoTime = cleanTime; 
                    const [date, time] = validIsoTime.split(' ');
                    const [y, m, d] = date.split('-');
                    displayTime = `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${y} ${time.substring(0, 5)}`;
                } else {
                    return;
                }
                
                const cleanType = String(log.typ)
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
                    .toLowerCase();

                let recordType = null;
                if (cleanType.includes('prichod')) recordType = 'prichod';
                else if (cleanType.includes('odchod')) recordType = 'odchod';
                else if (cleanType.includes('prestavka')) recordType = 'prestavka';
                else if (cleanType.includes('pn')) recordType = 'pn';
                
                if (recordType) {
                    records.push({
                        uid: log.uid,
                        userName: log.userName,
                        cas: validIsoTime, 
                        casDisplay: displayTime, 
                        stav: recordType,
                        // Pridanie d√°tumu a ƒçasu do samostatn√Ωch pol√≠ pre export
                        date: displayTime.substring(0, 10),
                        time: displayTime.substring(11, 16)
                    });
                }
            });
        }

        // 2. Triedenie pre zobrazenie (Najnov≈°ie prv√©)
        records.sort((a, b) => new Date(b.cas) - new Date(a.cas));
        allRecordsCache = records;
        
        // 3. Vykreslenie filtrov a tabuƒæky
        populateEmployeeFilter();
        renderTable(allRecordsCache);

    } catch (e) {
        console.error("Kritick√° chyba pri naƒç√≠tan√≠ d√°t:", e);
        dochadzkaTable.innerHTML = `<tr><td colspan="4">Kritick√° chyba: ${e.message}</td></tr>`;
    }
}

// --- Vykreslenie dropdown menu zamestnancov ---
function populateEmployeeFilter() {
    employeeFilter.innerHTML = '<option value="all">V≈°etci zamestnanci</option>';
    const sortedUsers = Object.values(allUsers).sort((a, b) => a.name.localeCompare(b.name));
    
    sortedUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.uid;
        option.textContent = user.name;
        employeeFilter.appendChild(option);
    });
}

// --- Vykreslenie tabuƒæky na z√°klade filtrov ---
function renderTable(records) {
    const selectedDate = dateFilter.value;
    const selectedEmployeeUid = employeeFilter.value;
    
    let filteredRecords = records;

    if (selectedDate) {
        filteredRecords = filteredRecords.filter(r => r.cas.substring(0, 10) === selectedDate);
    }

    if (selectedEmployeeUid !== 'all') {
        filteredRecords = filteredRecords.filter(r => r.uid === selectedEmployeeUid);
    }
    
    if (!filteredRecords.length) {
        dochadzkaTable.innerHTML = '<tr><td colspan="4">≈Ωiadne z√°znamy neboli n√°jden√© na z√°klade zvolen√Ωch filtrov.</td></tr>';
        return;
    }

    dochadzkaTable.innerHTML = filteredRecords.map(r => {
        let statusClass = '';
        if (r.stav === 'prichod') statusClass = 'status-prichod';
        else if (r.stav === 'odchod') statusClass = 'status-odchod';
        else if (r.stav === 'prestavka') statusClass = 'status-prestavka';
        else if (r.stav === 'pn') statusClass = 'status-pn';
        
        // Rozdelenie D√°tumu a ƒåasu pre prv√Ω stƒ∫pec (prehƒæadnos≈• pre admina)
        const [datePart, timePart] = r.casDisplay.split(' ');
        
        return `<tr>
            <td>${r.userName}</td>
            <td>${datePart} ${timePart}</td>
            <td><span class="status-badge ${statusClass}">${r.stav.toUpperCase()}</span></td>
            <td>${r.stav === 'pn' ? 'Pr√°ceneschopnos≈•' : r.stav === 'prestavka' ? 'Prest√°vka' : r.stav.toUpperCase()}</td>
        </tr>`;
    }).join('');
}


// --- POMOCN√Å FUNKCIA: Konverzia milisek√∫nd na form√°t HH:MM ---
function msToHhMm(ms) {
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// --- HLAVN√Å FUNKCIA: Export do XLSX s CELKOVOU SUMARIZ√ÅCIOU ---
document.getElementById('exportBtn').addEventListener('click', function() {
    
    const selectedDate = dateFilter.value;
    const selectedEmployeeUid = employeeFilter.value;
    
    let filteredRecords = allRecordsCache;
    
    if (selectedDate) {
        filteredRecords = filteredRecords.filter(r => r.cas.substring(0, 10) === selectedDate);
    }
    if (selectedEmployeeUid !== 'all') {
        filteredRecords = filteredRecords.filter(r => r.uid === selectedEmployeeUid);
    }
    
    // Filtrujeme len relevantn√© doch√°dzkov√© z√°znamy a triedime od najstar≈°ieho
    const dochadzkaRecords = filteredRecords
        .filter(r => r.stav === 'prichod' || r.stav === 'odchod')
        .sort((a, b) => new Date(a.cas) - new Date(b.cas));

    const exportData = [
        ["Typ z√°znamu:", "Sumarizovan√° doch√°dzka (Admin Export)"],
        ["Filter d√°tumu:", selectedDate || "V≈°etky d√°tumy"],
        ["Filter zamestnanca:", selectedEmployeeUid === 'all' ? "V≈°etci" : allUsers[selectedEmployeeUid]?.name || "Nezn√°my"],
        [], 
        ["Zamestnanec", "D√°tum", "ƒåas", "Typ", "Odpracovan√Ω ƒças/Status"] 
    ];

    let totalWorkMsGlobal = 0;
    const workSummaryByEmployee = {}; // { uid: totalWorkMs }
    const lastPrichodByEmployee = {}; // { uid: Date object }
    const dailySummary = {}; // { uid_date: dailyWorkMs }
    
    // 1. Prejdeme v≈°etky z√°znamy a vykon√°me p√°rovanie Pr√≠chod/Odchod
    dochadzkaRecords.forEach(record => {
        const key = record.uid;
        const currentDateStr = record.date; // DD.MM.RRRR
        const uidDateKey = `${key}_${currentDateStr}`;

        // Ak sa zmen√≠ de≈à, vynulujeme denn√Ω s√∫ƒçet
        if (!dailySummary[uidDateKey]) {
            dailySummary[uidDateKey] = 0;
        }

        if (record.stav === 'prichod') {
            lastPrichodByEmployee[key] = new Date(record.cas);
            exportData.push([record.userName, record.date, record.time, record.stav.toUpperCase(), ""]);
        } else if (record.stav === 'odchod') {
            const currentDateTime = new Date(record.cas);
            
            if (lastPrichodByEmployee[key]) {
                const durationMs = currentDateTime - lastPrichodByEmployee[key];
                const durationHhMm = msToHhMm(durationMs);
                
                workSummaryByEmployee[key] = (workSummaryByEmployee[key] || 0) + durationMs;
                dailySummary[uidDateKey] += durationMs;

                exportData.push([record.userName, record.date, record.time, record.stav.toUpperCase(), durationHhMm]);
                lastPrichodByEmployee[key] = null; // Vynulovanie po odchode
            } else {
                // Pr√≠pad odchodu bez predch√°dzaj√∫ceho pr√≠chodu
                exportData.push([record.userName, record.date, record.time, record.stav.toUpperCase(), "Chyba PRICHOD"]);
            }
        }
    });

    // 2. Pridanie sum√°rov do exportData (denn√© a celkov√©)

    // Denny Sum√°r (potrebn√© zoradi≈• pre lep≈°iu prehƒæadnos≈• v Exceli)
    const sortedDailyKeys = Object.keys(dailySummary).sort();
    sortedDailyKeys.forEach(uidDateKey => {
        if (dailySummary[uidDateKey] > 0) {
            const [uid, dateStr] = uidDateKey.split('_');
            const userName = allUsers[uid]?.name || "Nezn√°my UID";
            exportData.push(["", "Sumariz√°cia d≈àa:", userName, dateStr, msToHhMm(dailySummary[uidDateKey])]);
        }
    });
    
    exportData.push([]); 
    
    // Celkov√Ω Sum√°r podƒæa zamestnanca
    const sortedEmployeeUids = Object.keys(workSummaryByEmployee).sort((a, b) => allUsers[a].name.localeCompare(allUsers[b].name));
    
    sortedEmployeeUids.forEach(uid => {
        const totalWorkMs = workSummaryByEmployee[uid];
        totalWorkMsGlobal += totalWorkMs;
        exportData.push([allUsers[uid].name, "Celkov√° doba:", "", "", msToHhMm(totalWorkMs)]);
    });

    exportData.push([]);
    exportData.push(["Celkov√° odpracovan√° doba (V≈°etci):", "", "", "", msToHhMm(totalWorkMsGlobal)]);
    
    // 3. Export XLSX
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    
    // Vizu√°lne √∫pravy
    ws['!cols'] = [
        { wpx: 150 }, // A: Zamestnanec
        { wpx: 100 }, // B: D√°tum/Sumariz√°cia
        { wpx: 80 },  // C: ƒåas
        { wpx: 100 }, // D: Typ
        { wpx: 150 }  // E: Odpracovan√Ω ƒças/Status
    ];
    
    for (let i = 5; i < exportData.length; i++) { // Zaƒç√≠name po hlaviƒçke
        const row = exportData[i];
        
        // Zv√Ωraznenie denn√©ho sum√°ru
        if (row[1] === "Sumariz√°cia d≈àa:") {
            // Zamestnanec (A) a Suma (E)
            XLSX.utils.encode_cell({ r: i, c: 0 }); // Pridaj tuƒçn√© do mena
            XLSX.utils.encode_cell({ r: i, c: 4 }); // Pridaj tuƒçn√© do sumy
            
            const cellRefSum = XLSX.utils.encode_cell({ r: i, c: 4 }); 
            if (ws[cellRefSum]) { ws[cellRefSum].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFFCC00" } } }; }
        }
        
        // Zv√Ωraznenie celkov√©ho sum√°ru pre zamestnanca
        if (row[1] === "Celkov√° doba:") {
            // Zamestnanec (A) a Suma (E)
            const textCellRef = XLSX.utils.encode_cell({ r: i, c: 0 });
            if (ws[textCellRef]) { ws[textCellRef].s = { font: { bold: true } }; }
            
            const cellRefSum = XLSX.utils.encode_cell({ r: i, c: 4 }); 
            if (ws[cellRefSum]) { ws[cellRefSum].s = { font: { bold: true }, fill: { fgColor: { rgb: "FF00B050" } } }; }
        }

        // Zv√Ωraznenie celkov√©ho glob√°lneho sum√°ru (posledn√Ω riadok)
        if (i === exportData.length - 1) {
            for (let c = 0; c < 5; c++) {
                const cellRef = XLSX.utils.encode_cell({ r: i, c: c });
                 if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FF007bff" } }, font: { color: { rgb: "FFFFFFFF" }, bold: true } }; }
            }
        }
        
        // Zv√Ωraznenie chybov√©ho stavu
        if (row[4] === "Chyba PRICHOD") { 
            const cellRef = XLSX.utils.encode_cell({ r: i, c: 4 }); 
            if (ws[cellRef]) { ws[cellRef].s = { font: { bold: true, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FFCC0000" } } }; }
        }
    }


    XLSX.utils.book_append_sheet(wb, ws, "AdminPrehlad");

    const fileName = `admin_export_dochadzka_${selectedEmployeeUid}_${selectedDate || 'all'}.xlsx`;
    XLSX.writeFile(wb, fileName);

    // Sp√§tn√° v√§zba na tlaƒçidle
    const btn = document.getElementById('exportBtn');
    if(btn) {
        btn.textContent = "S√∫bor stiahnut√Ω!";
        setTimeout(() => btn.textContent = "Exportova≈• zobrazen√© d√°ta do XLSX", 2000);
    }
});


// --- Listenery ---
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("uid");
    window.location.href = "index.html";
});

document.getElementById('applyFilterBtn').addEventListener('click', () => {
    renderTable(allRecordsCache);
});

// --- Spustenie aplik√°cie ---
loadAllData();
</script>
</body>
</html>
