<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin panel ‚Äì Doch√°dzka</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: linear-gradient(135deg, #007bff, #6f42c1);
  color: #333;
  min-height: 100vh;
}
header {
  background: #fff;
  padding: 15px 25px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 10;
}
h1 {
  color: #007bff;
  margin: 0;
  font-size: 22px;
  font-weight: 600;
}
button {
  background: #007bff;
  border: none;
  color: white;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.3s;
}
button:hover { background: #0056b3; }
nav {
  background: #fff;
  display: flex;
  justify-content: center;
  padding: 10px;
  gap: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  position: sticky;
  top: 70px;
  z-index: 5;
}
nav button {
  background: #007bff;
  color: white;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 500;
}
nav button.active {
  background: #6f42c1;
}
section {
  display: none;
  padding: 25px;
  background: #fff;
  margin: 25px auto;
  border-radius: 12px;
  max-width: 1000px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
section.active {
  display: block;
}
h2 {
  color: #007bff;
  margin-top: 0;
  border-bottom: 2px solid #007bff;
  padding-bottom: 5px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  border-radius: 8px;
  overflow: hidden;
}
th, td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: left;
  font-size: 14px;
}
th {
  background: #007bff;
  color: white;
  font-weight: 500;
}
tr:nth-child(even) {
  background: #f8f9fa;
}
.loader {
  text-align: center;
  padding: 20px;
  color: #007bff;
  font-weight: bold;
}
td button {
  background: #dc3545;
  font-size: 13px;
}
td button:hover {
  background: #a71d2a;
}
.export-btn {
  margin-top: 15px;
  background: #28a745;
}
.export-btn:hover {
  background: #1e7e34;
}
</style>
</head>
<body>

<header>
  <h1>Admin panel ‚Äì Doch√°dzkov√Ω syst√©m</h1>
  <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<nav>
  <button data-target="dochadzka" class="active">Doch√°dzka</button>
  <button data-target="prest√°vky">Prest√°vky</button>
  <button data-target="pn">PN</button>
  <button data-target="pouzivatelia">Pou≈æ√≠vatelia</button>
</nav>

<section id="dochadzka" class="active">
  <h2>Doch√°dzka</h2>
  <button class="export-btn" onclick="exportTable('dochadzkaTable')">Exportova≈• do CSV</button>
  <div id="dochadzkaTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="prest√°vky">
  <h2>Prest√°vky</h2>
  <button class="export-btn" onclick="exportTable('prest√°vkyTable')">Exportova≈• do CSV</button>
  <div id="prest√°vkyTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pn">
  <h2>PN</h2>
  <button class="export-btn" onclick="exportTable('pnTable')">Exportova≈• do CSV</button>
  <div id="pnTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pouzivatelia">
  <h2>Pou≈æ√≠vatelia</h2>
  <div id="usersTable" class="loader">Naƒç√≠tavam pou≈æ√≠vateƒæov...</div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ‚úÖ ADMIN LOGIN KONTROLA
const isAdmin = localStorage.getItem("isAdmin");
if (isAdmin !== "true") {
  alert("Pr√≠stup len pre admina!");
  window.location.href = "index.html";
}

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("isAdmin");
  window.location.href = "index.html";
});

// üî• Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain: "dochadzkaesp32.firebaseapp.com",
  databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dochadzkaesp32",
  storageBucket: "dochadzkaesp32.firebasestorage.app",
  messagingSenderId: "417668021105",
  appId: "1:417668021105:web:7fa3e144892d8b304854d0"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// üïí Pomocn√° funkcia na form√°tovanie ƒçasu
function formatTimestamp(value) {
  if (!isNaN(value) && value > 1000000000) {
    const date = new Date(parseInt(value));
    return date.toLocaleString('sk-SK');
  }
  return value;
}

// üß≠ Prep√≠nanie sekci√≠
document.querySelectorAll("nav button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
    document.getElementById(btn.dataset.target).classList.add("active");
  });
});

// üìä Naƒç√≠tanie d√°t s konverziou ƒçasu
function loadTable(refName, tableId) {
  const container = document.getElementById(tableId);
  onValue(ref(db, refName), snapshot => {
    if (!snapshot.exists()) {
      container.innerHTML = "<p>≈Ωiadne d√°ta.</p>";
      return;
    }

    let data = [];

    snapshot.forEach(userSnap => {
      if (typeof userSnap.val() === "object") {
        userSnap.forEach(recordSnap => {
          const record = recordSnap.val();
          data.push({
            user: userSnap.key,
            ...record
          });
        });
      } else {
        data.push({ key: userSnap.key, ...userSnap.val() });
      }
    });

    if (data.length === 0) {
      container.innerHTML = "<p>≈Ωiadne d√°ta.</p>";
      return;
    }

    let html = "<table><thead><tr>";
    const keys = Object.keys(data[0]);
    keys.forEach(k => html += `<th>${k}</th>`);
    html += "</tr></thead><tbody>";

    data.forEach(item => {
      html += "<tr>";
      keys.forEach(k => html += `<td>${formatTimestamp(item[k])}</td>`);
      html += "</tr>";
    });
    html += "</tbody></table>";
    container.innerHTML = html;
  }, err => {
    console.error(err);
    container.innerHTML = "<p>Chyba naƒç√≠tania d√°t!</p>";
  });
}

// üîÑ Naƒç√≠tania sekci√≠
loadTable("dochadzka", "dochadzkaTable");
loadTable("prest√°vky", "prest√°vkyTable");
loadTable("pn", "pnTable");

// üë• Pou≈æ√≠vatelia
function loadUsers() {
  const container = document.getElementById("usersTable");
  onValue(ref(db, "users"), snapshot => {
    if (!snapshot.exists()) {
      container.innerHTML = "<p>≈Ωiadni pou≈æ√≠vatelia.</p>";
      return;
    }

    let html = `<table>
      <tr><th>Meno</th><th>UID</th><th>Akcie</th></tr>`;

    snapshot.forEach(child => {
      const u = child.val();
      html += `
        <tr>
          <td>${u.name}</td>
          <td>${u.chipUid || "-"}</td>
          <td><button onclick="deleteUser('${child.key}')">Vymaza≈•</button></td>
        </tr>`;
    });

    html += "</table>";
    container.innerHTML = html;
  }, err => {
    console.error(err);
    container.innerHTML = "<p>Chyba naƒç√≠tania pou≈æ√≠vateƒæov.</p>";
  });
}
loadUsers();

// ‚ùå Mazanie pou≈æ√≠vateƒæov + d√°t
window.deleteUser = async (key) => {
  if (!confirm("Naozaj chcete vymaza≈• pou≈æ√≠vateƒæa a jeho d√°ta?")) return;
  try {
    await Promise.all([
      remove(ref(db, "users/" + key)),
      remove(ref(db, "dochadzka/" + key)),
      remove(ref(db, "prest√°vky/" + key)),
      remove(ref(db, "pn/" + key))
    ]);
    alert("Pou≈æ√≠vateƒæ a jeho d√°ta boli odstr√°nen√©.");
  } catch (err) {
    console.error(err);
    alert("Chyba pri mazan√≠ pou≈æ√≠vateƒæa.");
  }
};

// üì§ Export do CSV (aj s form√°tovan√≠m ƒçasu)
window.exportTable = (tableId) => {
  const table = document.querySelector(`#${tableId} table`);
  if (!table) return;
  let csv = [];
  const headers = [];
  for (let cell of table.rows[0].cells) headers.push(cell.textContent);
  csv.push(headers.join(','));

  for (let i = 1; i < table.rows.length; i++) {
    let rowData = [];
    for (let j = 0; j < table.rows[i].cells.length; j++) {
      let cellValue = table.rows[i].cells[j].textContent;
      rowData.push(`"${cellValue.replace(/"/g, '""')}"`);
    }
    csv.push(rowData.join(','));
  }

  const csvContent = csv.join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${tableId}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>









