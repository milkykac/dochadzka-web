<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin panel â€“ DochÃ¡dzka</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* â€¦ tu mÃ´Å¾eÅ¡ ponechaÅ¥ celÃ½ CSS Å¡tÃ½l zo starÃ©ho admin.html â€¦ */
</style>
</head>
<body>

<header>
<h1>Admin panel â€“ DochÃ¡dzka</h1>
<button onclick="logout()">OdhlÃ¡siÅ¥ sa</button>
</header>

<nav>
<button data-target="dochadzka" class="active">DochÃ¡dzka</button>
<button data-target="prestavky">PrestÃ¡vky</button>
<button data-target="pn">PN</button>
<button data-target="pouzivatelia">PouÅ¾Ã­vatelia</button>
</nav>

<section id="dochadzka" class="active">
<h2>DochÃ¡dzka</h2>
<button class="export-btn" onclick="exportTable('dochadzkaTable')">ExportovaÅ¥ do CSV</button>
<div style="display:flex; gap:10px; margin-top:10px;">
<input type="date" id="dateDochadzka" style="flex:1;">
<input type="text" id="searchDochadzka" placeholder="HÄ¾adaÅ¥..." style="flex:2;">
</div>
<div id="dochadzkaTable" class="loader">NaÄÃ­tavam dÃ¡ta...</div>
</section>

<section id="prestavky">
<h2>PrestÃ¡vky</h2>
<button class="export-btn" onclick="exportTable('prestavkyTable')">ExportovaÅ¥ do CSV</button>
<div style="display:flex; gap:10px; margin-top:10px;">
<input type="date" id="datePrestavky" style="flex:1;">
<input type="text" id="searchPrestavky" placeholder="HÄ¾adaÅ¥..." style="flex:2;">
</div>
<div id="prestavkyTable" class="loader">NaÄÃ­tavam dÃ¡ta...</div>
</section>

<section id="pn">
<h2>PN</h2>
<button class="export-btn" onclick="exportTable('pnTable')">ExportovaÅ¥ do CSV</button>
<div style="display:flex; gap:10px; margin-top:10px;">
<input type="date" id="datePN" style="flex:1;">
<input type="text" id="searchPN" placeholder="HÄ¾adaÅ¥..." style="flex:2;">
</div>
<div id="pnTable" class="loader">NaÄÃ­tavam dÃ¡ta...</div>
</section>

<section id="pouzivatelia">
<h2>PouÅ¾Ã­vatelia</h2>
<button class="export-btn" onclick="exportTable('usersTable')">ExportovaÅ¥ do CSV</button>
<div id="usersTable" class="loader">NaÄÃ­tavam pouÅ¾Ã­vateÄ¾ov...</div>
<h3>NepriradenÃ© Äipy</h3>
<div id="newChipsContainer" class="loader">NaÄÃ­tavam Äipy...</div>
</section>

<div id="changePasswordModal" class="modal">
<div class="modal-content">
<span id="closeModal" onclick="closeModal()">&times;</span>
<h3>ZmeniÅ¥ heslo</h3>
<input type="hidden" id="changePasswordUserId">
<input type="password" id="newPassword" placeholder="NovÃ© heslo">
<button onclick="saveNewPassword()">UloÅ¾iÅ¥</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, child, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
  authDomain: "maturita-395fd.firebaseapp.com",
  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
  projectId: "maturita-395fd",
  storageBucket: "maturita-395fd.firebasestorage.app",
  messagingSenderId: "754745500563",
  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const analytics = getAnalytics(app);

// PrepÃ­nanie sekciÃ­
document.querySelectorAll("nav button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
    document.getElementById(btn.dataset.target).classList.add("active");
    loadSection(btn.dataset.target);
  });
});

// Export CSV
function exportTable(id){
  const table=document.getElementById(id).querySelector("table");
  if(!table)return alert("Å½iadne dÃ¡ta na export.");
  let csv=[];
  table.querySelectorAll("tr").forEach(row=>{
    const cols=[...row.querySelectorAll("th,td")].map(td=>`"${td.innerText}"`);
    csv.push(cols.join(","));
  });
  const blob=new Blob([csv.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${id}.csv`;
  a.click();
}

// Funkcia na naÄÃ­tanie dochÃ¡dzky/prestaviek/PN
async function loadAttendance(type, tableId, dateId, searchId){
  const el=document.getElementById(tableId);
  el.innerHTML="NaÄÃ­tavam dÃ¡ta...";
  const dateFilter=document.getElementById(dateId)?.value;
  const search=document.getElementById(searchId)?.value.toLowerCase()||"";

  try{
    const dbRef = ref(db);
    const snap = await get(child(dbRef, "users"));
    if(!snap.exists()){ el.innerHTML="Å½iadni pouÅ¾Ã­vatelia"; return; }

    let html="<table><tr><th>Meno</th><th>ÄŒas</th><th>Typ</th></tr>";
    const users = snap.val();

    Object.keys(users).forEach(uid=>{
      const user = users[uid];
      const logsObj = user[type] || {};
      Object.keys(logsObj).forEach(logKey=>{
        const log = logsObj[logKey];
        const logDate = (log.cas || "").slice(0,10);
        const name = user.name || "(bez mena)";
        if((!dateFilter || logDate===dateFilter) && (!search || name.toLowerCase().includes(search))){
          html += `<tr><td>${name}</td><td>${log.cas || "-"}</td><td>${log.typ || type}</td></tr>`;
        }
      });
    });

    html += "</table>";
    el.innerHTML = html;
  } catch(e){
    el.innerHTML="Chyba pri naÄÃ­tanÃ­ dÃ¡t.";
    console.error(e);
  }
}

// PouÅ¾Ã­vatelia
async function loadUsers(){
  const el=document.getElementById("usersTable");
  el.innerHTML="NaÄÃ­tavam pouÅ¾Ã­vateÄ¾ov...";
  try{
    const dbRef = ref(db);
    const snap = await get(child(dbRef, "users"));
    if(!snap.exists()){el.innerHTML="Å½iadni pouÅ¾Ã­vatelia"; return;}
    const users = snap.val();

    let html="<table><tr><th>Meno</th><th>ÄŒip</th><th>Akcie</th></tr>";
    Object.keys(users).forEach(uid=>{
      const d = users[uid];
      html += `<tr><td>${d.name||"(bez mena)"}</td><td>${d.chipUid||"-"}</td>
      <td><button onclick="removeUser('${uid}')">ğŸ—‘ï¸</button>
      <button onclick="openChangePassword('${uid}')">ğŸ”‘</button></td></tr>`;
    });
    html+="</table>";
    el.innerHTML=html;
  }catch(e){el.innerHTML="Chyba pri naÄÃ­tanÃ­ pouÅ¾Ã­vateÄ¾ov.";}
}

// NovÃ© Äipy
async function loadNewChips(){
  const el=document.getElementById("newChipsContainer");
  el.innerHTML="NaÄÃ­tavam Äipy...";
  try{
    const dbRef = ref(db);
    const snap = await get(child(dbRef, "newChips"));
    el.innerHTML="";
    if(!snap.exists()){el.innerHTML="Å½iadne novÃ© Äipy"; return;}
    const chips = snap.val();
    Object.keys(chips).forEach(chip=>{
      const div=document.createElement("div");
      div.className="new-chip";
      div.innerHTML=`${chip} <button onclick="assignChip('${chip}')">PriradiÅ¥</button> <button onclick="removeChip('${chip}')">OdstrÃ¡niÅ¥</button>`;
      el.appendChild(div);
    });
  }catch(e){el.innerHTML="Chyba pri naÄÃ­tanÃ­ Äipov.";}
}

// PomocnÃ© funkcie
async function assignChip(chipUid){
  const name=prompt("Zadaj meno pouÅ¾Ã­vateÄ¾a:");
  if(!name) return;
  const dbRef = ref(db);
  const snap = await get(child(dbRef, "users"));
  const users = snap.val();
  let uid=null;
  Object.keys(users).forEach(key=>{ if(users[key].name===name) uid=key; });
  if(!uid) return alert("PouÅ¾Ã­vateÄ¾ nenÃ¡jdenÃ½!");
  await set(ref(db, `users/${uid}/chipUid`), chipUid);
  await set(ref(db, `newChips/${chipUid}`), null);
  loadUsers(); loadNewChips();
}

async function removeChip(chipUid){
  if(confirm("Naozaj odstrÃ¡niÅ¥ Äip?")){
    await set(ref(db, `newChips/${chipUid}`), null);
    loadNewChips();
  }
}

async function removeUser(id){
  if(confirm("OdstrÃ¡niÅ¥ pouÅ¾Ã­vateÄ¾a?")){
    await set(ref(db, `users/${id}`), null);
    loadUsers();
  }
}

function logout(){alert("OdhlÃ¡senie");}
function openChangePassword(id){ document.getElementById("changePasswordModal").style.display="flex"; document.getElementById("changePasswordUserId").value=id; }
function closeModal(){ document.getElementById("changePasswordModal").style.display="none"; }
async function saveNewPassword(){
  const id=document.getElementById("changePasswordUserId").value;
  const pass=document.getElementById("newPassword").value.trim();
  if(!pass)return alert("Zadaj novÃ© heslo.");
  await set(ref(db, `users/${id}/password`), pass);
  alert("Heslo zmenenÃ©.");
  closeModal();
}

// Sekcie
function loadSection(id){
  if(id==="dochadzka") loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka");
  if(id==="prestavky") loadAttendance("prestavky","prestavkyTable","datePrestavky","searchPrestavky");
  if(id==="pn") loadAttendance("pn","pnTable","datePN","searchPN");
  if(id==="pouzivatelia"){ loadUsers(); loadNewChips(); }
}

// InicializÃ¡cia
loadSection("dochadzka");
["dateDochadzka","searchDochadzka","datePrestavky","searchPrestavky","datePN","searchPN"].forEach(id=>{
  document.getElementById(id).addEventListener("input",()=>{ loadSection(document.querySelector("section.active").id); });
});
</script>
</body>
</html>


