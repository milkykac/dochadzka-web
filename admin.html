<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, push, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

if(localStorage.getItem("uid") !== "admin"){ 
  alert("Nem√°≈° pr√≠stup!"); 
  window.location.href="index.html"; 
}

document.getElementById("logoutBtn").addEventListener("click",()=>{
  localStorage.removeItem("uid");
  window.location.href="index.html";
});

const firebaseConfig = {
  apiKey:"AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain:"dochadzkaesp32.firebaseapp.com",
  databaseURL:"https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"dochadzkaesp32",
  storageBucket:"dochadzkaesp32.firebasestorage.app",
  messagingSenderId:"417668021105",
  appId:"1:417668021105:web:7fa3e144892d8b304854d0",
  measurementId:"G-ZKQNMZEPHD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const nameInput=document.getElementById("name");
const passInput=document.getElementById("password");
const chipUidInput=document.getElementById("chipUid");
const addBtn=document.getElementById("addUserBtn");
const userBody=document.getElementById("userBody");
const attendanceBody=document.getElementById("attendanceBody");
const filterDate=document.getElementById("filterDate");
const filterName=document.getElementById("filterName");
const exportBtn=document.getElementById("exportBtn");
const passwordModal=document.getElementById("passwordModal");
const newPasswordInput=document.getElementById("newPassword");
const changePasswordBtn=document.getElementById("changePasswordBtn");
const closeModal=document.getElementsByClassName("close")[0];

let allUsers={}, allAttendance=[], currentUserUid=null;

/* --- Pridanie / aktualiz√°cia pou≈æ√≠vateƒæa --- */
addBtn.addEventListener("click", async ()=>{
  const name=nameInput.value.trim(), password=passInput.value.trim(), chipUid=chipUidInput.value.trim();
  if(!name||!password||!chipUid){alert("Vypl≈à v≈°etky polia!"); return;}
  try{
    const newRef = push(ref(db,"users/"));
    await set(newRef,{name,password,chipUid});
    alert("Pou≈æ√≠vateƒæ pridan√Ω ‚úÖ");
    nameInput.value = passInput.value = chipUidInput.value = "";
  }catch(err){console.error(err); alert("Chyba pri prid√°van√≠ pou≈æ√≠vateƒæa!");}
});

/* --- Naƒç√≠tanie pou≈æ√≠vateƒæov --- */
const usersRef=ref(db,"users/");
onValue(usersRef,(snapshot)=>{
  userBody.innerHTML=""; allUsers={}; filterName.innerHTML='<option value="">V≈°etci</option>';
  if(!snapshot.exists()){userBody.innerHTML="<tr><td colspan='5'>≈Ωiadni zamestnanci</td></tr>"; return;}
  snapshot.forEach(child=>{
    const data = child.val(); 
    allUsers[child.key] = data;
    const option = document.createElement("option"); option.value = data.name; option.textContent = data.name; filterName.appendChild(option);
    const row = document.createElement("tr");
    row.innerHTML=`<td>${child.key}</td><td>${data.name}</td><td>***</td><td>${data.chipUid||''}</td>
      <td><button class="action-btn" onclick="deleteUser('${child.key}')">Zmaza≈•</button>
      <button class="action-btn" onclick="openPasswordModal('${child.key}')">Zmeni≈• heslo</button></td>`;
    userBody.appendChild(row);
  });
});

/* --- Doch√°dzka --- */
const attendanceRef=ref(db,"dochadzka/");
onValue(attendanceRef,(snapshot)=>{
  allAttendance=[];
  if(snapshot.exists()){
    snapshot.forEach(userSnap=>{
      const userId = userSnap.key; 
      const userData = allUsers[userId];
      const userChip = userData ? userData.chipUid : userId; // skutoƒçn√Ω chip UID
      userSnap.forEach(recordSnap=>{
        if(recordSnap.key==="posledny_stav") return;
        const record = recordSnap.val();
        allAttendance.push({chipUid: userChip, cas: record.cas, stav: record.stav});
      });
    });
  }
  applyFilters();
});

/* --- Automatick√© ƒçipy --- */
const newChipsRef=ref(db,"newChips/");
onValue(newChipsRef,(snap)=>{
  if(!snap.exists()) return;
  snap.forEach((child)=>{
    const uid=child.key, data=child.val();
    if(data.status==="unassigned") showNewChipPrompt(uid);
  });
});
function showNewChipPrompt(uid){
  if(document.getElementById("newChipBanner")) return;
  const banner=document.createElement("div");
  banner.id="newChipBanner"; banner.className="new-chip-banner";
  banner.innerHTML=`ü™™ Na≈°iel sa nov√Ω ƒçip <b>${uid}</b> 
    <button id="assignBtn">Priradi≈•</button> <button id="dismissBtn">Zavrie≈•</button>`;
  document.body.appendChild(banner);
  document.getElementById("assignBtn").addEventListener("click",()=>{
    const name=prompt("Zadaj meno pre ƒçip "+uid);
    if(name){
      const newRef=push(ref(db,"users/"));
      set(newRef,{name,password:"default",chipUid:uid});
      update(ref(db,"newChips/"+uid),{status:"assigned"});
      banner.remove();
    }
  });
  document.getElementById("dismissBtn").addEventListener("click",()=>banner.remove());
}

/* --- Filtrovanie doch√°dzky --- */
function applyFilters(){
  const selectedDate=filterDate.value, selectedName=filterName.value;
  attendanceBody.innerHTML="";
  let filtered = allAttendance.filter(record=>{
    let matchDate = !selectedDate || record.cas.split(' ')[0]===selectedDate;
    let matchName = true;
    if(selectedName){
      const user = Object.values(allUsers).find(u => u.chipUid === record.chipUid);
      matchName = user && user.name===selectedName;
    }
    return matchDate && matchName;
  });
  if(!filtered.length) attendanceBody.innerHTML="<tr><td colspan='3'>≈Ωiadne z√°znamy</td></tr>";
  else filtered.forEach(record=>{
    const row=document.createElement("tr");
    const user = Object.values(allUsers).find(u => u.chipUid === record.chipUid);
    const name = user ? user.name : record.chipUid;
    row.innerHTML = `<td>${name}</td><td>${record.cas}</td><td>${record.stav}</td>`;
    attendanceBody.appendChild(row);
  });
}
filterDate.addEventListener("change",applyFilters);
filterName.addEventListener("change",applyFilters);

/* --- Export CSV --- */
exportBtn.addEventListener("click",()=>{
  let csv="Zamestnanec,ƒåas,Stav\n";
  allAttendance.forEach(record=>{
    const user = Object.values(allUsers).find(u => u.chipUid===record.chipUid);
    const name = user ? user.name : record.chipUid;
    csv += `"${name}","${record.cas}","${record.stav}"\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='dochadzka.csv'; a.click(); URL.revokeObjectURL(url);
});

/* --- Mazanie a hesl√° --- */
function deleteUser(uid){ if(confirm("Naozaj zmaza≈•?")) remove(ref(db,"users/"+uid)); }
window.deleteUser = deleteUser;
function openPasswordModal(uid){ currentUserUid=uid; passwordModal.style.display="block"; }
window.openPasswordModal = openPasswordModal;
closeModal.onclick = ()=>passwordModal.style.display="none";
window.onclick = (e)=>{ if(e.target==passwordModal) passwordModal.style.display="none"; }
changePasswordBtn.addEventListener("click", async ()=>{
  const newPass = newPasswordInput.value.trim(); if(!newPass){alert("Zadaj nov√© heslo!"); return;}
  await update(ref(db,"users/"+currentUserUid), {password:newPass});
  alert("Heslo zmenen√© ‚úÖ"); newPasswordInput.value=""; passwordModal.style.display="none";
});

/* --- Prep√≠nanie sekci√≠ --- */
document.getElementById("manageUsersTab").addEventListener("click",()=>{
  document.getElementById("manage-users").classList.add("active");
  document.getElementById("view-attendance").classList.remove("active");
  document.getElementById("manageUsersTab").classList.add("active");
  document.getElementById("viewAttendanceTab").classList.remove("active");
});
document.getElementById("viewAttendanceTab").addEventListener("click",()=>{
  document.getElementById("manage-users").classList.remove("active");
  document.getElementById("view-attendance").classList.add("active");
  document.getElementById("viewAttendanceTab").classList.add("active");
  document.getElementById("manageUsersTab").classList.remove("active");
});
</script>
</html>
body {font-family:'Poppins',sans-serif;background:#eef2f6;margin:0;padding:0;display:flex;}
.sidebar{width:230px;height:100vh;background:linear-gradient(180deg,#007bff 0%,#0056b3 100%);color:white;position:fixed;left:0;top:0;padding-top:30px;box-shadow:2px 0 10px rgba(0,0,0,0.15);display:flex;flex-direction:column;align-items:center;}
.sidebar h2{margin-bottom:40px;font-size:20px;font-weight:600;}
.sidebar ul{list-style:none;padding:0;width:100%;}
.sidebar li{padding:15px 30px;cursor:pointer;transition:0.3s;text-align:left;}
.sidebar li:hover,.sidebar li.active{background:rgba(255,255,255,0.2);}
header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.05);color:#333;text-align:center;padding:20px;font-size:22px;font-weight:600;position:fixed;top:0;left:230px;right:0;z-index:100;}
#logoutBtn{position:absolute;top:15px;right:30px;background:#dc3545;color:white;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;transition:0.3s;}
#logoutBtn:hover{background:#b52a3a;}
main{flex:1;margin-left:250px;margin-top:90px;padding:30px;}
section{display:none;}
section.active{display:block;background:#fff;padding:25px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.05);}
h2{color:#007bff;border-bottom:2px solid #007bff;padding-bottom:8px;margin-bottom:20px;}
input,select{padding:8px 12px;border-radius:8px;border:1px solid #ccc;margin:6px 4px;outline:none;}
button{background:#007bff;color:white;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;transition:0.3s;}
button:hover{background:#0056b3;}
table{border-collapse:collapse;width:100%;margin-top:20px;font-size:14px;}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:#007bff;color:white;}
tr:nth-child(even){background:#f9f9f9;}
.action-btn{background:#dc3545;border:none;color:white;padding:6px 10px;border-radius:6px;cursor:pointer;transition:0.3s;}
.action-btn:hover{background:#b52a3a;}
.modal{display:none;position:fixed;z-index:2;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);}
.modal-content{background:white;margin:15% auto;padding:20px;border-radius:10px;max-width:300px;}
.close{float:right;font-size:24px;cursor:pointer;color:#aaa;}
.close:hover{color:black;}
.new-chip-banner{position:fixed;top:75px;left:50%;transform:translateX(-50%);background:#ffc107;color:#000;padding:12px 25px;text-align:center;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.15);font-weight:600;z-index:1000;}
</style>
</head>
<body>

