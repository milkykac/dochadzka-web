<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin panel ‚Äì Doch√°dzka</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- P√îVODN√â A OPRAVEN√â ≈†T√ùLY --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; }
header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
h1 { color:#007bff; margin:0; font-size:22px; font-weight:600; }
/* VYLEP≈†ENIE: Hlavn√© tlaƒçidl√° */
button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; font-weight: 500;}
button:hover { background:#0056b3; }
nav { background:#fff; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:70px; z-index:5; flex-wrap:wrap; display: flex; justify-content: center; }
nav button.active { background:#6f42c1; }
section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }
table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
th,td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
th { background:#007bff; color:white; font-weight:500; }
tr:nth-child(even){ background:#f8f9fa; }
.loader{ text-align:center; padding:20px; color:#007bff; font-weight:bold; }
.export-btn{ margin-top:15px; background:#28a745; border-radius:8px; padding:8px 14px; }
.export-btn:hover{ background:#1e7e34; }

/* --- ≈†T√ùLY PRE ODZNAKY STAVU (Farebn√© bunky) --- */
.status-badge {
    font-weight: 700 !important;
    padding: 7px 14px !important;
    border-radius: 50px !important; 
    display: inline-block;
    text-align: center;
    min-width: 80px;
    white-space: nowrap;
    text-shadow: none !important; 
    color: white !important;
    font-size: 14px !important;
}
.status-prichod { 
    background: #198754 !important; /* Zelen√° */
    color: white !important; 
} 
.status-odchod { 
    background: #dc3545 !important; /* ƒåerven√° */
    color: white !important; 
} 
.status-prest√°vka, .status-prestavka { 
    background: #ffc107 !important; /* ≈Ωlt√° */
    color: #212529 !important; /* Tmav√Ω text na ≈æltej */
}
.status-pn { 
    background: #6f42c1 !important; /* Fialov√° */
    color: white !important;
} 

/* --- MODAL a POU≈Ω√çVATELIA --- */

/* OPRAVA: Kontrast nepriraden√Ωch ƒçipov */
.new-chip { 
    background:#17a2b8; 
    padding:8px 10px; 
    margin-bottom:8px; 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    border-radius:6px; 
    color:white; /* Biely text pre lep≈°√≠ kontrast */
    font-size:14px; 
    box-shadow:0 2px 6px rgba(0,0,0,0.1); 
}
.new-chip button { background:#007bff; border:none; padding:5px 8px; border-radius:4px; cursor:pointer; font-size:13px; }
.new-chip button:hover { background:#0056b3; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100; }
.modal-content{ background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; position:relative; animation:fadeIn 0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
.modal-content input{ width:100%; margin-top:10px; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
.modal-content button{ width:100%; margin-top:10px; border-radius:6px; padding:8px 0; font-weight:500; background:#007bff; color:white; transition:0.3s;}
.modal-content button:hover{ background:#0056b3; }
#closeModal{ position:absolute; right:10px; top:5px; font-size:22px; cursor:pointer; color:#333; }

/* OPRAVA: Vyn√∫tenie bieleho textu pre priraden√Ω ƒçip */
.chip-status-assigned { 
    background: #198754 !important; 
    color: white !important; /* KƒΩ√öƒåOV√Å OPRAVA: Prehƒæadn√Ω text na zelenom */
}
.chip-status-unassigned { 
    background: #6c757d !important; 
    color: white !important;
}

/* OPRAVA: Vylep≈°en√Ω vzhƒæad akƒçn√Ωch tlaƒçidiel pre pou≈æ√≠vateƒæov (vr√°tane ikoniek) */
.user-actions button { 
    background: #007bff; /* Modr√© pozadie pre akcie */
    border: none;
    color: white;
    padding: 5px 10px; 
    margin: 0 4px; 
    font-size: 14px;
    border-radius: 6px; 
    transition: 0.2s;
    min-width: 100px; 
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}
.user-actions button:hover {
    background: #0056b3;
}
.user-actions button.btn-remove { background: #dc3545; } /* Odstr√°ni≈• - ƒçerven√° */
.user-actions button.btn-password { background: #17a2b8; } /* Heslo - az√∫rov√° */
.user-actions button.btn-remove:hover { background: #c82333;}
.user-actions button.btn-password:hover { background: #138496;}

/* ----------------------------------- */
</style>
</head>
<body>

<header>
    <h1>Admin panel ‚Äì Doch√°dzka</h1>
    <button onclick="logout()">Odhl√°si≈• sa</button>
</header>

<nav>
    <button data-target="dochadzka" class="active">Doch√°dzka</button>
    <button data-target="prestavky">Prest√°vky</button>
    <button data-target="pn">PN</button>
    <button data-target="pouzivatelia">Pou≈æ√≠vatelia</button>
</nav>

<section id="dochadzka" class="active">
    <h2>Doch√°dzka (Pr√≠chod/Odchod)</h2>
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button style="background: #007bff;" onclick="addLog('dochadzka','pr√≠chod')">Pr√≠chod (ƒåip)</button>
        <button style="background: #dc3545;" onclick="addLog('dochadzka','odchod')">Odchod (ƒåip)</button>
        <button style="background: #ffc107; color: #333;" onclick="addLog('prestavky','prest√°vka_manual')">Prest√°vka (Meno)</button>
    </div>
    <button class="export-btn" data-export-table="dochadzka" onclick="exportTable('dochadzka')">Exportova≈• do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="dateDochadzka" style="flex:1;" onchange="loadSection('dochadzka')">
        <input type="text" id="searchDochadzka" placeholder="Hƒæada≈• podƒæa mena..." style="flex:2;" oninput="loadSection('dochadzka')">
    </div>
    <div id="dochadzkaTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="prestavky">
    <h2>Prest√°vky</h2>
    <button class="export-btn" data-export-table="prestavky" onclick="exportTable('prestavky')">Exportova≈• do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="datePrestavky" style="flex:1;" onchange="loadSection('prestavky')">
        <input type="text" id="searchPrestavky" placeholder="Hƒæada≈• podƒæa mena..." style="flex:2;" oninput="loadSection('prestavky')">
    </div>
    <div id="prestavkyTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pn">
    <h2>PN</h2>
    <button class="export-btn" data-export-table="pn" onclick="exportTable('pn')">Exportova≈• do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="datePN" style="flex:1;" onchange="loadSection('pn')">
        <input type="text" id="searchPN" placeholder="Hƒæada≈• podƒæa mena..." style="flex:2;" oninput="loadSection('pn')">
    </div>
    <div id="pnTable" class="loader">Naƒç√≠tavam d√°ta...</div>
</section>

<section id="pouzivatelia">
    <h2>Pou≈æ√≠vatelia</h2>
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="export-btn" data-export-table="users" onclick="exportTable('users')" style="background:#007bff;">Exportova≈• pou≈æ√≠vateƒæov</button>
        <button class="btn-add" style="background:#007bff;" onclick="addUser()">Prida≈• pou≈æ√≠vateƒæa</button>
    </div>
    <div id="usersTable" class="loader">Naƒç√≠tavam pou≈æ√≠vateƒæov...</div>
    <h3>Nepriraden√© ƒçipy</h3>
    <div id="newChipsContainer" class="loader">Naƒç√≠tavam ƒçipy...</div>
</section>

<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <span id="closeModal" onclick="closeModal()">&times;</span>
        <h3>Zmeni≈• heslo</h3>
        <input type="hidden" id="changePasswordUserId">
        <input type="password" id="newPassword" placeholder="Nov√© heslo">
        <button onclick="saveNewPassword()">Ulo≈æi≈•</button>
        <button onclick="closeModal()" style="background:#6c757d;">Zru≈°i≈•</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, child, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// !!! NAHRADTE TOTO VLASTNYMI UDAJMI Z FIREBASE !!!
const firebaseConfig = {
    apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
    authDomain: "maturita-395fd.firebaseapp.com",
    databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
    projectId: "maturita-395fd",
    storageBucket: "maturita-395fd.firebasestorage.app",
    messagingSenderId: "754745500563",
    appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
    measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Glob√°lne premenn√© pre cache d√°t
let allAdminRecordsCache = [];
let allUsersCache = {};


// --- HLAVN√â FUNKCIE PRE ROZHRANIE A D√ÅTA ---

// Hlavn√° funkcia pre prep√≠nanie sekci√≠
window.loadSection = function(id){
    if(id==="dochadzka") loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka");
    else if(id==="prestavky") loadAttendance("prestavky","prestavkyTable","datePrestavky","searchPrestavky");
    else if(id==="pn") loadAttendance("pn","pnTable","datePN","searchPN");
    else if(id==="pouzivatelia"){ loadUsers(); loadNewChips(); }
}

// Funkcia pre naƒç√≠tanie, filtrovanie a zobrazenie doch√°dzky (vr√°tane farebn√Ωch odznakov)
async function loadAttendance(type, tableId, dateId, searchId){
    const el = document.getElementById(tableId);
    el.innerHTML='<div class="loader">Naƒç√≠tavam d√°ta...</div>';

    // 1. Naƒç√≠tanie d√°t do cache, ak je pr√°zdna (vol√° sa len raz)
    if (allAdminRecordsCache.length === 0) {
        try {
            const snap = await get(ref(db, "users"));
            if(!snap.exists()) {
                el.innerHTML = '<table><tr><td colspan="3">≈Ωiadni pou≈æ√≠vatelia v datab√°ze.</td></tr></table>';
                return;
            }

            const allRecords = [];
            snap.forEach(userSnap => {
                const userData = userSnap.val();
                const userId = userSnap.key;
                const userName = userData.name || "(bez mena)";
                allUsersCache[userId] = userData; // Ulo≈æ√≠me do cache aj pou≈æ√≠vateƒæov

                ["dochadzka", "prestavky", "pn"].forEach(logType => {
                    const logsObj = userData[logType] || {};
                    Object.values(logsObj).forEach(log => {
                        if (!log || !log.cas || !log.typ) return;

                        let cleanTime = String(log.cas);
                        let validIsoTime = cleanTime;

                        // Logika na normaliz√°ciu d√°tumu/ƒçasu pre spr√°vne triedenie (YYYY-MM-DD HH:MM)
                        const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
                        const match = cleanTime.match(dateRegex);

                        if (match) {
                            const [full, day, month, year, time] = match;
                            validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
                        } else if (cleanTime.includes('T') && cleanTime.includes('-')) {
                            validIsoTime = cleanTime.replace('T', ' ');
                        } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
                            validIsoTime = cleanTime;
                        } else {
                            return;
                        }

                        // Normaliz√°cia typu na mal√∫ abecedu bez diakritiky
                        const cleanType = String(log.typ).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();  
                        let recordType = null;
                        if (cleanType.includes('prichod')) recordType = 'prichod';
                        else if (cleanType.includes('odchod')) recordType = 'odchod';
                        else if (cleanType.includes('prestavka')) recordType = 'prestavka';
                        else if (cleanType.includes('pn')) recordType = 'pn';

                        if (recordType) {
                            allRecords.push({
                                userId: userId,
                                userName: userName,
                                cas: validIsoTime, // Pre triedenie/filtrovanie
                                casDisplay: cleanTime, // P√¥vodn√Ω form√°t pre zobrazenie
                                date: validIsoTime.substring(0, 10), // YYYY-MM-DD
                                time: validIsoTime.substring(11, 16), // HH:MM
                                stav: recordType, // Normalizovan√Ω stav pre CSS
                                rawType: log.typ.toUpperCase() // P√¥vodn√Ω typ s diakritikou pre zobrazenie
                            });
                        }
                    });
                });
            });

            allAdminRecordsCache = allRecords;

        } catch (e) {
            el.innerHTML = "Chyba pri naƒç√≠tan√≠ d√°t.";
            console.error("Kritick√° chyba pri naƒç√≠tan√≠ d√°t pre admina:", e);
            return;
        }
    }

    // 2. Aplikovanie filtrov
    const dateFilter = document.getElementById(dateId)?.value || "";
    const search = document.getElementById(searchId)?.value.toLowerCase().trim() || "";  
    const expectedStav = {
      dochadzka: ["prichod", "odchod"],
      prestavky: ["prestavka"],
      pn: ["pn"]
    }[type];

    const filteredRecords = allAdminRecordsCache
      .filter(r => {
          const dateMatch = !dateFilter || r.date === dateFilter;
          const nameMatch = !search || r.userName.toLowerCase().includes(search);
          const typeMatch = expectedStav.includes(r.stav);
          return dateMatch && nameMatch && typeMatch;
      })
      .sort((a, b) => new Date(b.cas) - new Date(a.cas)); // Triedenie od najnov≈°ieho


    // 3. Generovanie HTML
    let html="<table><tr><th>Meno</th><th>ƒåas</th><th>Typ</th></tr>";
    let entriesFound = false;

    filteredRecords.forEach(log => {
        entriesFound = true;
        const logTypNormalized = log.stav;
        const rawType = log.rawType;
        
        // Aplikovanie triedy status-prichod, status-odchod, status-prestavka, status-pn
        let statusClass = 'status-' + logTypNormalized;
        
        html += `<tr>
            <td>${log.userName}</td>
            <td>${log.casDisplay || '-'}</td>
            <td><span class="status-badge ${statusClass}">${rawType}</span></td>
          </tr>`;
    });
    
    if (!entriesFound) {
      html += '<tr><td colspan="3">≈Ωiadne z√°znamy podƒæa filtra.</td></tr>';
    }
    
    html += "</table>";
    el.innerHTML = html;
}

// --- POMOCN√â FUNKCIE A MODAL LOGIKA ---

// Konverzia milisek√∫nd na form√°t HH:MM
function msToHhMm(ms) {
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// Funkcia pre export Pou≈æ√≠vateƒæov
async function exportUsersToXLSX() {
    const btn = document.querySelector(`[data-export-table="users"]`);
    if(btn) btn.textContent = "Generujem XLSX...";

    const exportData = [
        ["Export pou≈æ√≠vateƒæov a ƒçipov"],
        [],
        ["UID", "Meno", "Heslo", "ƒåip UID", "Status"]
    ];
    
    for (const userId in allUsersCache) {
        const user = allUsersCache[userId];
        if (userId === 'admin') continue;
        const chipStatus = user.chipUid ? `Priraden√Ω: ${user.chipUid}` : 'Nepriraden√Ω';
        exportData.push([
            userId,
            user.name || "(bez mena)",
            user.password || "",
            user.chipUid || "",
            chipStatus
        ]);
    }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    ws['!cols'] = [{ wpx: 150 }, { wpx: 150 }, { wpx: 100 }, { wpx: 150 }, { wpx: 150 }];
    XLSX.utils.book_append_sheet(wb, ws, "Pou≈æ√≠vatelia");

    XLSX.writeFile(wb, "pouzivatelia_export.xlsx");

    if(btn) {
        btn.textContent = "S√∫bor stiahnut√Ω!";
        setTimeout(() => btn.textContent = "Exportova≈• pou≈æ√≠vateƒæov", 2000);
    }
}


// Hlavn√° funkcia pre export d√°t do XLSX
window.exportTable = async function(sectionType){
    const btn = document.querySelector(`[data-export-table="${sectionType}"]`);
    if(sectionType === 'users') return exportUsersToXLSX();
    if(btn) btn.textContent = "Generujem XLSX...";

    // Z√≠skanie filtrov pre doch√°dzku/prest√°vky/pn
    const dateId = `date${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)}`;
    const searchId = `search${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)}`;

    const dateFilter = document.getElementById(dateId)?.value || "";
    const searchFilter = document.getElementById(searchId)?.value.toLowerCase().trim() || "";  
    
    const expectedStav = {
        dochadzka: ["prichod", "odchod"],
        prestavky: ["prestavka"],
        pn: ["pn"]
    }[sectionType];

    if (!expectedStav) {
        alert("Nezn√°my typ sekcie pre export.");
        if(btn) btn.textContent = "Exportova≈• do XLSX";
        return;
    }

    // Pr√≠prava d√°t: Aplikovanie filtrov a normaliz√°cia
    const recordsForExport = allAdminRecordsCache.filter(r => {
        const dateMatch = !dateFilter || r.date === dateFilter;
        const nameMatch = !searchFilter || (r.userName || "").toLowerCase().includes(searchFilter);
        const typeMatch = expectedStav.includes(r.stav);
        return dateMatch && nameMatch && typeMatch;
    }).sort((a, b) => new Date(a.cas) - new Date(b.cas));

    const wb = XLSX.utils.book_new();

    // Ak nebol filter na meno, exportujeme len jednoduch√∫ tabuƒæku v≈°etk√Ωch d√°t
    if (!searchFilter) {
        const simpleHeader = ["Meno", "D√°tum a ƒåas", "Typ"];
        const simpleData = recordsForExport.map(r => [r.userName, r.casDisplay, r.rawType]);
        
        const exportArray = [
            ["Export v≈°etk√Ωch z√°znamov", ""],
            ["Filter d√°tumu:", dateFilter || "V≈°etky"],
            [],
            simpleHeader,
            ...simpleData
        ];
        const ws = XLSX.utils.aoa_to_sheet(exportArray);
        ws['!cols'] = [{ wpx: 150 }, { wpx: 150 }, { wpx: 100 }];
        XLSX.utils.book_append_sheet(wb, ws, "V≈°etky Z√°znamy");

    } else {
        // Export s kalkul√°ciou (iba pre Doch√°dzku a filter na meno)

        const recordsByUser = recordsForExport.reduce((acc, r) => {
            acc[r.userId] = acc[r.userId] || { userName: r.userName, records: [] };
            acc[r.userId].records.push(r);
            return acc;
        }, {});

        for (const userId in recordsByUser) {
            const userRecords = recordsByUser[userId].records;
            const userName = recordsByUser[userId].userName;
            
            let exportData = [
                ["Pou≈æ√≠vateƒæ:", userName],
                ["Typ z√°znamu:", sectionType.toUpperCase()],
                ["Filter d√°tumu:", dateFilter || "V≈°etky"],
                [],  
            ];
            
            const sheetName = (userName.replace(/[^a-zA-Z0-9]/g, '').substring(0, 15) || "Export").substring(0, 30);
            
            if (sectionType === 'dochadzka') {
                exportData.push(["D√°tum", "ƒåas", "Typ", "Odpracovan√Ω ƒças/Status"]);
                
                let totalWorkMs = 0;
                let lastPrichod = null;
                let lastDate = null;
                let dailyWorkMs = 0;

                userRecords.forEach((record) => {
                    const currentDateTime = new Date(record.cas);
                    const currentDateStr = record.date;
                    const currentTimeStr = record.time;

                    if (lastDate && lastDate !== currentDateStr) {
                        if (dailyWorkMs > 0) {
                            exportData.push([lastDate, "Sumariz√°cia d≈àa:", "", msToHhMm(dailyWorkMs)]);
                        }
                        dailyWorkMs = 0;
                    }

                    if (record.stav === 'prichod') {
                        lastPrichod = currentDateTime;
                        exportData.push([currentDateStr, currentTimeStr, record.rawType, ""]);
                    } else if (record.stav === 'odchod' && lastPrichod) {
                        const durationMs = currentDateTime - lastPrichod;
                        const durationHhMm = msToHhMm(durationMs);
                        
                        totalWorkMs += durationMs;
                        dailyWorkMs += durationMs;

                        exportData.push([currentDateStr, currentTimeStr, record.rawType, durationHhMm]);
                        lastPrichod = null;
                    } else {
                        exportData.push([currentDateStr, currentTimeStr, record.rawType, "Ch√Ωba PR√çCHOD"]);
                    }
                    lastDate = currentDateStr;
                });

                // Fin√°lna Sumariz√°cia (Posledn√Ω de≈à)
                if (lastDate && dailyWorkMs > 0) {
                    exportData.push([lastDate, "Sumariz√°cia d≈àa:", "", msToHhMm(dailyWorkMs)]);
                }

                // Celkov√° Sumariz√°cia
                exportData.push([]);  
                exportData.push(["Celkov√° odpracovan√° doba:", "", "", msToHhMm(totalWorkMs)]);

            } else {
                // Pre Prest√°vky a PN
                exportData.push(["D√°tum a ƒåas", "Typ"]);
                userRecords.forEach(r => {
                    exportData.push([r.casDisplay, r.rawType]);
                });
            }
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            // Styling (prehƒæadnos≈• pri sum√°roch v XLSX)
            if (sectionType === 'dochadzka') {
                ws['!cols'] = [{ wpx: 100 }, { wpx: 150 }, { wpx: 100 }, { wpx: 150 }];
            } else {
                ws['!cols'] = [{ wpx: 150 }, { wpx: 100 }];
            }
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        }
    }

    const fileNameBase = searchFilter ? `${sectionType}_${searchFilter}` : sectionType;
    const fileName = `${fileNameBase}_export.xlsx`;
    
    XLSX.writeFile(wb, fileName);
    
    if(btn) {
        btn.textContent = "S√∫bor stiahnut√Ω!";
        setTimeout(() => btn.textContent = "Exportova≈• do XLSX", 2000);
    }
};

// --- FUNKCIE PRE SPR√ÅVU POU≈Ω√çVATEƒΩOV A ƒåIPOV ---

// Naƒç√≠tanie pou≈æ√≠vateƒæov
async function loadUsers(){
    const el = document.getElementById("usersTable");
    el.innerHTML="Naƒç√≠tavam pou≈æ√≠vateƒæov...";
    try{
        // Zabezpeƒçenie, ≈æe cache je naplnen√°
        if (Object.keys(allUsersCache).length === 0) {
            // Sk√∫si naƒç√≠ta≈• d√°ta doch√°dzky, ƒço napln√≠ aj allUsersCache
            await loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka"); 
        }

        if(Object.keys(allUsersCache).length === 0){ el.innerHTML="≈Ωiadni pou≈æ√≠vatelia."; return; }

        let html="<table><tr><th>Meno</th><th>ƒåip Status</th><th>Akcie</th></tr>";

        for (const key in allUsersCache) {
            const d = allUsersCache[key];
            if (key === 'admin') continue;

            const chip = d.chipUid;
            const statusClass = chip ? 'chip-status-assigned' : 'chip-status-unassigned';
            const chipDisplay = chip ? chip.substring(0, 8) + '...' : 'Nepriraden√Ω';
            const statusText = chip ? `Priraden√Ω (${chipDisplay})` : 'Nepriraden√Ω';
            
            html+=`<tr>
                <td>${d.name||"(bez mena)"}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td class="user-actions">
                    <button class="btn-remove" onclick="removeUser('${key}')">üóëÔ∏è Odstr√°ni≈•</button>
                    <button class="btn-password" onclick="openChangePassword('${key}')">üîë Heslo</button>
                </td>
            </tr>`;
        }
        html+="</table>";
        el.innerHTML=html;
    } catch(e){ el.innerHTML="Chyba pri naƒç√≠tan√≠ pou≈æ√≠vateƒæov."; console.error(e); }
}

// Naƒç√≠tanie nepriraden√Ωch ƒçipov
async function loadNewChips(){
    const el = document.getElementById("newChipsContainer");
    el.innerHTML="Naƒç√≠tavam ƒçipy...";
    try{
        const snap = await get(ref(db, "newChips"));
        el.innerHTML="";
        if(!snap.exists()){ el.innerHTML="≈Ωiadne nov√© ƒçipy na priradenie."; return; }
        
        Object.keys(snap.val()).reverse().forEach(chip=>{  
            const div = document.createElement("div");
            div.className="new-chip";
            // Vylep≈°en√© tlaƒçidl√° pre nepriraden√© ƒçipy
            div.innerHTML = `<span>${chip}</span> 
                <div>
                    <button onclick="assignChip('${chip}')">Priradi≈•</button>
                    <button onclick="removeChip('${chip}')" style="background:#dc3545;">Odstr√°ni≈•</button>
                </div>`;
            el.appendChild(div);
        });
    } catch(e){ el.innerHTML="Chyba pri naƒç√≠tan√≠ ƒçipov."; console.error(e); }
}

window.addUser = async function() {
    const name = prompt("Zadaj meno nov√©ho pou≈æ√≠vateƒæa:").trim();
    if(!name) return;

    const password = prompt(`Zadaj heslo pre ${name}:`).trim();
    if(!password || password.length < 4) return alert("Heslo mus√≠ ma≈• aspo≈à 4 znaky.");

    try {
        const newUserRef = push(ref(db, "users"));
        const newUserId = newUserRef.key;
        const newUserObject = { name: name, password: password, chipUid: null };

        await set(newUserRef, newUserObject);
        
        allUsersCache[newUserId] = newUserObject;
        alert(`Pou≈æ√≠vateƒæ ${name} bol √∫spe≈°ne pridan√Ω.`);
        loadUsers();
    }
    catch(e){ alert("Chyba pri prid√°van√≠ pou≈æ√≠vateƒæa."); console.error(e); }
};

window.removeUser = async function(id){
    if(confirm("Odstr√°ni≈• pou≈æ√≠vateƒæa a jeho doch√°dzku?")){
        const chipUid = allUsersCache[id]?.chipUid;
        
        await set(ref(db, `users/${id}`), null);
        if (chipUid) { await set(ref(db, `chipToUser/${chipUid}`), null); }
        
        delete allUsersCache[id];
        allAdminRecordsCache = allAdminRecordsCache.filter(r => r.userId !== id);
        
        alert("Pou≈æ√≠vateƒæ odstr√°nen√Ω.");
        loadUsers();
    }
};

window.assignChip = async function(chipUid){
    const name = prompt("Zadaj meno pou≈æ√≠vateƒæa, ktor√©mu chce≈° priradi≈• ƒçip:").trim();
    if(!name) return;

    let uid=null;
    for (const key in allUsersCache) {
        if ((allUsersCache[key].name || "").toLowerCase() === name.toLowerCase()) {
            uid = key;
            break;
        }
    }
    if(!uid) return alert("Pou≈æ√≠vateƒæ nen√°jden√Ω. Meno mus√≠ presne sedie≈•.");

    try{
        // Odstr√°nenie star√©ho priradenia ƒçipu, ak existuje
        if (allUsersCache[uid].chipUid) { await set(ref(db, `chipToUser/${allUsersCache[uid].chipUid}`), null); }
        
        // Nov√© priradenie
        await set(ref(db, `users/${uid}/chipUid`), chipUid);
        await set(ref(db, `chipToUser/${chipUid}`), uid);
        await set(ref(db, `newChips/${chipUid}`), null);
        
        allUsersCache[uid].chipUid = chipUid;
        
        alert(`ƒåip ${chipUid} bol priraden√Ω k ${name}.`);
        loadUsers(); loadNewChips();
    } catch(e){ alert("Chyba pri priraƒèovan√≠ ƒçipu."); console.error(e); }
};

window.removeChip = async function(chipUid){
    if(confirm(`Naozaj odstr√°ni≈• nepriraden√Ω ƒçip ${chipUid}?`)) {
        await set(ref(db, `newChips/${chipUid}`), null);
        loadNewChips();
    }
};

// --- LOGIKA MODAL OKNA ---

window.openChangePassword = function(id){
    document.getElementById("changePasswordModal").style.display="flex";
    document.getElementById("changePasswordUserId").value=id;
    document.getElementById("newPassword").value = ''; 
};

window.closeModal = function(){ document.getElementById("changePasswordModal").style.display="none"; };

window.saveNewPassword = async function(){
    const id=document.getElementById("changePasswordUserId").value;
    const pass=document.getElementById("newPassword").value.trim();
    if(!pass || pass.length < 4) return alert("Heslo mus√≠ ma≈• aspo≈à 4 znaky.");
    try{ 
        await set(ref(db, `users/${id}/password`), pass); 
        if (allUsersCache[id]) allUsersCache[id].password = pass;
        
        alert("Heslo zmenen√©."); 
        closeModal(); 
    }
    catch(e){ alert("Chyba pri zmene hesla."); console.error(e); }
};

window.logout = () => { localStorage.removeItem("uid"); window.location.href="index.html"; };

// --- Inicializ√°cia pri naƒç√≠tan√≠ DOM ---
document.addEventListener('DOMContentLoaded', () => {
    // Kontrola admina
    if (localStorage.getItem("uid") !== "admin") {
        alert("Pr√≠stup zamietnut√Ω. Iba pre admina.");
        // window.location.href = "index.html"; // Odkomentova≈• v produkƒçnom prostred√≠
        // return; // Odkomentova≈• v produkƒçnom prostred√≠
    }

    document.querySelectorAll("nav button").forEach(btn=>{
        btn.addEventListener("click",()=>{
            document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
            document.getElementById(btn.dataset.target).classList.add("active");
            window.loadSection(btn.dataset.target);
        });
    });
    // Predvolen√© naƒç√≠tanie doch√°dzky pri ≈°tarte
    window.loadSection("dochadzka");
});

// Zaznamenanie pr√≠chod/odchod/prest√°vka
window.addLog = async function(type, typ){
    
    let userId = null;
    let userName = null;
    let typeToSave = typ.toUpperCase().replace('_MANUAL', ''); // Napr. 'PREST√ÅVKA'
    let alertMessage = `Log (${typeToSave}) bol pridan√Ω pre `;

    if (typ === 'prest√°vka_manual') {
        // --- NOV√Å LOGIKA PRE PREST√ÅVKU (PODƒΩA MENA) ---
        const inputName = prompt(`Ready. Zadaj meno pou≈æ√≠vateƒæa pre ${typeToSave} (napr. 'Jozef Nov√°k'):`).trim();
        if (!inputName) return;

        // Vyhƒæadanie UID podƒæa mena
        for (const key in allUsersCache) {
            if ((allUsersCache[key].name || "").toLowerCase() === inputName.toLowerCase()) {
                userId = key;
                userName = allUsersCache[key].name;
                break;
            }
        }
        if (!userId) {
            alert("Pou≈æ√≠vateƒæ s menom '" + inputName + "' nebol n√°jden√Ω. Meno mus√≠ presne sedie≈•.");
            return;
        }
        alertMessage += userName;

    } else {
        // --- P√îVODN√Å LOGIKA PRE PR√çCHOD/ODCHOD (PODƒΩA ƒåIPU) ---
        alert(`Ready. Zadaj ƒçip pou≈æ√≠vateƒæa pre ${typeToSave}.`);

        const chipUid = prompt("Zadaj ƒçip pou≈æ√≠vateƒæa:").trim();
        if(!chipUid) return;

        const snap = await get(child(ref(db), `chipToUser/${chipUid}`));
        if(!snap.exists()){ alert("ƒåip nie je priraden√Ω!"); return; }
        userId = snap.val();
        
        // Ak je cache pr√°zdna, sk√∫sime ju naplni≈•, aby sme z√≠skali meno
        if (!allUsersCache[userId]) {
             allUsersCache[userId] = (await get(ref(db, `users/${userId}`))).val();
        }

        userName = allUsersCache[userId]?.name || "(Nezn√°me Meno)";
        alertMessage += userName;

        await new Promise(res => setTimeout(res, 500)); // Simul√°cia oneskorenia pri ƒçipe
    }
    
    if (!userId) return;

    // --- LOGIKA Z√ÅPISU DO DB (SPOLOƒåN√Å) ---
    const now = new Date();
    // Form√°t DD.MM.RRRR HH:MM
    const timestamp = now.getDate().toString().padStart(2, "0") + "." +
                        (now.getMonth() + 1).toString().padStart(2, "0") + "." +
                        now.getFullYear() + " " +
                        now.getHours().toString().padStart(2, "0") + ":" +
                        now.getMinutes().toString().padStart(2, "0");

    try {
        const newLogRef = push(child(ref(db, `users/${userId}`), type));
        const logData = { cas: timestamp, typ: typeToSave };
        
        await set(newLogRef, logData);

        // Akcia bola √∫spe≈°n√°
        alert(alertMessage);
        
        // Aktualiz√°cia cache a zobrazenia
        allAdminRecordsCache = []; // Vyn√∫ti≈• op√§tovn√© naƒç√≠tanie cache
        window.loadSection(type); 

    } catch (e) {
        alert("Chyba pri z√°pise logu do datab√°zy.");
        console.error("Chyba z√°pisu:", e);
    }
};
</script>

</body>
</html>
