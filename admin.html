<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äì Doch√°dzka</title>
<style>
  :root{--blue:#007bff;--blue-dark:#0056b3;}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#eef2f6;color:#222}
  .sidebar{width:220px;position:fixed;left:0;top:0;bottom:0;background:linear-gradient(180deg,var(--blue),var(--blue-dark));color:#fff;padding:28px 16px;box-shadow:2px 0 12px rgba(0,0,0,.12)}
  .sidebar h2{font-size:18px;margin:0 0 18px}
  .sidebar ul{list-style:none;padding:0;margin:0}
  .sidebar li{padding:10px 8px;border-radius:8px;cursor:pointer;margin-bottom:6px}
  .sidebar li.active,.sidebar li:hover{background:rgba(255,255,255,.12)}
  header{position:fixed;left:220px;right:0;top:0;height:68px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.06);z-index:10}
  header button{position:absolute;right:22px;top:14px;background:#dc3545;border:0;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer}
  main{margin-left:220px;padding:92px 28px 48px}
  section{display:none;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.04);margin-bottom:18px}
  section.active{display:block}
  h3{color:var(--blue);margin:0 0 12px}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  input,select{padding:8px 10px;border-radius:8px;border:1px solid #d6d9de;min-width:160px}
  button.primary{background:var(--blue);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #ddd;padding:7px 10px;border-radius:8px;cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e6e9ee;padding:10px;text-align:center;font-size:14px}
  th{background:var(--blue);color:#fff}
  tr:nth-child(even){background:#fbfcfe}
  .new-chip-banner{position:fixed;left:50%;transform:translateX(-50%);top:82px;background:#ffdd57;color:#111;padding:12px 18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.12);z-index:999}
  .small{font-size:13px;color:#666}
</style>
</head>
<body>
  <div class="sidebar">
    <h2>Admin panel</h2>
    <ul>
      <li id="tab-users" class="active">üë• Zamestnanci</li>
      <li id="tab-att" >üìã Doch√°dzka</li>
    </ul>
  </div>

  <header>
    <div>üõ†Ô∏è Administr√°cia doch√°dzky</div>
    <button id="logoutBtn">Odhl√°si≈• sa</button>
  </header>

  <main>
    <!-- USERS -->
    <section id="section-users" class="active">
      <h3>üë• Spr√°va zamestnancov</h3>
      <div class="row">
        <input id="name" placeholder="Meno" />
        <input id="password" placeholder="Heslo" />
        <input id="chipUid" placeholder="Chip UID" />
        <button id="addUserBtn" class="primary">Prida≈• / Aktualizova≈•</button>
      </div>
      <table>
        <thead><tr><th>UID</th><th>Meno</th><th>Heslo</th><th>Chip UID</th><th>Akcie</th></tr></thead>
        <tbody id="userBody"><tr><td colspan="5" class="small">Naƒç√≠tavam...</td></tr></tbody>
      </table>
    </section>

    <!-- ATTENDANCE -->
    <section id="section-att">
      <h3>üìã Doch√°dzka (Pr√≠chod / Odchod / Prest√°vka)</h3>

      <div class="row">
        <label class="small">Filtrova≈•:</label>
        <input type="date" id="filterDate" />
        <select id="filterName"><option value="">‚Äî V≈°etci ‚Äî</option></select>
      </div>

      <div class="row">
        <input id="chipUidAttendance" placeholder="Chip UID (manu√°lne)" />
        <select id="attendanceType">
          <option value="PRICHOD">PR√çCHOD</option>
          <option value="ODCHOD">ODCHOD</option>
          <option value="PRESTAVKA">PREST√ÅVKA</option>
          <option value="PN">PN</option>
        </select>
        <button id="addAttendanceBtn" class="primary">Prida≈• z√°znam</button>
        <button id="exportAllBtn" class="ghost">‚¨áÔ∏è Exportova≈• v≈°etko (CSV)</button>
      </div>

      <h3 style="margin-top:8px">Pr√≠chody / Odchody / Prest√°vky</h3>
      <table>
        <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th><th>Typ</th></tr></thead>
        <tbody id="attendanceBody"><tr><td colspan="4" class="small">Naƒç√≠tavam...</td></tr></tbody>
      </table>

      <h3 style="margin-top:18px">ü©∫ PN</h3>
      <table>
        <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th></tr></thead>
        <tbody id="pnBody"><tr><td colspan="3" class="small">Naƒç√≠tavam...</td></tr></tbody>
      </table>
    </section>
  </main>

  <!-- new password modal (simple) -->
  <div id="passwordModal" style="display:none"></div>

<script type="module">
/* ---------------------------
   Admin panel ‚Äì single file
   - Realtime DB (Firebase)
   - Two tables: attendance + pn
   - "Exportova≈• v≈°etko" -> downloads dochadzka.csv & pn.csv
   --------------------------- */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// --- ADMIN ACCESS CHECK ---
if (localStorage.getItem("uid") !== "admin") {
  // If not admin, redirect to index (or you can remove this check in dev)
  // window.location.href = "index.html";
  console.warn("Warning: localStorage.uid !== 'admin' (skipping redirect in this debug build).");
}

// --- Firebase config (use your project) ---
const firebaseConfig = {
  apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain: "dochadzkaesp32.firebaseapp.com",
  databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dochadzkaesp32",
  storageBucket: "dochadzkaesp32.firebasedestorage.app",
  messagingSenderId: "417668021105",
  appId: "1:417668021105:web:7fa3e144892d8b304854d0",
  measurementId: "G-ZKQNMZEPHD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- DOM ---
const tabUsers = document.getElementById("tab-users");
const tabAtt = document.getElementById("tab-att");
const sectionUsers = document.getElementById("section-users");
const sectionAtt = document.getElementById("section-att");
const logoutBtn = document.getElementById("logoutBtn");

const nameInput = document.getElementById("name");
const passInput = document.getElementById("password");
const chipUidInput = document.getElementById("chipUid");
const addUserBtn = document.getElementById("addUserBtn");
const userBody = document.getElementById("userBody");

const filterDate = document.getElementById("filterDate");
const filterName = document.getElementById("filterName");
const chipUidAttendance = document.getElementById("chipUidAttendance");
const attendanceType = document.getElementById("attendanceType");
const addAttendanceBtn = document.getElementById("addAttendanceBtn");
const exportAllBtn = document.getElementById("exportAllBtn");

const attendanceBody = document.getElementById("attendanceBody");
const pnBody = document.getElementById("pnBody");

// --- state holders ---
let allUsers = {};     // keyed by user UID in DB
let allAttendance = []; // objects { chipUid, cas, stav }
let allPn = [];        // objects { chipUid, cas }

// --- NAV ---
tabUsers.onclick = () => { showSection("users"); };
tabAtt.onclick = () => { showSection("att"); };
logoutBtn.onclick = () => { localStorage.removeItem("uid"); window.location.href = "index.html"; };

function showSection(id) {
  if (id === "users") {
    sectionUsers.classList.add("active");
    sectionAtt.classList.remove("active");
    tabUsers.classList.add("active");
    tabAtt.classList.remove("active");
  } else {
    sectionAtt.classList.add("active");
    sectionUsers.classList.remove("active");
    tabAtt.classList.add("active");
    tabUsers.classList.remove("active");
  }
}

// --- DB refs ---
const usersRef = ref(db, "users/");
const attendanceRef = ref(db, "dochadzka/");
const newChipsRef = ref(db, "newChips/");

// --- Load users ---
onValue(usersRef, snap => {
  userBody.innerHTML = "";
  allUsers = {};
  filterName.innerHTML = '<option value="">‚Äî V≈°etci ‚Äî</option>';
  if (!snap.exists()) {
    userBody.innerHTML = '<tr><td colspan="5" class="small">≈Ωiadni zamestnanci</td></tr>';
    return;
  }
  snap.forEach(child => {
    const key = child.key;
    const data = child.val();
    allUsers[key] = data;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${key}</td>
      <td>${escapeHtml(data.name||"")}</td>
      <td>***</td>
      <td>${escapeHtml(data.chipUid||"")}</td>
      <td>
        <button class="action-btn" onclick="window.deleteUser('${key}')">Zmaza≈•</button>
        <button class="action-btn" onclick="window.openPasswordModal('${key}')">Zmena hesla</button>
      </td>`;
    userBody.appendChild(tr);

    const opt = document.createElement("option");
    opt.value = data.name || "";
    opt.textContent = data.name || "";
    filterName.appendChild(opt);
  });
});

// --- Load attendance (separates PN) ---
onValue(attendanceRef, snap => {
  allAttendance = [];
  allPn = [];
  if (!snap.exists()) {
    renderTables();
    return;
  }
  snap.forEach(userSnap => {
    const chipKey = userSnap.key; // in your DB you store under user name or chipUid; adapt if needed
    userSnap.forEach(recordSnap => {
      const r = recordSnap.val();
      // guard: require cas
      const cas = (r && r.cas) ? r.cas : null;
      const stav = (r && r.stav) ? r.stav : null;
      if (!cas) return;
      if (stav === "PN") allPn.push({ chipUid: chipKey, cas });
      else allAttendance.push({ chipUid: chipKey, cas, stav });
    });
  });
  renderTables();
});

// --- New chips banner ---
onValue(newChipsRef, snap => {
  if (!snap.exists()) return;
  snap.forEach(child => {
    const uid = child.key;
    const data = child.val();
    if (data && data.status === "unassigned") showNewChipBanner(uid);
  });
});

function showNewChipBanner(uid) {
  if (document.getElementById("newChipBanner")) return;
  const b = document.createElement("div");
  b.id = "newChipBanner";
  b.className = "new-chip-banner";
  b.innerHTML = `ü™™ Nov√Ω ƒçip <b>${uid}</b> &nbsp; <button id="assignBtn">Priradi≈•</button> <button id="dismissBtn">Zavrie≈•</button>`;
  document.body.appendChild(b);
  document.getElementById("assignBtn").onclick = async () => {
    const name = prompt("Zadaj meno pre ƒçip " + uid);
    if (!name) return;
    await set(push(usersRef), { name, password: "default", chipUid: uid });
    await update(ref(db, "newChips/" + uid), { status: "assigned" });
    b.remove();
  };
  document.getElementById("dismissBtn").onclick = () => b.remove();
}

// --- Render tables ---
function renderTables() {
  // ATTENDANCE
  attendanceBody.innerHTML = "";
  const selDate = filterDate.value;
  const selName = filterName.value;

  const filtered = allAttendance.filter(r => {
    const [date] = (r.cas || "").split(" ");
    if (selDate && date !== selDate) return false;
    if (!selName) return true;
    // find user by chipUid
    const user = findUserByChip(r.chipUid);
    return user ? user.name === selName : false;
  });

  if (!filtered.length) {
    attendanceBody.innerHTML = '<tr><td colspan="4" class="small">≈Ωiadne z√°znamy</td></tr>';
  } else {
    for (const r of filtered) {
      const user = findUserByChip(r.chipUid);
      const name = user ? user.name : r.chipUid;
      const parts = (r.cas || "").split(" ");
      const date = parts[0] || "";
      const time = parts[1] || "";
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${escapeHtml(date)}</td><td>${escapeHtml(time)}</td><td>${escapeHtml(r.stav)}</td>`;
      attendanceBody.appendChild(tr);
    }
  }

  // PN
  pnBody.innerHTML = "";
  const filteredPn = allPn.filter(r => {
    const [date] = (r.cas || "").split(" ");
    if (selDate && date !== selDate) return false;
    if (!selName) return true;
    const user = findUserByChip(r.chipUid);
    return user ? user.name === selName : false;
  });

  if (!filteredPn.length) pnBody.innerHTML = '<tr><td colspan="3" class="small">≈Ωiadne z√°znamy</td></tr>';
  else {
    for (const r of filteredPn) {
      const user = findUserByChip(r.chipUid);
      const name = user ? user.name : r.chipUid;
      const [date, time] = (r.cas || "").split(" ");
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${escapeHtml(date||"")}</td><td>${escapeHtml(time||"")}</td>`;
      pnBody.appendChild(tr);
    }
  }
}

function findUserByChip(chip) {
  // users keyed by DB UID, but we stored chipUid inside user object
  return Object.values(allUsers).find(u => u.chipUid === chip);
}

// --- Add user ---
addUserBtn.onclick = async () => {
  const name = (nameInput.value || "").trim();
  const pass = (passInput.value || "").trim();
  const chip = (chipUidInput.value || "").trim();
  if (!name || !pass || !chip) { alert("Vypl≈à meno, heslo a chip UID."); return; }
  try {
    await set(push(usersRef), { name, password: pass, chipUid: chip });
    nameInput.value = ""; passInput.value = ""; chipUidInput.value = "";
  } catch (e) {
    console.error(e); alert("Chyba pri ukladan√≠ pou≈æ√≠vateƒæa.");
  }
};

// --- Add attendance (manual) ---
addAttendanceBtn.onclick = async () => {
  const chip = (chipUidAttendance.value || "").trim();
  const typ = attendanceType.value;
  if (!chip || !typ) { alert("Vypl≈à chip a typ."); return; }
  const user = findUserByChip(chip);
  if (!user) { alert("ƒåip nie je priraden√Ω ≈æiadnemu pou≈æ√≠vateƒæovi."); return; }
  const now = new Date();
  const iso = now.toISOString().replace('T',' ').split('.')[0]; // YYYY-MM-DD HH:MM:SS
  try {
    await set(push(ref(db, "dochadzka/" + user.chipUid)), { cas: iso, stav: typ });
    chipUidAttendance.value = "";
  } catch (e) {
    console.error(e); alert("Chyba pri ukladan√≠ z√°znamu.");
  }
};

// --- EXPORT ALL (downloads two files) ---
exportAllBtn.onclick = () => {
  exportAttendanceCSV();
  exportPnCSV();
};

function exportAttendanceCSV() {
  // header: Zamestnanec,D√°tum,ƒåas,Typ
  const header = '\uFEFFZamestnanec,D√°tum,ƒåas,Typ\n';
  let rows = "";
  for (const r of allAttendance) {
    const user = findUserByChip(r.chipUid);
    const name = user ? user.name : r.chipUid;
    const [date, time] = (r.cas || "").split(" ");
    rows += `"${escapeCsv(name)}","${escapeCsv(date||"")}","${escapeCsv(time||"")}","${escapeCsv(r.stav||"")}"\n`;
  }
  const csv = header + rows;
  downloadBlob(csv, "dochadzka.csv");
}

function exportPnCSV() {
  const header = '\uFEFFZamestnanec,D√°tum,ƒåas\n';
  let rows = "";
  for (const r of allPn) {
    const user = findUserByChip(r.chipUid);
    const name = user ? user.name : r.chipUid;
    const [date, time] = (r.cas || "").split(" ");
    rows += `"${escapeCsv(name)}","${escapeCsv(date||"")}","${escapeCsv(time||"")}"\n`;
  }
  const csv = header + rows;
  downloadBlob(csv, "pn.csv");
}

function downloadBlob(text, filename) {
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// --- small helpers ---
function escapeCsv(s) {
  return (s === null || s === undefined) ? "" : String(s).replace(/"/g, '""');
}
function escapeHtml(s) {
  const t = document.createElement('div'); t.textContent = s || ""; return t.innerHTML;
}

// --- new-chips loader already set above via onValue ---

// --- simple window functions for buttons in table rows ---
window.deleteUser = async function(uid) {
  if (!confirm("Naozaj zmaza≈• pou≈æ√≠vateƒæa?")) return;
  try { await remove(ref(db, "users/" + uid)); } catch (e) { alert("Chyba pri mazan√≠."); }
};
window.openPasswordModal = function(uid) {
  const newPass = prompt("Zadaj nov√© heslo pre pou≈æ√≠vateƒæa (UID: " + uid + "):");
  if (!newPass) return;
  update(ref(db,"users/"+uid), { password: newPass }).then(()=>alert("Heslo zmenen√©")).catch(()=>alert("Chyba pri zmene hesla"));
};

// --- filters ---
filterDate.onchange = renderTables;
filterName.onchange = renderTables;

// --- initial load + interval refresh for UI --
renderTables();
setInterval(() => { /* periodic refresh is reactive via onValue, but re-render to be safe */ renderTables(); }, 5000);

</script>
</body>
</html>









