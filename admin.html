<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin panel – Dochádzka</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- ŠTÝLY --- */
        body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; }
        header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
        h1 { color:#007bff; margin:0; font-size:22px; font-weight:600; }
        
        button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; font-weight: 500;}
        button:hover { background:#0056b3; }
        
        nav { background:#fff; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:70px; z-index:5; flex-wrap:wrap; display: flex; justify-content: center; }
        nav button.active { background:#6f42c1; }
        
        section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
        section.active { display:block; }
        
        h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }
        table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        th,td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
        th { background:#007bff; color:white; font-weight:500; }
        tr:nth-child(even){ background:#f8f9fa; }
        
        .loader{ text-align:center; padding:20px; color:#007bff; font-weight:bold; }
        .export-btn{ margin-top:15px; background:#28a745; border-radius:8px; padding:8px 14px; }
        .export-btn:hover{ background:#1e7e34; }

        /* --- STAVOVÉ ODZNAKY --- */
        .status-badge {
            font-weight: 700 !important;
            padding: 7px 14px !important;
            border-radius: 50px !important; 
            display: inline-block;
            text-align: center;
            min-width: 80px;
            white-space: nowrap;
            color: white !important;
            font-size: 14px !important;
        }
        .status-prichod { background: #198754 !important; } 
        .status-odchod { background: #dc3545 !important; } 
        .status-prestávka, .status-prestavka { background: #ffc107 !important; color: #212529 !important; }
        .status-pn { background: #6f42c1 !important; } 

        /* --- MODAL A POUŽÍVATELIA --- */
        .new-chip { background:#17a2b8; padding:8px 10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-radius:6px; color:white; font-size:14px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100; }
        .modal-content{ background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; position:relative; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
        .modal-content input{ width:100%; margin:10px 0; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box; }
        
        .chip-status-assigned { background: #198754 !important; color: white !important; }
        .chip-status-unassigned { background: #6c757d !important; color: white !important; }

        .user-actions button { background: #007bff; border: none; color: white; padding: 5px 10px; margin: 0 4px; font-size: 14px; border-radius: 6px; min-width: 100px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .user-actions button.btn-remove { background: #dc3545; }
        .user-actions button.btn-password { background: #17a2b8; }
    </style>
</head>
<body>

<header>
    <h1>Admin panel – Dochádzka</h1>
    <button onclick="logout()">Odhlásiť sa</button>
</header>

<nav>
    <button data-target="dochadzka" class="active">Dochádzka</button>
    <button data-target="prestavky">Prestávky</button>
    <button data-target="pn">PN</button>
    <button data-target="pouzivatelia">Používatelia</button>
</nav>

<section id="dochadzka" class="active">
    <h2>Dochádzka (Príchod/Odchod)</h2>
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button style="background: #007bff;" onclick="addLog('dochadzka','príchod')">Príchod</button>
        <button style="background: #dc3545;" onclick="addLog('dochadzka','odchod')">Odchod</button>
        <button style="background: #ffc107; color: #333;" onclick="addLog('prestavky','prestávka_manual')">Prestávka</button>
    </div>
    <button class="export-btn" onclick="exportTable('dochadzka')">Exportovať do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="dateDochadzka" style="flex:1;" onchange="loadSection('dochadzka')">
        <input type="text" id="searchDochadzka" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('dochadzka')">
    </div>
    <div id="dochadzkaTable" class="loader">Načítavam dáta...</div>
</section>

<section id="prestavky">
    <h2>Prestávky</h2>
    <button class="export-btn" onclick="exportTable('prestavky')">Exportovať do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="datePrestavky" style="flex:1;" onchange="loadSection('prestavky')">
        <input type="text" id="searchPrestavky" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('prestavky')">
    </div>
    <div id="prestavkyTable" class="loader">Načítavam dáta...</div>
</section>

<section id="pn">
    <h2>PN</h2>
    <button class="export-btn" onclick="exportTable('pn')">Exportovať do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="datePN" style="flex:1;" onchange="loadSection('pn')">
        <input type="text" id="searchPN" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('pn')">
    </div>
    <div id="pnTable" class="loader">Načítavam dáta...</div>
</section>

<section id="pouzivatelia">
    <h2>Používatelia</h2>
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="export-btn" onclick="exportTable('users')" style="background:#007bff;">Exportovať používateľov</button>
        <button onclick="addUser()">Pridať používateľa</button>
    </div>
    <div id="usersTable" class="loader">Načítavam používateľov...</div>
    <h3>Nepriradené čipy</h3>
    <div id="newChipsContainer" class="loader">Načítavam čipy...</div>
</section>

<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <span id="closeModal" style="position:absolute; right:15px; top:5px; cursor:pointer; font-size:24px;" onclick="closeModal()">&times;</span>
        <h3>Zmeniť heslo</h3>
        <input type="hidden" id="changePasswordUserId">
        <input type="password" id="newPassword" placeholder="Nové heslo">
        <button onclick="saveNewPassword()" style="width:100%;">Uložiť</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, child, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
    authDomain: "maturita-395fd.firebaseapp.com",
    databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
    projectId: "maturita-395fd",
    storageBucket: "maturita-395fd.firebasestorage.app",
    messagingSenderId: "754745500563",
    appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
    measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allAdminRecordsCache = [];
let allUsersCache = {};

window.loadSection = function(id){
    if(id==="dochadzka") loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka");
    else if(id==="prestavky") loadAttendance("prestavky","prestavkyTable","datePrestavky","searchPrestavky");
    else if(id==="pn") loadAttendance("pn","pnTable","datePN","searchPN");
    else if(id==="pouzivatelia"){ loadUsers(); loadNewChips(); }
}

async function loadAttendance(type, tableId, dateId, searchId){
    const el = document.getElementById(tableId);
    el.innerHTML='<div class="loader">Načítavam dáta...</div>';

    if (allAdminRecordsCache.length === 0) {
        try {
            const snap = await get(ref(db, "users"));
            if(!snap.exists()) {
                el.innerHTML = '<table><tr><td colspan="3">Žiadne dáta.</td></tr></table>';
                return;
            }
            const allRecords = [];
            snap.forEach(userSnap => {
                const userData = userSnap.val();
                const userId = userSnap.key;
                const userName = userData.name || "(bez mena)";
                allUsersCache[userId] = userData;

                ["dochadzka", "prestavky", "pn"].forEach(logType => {
                    const logsObj = userData[logType] || {};
                    Object.values(logsObj).forEach(log => {
                        if (!log || !log.cas || !log.typ) return;
                        
                        let cleanTime = String(log.cas);
                        const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
                        const match = cleanTime.match(dateRegex);
                        let iso = cleanTime;
                        if(match) iso = `${match[3]}-${match[2].padStart(2,'0')}-${match[1].padStart(2,'0')} ${match[4]}`;

                        const cleanType = String(log.typ).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                        let recordType = cleanType.includes('prichod') ? 'prichod' : 
                                         cleanType.includes('odchod') ? 'odchod' : 
                                         cleanType.includes('prestavka') ? 'prestavka' : 
                                         cleanType.includes('pn') ? 'pn' : null;

                        if (recordType) {
                            allRecords.push({
                                userId, userName, cas: iso, casDisplay: cleanTime,
                                date: iso.substring(0, 10), time: iso.substring(11, 16),
                                stav: recordType, rawType: log.typ.toUpperCase()
                            });
                        }
                    });
                });
            });
            allAdminRecordsCache = allRecords;
        } catch (e) { el.innerHTML = "Chyba načítania."; return; }
    }

    const dateFilter = document.getElementById(dateId)?.value || "";
    const search = document.getElementById(searchId)?.value.toLowerCase().trim() || "";
    const expected = { dochadzka: ["prichod", "odchod"], prestavky: ["prestavka"], pn: ["pn"] }[type];

    const filtered = allAdminRecordsCache.filter(r => 
        (!dateFilter || r.date === dateFilter) && 
        (!search || r.userName.toLowerCase().includes(search)) && 
        expected.includes(r.stav)
    ).sort((a, b) => new Date(b.cas) - new Date(a.cas));

    let html="<table><tr><th>Meno</th><th>Čas</th><th>Typ</th></tr>";
    filtered.forEach(log => {
        html += `<tr><td>${log.userName}</td><td>${log.casDisplay}</td><td><span class="status-badge status-${log.stav}">${log.rawType}</span></td></tr>`;
    });
    el.innerHTML = filtered.length ? html + "</table>" : "<table><tr><td colspan='3'>Žiadne záznamy.</td></tr></table>";
}

// --- SPRÁVA POUŽÍVATEĽOV ---
async function loadUsers(){
    const el = document.getElementById("usersTable");
    if (Object.keys(allUsersCache).length === 0) await loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka");
    
    let html="<table><tr><th>Meno</th><th>Čip Status</th><th>Akcie</th></tr>";
    for (const key in allUsersCache) {
        if (key === 'admin') continue;
        const d = allUsersCache[key];
        const chip = d.chipUid;
        const statusClass = chip ? 'chip-status-assigned' : 'chip-status-unassigned';
        html+=`<tr><td>${d.name}</td><td><span class="status-badge ${statusClass}">${chip ? 'Priradený' : 'Nepriradený'}</span></td>
        <td class="user-actions"><button class="btn-remove" onclick="removeUser('${key}')">Odstrániť</button>
        <button class="btn-password" onclick="openChangePassword('${key}')">Heslo</button></td></tr>`;
    }
    el.innerHTML = html + "</table>";
}

async function loadNewChips(){
    const el = document.getElementById("newChipsContainer");
    const snap = await get(ref(db, "newChips"));
    el.innerHTML = "";
    if(!snap.exists()) { el.innerHTML = "Žiadne nové čipy."; return; }
    Object.keys(snap.val()).forEach(chip => {
        const div = document.createElement("div");
        div.className = "new-chip";
        div.innerHTML = `<span>${chip}</span><div><button onclick="assignChip('${chip}')">Priradiť</button>
        <button onclick="removeChip('${chip}')" style="background:#dc3545; margin-left:5px;">X</button></div>`;
        el.appendChild(div);
    });
}

window.addUser = async () => {
    const name = prompt("Meno:");
    const pass = prompt("Heslo (min 4 znaky):");
    if(name && pass && pass.length >= 4) {
        const newUserRef = push(ref(db, "users"));
        await set(newUserRef, { name, password: pass, chipUid: null });
        allUsersCache = {}; allAdminRecordsCache = []; loadUsers();
    }
};

window.removeUser = async (id) => {
    if(confirm("Odstrániť?")){
        const chip = allUsersCache[id]?.chipUid;
        await set(ref(db, `users/${id}`), null);
        if(chip) await set(ref(db, `chipToUser/${chip}`), null);
        delete allUsersCache[id]; loadUsers();
    }
};

window.assignChip = async (chipUid) => {
    const name = prompt("Priradiť čip k menu:").trim();
    let uid = Object.keys(allUsersCache).find(k => allUsersCache[k].name?.toLowerCase() === name.toLowerCase());
    if(uid) {
        await set(ref(db, `users/${uid}/chipUid`), chipUid);
        await set(ref(db, `chipToUser/${chipUid}`), uid);
        await set(ref(db, `newChips/${chipUid}`), null);
        allUsersCache[uid].chipUid = chipUid; loadUsers(); loadNewChips();
    } else alert("Meno sa nenašlo.");
};

window.removeChip = async (chip) => { if(confirm("Zmazať čip?")) { await set(ref(db, `newChips/${chip}`), null); loadNewChips(); } };

// --- LOGIKA MODALU ---
window.openChangePassword = (id) => { document.getElementById("changePasswordModal").style.display="flex"; document.getElementById("changePasswordUserId").value=id; };
window.closeModal = () => { document.getElementById("changePasswordModal").style.display="none"; };
window.saveNewPassword = async () => {
    const id = document.getElementById("changePasswordUserId").value;
    const pass = document.getElementById("newPassword").value;
    if(pass.length >= 4) { await set(ref(db, `users/${id}/password`), pass); closeModal(); alert("Zmenené."); }
};

// --- LOGOVANIE ---
window.addLog = async function(type, typ){
    const typeToSave = typ.toUpperCase().replace('_MANUAL', '');
    const inputName = prompt(`Meno pre ${typeToSave}:`)?.trim();
    if (!inputName) return;

    let userId = Object.keys(allUsersCache).find(k => allUsersCache[k].name?.toLowerCase() === inputName.toLowerCase());
    if (!userId) return alert("Používateľ nenájdený.");

    const now = new Date();
    const timestamp = now.getDate().toString().padStart(2,"0") + "." + (now.getMonth()+1).toString().padStart(2,"0") + "." + now.getFullYear() + " " + now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");

    try {
        const newLogRef = push(child(ref(db, `users/${userId}`), type));
        await set(newLogRef, { cas: timestamp, typ: typeToSave });
        alert("Pridané.");
        allAdminRecordsCache = []; loadSection(type);
    } catch (e) { console.error(e); }
};

window.logout = () => { localStorage.removeItem("uid"); window.location.href="index.html"; };

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll("nav button").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll("nav button, section").forEach(el => el.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(btn.dataset.target).classList.add("active");
            loadSection(btn.dataset.target);
        });
    });
    loadSection("dochadzka");
});

window.exportTable = (section) => {
    // Jednoduchý export pre ukážku (používa allAdminRecordsCache)
    const wb = XLSX.utils.book_new();
    const data = allAdminRecordsCache.map(r => [r.userName, r.casDisplay, r.rawType]);
    data.unshift(["Meno", "Čas", "Typ"]);
    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Export");
    XLSX.writeFile(wb, `${section}_export.xlsx`);
};

</script>
</body>
</html>
