<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äì Doch√°dzka ESP32</title>
<style>
body {font-family:'Poppins',sans-serif;background:#eef2f6;margin:0;padding:0;display:flex;flex-direction:column;}
header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.05);color:#333;text-align:center;padding:20px;font-size:22px;font-weight:600;position:sticky;top:0;z-index:100;}
#logoutBtn{position:absolute;top:15px;right:30px;background:#dc3545;color:white;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;transition:0.3s;}
#logoutBtn:hover{background:#b52a3a;}
.container{display:flex;width:100%;}
.sidebar{width:230px;background:linear-gradient(180deg,#007bff 0%,#0056b3 100%);color:white;padding-top:30px;display:flex;flex-direction:column;align-items:center;box-shadow:2px 0 10px rgba(0,0,0,0.15);height:100vh;position:sticky;top:0;}
.sidebar h2{margin-bottom:40px;font-size:20px;font-weight:600;}
.sidebar ul{list-style:none;padding:0;width:100%;}
.sidebar li{padding:15px 30px;cursor:pointer;transition:0.3s;text-align:left;}
.sidebar li:hover,.sidebar li.active{background:rgba(255,255,255,0.2);}
main{flex:1;padding:30px;margin-left:230px;}
section{display:none;margin-bottom:30px;}
section.active{display:block;background:#fff;padding:25px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.05);}
h2{color:#007bff;border-bottom:2px solid #007bff;padding-bottom:8px;margin-bottom:20px;}
input,select{padding:8px 12px;border-radius:8px;border:1px solid #ccc;margin:6px 4px;outline:none;}
button{background:#007bff;color:white;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;transition:0.3s;margin-left:4px;}
button:hover{background:#0056b3;}
table{border-collapse:collapse;width:100%;margin-top:20px;font-size:14px;}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:#007bff;color:white;}
tr:nth-child(even){background:#f9f9f9;}
.action-btn{background:#dc3545;border:none;color:white;padding:6px 10px;border-radius:6px;cursor:pointer;transition:0.3s;}
.action-btn:hover{background:#b52a3a;}
.modal{display:none;position:fixed;z-index:2;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);}
.modal-content{background:white;margin:15% auto;padding:20px;border-radius:10px;max-width:300px;}
.close{float:right;font-size:24px;cursor:pointer;color:#aaa;}
.close:hover{color:black;}
.new-chip-banner{position:fixed;top:75px;left:50%;transform:translateX(-50%);background:#ffc107;color:#000;padding:12px 25px;text-align:center;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.15);font-weight:600;z-index:1000;}
</style>
</head>
<body>
<header>
üõ†Ô∏è Administr√°cia doch√°dzky
<button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<div class="container">
<div class="sidebar">
  <h2>Admin Panel</h2>
  <ul>
    <li id="manageUsersTab" class="active">üë§ Spr√°va zamestnancov</li>
    <li id="viewAttendanceTab">üìÖ Doch√°dzka</li>
    <li id="viewBreaksTab">‚òï Prest√°vky</li>
    <li id="viewPnTab">ü©∫ PN</li>
  </ul>
</div>

<main>
  <!-- Zamestnanci -->
  <section id="manage-users" class="active">
    <h2>üë§ Spr√°va zamestnancov</h2>
    <input type="text" id="name" placeholder="Meno">
    <input type="password" id="password" placeholder="Heslo">
    <input type="text" id="chipUid" placeholder="Chip UID">
    <button id="addUserBtn">Prida≈• / Aktualizova≈•</button>
    <table id="userTable">
      <thead><tr><th>UID</th><th>Meno</th><th>Heslo</th><th>Chip UID</th><th>Akcie</th></tr></thead>
      <tbody id="userBody"><tr><td colspan="5">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- Doch√°dzka -->
  <section id="view-attendance">
    <h2>üìÖ Prehƒæad doch√°dzky</h2>
    <div>
      <label>D√°tum:</label><input type="date" id="filterDate">
      <label>Zamestnanec:</label><select id="filterName"><option value="">V≈°etci</option></select>
      <button id="exportAttendanceBtn">‚¨áÔ∏è Exportova≈• doch√°dzku</button>
    </div>
    <table id="attendanceTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th><th>Typ</th></tr></thead>
      <tbody id="attendanceBody"><tr><td colspan="4">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- Prest√°vky -->
  <section id="view-breaks">
    <h2>‚òï Prest√°vky</h2>
    <div>
      <input type="text" id="chipUidBreak" placeholder="Chip UID">
      <button id="addBreakBtn">Prida≈• prest√°vku</button>
      <button id="exportBreakBtn">‚¨áÔ∏è Exportova≈• prest√°vky</button>
    </div>
    <table id="breakTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th></tr></thead>
      <tbody id="breakBody"><tr><td colspan="3">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- PN -->
  <section id="view-pn">
    <h2>ü©∫ PN</h2>
    <div>
      <input type="text" id="chipUidPn" placeholder="Chip UID">
      <button id="addPnBtn">Prida≈• PN</button>
      <button id="exportPnBtn">‚¨áÔ∏è Exportova≈• PN</button>
    </div>
    <table id="pnTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th></tr></thead>
      <tbody id="pnBody"><tr><td colspan="3">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>
</main>
</div>

<div id="passwordModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Zmeni≈• heslo</h3>
    <input type="password" id="newPassword" placeholder="Nov√© heslo">
    <button id="changePasswordBtn">Zmeni≈• heslo</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey:"TU_DAJ_SVOJ_API_KEY",
  authDomain:"TU_DAJ_SVOJ_AUTH_DOMAIN",
  databaseURL:"TU_DAJ_SVOJ_DATABASE_URL",
  projectId:"TU_DAJ_SVOJ_PROJECT_ID",
  storageBucket:"TU_DAJ_SVOJ_STORAGE_BUCKET",
  messagingSenderId:"TU_DAJ_SVOJ_SENDER_ID",
  appId:"TU_DAJ_SVOJ_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

document.addEventListener("DOMContentLoaded", () => {
  // Inputs
  const nameInput=document.getElementById("name");
  const passInput=document.getElementById("password");
  const chipUidInput=document.getElementById("chipUid");
  const addBtn=document.getElementById("addUserBtn");
  const userBody=document.getElementById("userBody");
  
  const filterDate=document.getElementById("filterDate");
  const filterName=document.getElementById("filterName");
  const attendanceBody=document.getElementById("attendanceBody");
  const exportAttendanceBtn=document.getElementById("exportAttendanceBtn");
  const chipUidAttendance=document.getElementById("chipUidAttendance");
  const attendanceTypeSelect=document.getElementById("attendanceType");
  const addAttendanceBtn=document.getElementById("addAttendanceBtn");

  const breakBody=document.getElementById("breakBody");
  const addBreakBtn=document.getElementById("addBreakBtn");
  const chipUidBreak=document.getElementById("chipUidBreak");
  const exportBreakBtn=document.getElementById("exportBreakBtn");

  const pnBody=document.getElementById("pnBody");
  const addPnBtn=document.getElementById("addPnBtn");
  const chipUidPn=document.getElementById("chipUidPn");
  const exportPnBtn=document.getElementById("exportPnBtn");

  let allUsers={}, allAttendance=[], allBreaks=[], allPn=[];

  // --- Naƒç√≠tanie pou≈æ√≠vateƒæov ---
  function loadUsers(){
    onValue(ref(db,"users/"),(snap)=>{
      allUsers={}; userBody.innerHTML=""; filterName.innerHTML='<option value="">V≈°etci</option>';
      if(!snap.exists()){userBody.innerHTML="<tr><td colspan='5'>≈Ωiadni zamestnanci</td></tr>"; return;}
      snap.forEach(child=>{
        const data=child.val(); allUsers[child.key]=data;
        const option=document.createElement("option"); option.value=data.name; option.textContent=data.name; filterName.appendChild(option);
        const row=document.createElement("tr");
        row.innerHTML=`<td>${child.key}</td><td>${data.name}</td><td>***</td><td>${data.chipUid||''}</td>
          <td><button class="action-btn" onclick="deleteUser('${child.key}')">Zmaza≈•</button>
          <button class="action-btn" onclick="openPasswordModal('${child.key}')">Zmeni≈• heslo</button></td>`;
        userBody.appendChild(row);
      });
    });
  }

  window.deleteUser=(uid)=>{if(confirm("Naozaj zmaza≈•?")) remove(ref(db,"users/"+uid));}

  // --- Doch√°dzka ---
  function loadAttendance(){
    onValue(ref(db,"dochadzka/"),snap=>{
      allAttendance=[]; attendanceBody.innerHTML="";
      if(snap.exists()){
        snap.forEach(userSnap=>{
          userSnap.forEach(recordSnap=>{
            const r=recordSnap.val();
            allAttendance.push({chipUid:userSnap.key, cas:r.cas, stav:r.stav});
          });
        });
      }
      renderAttendance();
    });
  }
  function renderAttendance(){
    attendanceBody.innerHTML="";
    if(!allAttendance.length) {attendanceBody.innerHTML="<tr><td colspan='4'>≈Ωiadne z√°znamy</td></tr>"; return;}
    allAttendance.forEach(r=>{
      const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
      const name=user?user.name:r.chipUid;
      const [date,time]=r.cas.split(' ');
      const row=document.createElement("tr");
      row.innerHTML=`<td>${name}</td><td>${date}</td><td>${time}</td><td>${r.stav}</td>`;
      attendanceBody.appendChild(row);
    });
  }

  addAttendanceBtn?.addEventListener("click", async()=>{
    const chipUid=chipUidAttendance?.value.trim(), typ=attendanceTypeSelect?.value;
    if(!chipUid || !typ){alert("Vypl≈à ƒçip a typ"); return;}
    const user=Object.values(allUsers).find(u=>u.chipUid===chipUid);
    if(!user){alert("ƒåip nie je priraden√Ω!"); return;}
    const timeStr=new Date().toISOString().replace("T"," ").split(".")[0];
    await set(push(ref(db,"dochadzka/"+chipUid)),{cas:timeStr, stav:typ});
    chipUidAttendance.value="";
  });

  exportAttendanceBtn?.addEventListener("click",()=>{
    let csv="Zamestnanec,D√°tum,ƒåas,Typ\n";
    allAttendance.forEach(r=>{
      const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
      const name=user?user.name:r.chipUid;
      const [date,time]=r.cas.split(' ');
      csv+=`"${name}","${date}","${time}","${r.stav}"\n`;
    });
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='dochadzka.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // --- Prest√°vky ---
  function loadBreaks(){
    onValue(ref(db,"prestavky/"),snap=>{
      allBreaks=[]; breakBody.innerHTML="";
      if(snap.exists()){
        snap.forEach(userSnap=>{
          userSnap.forEach(recordSnap=>{
            const r=recordSnap.val();
            allBreaks.push({chipUid:userSnap.key, cas:r.cas});
          });
        });
      }
      renderBreaks();
    });
  }
  function renderBreaks(){
    breakBody.innerHTML="";
    if(!allBreaks.length) {breakBody.innerHTML="<tr><td colspan='3'>≈Ωiadne z√°znamy</td></tr>"; return;}
    allBreaks.forEach(r=>{
      const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
      const name=user?user.name:r.chipUid;
      const [date,time]=r.cas.split(' ');
      const row=document.createElement("tr");
      row.innerHTML=`<td>${name}</td><td>${date}</td><td>${time}</td>`;
      breakBody.appendChild(row);
    });
  }

  addBreakBtn?.addEventListener("click", async()=>{
    const chip=chipUidBreak.value.trim(); if(!chip){alert("Vypl≈à ƒçip!"); return;}
    const user=Object.values(allUsers).find(u=>u.chipUid===chip);
    if(!user){alert("ƒåip nie je priraden√Ω!"); return;}
    const timeStr=new Date().toISOString().replace("T"," ").split(".")[0];
    await set(push(ref(db,"prestavky/"+chip)),{cas:timeStr});
    chipUidBreak.value="";
  });
  exportBreakBtn?.addEventListener("click",()=>{
    let csv="Zamestnanec,D√°tum,ƒåas\n";
    allBreaks.forEach(r=>{
      const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
      const name=user?user.name:r.chipUid;
      const [date,time]=r.cas.split(' ');
      csv+=`"${name}","${date}","${time}"\n`;
    });
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='prestavky.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // --- PN ---
  function loadPn(){
    onValue(ref(db,"pn/"),snap=>{
      allPn=[]; pnBody.innerHTML="";
      if(snap.exists()){
        snap.forEach(userSnap=>{
          userSnap.forEach(recordSnap=>{
            const r=recordSnap.val();
            allPn.push({chipUid:userSnap.key, cas:r.cas});
          });
        });
      }
      renderPn();
    });
  }
  function renderPn(){
    pnBody.innerHTML="";
    if(!allPn.length) {pnBody.innerHTML="<tr><td colspan='3'>≈Ωiadne z√°znamy</td></tr>"; return;}
    allPn.forEach(r=>{
      const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
      const name=user?user.name:r.chipUid;
      const [date,time]=r.cas.split(' ');
      const row=document.createElement("tr");
      row.innerHTML=`<td>${name}</td><td>${date}</td><td>${time}</td>`;
      pnBody.appendChild(row);
    });
  }

  addPnBtn?.addEventListener("click", async()=>{
    const chip=chipUidPn.value.trim(); if(!chip){alert("Vypl≈à ƒçip!"); return;}
    const user=Object.values(allUsers).find(u=>u.chipUid===chip);
    if(!user){alert("ƒåip nie je priraden√Ω!"); return;}
    const timeStr=new Date().toISOString().replace("T"," ").split(".")[0];
    await set(push(ref(db,"pn/"+chip)),{cas:timeStr});
    chipUidPn.value="";
  });
  exportPnBtn?.addEventListener("click",()=>{
    let csv="Zamestnanec,D√°tum,ƒåas\n";
    allPn.forEach(r=>{
      const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
      const name=user?user.name:r.chipUid;
      const [date,time]=r.cas.split(' ');
      csv+=`"${name}","${date}","${time}"\n`;
    });
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='pn.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // --- Pridanie pou≈æ√≠vateƒæa ---
  addBtn.addEventListener("click", async ()=>{
    const name=nameInput.value.trim(), password=passInput.value.trim(), chipUid=chipUidInput.value.trim();
    if(!name||!password||!chipUid){alert("Vypl≈à v≈°etky polia!");return;}
    await set(push(ref(db,"users/")),{name,password,chipUid});
    nameInput.value=passInput.value=chipUidInput.value="";
  });

  // --- Prep√≠nanie sekci√≠ ---
  document.getElementById("manageUsersTab").addEventListener("click",()=>{
    showSection("manage-users","manageUsersTab");
  });
  document.getElementById("viewAttendanceTab").addEventListener("click",()=>{
    showSection("view-attendance","viewAttendanceTab");
  });
  document.getElementById("viewBreaksTab").addEventListener("click",()=>{
    showSection("view-breaks","viewBreaksTab");
  });
  document.getElementById("viewPnTab").addEventListener("click",()=>{
    showSection("view-pn","viewPnTab");
  });

  function showSection(sectionId, tabId){
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".sidebar li").forEach(li=>li.classList.remove("active"));
    document.getElementById(sectionId).classList.add("active");
    document.getElementById(tabId).classList.add("active");
  }

  // --- Inicialne naƒç√≠tanie ---
  loadUsers(); loadAttendance(); loadBreaks(); loadPn();
});
</script>
</body>
</html>





