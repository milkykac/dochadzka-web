<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin panel – Dochádzka</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- ŠTÝLY --- */
        body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; }
        header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
        h1 { color:#007bff; margin:0; font-size:22px; font-weight:600; }
        
        button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; font-weight: 500;}
        button:hover { background:#0056b3; }
        
        nav { background:#fff; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:70px; z-index:5; flex-wrap:wrap; display: flex; justify-content: center; }
        nav button.active { background:#6f42c1; }
        
        section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
        section.active { display:block; }
        
        h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }
        table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        th,td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
        th { background:#007bff; color:white; font-weight:500; }
        tr:nth-child(even){ background:#f8f9fa; }
        
        .loader{ text-align:center; padding:20px; color:#007bff; font-weight:bold; }
        .export-btn{ margin-top:15px; background:#28a745; border-radius:8px; padding:8px 14px; }
        .export-btn:hover{ background:#1e7e34; }

        .status-badge { font-weight:700!important; padding:7px 14px!important; border-radius:50px!important; display:inline-block; text-align:center; min-width:80px; color:white!important; font-size:14px!important; }
        .status-prichod { background:#198754!important; } 
        .status-odchod { background:#dc3545!important; } 
        .status-prestavka { background:#ffc107!important; color:#212529!important; }
        .status-pn { background:#6f42c1!important; } 

        .new-chip { background:#17a2b8; padding:8px 10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-radius:6px; color:white; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100; }
        .modal-content{ background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; position:relative; }
        .modal-content input{ width:100%; margin:10px 0; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
        
        .user-actions button { background:#007bff; border:none; color:white; padding:5px 10px; margin:0 4px; border-radius:6px; }
        .user-actions button.btn-remove { background:#dc3545; }
    </style>
</head>
<body>

<header>
    <h1>Admin panel – Dochádzka</h1>
    <button onclick="logout()">Odhlásiť sa</button>
</header>

<nav>
    <button data-target="dochadzka" class="active">Dochádzka</button>
    <button data-target="prestavky">Prestávky</button>
    <button data-target="pn">PN</button>
    <button data-target="pouzivatelia">Používatelia</button>
</nav>

<section id="dochadzka" class="active">
    <h2>Dochádzka (Príchod/Odchod)</h2>
    <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
        <button style="background: #198754;" onclick="addLog('dochadzka','PRICHOD')">Príchod</button>
        <button style="background: #dc3545;" onclick="addLog('dochadzka','ODCHOD')">Odchod</button>
        <button style="background: #ffc107; color: #333;" onclick="addLog('dochadzka','PRESTAVKA')">Prestávka</button>
    </div>
    <button class="export-btn" onclick="exportTable('dochadzka')">Exportovať do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="dateDochadzka" style="flex:1;" onchange="loadSection('dochadzka')">
        <input type="text" id="searchDochadzka" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('dochadzka')">
    </div>
    <div id="dochadzkaTable" class="loader">Načítavam dáta...</div>
</section>

<section id="prestavky">
    <h2>Zobrazenie Prestávok</h2>
    <button class="export-btn" onclick="exportTable('prestavky')">Exportovať do XLSX</button>
    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap: wrap;">
        <input type="date" id="datePrestavky" style="flex:1;" onchange="loadSection('prestavky')">
        <input type="text" id="searchPrestavky" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('prestavky')">
    </div>
    <div id="prestavkyTable" class="loader">Načítavam dáta...</div>
</section>

<section id="pn">
    <h2>PN</h2>
    <button class="export-btn" onclick="exportTable('pn')">Exportovať do XLSX</button>
    <div id="pnTable" class="loader">Načítavam dáta...</div>
</section>

<section id="pouzivatelia">
    <h2>Správa používateľov</h2>
    <button onclick="addUser()" style="margin-bottom:10px;">+ Pridať používateľa</button>
    <div id="usersTable"></div>
    <h3>Nové čipy (nepriradené)</h3>
    <div id="newChipsContainer"></div>
</section>

<div id="changePasswordModal" class="modal">
    <div class="modal-content">
        <h3>Zmeniť heslo</h3>
        <input type="hidden" id="changePasswordUserId">
        <input type="password" id="newPassword" placeholder="Nové heslo">
        <button onclick="saveNewPassword()" style="width:100%;">Uložiť</button>
        <button onclick="closeModal()" style="width:100%; background:#6c757d; margin-top:5px;">Zrušiť</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, child, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
    authDomain: "maturita-395fd.firebaseapp.com",
    databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
    projectId: "maturita-395fd",
    storageBucket: "maturita-395fd.firebasestorage.app",
    messagingSenderId: "754745500563",
    appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
    measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let allAdminRecordsCache = [];
let allUsersCache = {};

// --- HLAVNÁ LOGIKA NAČÍTANIA ---
window.loadSection = function(id){
    if(id==="dochadzka") loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka");
    else if(id==="prestavky") loadAttendance("prestavky","prestavkyTable","datePrestavky","searchPrestavky");
    else if(id==="pn") loadAttendance("pn","pnTable","","");
    else if(id==="pouzivatelia"){ loadUsers(); loadNewChips(); }
}

async function loadAttendance(type, tableId, dateId, searchId){
    const el = document.getElementById(tableId);
    if (allAdminRecordsCache.length === 0) {
        try {
            const snap = await get(ref(db, "users"));
            if(!snap.exists()) return el.innerHTML = "Žiadne dáta.";
            
            const allRecords = [];
            snap.forEach(userSnap => {
                const userData = userSnap.val();
                const userId = userSnap.key;
                allUsersCache[userId] = userData;

                ["dochadzka", "prestavky", "pn"].forEach(logType => {
                    const logs = userData[logType] || {};
                    Object.values(logs).forEach(log => {
                        if (!log.cas || !log.typ) return;
                        
                        // Normalizácia času pre zoradenie
                        let cleanTime = String(log.cas);
                        const parts = cleanTime.split(/[\. :]/);
                        let isoDate = cleanTime;
                        if(parts.length >= 5) isoDate = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}T${parts[3]}:${parts[4]}`;

                        const normTyp = log.typ.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
                        let stav = normTyp.includes('prichod') ? 'prichod' : 
                                   normTyp.includes('odchod') ? 'odchod' : 
                                   normTyp.includes('prestavka') ? 'prestavka' : 'pn';

                        allRecords.push({
                            userName: userData.name || "Neznámy",
                            casDisplay: cleanTime,
                            casIso: new Date(isoDate),
                            date: isoDate.substring(0, 10),
                            rawType: log.typ.toUpperCase(),
                            stav: stav
                        });
                    });
                });
            });
            allAdminRecordsCache = allRecords;
        } catch (e) { console.error(e); }
    }

    const dateFilter = document.getElementById(dateId)?.value || "";
    const search = document.getElementById(searchId)?.value.toLowerCase().trim() || "";
    const expected = { dochadzka:["prichod","odchod","prestavka"], prestavky:["prestavka"], pn:["pn"] }[type];

    const filtered = allAdminRecordsCache.filter(r => 
        (!dateFilter || r.date === dateFilter) && 
        (!search || r.userName.toLowerCase().includes(search)) && 
        expected.includes(r.stav)
    ).sort((a, b) => b.casIso - a.casIso);

    let html="<table><tr><th>Meno</th><th>Čas</th><th>Typ</th></tr>";
    filtered.forEach(log => {
        html += `<tr><td>${log.userName}</td><td>${log.casDisplay}</td><td><span class="status-badge status-${log.stav}">${log.rawType}</span></td></tr>`;
    });
    el.innerHTML = html + "</table>";
}

// --- MANUÁLNY ZÁPIS (VŽDY DO DOCHÁDZKY) ---
window.addLog = async function(sectionId, typToSave){
    const inputName = prompt(`Meno pre ${typToSave}:`)?.trim();
    if (!inputName) return;

    let userId = Object.keys(allUsersCache).find(k => allUsersCache[k].name?.toLowerCase() === inputName.toLowerCase());
    if (!userId) return alert("Používateľ nenájdený.");

    const now = new Date();
    const timestamp = now.getDate().toString().padStart(2,"0") + "." + (now.getMonth()+1).toString().padStart(2,"0") + "." + now.getFullYear() + " " + now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");

    try {
        // Natvrdo zapisujeme do "dochadzka" uzla
        const newLogRef = push(child(ref(db, `users/${userId}`), "dochadzka"));
        await set(newLogRef, { cas: timestamp, typ: typToSave });
        
        alert("Zápis úspešný.");
        allAdminRecordsCache = []; // Premazať cache pre refresh
        loadSection(sectionId);
    } catch (e) { alert("Chyba zápisu."); }
};

// --- PÔVODNÝ EXPORT ---
window.exportTable = function(type) {
    const expected = { dochadzka:["prichod","odchod","prestavka"], prestavky:["prestavka"], pn:["pn"] }[type];
    const filtered = allAdminRecordsCache.filter(r => expected.includes(r.stav))
                     .sort((a,b) => a.casIso - b.casIso);

    const data = [["Meno", "Dátum a Čas", "Typ"]];
    filtered.forEach(r => data.push([r.userName, r.casDisplay, r.rawType]));

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Export");
    XLSX.writeFile(wb, `export_${type}.xlsx`);
};

// --- OSTATNÉ FUNKCIE (POUŽÍVATELIA) ---
async function loadUsers(){
    const el = document.getElementById("usersTable");
    let html="<table><tr><th>Meno</th><th>Akcie</th></tr>";
    for(let id in allUsersCache) {
        if(id==='admin') continue;
        html+=`<tr><td>${allUsersCache[id].name}</td><td class="user-actions">
        <button class="btn-remove" onclick="removeUser('${id}')">Zmazať</button>
        <button onclick="openChangePassword('${id}')">Heslo</button></td></tr>`;
    }
    el.innerHTML = html + "</table>";
}

async function loadNewChips(){
    const el = document.getElementById("newChipsContainer");
    const snap = await get(ref(db, "newChips"));
    el.innerHTML = snap.exists() ? "" : "Žiadne nové čipy.";
    if(snap.exists()){
        Object.keys(snap.val()).forEach(chip => {
            const div = document.createElement("div");
            div.className="new-chip";
            div.innerHTML=`<span>${chip}</span><button onclick="assignChip('${chip}')">Priradiť</button>`;
            el.appendChild(div);
        });
    }
}

window.addUser = async () => {
    const n = prompt("Meno:");
    const p = prompt("Heslo:");
    if(n && p){
        const refU = push(ref(db, "users"));
        await set(refU, { name:n, password:p });
        allAdminRecordsCache=[]; loadSection('pouzivatelia');
    }
};

window.assignChip = async (chip) => {
    const name = prompt("Priradiť k menu:");
    let uid = Object.keys(allUsersCache).find(k => allUsersCache[k].name === name);
    if(uid){
        await set(ref(db, `users/${uid}/chipUid`), chip);
        await set(ref(db, `chipToUser/${chip}`), uid);
        await set(ref(db, `newChips/${chip}`), null);
        allAdminRecordsCache=[]; loadSection('pouzivatelia');
    }
};

window.openChangePassword = (id) => { document.getElementById("changePasswordModal").style.display="flex"; document.getElementById("changePasswordUserId").value=id; };
window.closeModal = () => { document.getElementById("changePasswordModal").style.display="none"; };
window.saveNewPassword = async () => {
    const id = document.getElementById("changePasswordUserId").value;
    const p = document.getElementById("newPassword").value;
    await set(ref(db, `users/${id}/password`), p);
    closeModal(); alert("Heslo zmenené.");
};

window.logout = () => { window.location.href="index.html"; };

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll("nav button").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll("nav button, section").forEach(el => el.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(btn.dataset.target).classList.add("active");
            loadSection(btn.dataset.target);
        });
    });
    loadSection("dochadzka");
});
</script>
</body>
</html>
