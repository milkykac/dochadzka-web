<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin panel – Dochádzka</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
/* --- PÔVODNÉ A OPRAVENÉ ŠTÝLY --- */
body { font-family:'Poppins',sans-serif; margin:0; background:linear-gradient(135deg,#007bff,#6f42c1); min-height:100vh; color:#333; }
header { background:#fff; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 3px 10px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
h1 { color:#007bff; margin:0; font-size:22px; font-weight:600; }
button { background:#007bff; border:none; color:white; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:14px; transition:0.3s; }
button:hover { background:#0056b3; }
nav { background:#fff; padding:10px; gap:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:70px; z-index:5; flex-wrap:wrap; display: flex; justify-content: center; }

/* NAVIGAČNÉ TLAČIDLÁ - ŠPECIFICKÝ VZHĽAD Z OBRÁZKU */
nav button { 
    background: #007bff; /* Modré pre Dochádzka, Prestávky, PN */
    padding: 10px 20px;
    border-radius: 0; /* Bez zaoblenia pre rovnaký vzhľad */
    font-weight: 600;
}
nav button[data-target="pouzivatelia"] { /* Fialové pre Používatelia */
    background: #6f42c1;
}
nav button.active { 
    /* Len malá zmena odtieňa pri aktívnom */
    filter: brightness(1.2);
    box-shadow: inset 0 -4px 0 rgba(0,0,0,0.1);
}
nav button:hover {
    background: #0056b3;
    filter: none;
}
nav button[data-target="pouzivatelia"].active, nav button[data-target="pouzivatelia"]:hover {
    background: #6f42c1;
    filter: brightness(1.1);
}
/* Koniec Navigácie */

section { display:none; padding:25px; background:#fff; margin:25px auto; border-radius:12px; max-width:1100px; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:0.3s; }
section.active { display:block; }
h2 { color:#007bff; margin-top:0; border-bottom:2px solid #007bff; padding-bottom:5px; }
table { width:100%; border-collapse:collapse; margin-top:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
th,td { border:1px solid #ddd; padding:10px; text-align:left; font-size:14px; }
th { background:#007bff; color:white; font-weight:500; }
tr:nth-child(even){ background:#f8f9fa; }
.loader{ text-align:center; padding:20px; color:#007bff; font-weight:bold; }

/* TLAČIDLÁ PRE EXPORT/PRIDAŤ (V Sekcii Používatelia) */
.export-btn{ 
    margin-top:0px; 
    background:#007bff !important; /* Modrá pre Používateľov */
    border-radius:8px; 
    padding:8px 14px; 
}
.export-btn:hover{ background:#0056b3 !important; }

/* TLAČIDLÁ PRE PRÍCHOD/ODCHOD/PRESTÁVKA */
#dochadzka button:not(.export-btn) {
    background: #007bff;
    font-weight: 600;
}
#dochadzka button[onclick*="odchod"] {
    background: #dc3545; /* Červená */
}
#dochadzka button[onclick*="prestávka"] {
    background: #ffc107; /* Žltá */
    color: #333; /* Tmavý text na žltej */
}

/* --- ŠTÝLY PRE ODZNAKY STAVU (Farebné bunky) --- */
.status-badge {
    font-weight: 700 !important;
    padding: 7px 14px !important;
    border-radius: 50px !important; 
    display: inline-block;
    text-align: center;
    min-width: 80px;
    white-space: nowrap;
    text-shadow: none !important; 
    color: inherit !important; 
    font-size: 14px !important;
}
.status-prichod { 
    background: #198754 !important; /* Zelená */
    color: white !important; 
} 
.status-odchod { 
    background: #dc3545 !important; /* Červená */
    color: white !important; 
} 
.status-prestávka, .status-prestavka { 
    background: #ffc107 !important; /* Žltá */
    color: #212529 !important; /* Tmavý text na žltej */
}
.status-pn { 
    background: #6f42c1 !important; /* Fialová */
    color: white !important;
} 

/* --- MODAL a POUŽÍVATELIA --- */
.new-chip { background:#17a2b8; padding:8px 10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-radius:6px; color:white; font-size:14px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.new-chip button { background:#007bff; border:none; padding:5px 8px; border-radius:4px; cursor:pointer; font-size:13px; }
.new-chip button:hover { background:#0056b3; }
.new-chip button[onclick*="removeChip"] { /* Červené tlačidlo odstrániť pri čipoch */
    background: #dc3545 !important;
}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100; }
.modal-content{ background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; position:relative; animation:fadeIn 0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.2);}
.modal-content input{ width:100%; margin-top:10px; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
.modal-content button{ width:100%; margin-top:10px; border-radius:6px; padding:8px 0; font-weight:500; background:#007bff; color:white; transition:0.3s;}
.modal-content button:hover{ background:#0056b3; }
#closeModal{ position:absolute; right:10px; top:5px; font-size:22px; cursor:pointer; color:#333; }
.chip-status-assigned { background: #198754 !important; }
.chip-status-unassigned { background: #6c757d !important; }

/* AKČNÉ TLAČIDLÁ V TABUĽKE POUŽÍVATEĽOV - VIZUÁL Z OBRÁZKU */
.user-actions button { 
    background: #007bff !important;  /* Primárna modrá */
    border: none !important;
    color: white !important;
    padding: 5px 15px; 
    margin: 0 5px;
    font-size: 14px;
    border-radius: 4px;
    transition: 0.2s;
}
.user-actions button:first-child { /* Tlačidlo Odstrániť */
    background: #dc3545 !important; /* Červená */
}
.user-actions button:hover {
    background: #0056b3 !important;
    border-color: none;
    color: white !important;
}
.user-actions button:first-child:hover { 
    background: #c82333 !important; /* Tmavšia červená */
    color: white !important;
}
/* ----------------------------------- */
</style>
</head>
<body>

<header>
  <h1>Admin panel – Dochádzka</h1>
  <button onclick="logout()">Odhlásiť sa</button>
</header>

<nav>
  <button data-target="dochadzka" class="active">Dochádzka</button>
  <button data-target="prestavky">Prestávky</button>
  <button data-target="pn">PN</button>
  <button data-target="pouzivatelia">Používatelia</button>
</nav>

<section id="dochadzka" class="active">
  <h2>Dochádzka (Príchod/Odchod)</h2>
  <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
    <button onclick="addLog('dochadzka','prichod')">Príchod</button>
    <button onclick="addLog('dochadzka','odchod')">Odchod</button>
    <button onclick="addLog('prestavky','prestávka')">Prestávka</button>
  </div>
  <button class="export-btn" data-export-table="dochadzka" onclick="exportTable('dochadzka')" style="background:#28a745 !important;">Exportovať do XLSX</button>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input type="date" id="dateDochadzka" style="flex:1;" onchange="loadSection('dochadzka')">
    <input type="text" id="searchDochadzka" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('dochadzka')">
  </div>
  <div id="dochadzkaTable" class="loader">Načítavam dáta...</div>
</section>

<section id="prestavky">
  <h2>Prestávky</h2>
  <button class="export-btn" data-export-table="prestavky" onclick="exportTable('prestavky')" style="background:#28a745 !important;">Exportovať do XLSX</button>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input type="date" id="datePrestavky" style="flex:1;" onchange="loadSection('prestavky')">
    <input type="text" id="searchPrestavky" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('prestavky')">
  </div>
  <div id="prestavkyTable" class="loader">Načítavam dáta...</div>
</section>

<section id="pn">
  <h2>PN</h2>
  <button class="export-btn" data-export-table="pn" onclick="exportTable('pn')" style="background:#28a745 !important;">Exportovať do XLSX</button>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <input type="date" id="datePN" style="flex:1;" onchange="loadSection('pn')">
    <input type="text" id="searchPN" placeholder="Hľadať podľa mena..." style="flex:2;" oninput="loadSection('pn')">
  </div>
  <div id="pnTable" class="loader">Načítavam dáta...</div>
</section>

<section id="pouzivatelia">
  <h2>Používatelia</h2>
  <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
    <button class="export-btn" data-export-table="users" onclick="exportTable('users')" style="background:#007bff;">Exportovať používateľov</button>
    <button class="export-btn" style="background:#007bff;" onclick="addUser()">Pridať používateľa</button>
  </div>
  <div id="usersTable" class="loader">Načítavam používateľov...</div>
  <h3>Nepriradené čipy</h3>
  <div id="newChipsContainer" class="loader">Načítavam čipy...</div>
</section>

<div id="changePasswordModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" onclick="closeModal()">&times;</span>
    <h3>Zmeniť heslo</h3>
    <input type="hidden" id="changePasswordUserId">
    <input type="password" id="newPassword" placeholder="Nové heslo">
    <button onclick="saveNewPassword()">Uložiť</button>
    <button onclick="closeModal()" style="background:#6c757d;">Zrušiť</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, set, child, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// !!! NAHRADTE TOTO VLASTNYMI UDAJMI Z FIREBASE !!!
const firebaseConfig = {
  apiKey: "AIzaSyBsYrbYtP4E5blWbKlrJ6iI9v6YPAYYp0g",
  authDomain: "maturita-395fd.firebaseapp.com",
  databaseURL: "https://maturita-395fd-default-rtdb.firebaseio.com",
  projectId: "maturita-395fd",
  storageBucket: "maturita-395fd.firebasestorage.app",
  messagingSenderId: "754745500563",
  appId: "1:754745500563:web:74fd4d6ab5765ee788be66",
  measurementId: "G-F6KQQS48GD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Globálne premenné pre cache dát
let allAdminRecordsCache = [];
let allUsersCache = {};


// --- HLAVNÉ FUNKCIE PRE ROZHRANIE A DÁTA ---

// Hlavná funkcia pre prepínanie sekcií
window.loadSection = function(id){
  if(id==="dochadzka") loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka");
  else if(id==="prestavky") loadAttendance("prestavky","prestavkyTable","datePrestavky","searchPrestavky");
  else if(id==="pn") loadAttendance("pn","pnTable","datePN","searchPN");
  else if(id==="pouzivatelia"){ loadUsers(); loadNewChips(); }
}

// Funkcia pre načítanie, filtrovanie a zobrazenie dochádzky (vrátane farebných odznakov)
async function loadAttendance(type, tableId, dateId, searchId){
  const el = document.getElementById(tableId);
  el.innerHTML="Načítavam dáta...";

  // 1. Načítanie dát do cache, ak je prázdna (volá sa len raz)
  if (allAdminRecordsCache.length === 0) {
      try {
          const snap = await get(ref(db, "users"));
          if(!snap.exists()) {
              el.innerHTML = '<table><tr><td colspan="3">Žiadni používatelia v databáze.</td></tr></table>';
              return;
          }

          const allRecords = [];
          snap.forEach(userSnap => {
              const userData = userSnap.val();
              const userId = userSnap.key;
              const userName = userData.name || "(bez mena)";
              allUsersCache[userId] = userData; // Uložíme do cache aj používateľov

              ["dochadzka", "prestavky", "pn"].forEach(logType => {
                  const logsObj = userData[logType] || {};
                  Object.values(logsObj).forEach(log => {
                      if (!log || !log.cas || !log.typ) return;

                      let cleanTime = String(log.cas);
                      let validIsoTime = cleanTime;

                      // Logika na normalizáciu dátumu/času pre správne triedenie (YYYY-MM-DD HH:MM)
                      const dateRegex = /(\d{1,2})\.(\d{1,2})\.(\d{4}) (\d{1,2}:\d{1,2})/;
                      const match = cleanTime.match(dateRegex);

                      if (match) {
                          const [full, day, month, year, time] = match;
                          validIsoTime = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
                      } else if (cleanTime.includes('T') && cleanTime.includes('-')) {
                          validIsoTime = cleanTime.replace('T', ' ');
                      } else if (cleanTime.includes('-') && cleanTime.length >= 16) {
                          validIsoTime = cleanTime;
                      } else {
                          return;
                      }

                      // Normalizácia typu na malú abecedu bez diakritiky
                      const cleanType = String(log.typ).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); 
                      let recordType = null;
                      if (cleanType.includes('prichod')) recordType = 'prichod';
                      else if (cleanType.includes('odchod')) recordType = 'odchod';
                      else if (cleanType.includes('prestavka')) recordType = 'prestavka';
                      else if (cleanType.includes('pn')) recordType = 'pn';

                      if (recordType) {
                          allRecords.push({
                              userId: userId,
                              userName: userName,
                              cas: validIsoTime, // Pre triedenie/filtrovanie
                              casDisplay: cleanTime, // Pôvodný formát pre zobrazenie
                              date: validIsoTime.substring(0, 10), // YYYY-MM-DD
                              time: validIsoTime.substring(11, 16), // HH:MM
                              stav: recordType, // Normalizovaný stav pre CSS
                              rawType: log.typ.toUpperCase() // Pôvodný typ s diakritikou pre zobrazenie
                          });
                      }
                  });
              });
          });

          allAdminRecordsCache = allRecords;

      } catch (e) {
          el.innerHTML = "Chyba pri načítaní dát.";
          console.error("Kritická chyba pri načítaní dát pre admina:", e);
          return;
      }
  }

  // 2. Aplikovanie filtrov
  const dateFilter = document.getElementById(dateId)?.value || "";
  const search = document.getElementById(searchId)?.value.toLowerCase().trim() || ""; 
  const expectedStav = {
    dochadzka: ["prichod", "odchod"],
    prestavky: ["prestavka"],
    pn: ["pn"]
  }[type];

  const filteredRecords = allAdminRecordsCache
    .filter(r => {
        const dateMatch = !dateFilter || r.date === dateFilter;
        const nameMatch = !search || r.userName.toLowerCase().includes(search);
        const typeMatch = expectedStav.includes(r.stav);
        return dateMatch && nameMatch && typeMatch;
    })
    .sort((a, b) => new Date(b.cas) - new Date(a.cas)); // Triedenie od najnovšieho


  // 3. Generovanie HTML
  let html="<table><tr><th>Meno</th><th>Čas</th><th>Typ</th></tr>";
  let entriesFound = false;

  filteredRecords.forEach(log => {
      entriesFound = true;
      const logTypNormalized = log.stav;
      const rawType = log.rawType;
      
      // Aplikovanie triedy status-prichod, status-odchod, status-prestavka, status-pn
      let statusClass = 'status-' + logTypNormalized;
      
      html += `<tr>
          <td>${log.userName}</td>
          <td>${log.casDisplay || '-'}</td>
          <td><span class="status-badge ${statusClass}">${rawType}</span></td>
        </tr>`;
  });
    
  if (!entriesFound) {
    html += '<tr><td colspan="3">Žiadne záznamy podľa filtra.</td></tr>';
  }
    
  html += "</table>";
  el.innerHTML = html;
}

// --- POMOCNÉ FUNKCIE A MODAL LOGIKA ---

// Konverzia milisekúnd na formát HH:MM
function msToHhMm(ms) {
    const totalMinutes = Math.floor(ms / (1000 * 60));
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

// Funkcia pre export Používateľov
async function exportUsersToXLSX() {
    const btn = document.querySelector(`[data-export-table="users"]`);
    if(btn) btn.textContent = "Generujem XLSX...";

    const exportData = [
        ["Export používateľov a čipov"],
        [],
        ["UID", "Meno", "Heslo", "Čip UID", "Status"]
    ];
    
    for (const userId in allUsersCache) {
        const user = allUsersCache[userId];
        if (userId === 'admin') continue;
        const chipStatus = user.chipUid ? `Priradený: ${user.chipUid}` : 'Nepriradený';
        exportData.push([
            userId,
            user.name || "(bez mena)",
            user.password || "",
            user.chipUid || "",
            chipStatus
        ]);
    }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    ws['!cols'] = [{ wpx: 150 }, { wpx: 150 }, { wpx: 100 }, { wpx: 150 }, { wpx: 150 }];
    XLSX.utils.book_append_sheet(wb, ws, "Používatelia");

    XLSX.writeFile(wb, "pouzivatelia_export.xlsx");

    if(btn) {
        btn.textContent = "Súbor stiahnutý!";
        setTimeout(() => btn.textContent = "Exportovať používateľov", 2000);
    }
}


// Hlavná funkcia pre export dát do XLSX
window.exportTable = async function(sectionType){
    const btn = document.querySelector(`[data-export-table="${sectionType}"]`);
    if(sectionType === 'users') return exportUsersToXLSX();
    if(btn) btn.textContent = "Generujem XLSX...";

    // Získanie filtrov pre dochádzku/prestávky/pn
    const dateId = `date${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)}`;
    const searchId = `search${sectionType.charAt(0).toUpperCase() + sectionType.slice(1)}`;

    const dateFilter = document.getElementById(dateId)?.value || "";
    const searchFilter = document.getElementById(searchId)?.value.toLowerCase().trim() || ""; 
    
    const expectedStav = {
        dochadzka: ["prichod", "odchod"],
        prestavky: ["prestavka"],
        pn: ["pn"]
    }[sectionType];

    if (!expectedStav) {
        alert("Neznámy typ sekcie pre export.");
        if(btn) btn.textContent = "Exportovať do XLSX";
        return;
    }

    // Príprava dát: Aplikovanie filtrov a normalizácia
    const recordsForExport = allAdminRecordsCache.filter(r => {
        const dateMatch = !dateFilter || r.date === dateFilter;
        const nameMatch = !searchFilter || (r.userName || "").toLowerCase().includes(searchFilter);
        const typeMatch = expectedStav.includes(r.stav);
        return dateMatch && nameMatch && typeMatch;
    }).sort((a, b) => new Date(a.cas) - new Date(b.cas));

    const wb = XLSX.utils.book_new();

    // Ak nebol filter na meno, exportujeme len jednoduchú tabuľku všetkých dát
    if (!searchFilter) {
        const simpleHeader = ["Meno", "Dátum a Čas", "Typ"];
        const simpleData = recordsForExport.map(r => [r.userName, r.casDisplay, r.rawType]);
        
        const exportArray = [
            ["Export všetkých záznamov", ""],
            ["Filter dátumu:", dateFilter || "Všetky"],
            [],
            simpleHeader,
            ...simpleData
        ];
        const ws = XLSX.utils.aoa_to_sheet(exportArray);
        ws['!cols'] = [{ wpx: 150 }, { wpx: 150 }, { wpx: 100 }];
        XLSX.utils.book_append_sheet(wb, ws, "Všetky Záznamy");

    } else {
        // Export s kalkuláciou (iba pre Dochádzku a filter na meno)

        const recordsByUser = recordsForExport.reduce((acc, r) => {
            acc[r.userId] = acc[r.userId] || { userName: r.userName, records: [] };
            acc[r.userId].records.push(r);
            return acc;
        }, {});

        for (const userId in recordsByUser) {
            const userRecords = recordsByUser[userId].records;
            const userName = recordsByUser[userId].userName;
            
            let exportData = [
                ["Používateľ:", userName],
                ["Typ záznamu:", sectionType.toUpperCase()],
                ["Filter dátumu:", dateFilter || "Všetky"],
                [], 
            ];
            
            const sheetName = (userName.replace(/[^a-zA-Z0-9]/g, '').substring(0, 15) || "Export").substring(0, 30);
            
            if (sectionType === 'dochadzka') {
                exportData.push(["Dátum", "Čas", "Typ", "Odpracovaný čas/Status"]);
                
                let totalWorkMs = 0;
                let lastPrichod = null;
                let lastDate = null;
                let dailyWorkMs = 0;

                userRecords.forEach((record) => {
                    const currentDateTime = new Date(record.cas);
                    const currentDateStr = record.date;
                    const currentTimeStr = record.time;

                    if (lastDate && lastDate !== currentDateStr) {
                        if (dailyWorkMs > 0) {
                            exportData.push([lastDate, "Sumarizácia dňa:", "", msToHhMm(dailyWorkMs)]);
                        }
                        dailyWorkMs = 0;
                    }

                    if (record.stav === 'prichod') {
                        lastPrichod = currentDateTime;
                        exportData.push([currentDateStr, currentTimeStr, record.rawType, ""]);
                    } else if (record.stav === 'odchod' && lastPrichod) {
                        const durationMs = currentDateTime - lastPrichod;
                        const durationHhMm = msToHhMm(durationMs);
                        
                        totalWorkMs += durationMs;
                        dailyWorkMs += durationMs;

                        exportData.push([currentDateStr, currentTimeStr, record.rawType, durationHhMm]);
                        lastPrichod = null;
                    } else {
                        exportData.push([currentDateStr, currentTimeStr, record.rawType, "Chýba PRÍCHOD"]);
                    }
                    lastDate = currentDateStr;
                });

                // Finálna Sumarizácia (Posledný deň)
                if (lastDate && dailyWorkMs > 0) {
                    exportData.push([lastDate, "Sumarizácia dňa:", "", msToHhMm(dailyWorkMs)]);
                }

                // Celková Sumarizácia
                exportData.push([]); 
                exportData.push(["Celková odpracovaná doba:", "", "", msToHhMm(totalWorkMs)]);

            } else {
                // Pre Prestávky a PN
                exportData.push(["Dátum a Čas", "Typ"]);
                userRecords.forEach(r => {
                    exportData.push([r.casDisplay, r.rawType]);
                });
            }
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            // Styling (prehľadnosť pri sumároch v XLSX)
            if (sectionType === 'dochadzka') {
                ws['!cols'] = [{ wpx: 100 }, { wpx: 150 }, { wpx: 100 }, { wpx: 150 }];
            } else {
                ws['!cols'] = [{ wpx: 150 }, { wpx: 100 }];
            }
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        }
    }

    const fileNameBase = searchFilter ? `${sectionType}_${searchFilter}` : sectionType;
    const fileName = `${fileNameBase}_export.xlsx`;
    
    XLSX.writeFile(wb, fileName);
    
    if(btn) {
        btn.textContent = "Súbor stiahnutý!";
        setTimeout(() => btn.textContent = "Exportovať do XLSX", 2000);
    }
};

// --- FUNKCIE PRE SPRÁVU POUŽÍVATEĽOV A ČIPOV ---

// Načítanie používateľov
async function loadUsers(){
  const el = document.getElementById("usersTable");
  el.innerHTML="Načítavam používateľov...";
  try{
    // Zabezpečenie, že cache je naplnená
    if (Object.keys(allUsersCache).length === 0) {
        await loadAttendance("dochadzka","dochadzkaTable","dateDochadzka","searchDochadzka"); 
    }

    if(Object.keys(allUsersCache).length === 0){ el.innerHTML="Žiadni používatelia."; return; }

    let html="<table><tr><th>Meno</th><th>Čip Status</th><th>Akcie</th></tr>";

    for (const key in allUsersCache) {
        const d = allUsersCache[key];
        if (key === 'admin') continue;

        const chip = d.chipUid;
        const statusClass = chip ? 'chip-status-assigned' : 'chip-status-unassigned';
        const statusText = chip ? `Priradený (${chip.substring(0, 8)}...)` : 'Nepriradený';
        
        html+=`<tr>
          <td>${d.name||"(bez mena)"}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td class="user-actions">
            <button onclick="removeUser('${key}')">Odstrániť</button>
            <button onclick="openChangePassword('${key}')">Heslo</button>
          </td>
        </tr>`;
    }
    html+="</table>";
    el.innerHTML=html;
}

// Načítanie nepriradených čipov
async function loadNewChips(){
  const el = document.getElementById("newChipsContainer");
  el.innerHTML="Načítavam čipy...";
  try{
    const snap = await get(ref(db, "newChips"));
    el.innerHTML="";
    if(!snap.exists()){ el.innerHTML="Žiadne nové čipy na priradenie."; return; }
    
    Object.keys(snap.val()).reverse().forEach(chip=>{ 
      const div = document.createElement("div");
      div.className="new-chip";
      div.innerHTML = `${chip} 
        <button onclick="assignChip('${chip}')">Priradiť</button>
        <button onclick="removeChip('${chip}')" style="background:#dc3545;">Odstrániť</button>`;
      el.appendChild(div);
    });
  } catch(e){ el.innerHTML="Chyba pri načítaní čipov."; console.error(e); }
}

window.addUser = async function() {
  const name = prompt("Zadaj meno nového používateľa:").trim();
  if(!name) return;

  const password = prompt(`Zadaj heslo pre ${name}:`).trim();
  if(!password || password.length < 4) return alert("Heslo musí mať aspoň 4 znaky.");

  try {
    const newUserRef = push(ref(db, "users"));
    const newUserId = newUserRef.key;
    const newUserObject = { name: name, password: password, chipUid: null };

    await set(newUserRef, newUserObject);
    
    allUsersCache[newUserId] = newUserObject;
    alert(`Používateľ ${name} bol úspešne pridaný.`);
    loadUsers();
  }
  catch(e){ alert("Chyba pri pridávaní používateľa."); console.error(e); }
};

window.removeUser = async function(id){
  if(confirm("Odstrániť používateľa a jeho dochádzku?")){
    const chipUid = allUsersCache[id]?.chipUid;
    
    await set(ref(db, `users/${id}`), null);
    if (chipUid) { await set(ref(db, `chipToUser/${chipUid}`), null); }
    
    delete allUsersCache[id];
    allAdminRecordsCache = allAdminRecordsCache.filter(r => r.userId !== id);
    
    alert("Používateľ odstránený.");
    loadUsers();
  }
};

window.assignChip = async function(chipUid){
  const name = prompt("Zadaj meno používateľa, ktorému chceš priradiť čip:").trim();
  if(!name) return;

  let uid=null;
  for (const key in allUsersCache) {
      if ((allUsersCache[key].name || "").toLowerCase() === name.toLowerCase()) {
          uid = key;
          break;
      }
  }
  if(!uid) return alert("Používateľ nenájdený. Meno musí presne sedieť.");

  try{
    // Odstránenie starého priradenia čipu, ak existuje
    if (allUsersCache[uid].chipUid) { await set(ref(db, `chipToUser/${allUsersCache[uid].chipUid}`), null); }
    
    // Nové priradenie
    await set(ref(db, `users/${uid}/chipUid`), chipUid);
    await set(ref(db, `chipToUser/${chipUid}`), uid);
    await set(ref(db, `newChips/${chipUid}`), null);
    
    allUsersCache[uid].chipUid = chipUid;
    
    alert(`Čip ${chipUid} bol priradený k ${name}.`);
    loadUsers(); loadNewChips();
  } catch(e){ alert("Chyba pri priraďovaní čipu."); console.error(e); }
};

window.removeChip = async function(chipUid){
  if(confirm(`Naozaj odstrániť nepriradený čip ${chipUid}?`)) {
    await set(ref(db, `newChips/${chipUid}`), null);
    loadNewChips();
  }
};

// --- LOGIKA MODAL OKNA ---

window.openChangePassword = function(id){
  document.getElementById("changePasswordModal").style.display="flex";
  document.getElementById("changePasswordUserId").value=id;
  document.getElementById("newPassword").value = ''; 
};

window.closeModal = function(){ document.getElementById("changePasswordModal").style.display="none"; };

window.saveNewPassword = async function(){
  const id=document.getElementById("changePasswordUserId").value;
  const pass=document.getElementById("newPassword").value.trim();
  if(!pass || pass.length < 4) return alert("Heslo musí mať aspoň 4 znaky.");
  try{ 
    await set(ref(db, `users/${id}/password`), pass); 
    if (allUsersCache[id]) allUsersCache[id].password = pass;
    
    alert("Heslo zmenené."); 
    closeModal(); 
  }
  catch(e){ alert("Chyba pri zmene hesla."); console.error(e); }
};

window.logout = () => { localStorage.removeItem("uid"); window.location.href="index.html"; };

// --- Inicializácia pri načítaní DOM ---
document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem("uid") !== "admin") {
        alert("Prístup zamietnutý. Iba pre admina.");
        window.location.href = "index.html";
        return;
    }

    document.querySelectorAll("nav button").forEach(btn=>{
        btn.addEventListener("click",()=>{
            document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            document.querySelectorAll("section").forEach(sec=>sec.classList.remove("active"));
            document.getElementById(btn.dataset.target).classList.add("active");
            window.loadSection(btn.dataset.target);
        });
    });
    // Predvolené načítanie dochádzky pri štarte
    window.loadSection("dochadzka");
});

// Zaznamenanie príchod/odchod/prestávka simuláciou čipu
window.addLog = async function(type, typ){
  alert("Ready. Zadaj čip používateľa.");

  const chipUid = prompt("Zadaj čip používateľa:").trim();
  if(!chipUid) return;

  try {
    const snap = await get(child(ref(db), `chipToUser/${chipUid}`));
    if(!snap.exists()){ alert("Čip nie je priradený!"); return; }
    const userId = snap.val();

    await new Promise(res => setTimeout(res, 500)); // Simulácia oneskorenia

    const now = new Date();
    const timestamp = now.getFullYear().toString() + "-" +
                      (now.getMonth() + 1).toString().padStart(2, "0") + "-" +
                      now.getDate().toString().padStart(2, "0") + " " +
                      now.getHours().toString().padStart(2,"0") + ":" +
                      now.getMinutes().toString().padStart(2,"0");

    let path = `users/${userId}/${type}`;
    const userName = allUsersCache[userId]?.name || (await get(ref(db, `users/${userId}/name`))).val();

    await push(ref(db, path), { 
      cas: timestamp, 
      typ: typ.charAt(0).toUpperCase() + typ.slice(1), // S diakritikou/veľkým písmenom
      manual: true, 
      meno: userName 
    });
    
    // Reset cache a reload sekcie
    allAdminRecordsCache = [];
    alert(`${typ.charAt(0).toUpperCase() + typ.slice(1)} zaznamenaný pre ${userName} o ${timestamp}`);
    window.loadSection(type === "prestavky" ? "prestavky" : "dochadzka");

  } catch(e){ 
    alert("Chyba pri pridávaní záznamu."); 
    console.error(e); 
  }
};
</script>
</body>
</html>
