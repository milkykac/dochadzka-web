<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - DochÃ¡dzka</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Roboto', sans-serif; margin: 0; background: #f4f5f7; color: #333; display: flex; }
    .sidebar { width: 240px; background: #2b3a67; color: white; height: 100vh; display: flex; flex-direction: column; padding-top: 20px; }
    .sidebar h2 { text-align: center; font-weight: 600; margin-bottom: 20px; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar li { padding: 14px 20px; cursor: pointer; transition: background 0.2s; }
    .sidebar li:hover, .sidebar li.active { background: #5060a8; font-weight: 600; }
    main { flex: 1; padding: 20px; }
    section { display: none; animation: fadeIn 0.3s ease; }
    section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #dfe3ee; }
    tbody tr:nth-child(even) { background: #f9f9f9; }
    button { background: #3e4e88; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    button:hover { background: #2b3a67; }
    input { padding: 8px; margin-top: 5px; width: 200px; }
    .loading { text-align: center; margin-top: 20px; font-style: italic; color: #666; display: none; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>ğŸ‘‘ Admin Panel</h2>
    <ul>
      <li data-target="view-attendance" class="active">ğŸ“… DochÃ¡dzka</li>
      <li data-target="view-breaks">â˜• PrestÃ¡vky</li>
      <li data-target="view-pn">ğŸ¥ PN</li>
      <li data-target="manage-users">ğŸ‘¤ SprÃ¡va zamestnancov</li>
      <li id="logoutBtn">ğŸšª OdhlÃ¡siÅ¥</li>
    </ul>
  </aside>

  <main>
    <section id="view-attendance" class="active">
      <h2>ğŸ“… DochÃ¡dzka</h2>
      <button onclick="exportToExcel('dochadzkaTable', 'Dochadzka')">Export do Excel</button>
      <div id="loading" class="loading">NaÄÃ­tavam Ãºdaje...</div>
      <table id="dochadzkaTable">
        <thead><tr><th>Zamestnanec</th><th>UID</th><th>DÃ¡tum</th><th>ÄŒas</th><th>Typ</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="view-breaks">
      <h2>â˜• PrestÃ¡vky</h2>
      <button onclick="exportToExcel('prestÃ¡vkyTable', 'PrestÃ¡vky')">Export do Excel</button>
      <div id="loadingBreaks" class="loading">NaÄÃ­tavam Ãºdaje...</div>
      <table id="prestÃ¡vkyTable">
        <thead><tr><th>Zamestnanec</th><th>DÃ¡tum</th><th>ZaÄiatok</th><th>Koniec</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="view-pn">
      <h2>ğŸ¥ PN</h2>
      <button onclick="exportToExcel('pnTable', 'PN')">Export do Excel</button>
      <div id="loadingPN" class="loading">NaÄÃ­tavam Ãºdaje...</div>
      <table id="pnTable">
        <thead><tr><th>Zamestnanec</th><th>Od</th><th>Do</th><th>PoznÃ¡mka</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="manage-users">
      <h2>ğŸ‘¤ SprÃ¡va zamestnancov</h2>
      <button onclick="showAddUserForm()">PridaÅ¥ zamestnanca</button>
      <button onclick="exportToExcel('usersTable', 'Zamestnanci')">Export do Excel</button>
      <div id="loadingUsers" class="loading">NaÄÃ­tavam Ãºdaje...</div>
      <table id="usersTable">
        <thead><tr><th>Meno</th><th>UID Äipu</th><th>Akcie</th></tr></thead>
        <tbody id="usersList"></tbody>
      </table>

      <div id="addUserForm" style="display:none;margin-top:20px;">
        <h3>PridaÅ¥ novÃ©ho zamestnanca</h3>
        <input type="text" id="newUserName" placeholder="Meno"><br>
        <input type="text" id="newUserUid" placeholder="UID Äipu (povinnÃ©)"><br>
        <button id="confirmAddUserBtn">PridaÅ¥</button>
        <button onclick="hideAddUserForm()">ZruÅ¡iÅ¥</button>
        <p id="addUserMsg"></p>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

    const firebaseConfig = {
      apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
      authDomain: "dochadzkaesp32.firebaseapp.com",
      databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "dochadzkaesp32",
      storageBucket: "dochadzkaesp32.appspot.com",
      messagingSenderId: "417668021105",
      appId: "1:417668021105:web:99a456dd622bb4ac4854d0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ğŸ” Overenie prihlÃ¡senia
    const main = document.querySelector("main");
    main.style.display = "none";
    const info = document.createElement("p");
    info.textContent = "ğŸ” Overujem prihlÃ¡senie...";
    info.style.textAlign = "center";
    info.style.margin = "40px auto";
    document.body.appendChild(info);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        info.remove();
        main.style.display = "block";
        loadAttendance();
        loadBreaks();
        loadPN();
        loadUsers();
      } else {
        info.textContent = "â³ PresmerovÃ¡vam...";
        setTimeout(() => window.location.href = "index.html", 1000);
      }
    });

    // ğŸšª OdhlÃ¡senie
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      alert("OdhlÃ¡senie prebehlo ÃºspeÅ¡ne.");
      window.location.href = "index.html";
    });

    // ğŸ“Š NaÄÃ­tania s error handlingom
    function loadAttendance() {
      const tbody = document.querySelector("#dochadzkaTable tbody");
      const loader = document.getElementById("loading");
      loader.style.display = "block";
      onValue(ref(db, "dochadzka"), (snap) => {
        const rows = [];
        snap.forEach(c => {
          const d = c.val();
          rows.push(`<tr><td>${d.zamestnanec}</td><td>${d.uid || ""}</td><td>${d.datum}</td><td>${d.cas}</td><td>${d.typ}</td></tr>`);
        });
        tbody.innerHTML = rows.join("");
        loader.style.display = "none";
      }, (err) => {
        console.error(err);
        alert("Chyba pri naÄÃ­tanÃ­ dochÃ¡dzky: " + err.message);
      });
    }

    function loadBreaks() {
      const tbody = document.querySelector("#prestÃ¡vkyTable tbody");
      const loader = document.getElementById("loadingBreaks");
      loader.style.display = "block";
      onValue(ref(db, "prestÃ¡vky"), (snap) => {
        const rows = [];
        snap.forEach(c => {
          const d = c.val();
          rows.push(`<tr><td>${d.zamestnanec}</td><td>${d.datum}</td><td>${d.zaciatok}</td><td>${d.koniec}</td></tr>`);
        });
        tbody.innerHTML = rows.join("");
        loader.style.display = "none";
      }, (err) => {
        console.error(err);
        alert("Chyba pri naÄÃ­tanÃ­ prestÃ¡vok: " + err.message);
      });
    }

    function loadPN() {
      const tbody = document.querySelector("#pnTable tbody");
      const loader = document.getElementById("loadingPN");
      loader.style.display = "block";
      onValue(ref(db, "pn"), (snap) => {
        const rows = [];
        snap.forEach(c => {
          const d = c.val();
          rows.push(`<tr><td>${d.zamestnanec}</td><td>${d.od}</td><td>${d.do}</td><td>${d.poznamka || ""}</td></tr>`);
        });
        tbody.innerHTML = rows.join("");
        loader.style.display = "none";
      }, (err) => {
        console.error(err);
        alert("Chyba pri naÄÃ­tanÃ­ PN: " + err.message);
      });
    }

    function loadUsers() {
      const tbody = document.getElementById("usersList");
      const loader = document.getElementById("loadingUsers");
      loader.style.display = "block";
      onValue(ref(db, "users"), (snap) => {
        const rows = [];
        snap.forEach(child => {
          const user = child.val();
          rows.push(`<tr><td>${user.name}</td><td>${user.chipUid || ""}</td><td><button onclick="deleteUser('${child.key}')">VymazaÅ¥</button></td></tr>`);
        });
        tbody.innerHTML = rows.join("");
        loader.style.display = "none";
      }, (err) => {
        console.error(err);
        alert("Chyba pri naÄÃ­tanÃ­ pouÅ¾Ã­vateÄ¾ov: " + err.message);
      });
    }

    // ğŸ—‘ï¸ Mazanie pouÅ¾Ã­vateÄ¾a + vÅ¡etky jeho dÃ¡ta
    window.deleteUser = async (key) => {
      if (!confirm("Naozaj chcete vymazaÅ¥ tohto pouÅ¾Ã­vateÄ¾a a vÅ¡etky jeho dÃ¡ta?")) return;
      try {
        const paths = ["dochadzka", "prestÃ¡vky", "pn"];
        await Promise.all(paths.map(async (p) => {
          const pathRef = ref(db, `${p}/${key}`);
          const snap = await get(pathRef);
          if (snap.exists()) await remove(pathRef);
        }));
        await remove(ref(db, "users/" + key));
        alert("âœ… PouÅ¾Ã­vateÄ¾ a vÅ¡etky jeho dÃ¡ta boli vymazanÃ©.");
      } catch (err) {
        console.error(err);
        alert("âŒ Chyba pri mazanÃ­: " + err.message);
      }
    };

    // â• Pridanie pouÅ¾Ã­vateÄ¾a
    document.getElementById("confirmAddUserBtn").addEventListener("click", async () => {
      const name = document.getElementById("newUserName").value.trim();
      const uid = document.getElementById("newUserUid").value.trim();
      const msg = document.getElementById("addUserMsg");

      if (!name) return msg.textContent = "Zadajte meno zamestnanca!";
      if (!uid) return msg.textContent = "UID Äipu je povinnÃ©!";

      const q = query(ref(db, "users"), orderByChild("chipUid"), equalTo(uid));
      const snap = await get(q);
      if (snap.exists()) return msg.textContent = "Tento UID Äipu uÅ¾ existuje!";

      push(ref(db, "users"), { name, chipUid: uid, createdAt: new Date().toISOString() })
        .then(() => { msg.textContent = "âœ… Zamestnanec pridanÃ½!"; hideAddUserForm(); })
        .catch(err => msg.textContent = "Chyba: " + err.message);
    });

    // ğŸ“¤ Export
    window.exportToExcel = (tableId, fileName) => {
      const table = document.getElementById(tableId);
      if (!table || !table.querySelectorAll("tbody tr").length) return alert("TabuÄ¾ka je prÃ¡zdna!");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Ãšdaje" });
      XLSX.writeFile(wb, fileName + ".xlsx");
    };

    // ğŸ“‹ PrepÃ­nanie sekciÃ­
    const tabs = document.querySelectorAll(".sidebar li[data-target]");
    const sections = document.querySelectorAll("main section");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.target).classList.add("active");
      });
    });

    // ğŸ‘¤ Form funkcie
    window.showAddUserForm = () => document.getElementById("addUserForm").style.display = "block";
    window.hideAddUserForm = () => {
      document.getElementById("addUserForm").style.display = "none";
      document.getElementById("newUserName").value = "";
      document.getElementById("newUserUid").value = "";
      document.getElementById("addUserMsg").textContent = "";
    };
  </script>
</body>
        </html>




