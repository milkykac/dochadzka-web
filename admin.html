<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Doch√°dzka</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    background: #f4f5f7;
    color: #333;
    display: flex;
  }

  .sidebar {
    width: 240px;
    background: #2b3a67;
    color: white;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding-top: 20px;
  }

  .sidebar h2 {
    text-align: center;
    font-weight: 600;
    margin-bottom: 20px;
  }

  .sidebar ul {
    list-style: none;
    padding: 0;
  }

  .sidebar li {
    padding: 14px 20px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .sidebar li:hover, .sidebar li.active {
    background: #3e4e88;
  }

  main {
    flex: 1;
    padding: 20px;
  }

  section {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  section.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: center;
  }

  th {
    background: #dfe3ee;
  }

  .dochadzka { background: #e8f5e9; }
  .prest√°vky { background: #fff3e0; }
  .pn { background: #fce4ec; }

  button {
    background: #3e4e88;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
  }

  button:hover {
    background: #2b3a67;
  }

  input {
    padding: 8px;
    margin-top: 5px;
    width: 200px;
  }
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <h2>üëë Admin Panel</h2>
  <ul>
    <li id="viewAttendanceTab" data-target="view-attendance" class="active">üìÖ Doch√°dzka</li>
    <li id="viewBreaksTab" data-target="view-breaks">‚òï Prest√°vky</li>
    <li id="viewPnTab" data-target="view-pn">üè• PN</li>
    <li id="manageUsersTab" data-target="manage-users">üë§ Spr√°va zamestnancov</li>
  </ul>
</aside>

<!-- Hlavn√Ω obsah -->
<main>
  <section id="view-attendance" class="active">
    <h2>üìÖ Doch√°dzka</h2>
    <button onclick="exportToExcel('dochadzkaTable', 'Dochadzka')">Export do Excel</button>
    <table id="dochadzkaTable">
      <thead>
        <tr><th>Zamestnanec</th><th>UID</th><th>D√°tum</th><th>ƒåas</th><th>Typ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="view-breaks">
    <h2>‚òï Prest√°vky</h2>
    <button onclick="exportToExcel('prest√°vkyTable', 'Prest√°vky')">Export do Excel</button>
    <table id="prest√°vkyTable">
      <thead>
        <tr><th>Zamestnanec</th><th>D√°tum</th><th>Zaƒçiatok</th><th>Koniec</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="view-pn">
    <h2>üè• PN</h2>
    <button onclick="exportToExcel('pnTable', 'PN')">Export do Excel</button>
    <table id="pnTable">
      <thead>
        <tr><th>Zamestnanec</th><th>Od</th><th>Do</th><th>Pozn√°mka</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="manage-users">
    <h2>üë§ Spr√°va zamestnancov</h2>
    <button onclick="showAddUserForm()">Prida≈• zamestnanca</button>
    <button onclick="exportToExcel('usersTable', 'Zamestnanci')">Export do Excel</button>
    <table id="usersTable">
      <thead>
        <tr><th>Meno</th><th>UID ƒçipu</th><th>Akcie</th></tr>
      </thead>
      <tbody id="usersList"></tbody>
    </table>
    <div id="addUserForm" style="display: none; margin-top: 20px;">
      <h3>Prida≈• nov√©ho zamestnanca</h3>
      <input type="text" id="newUserName" placeholder="Meno"><br>
      <input type="password" id="newUserPassword" placeholder="Heslo"><br>
      <input type="text" id="newUserUid" placeholder="UID ƒçipu (voliteƒæn√©)"><br>
      <button onclick="addUser()">Prida≈•</button>
      <button onclick="hideAddUserForm()">Zru≈°i≈•</button>
      <p id="addUserMsg"></p>
    </div>
  </section>



  <!-- Modal pre pridanie nov√©ho zamestnanca -->
  <div id="newEmployeeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;">
      <h3>Nov√Ω zamestnanec detekovan√Ω</h3>
      <p>Nov√Ω ƒçip UID: <span id="newChipUid"></span></p>
      <input type="text" id="newEmpName" placeholder="Meno zamestnanca"><br>
      <button onclick="addNewEmployee()">Prida≈• zamestnanca</button>
      <button onclick="closeNewEmployeeModal()">Zru≈°i≈•</button>
      <p id="newEmpMsg"></p>
    </div>
  </div>
</main>

<script>
  // üî• Firebase konfigur√°cia
  const firebaseConfig = {
    apiKey: "AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
    authDomain: "dochadzkaesp32.firebaseapp.com",
    databaseURL: "https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dochadzkaesp32",
    storageBucket: "dochadzkaesp32.firebasestorage.app",
    messagingSenderId: "417668021105",
    appId: "1:417668021105:web:99a456dd622bb4ac4854d0",
    measurementId: "G-268ZE9WLV1"
  };

  let db = null;
  try {
    const app = firebase.initializeApp(firebaseConfig);
    db = firebase.database();
  } catch (error) {
    console.error("Firebase inicializ√°cia zlyhala:", error);
  }

  // üìã Naƒç√≠tanie d√°t z datab√°zy
  function loadAttendance() {
    if (!db) return;
    const ref = db.ref("dochadzka");
    ref.on("value", (snapshot) => {
      const tbody = document.querySelector("#dochadzkaTable tbody");
      tbody.innerHTML = "";
      snapshot.forEach(rec => {
        const d = rec.val();
        const row = `<tr><td>${d.zamestnanec}</td><td>${d.uid || ""}</td><td>${d.datum}</td><td>${d.cas}</td><td>${d.typ}</td></tr>`;
        tbody.innerHTML += row;
      });
    });
  }

  function loadBreaks() {
    if (!db) return;
    const ref = db.ref("prest√°vky");
    ref.on("value", (snapshot) => {
      const tbody = document.querySelector("#prest√°vkyTable tbody");
      tbody.innerHTML = "";
      snapshot.forEach(rec => {
        const d = rec.val();
        const row = `<tr><td>${d.zamestnanec}</td><td>${d.datum}</td><td>${d.zaciatok}</td><td>${d.koniec}</td></tr>`;
        tbody.innerHTML += row;
      });
    });
  }

  function loadPN() {
    if (!db) return;
    const ref = db.ref("pn");
    ref.on("value", (snapshot) => {
      const tbody = document.querySelector("#pnTable tbody");
      tbody.innerHTML = "";
      snapshot.forEach(rec => {
        const d = rec.val();
        const row = `<tr><td>${d.zamestnanec}</td><td>${d.od}</td><td>${d.do}</td><td>${d.poznamka || ""}</td></tr>`;
        tbody.innerHTML += row;
      });
    });
  }

  loadAttendance();
  loadBreaks();
  loadPN();
  loadUsers();

  // ü™Ñ Prep√≠nanie sekci√≠
  const tabs = document.querySelectorAll(".sidebar li");
  const sections = document.querySelectorAll("main section");
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      sections.forEach(s => s.classList.remove("active"));
      tab.classList.add("active");
      const target = tab.dataset.target;
      if (target) {
        document.getElementById(target).classList.add("active");
      }
    });
  });

  // üë§ Spr√°va zamestnancov
  function loadUsers() {
    if (!db) return;
    const ref = db.ref("users");
    ref.on("value", (snapshot) => {
      const tbody = document.getElementById("usersList");
      tbody.innerHTML = "";
      snapshot.forEach(childSnap => {
        const user = childSnap.val();
        const row = document.createElement('tr');
        const nameTd = document.createElement('td');
        nameTd.textContent = user.name;
        nameTd.onclick = () => editCell(nameTd, childSnap.key, 'name');
        const uidTd = document.createElement('td');
        uidTd.textContent = user.chipUid || "";
        uidTd.onclick = () => editCell(uidTd, childSnap.key, 'chipUid');
        const actionsTd = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Vymaza≈•';
        deleteBtn.onclick = () => deleteUser(childSnap.key);
        actionsTd.appendChild(deleteBtn);
        row.appendChild(nameTd);
        row.appendChild(uidTd);
        row.appendChild(actionsTd);
        tbody.appendChild(row);
      });
    });
  }

  function editCell(td, key, field) {
    if (!db) return;
    const originalText = td.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = originalText;
    input.onblur = () => {
      const newValue = input.value.trim();
      if (newValue !== originalText) {
        if (field === 'name' && !newValue) {
          td.textContent = originalText;
          return;
        }
        if (field === 'chipUid' && newValue) {
          // Kontrola duplicitn√©ho UID
          db.ref("users").orderByChild("chipUid").equalTo(newValue).once("value", snapshot => {
            let duplicate = false;
            snapshot.forEach(childSnap => {
              if (childSnap.key !== key) {
                duplicate = true;
              }
            });
            if (duplicate) {
              alert("UID ƒçipu u≈æ existuje!");
              td.textContent = originalText;
              return;
            }
            updateField(td, key, field, newValue, originalText);
          });
        } else {
          updateField(td, key, field, newValue, originalText);
        }
      } else {
        td.textContent = originalText;
      }
    };
    input.onkeydown = (e) => {
      if (e.key === 'Enter') input.blur();
      if (e.key === 'Escape') {
        td.textContent = originalText;
      }
    };
    td.innerHTML = '';
    td.appendChild(input);
    input.focus();
    input.select();
  }

  function updateField(td, key, field, newValue, originalText) {
    td.textContent = newValue;
    db.ref("users/" + key).update({ [field]: newValue }).catch(err => {
      alert("Chyba pri aktualiz√°cii: " + err.message);
      td.textContent = originalText;
    });
  }

  function showAddUserForm() {
    document.getElementById("addUserForm").style.display = "block";
  }

  function hideAddUserForm() {
    document.getElementById("addUserForm").style.display = "none";
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPassword").value = "";
    document.getElementById("newUserUid").value = "";
    document.getElementById("addUserMsg").textContent = "";
  }

  function addUser() {
    if (!db) return;
    const name = document.getElementById("newUserName").value.trim();
    const password = document.getElementById("newUserPassword").value;
    const msg = document.getElementById("addUserMsg");
    if (!name || !password) {
      msg.textContent = "Vypl≈àte meno a heslo!";
      return;
    }
    // Kontrola duplicitn√©ho UID
    const uid = document.getElementById("newUserUid").value.trim();
    if (uid) {
      db.ref("users").orderByChild("chipUid").equalTo(uid).once("value", snapshot => {
        if (snapshot.exists()) {
          msg.textContent = "UID ƒçipu u≈æ existuje!";
          return;
        }
        proceedAddUser(name, password, uid, msg);
      });
    } else {
      proceedAddUser(name, password, "", msg);
    }
  }

  function proceedAddUser(name, password, uid, msg) {
    msg.textContent = "Prid√°vanie...";
    const ref = db.ref("users").push();
    const userData = { name, password, chipUid: uid || "" };
    ref.set(userData).then(() => {
      msg.textContent = "Zamestnanec pridan√Ω!";
      hideAddUserForm();
      loadUsers(); // Reload the users table
    }).catch(err => {
      msg.textContent = "Chyba: " + err.message;
    });
  }

  function deleteUser(key) {
    if (!db) return;
    if (confirm("Naozaj chcete vymaza≈• tohto zamestnanca?")) {
      db.ref("users/" + key).remove().then(() => {
        alert("Zamestnanec vymazan√Ω!");
      }).catch(err => {
        alert("Chyba: " + err.message);
      });
    }
  }

  // üîë Zmena hesla
  function changePassword() {
    const newEmail = document.getElementById("newEmail").value;
    const newPass = document.getElementById("newPassword").value;
    const msg = document.getElementById("changePassMsg");
    msg.textContent = "Zmena prebieha...";
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        user.updateEmail(newEmail).then(() => {
          return user.updatePassword(newPass);
        }).then(() => {
          msg.textContent = "√öspe≈°ne zmenen√©!";
        }).catch(err => {
          msg.textContent = "Chyba: " + err.message;
        });
      } else msg.textContent = "Nie si prihl√°sen√Ω!";
    });
  }

  // üìä Export do Excel
  function exportToExcel(tableId, fileName) {
    const table = document.getElementById(tableId);
    const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
    XLSX.writeFile(wb, fileName + ".xlsx");
  }

  // üë§ Detekcia nov√©ho ƒçipu a pridanie zamestnanca
  let knownUids = new Set();
  function checkForNewChips() {
    if (!db) return;
    const ref = db.ref("dochadzka");
    ref.on("value", (snapshot) => {
      snapshot.forEach(userSnap => {
        userSnap.forEach(rec => {
          const d = rec.val();
          const uid = d.uid;
          if (uid && !knownUids.has(uid)) {
            knownUids.add(uid);
            // Skontroluj, ƒçi u≈æ existuje v users
            db.ref("users").orderByChild("chipUid").equalTo(uid).once("value", userSnap => {
              if (!userSnap.exists()) {
                // Nov√Ω ƒçip, zobraz modal
                document.getElementById("newChipUid").textContent = uid;
                document.getElementById("newEmployeeModal").style.display = "flex";
              }
            });
          }
        });
      });
    });
  }

  function addNewEmployee() {
    if (!db) return;
    const name = document.getElementById("newEmpName").value.trim();
    const uid = document.getElementById("newChipUid").textContent;
    const msg = document.getElementById("newEmpMsg");
    if (!name) {
      msg.textContent = "Vypl≈àte meno!";
      return;
    }
    msg.textContent = "Prid√°vanie...";
    const ref = db.ref("users").push();
    const userData = { name, chipUid: uid };
    ref.set(userData).then(() => {
      msg.textContent = "Zamestnanec pridan√Ω!";
      closeNewEmployeeModal();
      loadUsers(); // Reload the users table
    }).catch(err => {
      msg.textContent = "Chyba: " + err.message;
    });
  }

  function closeNewEmployeeModal() {
    document.getElementById("newEmployeeModal").style.display = "none";
    document.getElementById("newEmpName").value = "";
    document.getElementById("newEmpMsg").textContent = "";
  }

  // Spusti kontrolu nov√Ωch ƒçipov
  checkForNewChips();
</script>
</body>
</html>
