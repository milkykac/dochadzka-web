<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äì Doch√°dzka ESP32</title>
<style>
body {font-family:'Poppins',sans-serif;background:#eef2f6;margin:0;padding:0;display:flex;}
.sidebar{width:230px;height:100vh;background:linear-gradient(180deg,#007bff 0%,#0056b3 100%);color:white;position:fixed;left:0;top:0;padding-top:30px;box-shadow:2px 0 10px rgba(0,0,0,0.15);display:flex;flex-direction:column;align-items:center;}
.sidebar h2{margin-bottom:40px;font-size:20px;font-weight:600;}
.sidebar ul{list-style:none;padding:0;width:100%;}
.sidebar li{padding:15px 30px;cursor:pointer;transition:0.3s;text-align:left;}
.sidebar li:hover,.sidebar li.active{background:rgba(255,255,255,0.2);}
header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.05);color:#333;text-align:center;padding:20px;font-size:22px;font-weight:600;position:fixed;top:0;left:230px;right:0;z-index:100;}
#logoutBtn{position:absolute;top:15px;right:30px;background:#dc3545;color:white;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;transition:0.3s;}
#logoutBtn:hover{background:#b52a3a;}
main{flex:1;margin-left:250px;margin-top:90px;padding:30px;}
section{display:none;margin-bottom:30px;}
section.active{display:block;background:#fff;padding:25px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.05);}
h2{color:#007bff;border-bottom:2px solid #007bff;padding-bottom:8px;margin-bottom:20px;}
input,select{padding:8px 12px;border-radius:8px;border:1px solid #ccc;margin:6px 4px;outline:none;}
button{background:#007bff;color:white;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;transition:0.3s;}
button:hover{background:#0056b3;}
table{border-collapse:collapse;width:100%;margin-top:20px;font-size:14px;}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:#007bff;color:white;}
tr:nth-child(even){background:#f9f9f9;}
.action-btn{background:#dc3545;border:none;color:white;padding:6px 10px;border-radius:6px;cursor:pointer;transition:0.3s;}
.action-btn:hover{background:#b52a3a;}
.modal{display:none;position:fixed;z-index:2;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);}
.modal-content{background:white;margin:15% auto;padding:20px;border-radius:10px;max-width:300px;}
.close{float:right;font-size:24px;cursor:pointer;color:#aaa;}
.close:hover{color:black;}
.new-chip-banner{position:fixed;top:75px;left:50%;transform:translateX(-50%);background:#ffc107;color:#000;padding:12px 25px;text-align:center;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.15);font-weight:600;z-index:1000;}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Admin Panel</h2>
  <ul>
    <li id="manageUsersTab" class="active">üë§ Spr√°va zamestnancov</li>
    <li id="viewAttendanceTab">üìÖ Pr√≠chody/Odchody</li>
    <li id="breaksTab">‚òï Prest√°vky</li>
    <li id="pnTab">ü©∫ PN</li>
  </ul>
</div>

<header>
  üõ†Ô∏è Administr√°cia doch√°dzky
  <button id="logoutBtn">Odhl√°si≈• sa</button>
</header>

<main>
  <!-- Spr√°va zamestnancov -->
  <section id="manage-users" class="active">
    <h2>üë§ Spr√°va zamestnancov</h2>
    <input type="text" id="name" placeholder="Meno">
    <input type="password" id="password" placeholder="Heslo">
    <input type="text" id="chipUid" placeholder="Chip UID">
    <button id="addUserBtn">Prida≈• / Aktualizova≈•</button>

    <table id="userTable">
      <thead><tr><th>UID</th><th>Meno</th><th>Heslo</th><th>Chip UID</th><th>Akcie</th></tr></thead>
      <tbody id="userBody"><tr><td colspan="5">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- Pr√≠chody/Odchody -->
  <section id="view-attendance">
    <h2>üìÖ Pr√≠chody/Odchody</h2>
    <div>
      <label>D√°tum:</label>
      <input type="date" id="filterDate">
      <label style="margin-left:20px;">Zamestnanec:</label>
      <select id="filterName"><option value="">V≈°etci</option></select>
    </div>
    <div style="margin-top:10px;">
      <input type="text" id="chipUidAttendance" placeholder="Chip UID">
      <select id="attendanceType">
        <option value="PRICHOD">Pr√≠chod</option>
        <option value="ODCHOD">Odchod</option>
      </select>
      <button id="addAttendanceBtn">Prida≈• z√°znam</button>
      <button id="exportAttendanceBtn">‚¨áÔ∏è Exportova≈•</button>
    </div>
    <table id="attendanceTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas</th><th>Typ</th></tr></thead>
      <tbody id="attendanceBody"><tr><td colspan="4">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- Prest√°vky -->
  <section id="breaks">
    <h2>‚òï Prest√°vky</h2>
    <div>
      <input type="text" id="chipUidBreak" placeholder="Chip UID">
      <button id="addBreakBtn">Prida≈• prest√°vku</button>
      <button id="exportBreakBtn">‚¨áÔ∏è Exportova≈•</button>
    </div>
    <table id="breakTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>ƒåas zaƒçiatku</th><th>ƒåas konca</th></tr></thead>
      <tbody id="breakBody"><tr><td colspan="4">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>

  <!-- PN -->
  <section id="pn">
    <h2>ü©∫ PN</h2>
    <div>
      <input type="text" id="chipUidPN" placeholder="Chip UID">
      <button id="addPNBtn">Prida≈• PN</button>
      <button id="exportPNBtn">‚¨áÔ∏è Exportova≈•</button>
    </div>
    <table id="pnTable">
      <thead><tr><th>Zamestnanec</th><th>D√°tum</th><th>Typ</th></tr></thead>
      <tbody id="pnBody"><tr><td colspan="3">Naƒç√≠tavam √∫daje...</td></tr></tbody>
    </table>
  </section>
</main>

<div id="passwordModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Zmeni≈• heslo</h3>
    <input type="password" id="newPassword" placeholder="Nov√© heslo">
    <button id="changePasswordBtn">Zmeni≈• heslo</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, push, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

if(localStorage.getItem("uid")!=="admin"){ alert("Nem√°≈° pr√≠stup!"); window.location.href="index.html"; }

const firebaseConfig = {
  apiKey:"AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain:"dochadzkaesp32.firebaseapp.com",
  databaseURL:"https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"dochadzkaesp32",
  storageBucket:"dochadzkaesp32.firebasestorage.app",
  messagingSenderId:"417668021105",
  appId:"1:417668021105:web:7fa3e144892d8b304854d0",
  measurementId:"G-ZKQNMZEPHD"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Inputs
const nameInput=document.getElementById("name");
const passInput=document.getElementById("password");
const chipUidInput=document.getElementById("chipUid");
const addBtn=document.getElementById("addUserBtn");
const userBody=document.getElementById("userBody");
const attendanceBody=document.getElementById("attendanceBody");
const breakBody=document.getElementById("breakBody");
const pnBody=document.getElementById("pnBody");

const filterDate=document.getElementById("filterDate");
const filterName=document.getElementById("filterName");
const chipUidAttendance=document.getElementById("chipUidAttendance");
const attendanceTypeSelect=document.getElementById("attendanceType");
const addAttendanceBtn=document.getElementById("addAttendanceBtn");
const exportAttendanceBtn=document.getElementById("exportAttendanceBtn");

const chipUidBreak=document.getElementById("chipUidBreak");
const addBreakBtn=document.getElementById("addBreakBtn");
const exportBreakBtn=document.getElementById("exportBreakBtn");

const chipUidPN=document.getElementById("chipUidPN");
const addPNBtn=document.getElementById("addPNBtn");
const exportPNBtn=document.getElementById("exportPNBtn");

const passwordModal=document.getElementById("passwordModal");
const newPasswordInput=document.getElementById("newPassword");
const changePasswordBtn=document.getElementById("changePasswordBtn");
const closeModal=document.getElementsByClassName("close")[0];

let allUsers={}, allAttendance=[], allBreaks=[], allPN=[], currentUserUid=null;

// --- Naƒç√≠tanie pou≈æ√≠vateƒæov ---
const usersRef=ref(db,"users/");
function loadUsers(){
  onValue(usersRef,(snapshot)=>{
    userBody.innerHTML=""; allUsers={}; filterName.innerHTML='<option value="">V≈°etci</option>';
    if(!snapshot.exists()){userBody.innerHTML="<tr><td colspan='5'>≈Ωiadni zamestnanci</td></tr>"; return;}
    snapshot.forEach(child=>{
      const data=child.val(); allUsers[child.key]=data;
      const option=document.createElement("option"); option.value=data.name; option.textContent=data.name; filterName.appendChild(option);
      const row=document.createElement("tr");
      row.innerHTML=`<td>${child.key}</td><td>${data.name}</td><td>***</td><td>${data.chipUid||''}</td>
        <td><button class="action-btn" onclick="deleteUser('${child.key}')">Zmaza≈•</button>
        <button class="action-btn" onclick="openPasswordModal('${child.key}')">Zmeni≈• heslo</button></td>`;
      userBody.appendChild(row);
    });
  });
}

// --- Naƒç√≠tanie doch√°dzky ---
const attendanceRef=ref(db,"dochadzka/");
function loadAttendance(){
  onValue(attendanceRef,(snapshot)=>{
    allAttendance=[]; allBreaks=[]; allPN=[];
    if(snapshot.exists()){
      snapshot.forEach(userSnap=>{
        userSnap.forEach(recordSnap=>{
          const record=recordSnap.val();
          if(record.stav==="PRESTAVKA") allBreaks.push({chipUid:userSnap.key, cas:record.cas});
          else if(record.stav==="PN") allPN.push({chipUid:userSnap.key, cas:record.cas, stav:"PN"});
          else allAttendance.push({chipUid:userSnap.key, cas:record.cas, stav:record.stav});
        });
      });
    }
    applyFilters();
  });
}

// --- Pridanie z√°znamu doch√°dzky ---
addAttendanceBtn.addEventListener("click", async()=>{
  const chipUid = chipUidAttendance.value.trim();
  const type = attendanceTypeSelect.value;
  if(!chipUid || !type){ alert("Vypl≈à ƒçip a typ!"); return; }
  const user = Object.values(allUsers).find(u=>u.chipUid===chipUid);
  if(!user){ alert("ƒåip nie je priraden√Ω!"); return; }

  const timeStr = new Date().toISOString().replace("T"," ").split(".")[0];
  const recordRef = push(ref(db,"dochadzka/"+user.name));
  await set(recordRef, {cas:timeStr, stav:type});
  chipUidAttendance.value="";
});

// --- Pridanie prest√°vky ---
addBreakBtn.addEventListener("click", async()=>{
  const chipUid = chipUidBreak.value.trim();
  if(!chipUid){ alert("Vypl≈à ƒçip!"); return; }
  const user = Object.values(allUsers).find(u=>u.chipUid===chipUid);
  if(!user){ alert("ƒåip nie je priraden√Ω!"); return; }
  const timeStr = new Date().toISOString().replace("T"," ").split(".")[0];
  const recordRef = push(ref(db,"dochadzka/"+user.name));
  await set(recordRef, {cas:timeStr, stav:"PRESTAVKA"});
  chipUidBreak.value="";
});

// --- Pridanie PN ---
addPNBtn.addEventListener("click", async()=>{
  const chipUid = chipUidPN.value.trim();
  if(!chipUid){ alert("Vypl≈à ƒçip!"); return; }
  const user = Object.values(allUsers).find(u=>u.chipUid===chipUid);
  if(!user){ alert("ƒåip nie je priraden√Ω!"); return; }
  const timeStr = new Date().toISOString().split("T")[0]; // iba d√°tum
  const recordRef = push(ref(db,"dochadzka/"+user.name));
  await set(recordRef, {cas:timeStr, stav:"PN"});
  chipUidPN.value="";
});

// --- Filtrovanie ---
function applyFilters(){
  const selectedDate=filterDate.value, selectedName=filterName.value;
  // Pr√≠chody/Odchody
  attendanceBody.innerHTML="";
  let filtered=allAttendance.filter(record=>{
    let matchDate=!selectedDate||record.cas.split(' ')[0]===selectedDate;
    let matchName=true;
    if(selectedName){
      const user=Object.values(allUsers).find(u=>u.chipUid===record.chipUid);
      matchName=user&&user.name===selectedName;
    }
    return matchDate&&matchName;
  });
  if(!filtered.length) attendanceBody.innerHTML="<tr><td colspan='4'>≈Ωiadne z√°znamy</td></tr>";
  else filtered.forEach(record=>{
    const row=document.createElement("tr");
    const user=Object.values(allUsers).find(u=>u.chipUid===record.chipUid);
    const name=user?user.name:record.chipUid;
    const [date,time]=record.cas.split(" ");
    row.innerHTML=`<td>${name}</td><td>${date}</td><td>${time}</td><td>${record.stav}</td>`;
    attendanceBody.appendChild(row);
  });

  // Prest√°vky
  breakBody.innerHTML="";
  if(!allBreaks.length) breakBody.innerHTML="<tr><td colspan='4'>≈Ωiadne z√°znamy</td></tr>";
  else allBreaks.forEach(record=>{
    const row=document.createElement("tr");
    const user=Object.values(allUsers).find(u=>u.chipUid===record.chipUid);
    const name=user?user.name:record.chipUid;
    const [date,time]=record.cas.split(" ");
    row.innerHTML=`<td>${name}</td><td>${date}</td><td>${time}</td><td>-</td>`;
    breakBody.appendChild(row);
  });

  // PN
  pnBody.innerHTML="";
  if(!allPN.length) pnBody.innerHTML="<tr><td colspan='3'>≈Ωiadne z√°znamy</td></tr>";
  else allPN.forEach(record=>{
    const row=document.createElement("tr");
    const user=Object.values(allUsers).find(u=>u.chipUid===record.chipUid);
    const name=user?user.name:record.chipUid;
    const date=record.cas;
    row.innerHTML=`<td>${name}</td><td>${date}</td><td>${record.stav}</td>`;
    pnBody.appendChild(row);
  });
}

filterDate.addEventListener("change",applyFilters);
filterName.addEventListener("change",applyFilters);

// --- Export ---
function exportCSV(data, filename, columns){
  let csv = columns.join(",") + "\n";
  data.forEach(record=>{
    csv += columns.map(col=>record[col]).join(",") + "\n";
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}

exportAttendanceBtn.addEventListener("click",()=>{  
  const data = allAttendance.map(r=>{
    const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
    const [date,time]=r.cas.split(" ");
    return {Zamestnanec:user?user.name:r.chipUid,D√°tum:date,ƒåas:time,Typ:r.stav};
  });
  exportCSV(data,"prichody_odchody.csv",["Zamestnanec","D√°tum","ƒåas","Typ"]);
});

exportBreakBtn.addEventListener("click",()=>{
  const data = allBreaks.map(r=>{
    const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
    const [date,time]=r.cas.split(" ");
    return {Zamestnanec:user?user.name:r.chipUid,D√°tum:date,ƒåas:time};
  });
  exportCSV(data,"prestavky.csv",["Zamestnanec","D√°tum","ƒåas"]);
});

exportPNBtn.addEventListener("click",()=>{
  const data = allPN.map(r=>{
    const user=Object.values(allUsers).find(u=>u.chipUid===r.chipUid);
    return {Zamestnanec:user?user.name:r.chipUid,D√°tum:r.cas,Typ:"PN"};
  });
  exportCSV(data,"pn.csv",["Zamestnanec","D√°tum","Typ"]);
});

// --- Pridanie pou≈æ√≠vateƒæa ---
addBtn.addEventListener("click", async ()=>{
  const name=nameInput.value.trim(),password=passInput.value.trim(),chipUid=chipUidInput.value.trim();
  if(!name||!password||!chipUid){alert("Vypl≈à v≈°etky polia!");return;}
  try{
    const newRef=push(ref(db,"users/"));
    await set(newRef,{name,password,chipUid});
    alert("Pou≈æ√≠vateƒæ pridan√Ω ‚úÖ");
    nameInput.value=passInput.value=chipUidInput.value="";
  }catch(err){console.error(err);alert("Chyba pri prid√°van√≠ pou≈æ√≠vateƒæa!");}
});

// --- Mazanie / heslo ---
function deleteUser(uid){if(confirm("Naozaj zmaza≈•?"))remove(ref(db,"users/"+uid));}
window.deleteUser=deleteUser;
function openPasswordModal(uid){currentUserUid=uid;passwordModal.style.display="block";}
window.openPasswordModal=openPasswordModal;
closeModal.onclick=()=>passwordModal.style.display="none";
window.onclick=(e)=>{if(e.target==passwordModal)passwordModal.style.display="none";}
changePasswordBtn.addEventListener("click",async()=>{
  const newPass=newPasswordInput.value.trim(); if(!newPass){alert("Zadaj nov√© heslo!");return;}
  await update(ref(db,"users/"+currentUserUid),{password:newPass});
  alert("Heslo zmenen√© ‚úÖ"); newPasswordInput.value=""; passwordModal.style.display="none";
});

// --- Prep√≠nanie sekci√≠ ---
document.getElementById("manageUsersTab").addEventListener("click",()=>{showSection("manage-users");});
document.getElementById("viewAttendanceTab").addEventListener("click",()=>{showSection("view-attendance");});
document.getElementById("breaksTab").addEventListener("click",()=>{showSection("breaks");});
document.getElementById("pnTab").addEventListener("click",()=>{showSection("pn");});

function showSection(id){
  ["manage-users","view-attendance","breaks","pn"].forEach(s=>document.getElementById(s).classList.remove("active"));
  document.getElementById(id).classList.add("active");
  ["manageUsersTab","viewAttendanceTab","breaksTab","pnTab"].forEach(t=>document.getElementById(t).classList.remove("active"));
  const tabMap={"manage-users":"manageUsersTab","view-attendance":"viewAttendanceTab","breaks":"breaksTab","pn":"pnTab"};
  document.getElementById(tabMap[id]).classList.add("active");
}

// --- Automatick√Ω refresh ka≈æd√© 3 sekundy ---
setInterval(()=>{
  loadUsers();
  loadAttendance();
},3000);

// --- Inicialne naƒç√≠tanie ---
loadUsers();
loadAttendance();
</script>
</body>
</html>








