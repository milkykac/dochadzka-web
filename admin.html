<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Dochádzka ESP32</title>
<style>
body{font-family:'Poppins',sans-serif;margin:0;display:flex;background:#eef2f6;}
.sidebar{width:230px;height:100vh;background:#007bff;color:white;position:fixed;padding-top:30px;display:flex;flex-direction:column;}
.sidebar h2{text-align:center;margin-bottom:40px;font-size:20px;}
.sidebar ul{list-style:none;padding:0;width:100%;}
.sidebar li{padding:15px 20px;cursor:pointer;transition:0.3s;}
.sidebar li:hover,.sidebar li.active{background:rgba(255,255,255,0.2);}
header{position:fixed;top:0;left:230px;right:0;background:#fff;padding:20px;font-size:22px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
#logoutBtn{position:absolute;top:15px;right:30px;background:#dc3545;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
main{margin-left:250px;margin-top:90px;padding:20px;flex:1;}
section{display:none;}
section.active{display:block;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#007bff;color:white;}
tr:nth-child(even){background:#f9f9f9;}
button{padding:6px 12px;border:none;border-radius:6px;background:#007bff;color:white;cursor:pointer;}
button:hover{background:#0056b3;}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Admin Panel</h2>
  <ul>
    <li id="tabUsers" class="active">Správa zamestnancov</li>
    <li id="tabAttendance">Dochádzka</li>
    <li id="tabBreaks">Prestávky</li>
    <li id="tabPN">PN</li>
    <li id="tabPassword">Zmena hesla</li>
  </ul>
</div>

<header>
  Administrácia dochádzky
  <button id="logoutBtn">Odhlásiť sa</button>
</header>

<main>
  <section id="sectionUsers" class="active">
    <h2>Správa zamestnancov</h2>
    <input type="text" id="name" placeholder="Meno">
    <input type="password" id="password" placeholder="Heslo">
    <input type="text" id="chip" placeholder="Chip UID">
    <button id="addUser">Pridať</button>
    <table>
      <thead><tr><th>UID</th><th>Meno</th><th>Heslo</th><th>Chip UID</th><th>Akcie</th></tr></thead>
      <tbody id="userBody"><tr><td colspan="5">Načítavam...</td></tr></tbody>
    </table>
  </section>

  <section id="sectionAttendance">
    <h2>Dochádzka</h2>
    <input type="date" id="filterDate">
    <select id="filterName"><option value="">Všetci</option></select>
    <input type="text" id="chipAttendance" placeholder="Chip UID">
    <select id="typeAttendance">
      <option value="PRICHOD">Príchod</option>
      <option value="ODCHOD">Odchod</option>
      <option value="PRESTAVKA">Prestávka</option>
      <option value="PN">PN</option>
    </select>
    <button id="addAttendance">Pridať záznam</button>
    <table>
      <thead><tr><th>Zamestnanec</th><th>Dátum</th><th>Čas</th><th>Typ</th></tr></thead>
      <tbody id="attendanceBody"><tr><td colspan="4">Načítavam...</td></tr></tbody>
    </table>
  </section>

  <section id="sectionBreaks">
    <h2>Prestávky</h2>
    <table>
      <thead><tr><th>Zamestnanec</th><th>Dátum</th><th>Čas</th></tr></thead>
      <tbody id="breakBody"><tr><td colspan="3">Načítavam...</td></tr></tbody>
    </table>
  </section>

  <section id="sectionPN">
    <h2>PN</h2>
    <table>
      <thead><tr><th>Zamestnanec</th><th>Dátum</th><th>Čas</th></tr></thead>
      <tbody id="pnBody"><tr><td colspan="3">Načítavam...</td></tr></tbody>
    </table>
  </section>

  <section id="sectionPassword">
    <h2>Zmena hesla</h2>
    <input type="text" id="passName" placeholder="Meno">
    <input type="password" id="newPass" placeholder="Nové heslo">
    <button id="updatePass">Zmeniť heslo</button>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
const app = firebase.initializeApp({
  apiKey:"AIzaSyB5ovJ-_GAnfIExgBsNuQtc4tb6mqhsdj8",
  authDomain:"dochadzkaesp32.firebaseapp.com",
  databaseURL:"https://dochadzkaesp32-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"dochadzkaesp32"
});
const db = firebase.database();

let allUsers={}, allAttendance=[], allBreaks=[], allPN=[];

// Hash password
async function hashPassword(pass){ return CryptoJS.SHA256(pass).toString(); }

// Load users
function loadUsers(){
  db.ref("users/").on("value", snap=>{
    userBody.innerHTML=""; allUsers={}; filterName.innerHTML='<option value="">Všetci</option>';
    if(!snap.exists()){ userBody.innerHTML="<tr><td colspan='5'>Žiadni</td></tr>"; return;}
    snap.forEach(child=>{
      const data=child.val(); allUsers[child.key]=data;
      const row=document.createElement("tr");
      row.innerHTML=`<td>${child.key}</td><td>${data.name}</td><td>***</td><td>${data.chipUid||''}</td>
        <td><button onclick="deleteUser('${child.key}')">Zmazať</button></td>`;
      userBody.appendChild(row);

      const opt=document.createElement("option"); opt.value=data.name; opt.textContent=data.name; filterName.appendChild(opt);
    });
    loadAttendance();
  });
}

// Delete user
function deleteUser(uid){ if(confirm("Naozaj zmazať?")) db.ref("users/"+uid).remove();}
window.deleteUser = deleteUser;

// Add user
document.getElementById("addUser").addEventListener("click", async()=>{
  const name = document.getElementById("name").value.trim();
  const pass = document.getElementById("password").value.trim();
  const chip = document.getElementById("chip").value.trim();
  if(!name||!pass){ alert("Vyplň meno a heslo!"); return;}
  const hashed = await hashPassword(pass);
  db.ref("users/"+name).set({name,password:hashed,chipUid:chip});
  document.getElementById("name").value=""; document.getElementById("password").value=""; document.getElementById("chip").value="";
});

// Load attendance
function loadAttendance(){
  db.ref("dochadzka/").on("value", snap=>{
    allAttendance=[]; allBreaks=[]; allPN=[];
    if(snap.exists()){
      snap.forEach(chipSnap=>{
        const chip = chipSnap.key;
        let userName = chip;
        for(const uid in allUsers){ if(allUsers[uid].chipUid===chip){ userName=allUsers[uid].name; break;} }
        chipSnap.forEach(rSnap=>{
          const r = rSnap.val(); const [date,time]=r.cas?r.cas.split(" "):["",""];
          if(r.stav==="PN") allPN.push({name:userName,date,time});
          else if(r.stav==="PRESTAVKA") allBreaks.push({name:userName,date,time});
          else allAttendance.push({name:userName,date,time,stav:r.stav});
        });
      });
    }
    renderTables();
  });
}

// Render
function renderTables(){
  const date = document.getElementById("filterDate").value;
  const name = document.getElementById("filterName").value;

  function filterData(arr){ return arr.filter(r=>(!date||r.date===date)&&(!name||r.name===name));}

  const att = filterData(allAttendance);
  const br = filterData(allBreaks);
  const pn = filterData(allPN);

  const attBody = document.getElementById("attendanceBody"); attBody.innerHTML = att.length?att.map(r=>`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.time}</td><td>${r.stav}</td></tr>`).join(''):"<tr><td colspan='4'>Žiadne</td></tr>";
  const brBody = document.getElementById("breakBody"); brBody.innerHTML = br.length?br.map(r=>`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.time}</td></tr>`).join(''):"<tr><td colspan='3'>Žiadne</td></tr>";
  const pnBody = document.getElementById("pnBody"); pnBody.innerHTML = pn.length?pn.map(r=>`<tr><td>${r.name}</td><td>${r.date}</td><td>${r.time}</td></tr>`).join(''):"<tr><td colspan='3'>Žiadne</td></tr>";
}

// Filter
document.getElementById("filterDate").addEventListener("change", renderTables);
document.getElementById("filterName").addEventListener("change", renderTables);

// Add attendance
document.getElementById("addAttendance").addEventListener("click", async()=>{
  const chip = document.getElementById("chipAttendance").value.trim();
  const type = document.getElementById("typeAttendance").value;
  if(!chip){ alert("Vyplň Chip UID"); return;}
  const now = new Date();
  const date = now.toISOString().split("T")[0];
  const time = now.toTimeString().split(' ')[0];
  await db.ref("dochadzka/"+chip).push({cas:date+" "+time,stav:type});
  document.getElementById("chipAttendance").value="";
  alert("Pridané!");
});

// Change password
document.getElementById("updatePass").addEventListener("click", async()=>{
  const uname = document.getElementById("passName").value.trim();
  const newPass = document.getElementById("newPass").value.trim();
  if(!uname||!newPass){ alert("Vyplň údaje"); return;}
  const hashed = await hashPassword(newPass);
  await db.ref("users/"+uname).update({password:hashed});
  document.getElementById("passName").value=""; document.getElementById("newPass").value="";
  alert("Zmenené!");
});

// Tabs
const tabs = {tabUsers:"sectionUsers",tabAttendance:"sectionAttendance",tabBreaks:"sectionBreaks",tabPN:"sectionPN",tabPassword:"sectionPassword"};
for(const t in tabs){
  document.getElementById(t).addEventListener("click",()=>{
    Object.values(tabs).forEach(s=>document.getElementById(s).classList.remove("active"));
    document.getElementById(tabs[t]).classList.add("active");
    document.querySelectorAll(".sidebar li").forEach(li=>li.classList.remove("active"));
    document.getElementById(t).classList.add("active");
  });
}

// Logout
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  localStorage.removeItem("uid"); window.location.href="index.html";
});

// Init
loadUsers();
</script>
</body>
</html>





